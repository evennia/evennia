# 事件中的对话

本教程将引导您使用游戏内 Python 系统创建多个角色对话。这假设您的游戏中已安装了游戏内 Python 系统。如果没有，您可以按照[游戏内 Python 主文档](./Contrib-Ingame-Python.md)中的安装步骤进行操作，安装完成后再回到本教程。**您不需要阅读**完整文档，它是一个很好的参考，但不是学习它的最佳方式，因此有这些教程。

游戏内 Python 系统允许在某些情况下在单个对象上运行代码。安装完成后，您无需修改源代码即可添加这些功能。整个系统使得为某些对象添加特定功能变得容易，但不是所有对象。这就是为什么利用游戏内 Python 系统创建对话系统非常有用。

> 我们将尝试做什么？

在本教程中，我们将创建一个基本对话，以便多个角色自动响应其他人说的特定消息。

## 第一个角色的示例

让我们先创建一个角色。

    @charcreate a merchant

这将在您当前所在的房间中创建一个商人。它没有任何东西，比如描述，您可以根据需要装饰一下。

如上所述，游戏内 Python 系统由将对象与任意代码链接组成。此代码将在某些情况下执行。这里的情况是“当有人在同一个房间说话”时，可能更具体，比如“当有人说你好”时。我们将决定运行什么代码（实际上我们将在游戏中输入代码）。使用游戏内 Python 系统的术语，我们将创建一个回调：回调只是一些条件下将运行的一组代码行。

您可以使用 `@call` 命令（`@callback` 的缩写）概览可以创建回调的所有“条件”。您需要给它一个对象作为参数。例如，我们可以这样做：

    @call a merchant

您应该会看到一个三列的表格，显示我们新创建的商人上存在的事件列表。虽然还没有设置任何代码，但已经有很多事件。对于我们的系统，您可能更感兴趣的是描述 `say` 事件的行：

    | say              |   0 (0) | 在另一个角色在角色的房间里说了些什么之后。|

我们将在商人的房间里说“hello”时创建一个 `say` 事件的回调：

    @call/add a merchant = say hello

在查看此命令显示的内容之前，让我们看看命令的语法：

- `@call` 是命令名称，`/add` 是一个开关。您可以阅读命令的帮助以获取可用开关的帮助和语法的简要概述。
- 然后输入对象的名称，这里是“a merchant”。您也可以输入 ID（在我的情况下是“#3”），这在您不在同一个房间时编辑对象非常有用。您甚至可以像往常一样输入名称的一部分。
- 一个等号，简单的分隔符。
- 事件的名称。这里是“say”。可用事件在您使用 `@call` 时显示。
- 之后是一个空格，我们输入调用此回调的条件。这里，条件表示其他角色应该说什么。我们输入“hello”。这意味着如果有人在房间里说的内容包含“hello”，我们现在创建的回调将被调用。

当您输入此命令时，您应该会看到类似这样的内容：

```
在角色的房间里，另一个角色说了些什么之后。
此事件在另一个角色在同一位置说了些什么之后立即被调用。此时无法阻止该动作。相反，此事件非常适合在特定短语在同一位置被说出时触发角色（如 NPC）执行某些操作。

要使用此事件，您必须指定应该作为参数存在的关键字列表，这些关键字应作为单独的单词出现在所说的短语中。例如，您可以设置一个回调，如果角色所说的短语包含“menu”或“dinner”或“lunch”，则触发：
    @call/add ... = say menu, dinner, lunch
然后，如果角色所说的内容中包含其中一个单词，则此回调将触发。

您可以在此事件中使用的变量：
    speaker: 在此房间中说话的角色。
    character: 连接到此事件的角色。
    message: 角色说的文本。
```

这是一系列信息。对我们来说，现在最重要的是：

- “say”事件在房间里有人说话时被调用。
- 我们可以通过将特定关键字作为附加参数放入来设置回调，以在短语中存在特定关键字时触发。这里我们将此参数设置为“hello”。我们可以有几个用逗号分隔的关键字（稍后我们将详细讨论这一点）。
- 我们可以在此回调中使用三个默认变量：`speaker` 包含说话的角色，`character` 包含被游戏内 Python 系统修改的角色（这里是我们的商人），`message` 包含所说的短语。

变量的概念很重要。如果这让事情变得更简单，可以将它们视为函数中的参数：它们可以在函数体内使用，因为它们在函数被调用时已被设置。

此命令已打开一个编辑器，我们可以在其中输入我们的 Python 代码。

```
----------Line Editor [Callback say of a merchant]--------------------------------
01|
----------[l:01 w:000 c:0000]------------(:h for help)----------------------------
```

对于我们的第一次测试，让我们输入类似这样的内容：

```python
character.location.msg_contents("{character} 耸耸肩说：'嗯，是的，你好！'",
mapping=dict(character=character))
```

输入此行后，您可以键入 `:wq` 来保存编辑器并退出。

现在如果您使用“say”命令说出包含“hello”的消息：

```
你说：“你好，商人先生！”
商人(#3) 耸耸肩说：'嗯，是的，你好！'
```

如果您说的内容不包含“hello”，我们的回调将不会执行。

**总结**：

1. 当我们在房间里用“say”命令说话时，所有角色（除了我们）的“say”事件被调用。
2. 游戏内 Python 系统查看我们说的内容，并检查我们在“say”事件中的回调是否包含我们说的关键字。
3. 如果是，则调用它，并定义我们看到的事件变量。
4. 然后回调作为正常的 Python 代码执行。这里我们调用了角色位置（可能是一个房间）的 `msg_contents` 方法来向整个房间显示一条消息。我们还使用了映射来轻松显示角色的名称。这不是游戏内 Python 系统特有的。如果您对我们使用的代码感到不知所措，只需简化它并使用更简单的内容，例如：

```python
speaker.msg("你对我说了些什么。")
```

## 针对多个关键字的相同回调

很容易创建一个回调，如果句子中包含多个关键字之一，则会触发。

    @call/add merchant = say trade, trader, goods

在打开的编辑器中输入：

```python
character.location.msg_contents("{character} 说：'哦，贸易还不错，只要道路安全。'",
mapping=dict(character=character))
```

然后您可以在句子中使用“trade”、“trader”或“goods”之一，这应该会调用回调：

```
你说：“你的贸易怎么样？”
商人(#3) 说：'哦，贸易还不错，只要道路安全。'
```

我们可以在添加回调时设置多个关键字。我们只需用逗号分隔它们。

## 更长的回调

到目前为止，我们在回调中只设置了一行。这很有用，但我们通常需要更多。对于整个对话，您可能想做的不仅仅是这些。

    @call/add merchant = say bandit, bandits

在编辑器中，您可以粘贴以下内容：

```python
character.location.msg_contents("{character} 说：'土匪吗？'",
mapping=dict(character=character))
character.location.msg_contents("{character} 挠挠头，思考着。",
mapping=dict(character=character))
character.location.msg_contents("{character} 低声说：'是的，看到他们了，北边。不关我的事，但是...'",
mapping=dict(character=character))
speaker.msg("{character} 更仔细地看着你。".format(character=character.get_display_name(speaker)))
speaker.msg("{character} 继续低声说：'我不该说，但如果你需要找到他们，他们在离路有些距离的地方扎营，我猜是在一个洞穴附近。'".format(character=character.get_display_name(speaker)))
```

现在尝试询问商人关于土匪的事情：

```
你说：“你见过土匪吗？”
商人(#3) 说：'土匪吗？'
商人(#3) 挠挠头，思考着。
商人(#3) 低声说：'是的，看到他们了，北边。不关我的事，但是...'
商人(#3) 更仔细地看着你。
商人(#3) 继续低声说：'我不该说，但如果你需要找到他们，他们在离路有些距离的地方扎营，我猜是在一个洞穴附近。'
```

请注意，这里的第一行对话是对整个房间说的，但随后商人直接对说话者说话，只有说话者能听到。您可以做的事情没有真正的限制。

- 您可以设置一个情绪系统，在 NPC 本身中存储属性，以告诉您他处于何种情绪，这将影响他提供的信息...也许是信息的准确性。
- 您可以在某些上下文中添加随机短语。
- 您可以使用其他操作（您不仅限于让商人说些什么，您可以让他移动，给您东西，攻击（如果您有战斗系统）或其他任何事情）。
- 回调是纯 Python，所以您可以编写条件或循环。
- 您可以使用链式事件在某些指令之间添加“暂停”。本教程不会描述如何做到这一点。您已经有很多东西可以玩了。

## 教程常见问题

- **问：** 我可以创建多个角色以响应特定对话吗？
- **答：** 当然可以。游戏内 Python 系统非常强大，因为您可以为各种对象设置独特的代码。您可以有多个角色回答不同的内容。您甚至可以在房间里有不同的角色回答问候。所有回调将一个接一个地执行。
- **问：** 我可以让两个角色以完全相同的方式回答相同的对话吗？
- **答：** 这是可能的，但并不容易做到。通常，事件分组是在代码中设置的，并且取决于不同的游戏。但是，如果这是一些不常见的情况，使用[链式事件](./Contrib-Ingame-Python.md)很容易做到。
- **问：** 是否可以在共享相同原型的所有角色上部署回调？
- **答：** 默认情况下不行。这取决于代码中的个别设置。可以想象某些类型的所有角色共享某些事件，但这是游戏特定的。同一区域的房间也可以共享相同的事件。这是可能的，但需要修改源代码。

- 下一个教程：[使用事件添加语音操作电梯](A-voice-operated-elevator-using-events)。
