
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Tutorial NPCs listening &#8212; Evennia 0.9.1 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Evennia 0.9.1 documentation</a> &#187;</li>
<li class="nav-item nav-item-last"><a href="#">Tutorial NPCs listening</a></li>


      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial-npcs-listening">
<h1>Tutorial NPCs listening<a class="headerlink" href="#tutorial-npcs-listening" title="Permalink to this headline">¶</a></h1>
<p>This tutorial shows the implementation of an NPC object that responds to characters speaking in their location. In this example the NPC parrots what is said, but any actions could be triggered this way.</p>
<p>It is assumed that you already know how to create custom room and character typeclasses, please see the <a class="reference internal" href="Tutorial-for-basic-MUSH-like-game.html"><span class="doc">Basic Game tutorial</span></a> if you haven’t already done this.</p>
<p>What we will need is simply a new NPC typeclass that can react when someone speaks.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># mygame/typeclasses/npc.py</span>

<span class="kn">from</span> <span class="nn">characters</span> <span class="kn">import</span> <span class="n">Character</span>
<span class="k">class</span> <span class="nc">Npc</span><span class="p">(</span><span class="n">Character</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A NPC typeclass which extends the character class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">at_heard_say</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A simple listener and response. This makes it easy to change for</span>
<span class="sd">        subclasses of NPCs reacting differently to says.       </span>

<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># message will be on the form `&lt;Person&gt; says, &quot;say_text&quot;`</span>
        <span class="c1"># we want to get only say_text without the quotes and any spaces</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;says, &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &quot;&#39;</span><span class="p">)</span>

        <span class="c1"># we&#39;ll make use of this in .msg() below</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> said: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>When someone in the room speaks to this NPC, its <code class="docutils literal notranslate"><span class="pre">msg</span></code> method will be called. We will modify the NPCs <code class="docutils literal notranslate"><span class="pre">.msg</span></code> method to catch says so the NPC can respond.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># mygame/typeclasses/npc.py</span>

<span class="kn">from</span> <span class="nn">characters</span> <span class="kn">import</span> <span class="n">Character</span>
<span class="k">class</span> <span class="nc">Npc</span><span class="p">(</span><span class="n">Character</span><span class="p">):</span>

    <span class="c1"># [at_heard_say() goes here]</span>

    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;Custom msg() method reacting to say.&quot;</span>

        <span class="k">if</span> <span class="n">from_obj</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># make sure to not repeat what we ourselves said or we&#39;ll create a loop</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if text comes from a say, `text` is `(&#39;say_text&#39;, {&#39;type&#39;: &#39;say&#39;})`</span>
                <span class="n">say_text</span><span class="p">,</span> <span class="n">is_say</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;say&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_say</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">is_say</span><span class="p">:</span>
                <span class="c1"># First get the response (if any)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_heard_say</span><span class="p">(</span><span class="n">say_text</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">)</span>
                <span class="c1"># If there is a response</span>
                <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># speak ourselves, using the return</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">(</span><span class="s2">&quot;say </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>   
    
        <span class="c1"># this is needed if anyone ever puppets this NPC - without it you would never</span>
        <span class="c1"># get any feedback from the server (not even the results of look)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="n">from_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
</pre></div>
</td></tr></table></div>
<p>So if the NPC gets a say and that say is not coming from the NPC itself, it will echo it using the <code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> hook. Some things of note in the above example:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">text</span></code> input can be on many different forms depending on where this <code class="docutils literal notranslate"><span class="pre">msg</span></code> is called from. Instead of trying to analyze <code class="docutils literal notranslate"><span class="pre">text</span></code> in detail with a range of <code class="docutils literal notranslate"><span class="pre">if</span></code> statements we just assume the form we want and catch the error if it does not match. This simplifies the code considerably. It’s called ‘leap before you look’ and is a Python paradigm that may feel unfamiliar if you are used to other languages. Here we ‘swallow’ the error silently, which is fine when the code checked is simple. If not we may want to import <code class="docutils literal notranslate"><span class="pre">evennia.logger.log_trace</span></code> and add <code class="docutils literal notranslate"><span class="pre">log_trace()</span></code> in the <code class="docutils literal notranslate"><span class="pre">except</span></code> clause.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">execute_cmd</span></code> to fire the <code class="docutils literal notranslate"><span class="pre">say</span></code> command back. We could also have called <code class="docutils literal notranslate"><span class="pre">self.location.msg_contents</span></code>  directly but using the Command makes sure all hooks are called (so those seeing the NPC’s <code class="docutils literal notranslate"><span class="pre">say</span></code> can in turn react if they want).</p></li>
<li><p>Note the comments about <code class="docutils literal notranslate"><span class="pre">super</span></code> at the end. This will trigger the ‘default’ <code class="docutils literal notranslate"><span class="pre">msg</span></code> (in the parent class) as well. It’s not really necessary as long as no one puppets the NPC (by <code class="docutils literal notranslate"><span class="pre">&#64;ic</span> <span class="pre">&lt;npcname&gt;</span></code>) but it’s wise to keep in there since the puppeting player will be totally blind if <code class="docutils literal notranslate"><span class="pre">msg()</span></code> is never returning anything to them!</p></li>
</ul>
<p>Now that’s done, let’s create an NPC and see what it has to say for itself.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@reload</span>
<span class="nd">@create</span><span class="o">/</span><span class="n">drop</span> <span class="n">Guild</span> <span class="n">Master</span><span class="p">:</span><span class="n">npc</span><span class="o">.</span><span class="n">Npc</span>
</pre></div>
</div>
<p>(you could also give the path as <code class="docutils literal notranslate"><span class="pre">typeclasses.npc.Npc</span></code>, but Evennia will look into the <code class="docutils literal notranslate"><span class="pre">typeclasses</span></code> folder automatically so this is a little shorter).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">say</span> <span class="n">hi</span>
<span class="n">You</span> <span class="n">say</span><span class="p">,</span> <span class="s2">&quot;hi&quot;</span>
<span class="n">Guild</span> <span class="n">Master</span> <span class="n">says</span><span class="p">,</span> <span class="s2">&quot;Anna said: &#39;hi&#39;&quot;</span>
</pre></div>
</div>
<div class="section" id="assorted-notes">
<h2>Assorted notes<a class="headerlink" href="#assorted-notes" title="Permalink to this headline">¶</a></h2>
<p>There are many ways to implement this kind of functionality. An alternative example to overriding <code class="docutils literal notranslate"><span class="pre">msg</span></code> would be to modify the <code class="docutils literal notranslate"><span class="pre">at_say</span></code> hook on the <em>Character</em> instead. It could detect that it’s sending to an NPC and call the <code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> hook directly.</p>
<p>While the tutorial solution has the advantage of being contained only within the NPC class, combining this with using the Character class gives more direct control over how the NPC will react. Which way to go depends on the design requirements of your particular game.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<p><h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial NPCs listening</a><ul>
<li><a class="reference internal" href="#assorted-notes">Assorted notes</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <!--h3>This Page</h3-->
    <ul class="this-page-menu">
      <li><a href="_sources/Tutorial-NPCs-listening.md.txt"
            rel="nofollow">Show Page Source</a></li>
    </ul>
   </div>
<h3>Versions</h3>
<ul>
  <li><a href="../1.0-dev/Tutorial-NPCs-listening.html">1.0-dev (develop branch)</a></li>
  <li><a href="Tutorial-NPCs-listening.html">0.9.1 (master branch)</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Evennia 0.9.1 documentation</a> &#187;</li>
<li class="nav-item nav-item-last"><a href="#">Tutorial NPCs listening</a></li>


      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, The Evennia developer community.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>