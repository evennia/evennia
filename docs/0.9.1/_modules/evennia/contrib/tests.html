
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>evennia.contrib.tests &#8212; Evennia 0.9.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for evennia.contrib.tests</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Testing suite for contrib folder</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">override_settings</span>
<span class="kn">from</span> <span class="nn">evennia.commands.default.tests</span> <span class="k">import</span> <span class="n">CommandTest</span>
<span class="kn">from</span> <span class="nn">evennia.utils.test_resources</span> <span class="k">import</span> <span class="n">EvenniaTest</span><span class="p">,</span> <span class="n">mockdelay</span><span class="p">,</span> <span class="n">mockdeferLater</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="k">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="c1"># Testing of rplanguage module</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">rplanguage</span>

<span class="n">mtrans</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;testing&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">}</span>
<span class="n">atrans</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;An&quot;</span><span class="p">,</span> <span class="s2">&quot;automated&quot;</span><span class="p">,</span> <span class="s2">&quot;advantageous&quot;</span><span class="p">,</span> <span class="s2">&quot;repeatable&quot;</span><span class="p">,</span> <span class="s2">&quot;faster&quot;</span><span class="p">]</span>

<span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Automated testing is advantageous for a number of reasons: &quot;</span>
    <span class="s2">&quot;tests may be executed Continuously without the need for human &quot;</span>
    <span class="s2">&quot;intervention, They are easily repeatable, and often faster.&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="TestLanguage"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage">[docs]</a><span class="k">class</span> <span class="nc">TestLanguage</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestLanguage.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">rplanguage</span><span class="o">.</span><span class="n">add_language</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testlang&quot;</span><span class="p">,</span>
            <span class="n">word_length_variance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">noun_prefix</span><span class="o">=</span><span class="s2">&quot;bara&quot;</span><span class="p">,</span>
            <span class="n">noun_postfix</span><span class="o">=</span><span class="s2">&quot;&#39;y&quot;</span><span class="p">,</span>
            <span class="n">manual_translations</span><span class="o">=</span><span class="n">mtrans</span><span class="p">,</span>
            <span class="n">auto_translations</span><span class="o">=</span><span class="n">atrans</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rplanguage</span><span class="o">.</span><span class="n">add_language</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span>
            <span class="n">phonemes</span><span class="o">=</span><span class="s2">&quot;oo ii a ck w b d t&quot;</span><span class="p">,</span>
            <span class="n">grammar</span><span class="o">=</span><span class="s2">&quot;cvvv cvv cvvcv cvvcvv cvvvc cvvvcvv cvvc&quot;</span><span class="p">,</span>
            <span class="n">noun_prefix</span><span class="o">=</span><span class="s2">&quot;beep-&quot;</span><span class="p">,</span>
            <span class="n">word_length_variance</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestLanguage.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="n">rplanguage</span><span class="o">.</span><span class="n">_LANGUAGE_HANDLER</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">rplanguage</span><span class="o">.</span><span class="n">_LANGUAGE_HANDLER</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestLanguage.test_obfuscate_language"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.test_obfuscate_language">[docs]</a>    <span class="k">def</span> <span class="nf">test_obfuscate_language</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result0</span> <span class="o">=</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_language</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;testlang&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result0</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_language</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;testlang&quot;</span><span class="p">)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_language</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;testlang&quot;</span><span class="p">)</span>
        <span class="n">result3</span> <span class="o">=</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_language</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">result3</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">result1</span><span class="p">,</span> <span class="n">result2</span> <span class="o">=</span> <span class="n">result1</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">result2</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result1</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">result2</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">result2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestLanguage.test_faulty_language"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.test_faulty_language">[docs]</a>    <span class="k">def</span> <span class="nf">test_faulty_language</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">rplanguage</span><span class="o">.</span><span class="n">LanguageError</span><span class="p">,</span>
            <span class="n">rplanguage</span><span class="o">.</span><span class="n">add_language</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;binary2&quot;</span><span class="p">,</span>
            <span class="n">phonemes</span><span class="o">=</span><span class="s2">&quot;w b d t oe ee, oo e o a wh dw bw&quot;</span><span class="p">,</span>  <span class="c1"># erroneous comma</span>
            <span class="n">grammar</span><span class="o">=</span><span class="s2">&quot;cvvv cvv cvvcv cvvcvvo cvvvc cvvvcvv cvvc c v cc vv ccvvc ccvvccvv &quot;</span><span class="p">,</span>
            <span class="n">vowels</span><span class="o">=</span><span class="s2">&quot;oea&quot;</span><span class="p">,</span>
            <span class="n">word_length_variance</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestLanguage.test_available_languages"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.test_available_languages">[docs]</a>    <span class="k">def</span> <span class="nf">test_available_languages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rplanguage</span><span class="o">.</span><span class="n">available_languages</span><span class="p">())),</span> <span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;testlang&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestLanguage.test_obfuscate_whisper"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestLanguage.test_obfuscate_whisper">[docs]</a>    <span class="k">def</span> <span class="nf">test_obfuscate_whisper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_whisper</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_whisper</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;-utom-t-d t-sting is -dv-nt-g-ous for - numb-r of r--sons: t-sts m-y b- -x-cut-d Continuously&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_whisper</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;--------- --s---- -s -----------s f-- - ------ -f ---s--s: --s-s &quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rplanguage</span><span class="o">.</span><span class="n">obfuscate_whisper</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span></div></div>


<span class="c1"># Testing of emoting / sdesc / recog system</span>


<span class="kn">from</span> <span class="nn">evennia</span> <span class="k">import</span> <span class="n">create_object</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">rpsystem</span>

<span class="n">sdesc0</span> <span class="o">=</span> <span class="s2">&quot;A nice sender of emotes&quot;</span>
<span class="n">sdesc1</span> <span class="o">=</span> <span class="s2">&quot;The first receiver of emotes.&quot;</span>
<span class="n">sdesc2</span> <span class="o">=</span> <span class="s2">&quot;Another nice colliding sdesc-guy for tests&quot;</span>
<span class="n">recog01</span> <span class="o">=</span> <span class="s2">&quot;Mr Receiver&quot;</span>
<span class="n">recog02</span> <span class="o">=</span> <span class="s2">&quot;Mr Receiver2&quot;</span>
<span class="n">recog10</span> <span class="o">=</span> <span class="s2">&quot;Mr Sender&quot;</span>
<span class="n">emote</span> <span class="o">=</span> <span class="s1">&#39;With a flair, /me looks at /first and /colliding sdesc-guy. She says &quot;This is a test.&quot;&#39;</span>


<div class="viewcode-block" id="TestRPSystem"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem">[docs]</a><span class="k">class</span> <span class="nc">TestRPSystem</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
    <span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestRPSystem.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Sender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Receiver1&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Receiver2&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.test_ordered_permutation_regex"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_ordered_permutation_regex">[docs]</a>    <span class="k">def</span> <span class="nf">test_ordered_permutation_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">ordered_permutation_regex</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">),</span>
            <span class="s2">&quot;/[0-9]*-*A</span><span class="se">\\</span><span class="s2"> nice</span><span class="se">\\</span><span class="s2"> sender</span><span class="se">\\</span><span class="s2"> of</span><span class="se">\\</span><span class="s2"> emotes(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*nice</span><span class="se">\\</span><span class="s2"> sender</span><span class="se">\\</span><span class="s2"> of</span><span class="se">\\</span><span class="s2"> emotes(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*A</span><span class="se">\\</span><span class="s2"> nice</span><span class="se">\\</span><span class="s2"> sender</span><span class="se">\\</span><span class="s2"> of(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*sender</span><span class="se">\\</span><span class="s2"> of</span><span class="se">\\</span><span class="s2"> emotes(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*nice</span><span class="se">\\</span><span class="s2"> sender</span><span class="se">\\</span><span class="s2"> of(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*A</span><span class="se">\\</span><span class="s2"> nice</span><span class="se">\\</span><span class="s2"> sender(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*nice</span><span class="se">\\</span><span class="s2"> sender(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*of</span><span class="se">\\</span><span class="s2"> emotes(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*sender</span><span class="se">\\</span><span class="s2"> of(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*A</span><span class="se">\\</span><span class="s2"> nice(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*emotes(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*sender(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*nice(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*of(?=</span><span class="se">\\</span><span class="s2">W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*A(?=</span><span class="se">\\</span><span class="s2">W|$)+&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.test_sdesc_handler"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_sdesc_handler">[docs]</a>    <span class="k">def</span> <span class="nf">test_sdesc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">sdesc0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;This is {#324} ignored&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="s2">&quot;This is 324 ignored&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Testing three words&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">get_regex_tuple</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
            <span class="s2">&quot;/[0-9]*-*Testing\ three\ words(?=\W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*Testing\ three(?=\W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*three\ words(?=\W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*Testing(?=\W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*three(?=\W|$)+|&quot;</span>
            <span class="s2">&quot;/[0-9]*-*words(?=\W|$)+&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.test_recog_handler"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_recog_handler">[docs]</a>    <span class="k">def</span> <span class="nf">test_recog_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">,</span> <span class="n">recog01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="p">,</span> <span class="n">recog02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">),</span> <span class="n">recog01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="p">),</span> <span class="n">recog02</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">get_regex_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
            <span class="s2">&quot;/[0-9]*-*Mr</span><span class="se">\\</span><span class="s2"> Receiver(?=</span><span class="se">\\</span><span class="s2">W|$)+|/[0-9]*-*Receiver(?=</span><span class="se">\\</span><span class="s2">W|$)+|/[0-9]*-*Mr(?=</span><span class="se">\\</span><span class="s2">W|$)+&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">),</span> <span class="n">sdesc1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;Mr Receiver2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="p">})</span></div>

<div class="viewcode-block" id="TestRPSystem.test_parse_language"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_parse_language">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_language</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">parse_language</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="p">,</span> <span class="n">emote</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="s2">&quot;With a flair, /me looks at /first and /colliding sdesc-guy. She says {##0}&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;##0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&quot;This is a test.&quot;&#39;</span><span class="p">)},</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.parse_sdescs_and_recogs"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.parse_sdescs_and_recogs">[docs]</a>    <span class="k">def</span> <span class="nf">parse_sdescs_and_recogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">speaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span>
        <span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc2</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;With a flair, {#9} looks at {#10} and {#11}. She says &quot;This is a test.&quot;&#39;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;#11&quot;</span><span class="p">:</span> <span class="s2">&quot;Another nice colliding sdesc-guy for tests&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#10&quot;</span><span class="p">:</span> <span class="s2">&quot;The first receiver of emotes.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#9&quot;</span><span class="p">:</span> <span class="s2">&quot;A nice sender of emotes&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">parse_sdescs_and_recogs</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">emote</span><span class="p">),</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">recog</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">,</span> <span class="n">recog01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">parse_sdescs_and_recogs</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">emote</span><span class="p">),</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.test_send_emote"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_send_emote">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_emote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">speaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span>
        <span class="n">receiver1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span>
        <span class="n">receiver2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span>
        <span class="n">receivers</span> <span class="o">=</span> <span class="p">[</span><span class="n">speaker</span><span class="p">,</span> <span class="n">receiver1</span><span class="p">,</span> <span class="n">receiver2</span><span class="p">]</span>
        <span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">)</span>
        <span class="n">receiver1</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc1</span><span class="p">)</span>
        <span class="n">receiver2</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc2</span><span class="p">)</span>
        <span class="n">speaker</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;out0&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">receiver1</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;out1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">receiver2</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;out2&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">rpsystem</span><span class="o">.</span><span class="n">send_emote</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">receivers</span><span class="p">,</span> <span class="n">emote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out0</span><span class="p">,</span>
            <span class="s2">&quot;With a flair, |bSender|n looks at |bThe first receiver of emotes.|n &quot;</span>
            <span class="s1">&#39;and |bAnother nice colliding sdesc-guy for tests|n. She says |w&quot;This is a test.&quot;|n&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out1</span><span class="p">,</span>
            <span class="s2">&quot;With a flair, |bA nice sender of emotes|n looks at |bReceiver1|n and &quot;</span>
            <span class="s1">&#39;|bAnother nice colliding sdesc-guy for tests|n. She says |w&quot;This is a test.&quot;|n&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out2</span><span class="p">,</span>
            <span class="s2">&quot;With a flair, |bA nice sender of emotes|n looks at |bThe first &quot;</span>
            <span class="s1">&#39;receiver of emotes.|n and |bReceiver2|n. She says |w&quot;This is a test.&quot;|n&#39;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystem.test_rpsearch"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystem.test_rpsearch">[docs]</a>    <span class="k">def</span> <span class="nf">test_rpsearch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="o">.</span><span class="n">sdesc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sdesc2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;out0&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;receiver of emotes&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;colliding&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestRPSystemCommands"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystemCommands">[docs]</a><span class="k">class</span> <span class="nc">TestRPSystemCommands</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestRPSystemCommands.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystemCommands.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">swap_typeclass</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPCharacter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">swap_typeclass</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">ContribRPCharacter</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestRPSystemCommands.test_commands"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRPSystemCommands.test_commands">[docs]</a>    <span class="k">def</span> <span class="nf">test_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdSdesc</span><span class="p">(),</span> <span class="s2">&quot;Foobar Character&quot;</span><span class="p">,</span> <span class="s2">&quot;Char&#39;s sdesc was set to &#39;Foobar Character&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdSdesc</span><span class="p">(),</span>
            <span class="s2">&quot;BarFoo Character&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Char2&#39;s sdesc was set to &#39;BarFoo Character&#39;.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdSay</span><span class="p">(),</span> <span class="s2">&quot;Hello!&quot;</span><span class="p">,</span> <span class="s1">&#39;Char says, &quot;Hello!&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdEmote</span><span class="p">(),</span> <span class="s2">&quot;/me smiles to /barfoo.&quot;</span><span class="p">,</span> <span class="s2">&quot;Char smiles to BarFoo Character&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdPose</span><span class="p">(),</span>
            <span class="s2">&quot;stands by the bar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Pose will read &#39;Foobar Character stands by the bar.&#39;.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdRecog</span><span class="p">(),</span>
            <span class="s2">&quot;barfoo as friend&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Char will now remember BarFoo Character as friend.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdRecog</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Currently recognized (use &#39;recog &lt;sdesc&gt; as &lt;alias&gt;&#39; to add new &quot;</span>
            <span class="s2">&quot;and &#39;forget &lt;alias&gt;&#39; to remove):</span><span class="se">\n</span><span class="s2"> friend  (BarFoo Character)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">rpsystem</span><span class="o">.</span><span class="n">CmdRecog</span><span class="p">(),</span>
            <span class="s2">&quot;friend&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Char will now know them only as &#39;BarFoo Character&#39;&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;forget&quot;</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="c1"># Testing of ExtendedRoom contrib</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">extended_room</span>
<span class="kn">from</span> <span class="nn">evennia.objects.objects</span> <span class="k">import</span> <span class="n">DefaultRoom</span>


<div class="viewcode-block" id="ForceUTCDatetime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.ForceUTCDatetime">[docs]</a><span class="k">class</span> <span class="nc">ForceUTCDatetime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Force UTC datetime.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ForceUTCDatetime.fromtimestamp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.ForceUTCDatetime.fromtimestamp">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromtimestamp</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Force fromtimestamp to run with naive datetimes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestExtendedRoom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom">[docs]</a><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.extended_room.datetime.datetime&quot;</span><span class="p">,</span> <span class="n">ForceUTCDatetime</span><span class="p">)</span>
<span class="c1"># mock gametime to return April 9, 2064, at 21:06 (spring evening)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.utils.gametime.gametime&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">2975000766</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">TestExtendedRoom</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
    <span class="n">room_typeclass</span> <span class="o">=</span> <span class="n">extended_room</span><span class="o">.</span><span class="n">ExtendedRoom</span>
    <span class="n">DETAIL_DESC</span> <span class="o">=</span> <span class="s2">&quot;A test detail.&quot;</span>
    <span class="n">SPRING_DESC</span> <span class="o">=</span> <span class="s2">&quot;A spring description.&quot;</span>
    <span class="n">OLD_DESC</span> <span class="o">=</span> <span class="s2">&quot;Old description.&quot;</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>

<div class="viewcode-block" id="TestExtendedRoom.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">last_timeslot</span> <span class="o">=</span> <span class="s2">&quot;afternoon&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">last_season</span> <span class="o">=</span> <span class="s2">&quot;winter&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;testdetail&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">DETAIL_DESC</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">spring_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPRING_DESC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OLD_DESC</span></div>

<div class="viewcode-block" id="TestExtendedRoom.test_return_appearance"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.test_return_appearance">[docs]</a>    <span class="k">def</span> <span class="nf">test_return_appearance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the appearance of a non-extended room for contrast purposes</span>
        <span class="n">old_desc</span> <span class="o">=</span> <span class="n">DefaultRoom</span><span class="o">.</span><span class="n">return_appearance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="c1"># the new appearance should be the old one, but with the desc switched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">old_desc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OLD_DESC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPRING_DESC</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">return_appearance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;spring&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">last_season</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;evening&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">last_timeslot</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtendedRoom.test_return_detail"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.test_return_detail">[docs]</a>    <span class="k">def</span> <span class="nf">test_return_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DETAIL_DESC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">return_detail</span><span class="p">(</span><span class="s2">&quot;testdetail&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestExtendedRoom.test_cmdextendedlook"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.test_cmdextendedlook">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdextendedlook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomLook</span><span class="p">(),</span>
            <span class="s2">&quot;here&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Room(#</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPRING_DESC</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomLook</span><span class="p">(),</span> <span class="s2">&quot;testdetail&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DETAIL_DESC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomLook</span><span class="p">(),</span> <span class="s2">&quot;nonexistent&quot;</span><span class="p">,</span> <span class="s2">&quot;Could not find &#39;nonexistent&#39;.&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestExtendedRoom.test_cmdsetdetail"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.test_cmdsetdetail">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdsetdetail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Details on Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span>
            <span class="s2">&quot;thingie = newdetail with spaces&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Detail set &#39;thingie&#39;: &#39;newdetail with spaces&#39;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;thingie&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;thingie&#39; on Room:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span>
            <span class="s2">&quot;/del thingie&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Detail thingie deleted, if it existed.&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;thingie&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;thingie&#39; not found.&quot;</span><span class="p">)</span>

        <span class="c1"># Test with aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Details on Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span>
            <span class="s2">&quot;thingie;other;stuff = newdetail with spaces&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Detail set &#39;thingie;other;stuff&#39;: &#39;newdetail with spaces&#39;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;thingie&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;thingie&#39; on Room:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;other&#39; on Room:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;stuff&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;stuff&#39; on Room:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span>
            <span class="s2">&quot;/del other;stuff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Detail other;stuff deleted, if it existed.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;other&#39; not found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomDetail</span><span class="p">(),</span> <span class="s2">&quot;stuff&quot;</span><span class="p">,</span> <span class="s2">&quot;Detail &#39;stuff&#39; not found.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtendedRoom.test_cmdgametime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestExtendedRoom.test_cmdgametime">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdgametime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">extended_room</span><span class="o">.</span><span class="n">CmdExtendedRoomGameTime</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;It&#39;s a spring day, in the evening.&quot;</span><span class="p">)</span></div></div>


<span class="c1"># Test the contrib barter system</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">barter</span>


<div class="viewcode-block" id="TestBarter"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter">[docs]</a><span class="k">class</span> <span class="nc">TestBarter</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestBarter.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;TradeItem1&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;TradeItem2&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;TradeItem3&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBarter.test_tradehandler_base"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.test_tradehandler_base">[docs]</a>    <span class="k">def</span> <span class="nf">test_tradehandler_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="c1"># test all methods of the tradehandler</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">barter</span><span class="o">.</span><span class="n">TradeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">part_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">part_b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">msg_other</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="s2">&quot;Want to trade?&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">msg_other</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="s2">&quot;Yes!&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">msg_other</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Talking to myself...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Want to trade?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Yes!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Talking to myself...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_other</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBarter.test_tradehandler_joins"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.test_tradehandler_joins">[docs]</a>    <span class="k">def</span> <span class="nf">test_tradehandler_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">barter</span><span class="o">.</span><span class="n">TradeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">unjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">unjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">))</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBarter.test_tradehandler_offers"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.test_tradehandler_offers">[docs]</a>    <span class="k">def</span> <span class="nf">test_tradehandler_offers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">barter</span><span class="o">.</span><span class="n">TradeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">offer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">part_a_offers</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">part_a_accepted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">part_b_accepted</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">offer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">list</span><span class="p">(),</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;TradeItem2&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;TradeItem3&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;nonexisting&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">())</span>  <span class="c1"># should fail since offer not yet accepted</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">decline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>  <span class="c1"># should trigger handler.finish() automatically</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBarter.test_cmdtrade"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.test_cmdtrade">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdtrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdTrade</span><span class="p">(),</span>
            <span class="s2">&quot;Char2 : Hey wanna trade?&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Hey wanna trade?&quot;&#39;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">barter</span><span class="o">.</span><span class="n">CmdTrade</span><span class="p">(),</span> <span class="s2">&quot;Char decline : Nope!&quot;</span><span class="p">,</span> <span class="s1">&#39;You say, &quot;Nope!&quot;&#39;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdTrade</span><span class="p">(),</span>
            <span class="s2">&quot;Char2 : Hey wanna trade?&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Hey wanna trade?&quot;&#39;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">barter</span><span class="o">.</span><span class="n">CmdTrade</span><span class="p">(),</span> <span class="s2">&quot;Char accept : Sure!&quot;</span><span class="p">,</span> <span class="s1">&#39;You say, &quot;Sure!&quot;&#39;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdOffer</span><span class="p">(),</span>
            <span class="s2">&quot;TradeItem3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Your trade action: You offer TradeItem3&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdOffer</span><span class="p">(),</span>
            <span class="s2">&quot;TradeItem1 : Here&#39;s my offer.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Here</span><span class="se">\&#39;</span><span class="s1">s my offer.&quot;</span><span class="se">\n</span><span class="s1">  [You offer TradeItem1]&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdAccept</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Your trade action: You accept the offer. Char2 must now also accept&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdDecline</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Your trade action: You change your mind, declining the current offer.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdAccept</span><span class="p">(),</span>
            <span class="s2">&quot;: Sounds good.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Sounds good.&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="s2">&quot;  [You accept the offer. Char must now also accept.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdDecline</span><span class="p">(),</span>
            <span class="s2">&quot;:No way!&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;No way!&quot;</span><span class="se">\n</span><span class="s1">  [You change your mind, declining the current offer.]&#39;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdOffer</span><span class="p">(),</span>
            <span class="s2">&quot;TradeItem1, TradeItem2 : My final offer!&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;My final offer!&quot;</span><span class="se">\n</span><span class="s1">  [You offer TradeItem1 and TradeItem2]&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdAccept</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Your trade action: You accept the offer. Char2 must now also accept.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">barter</span><span class="o">.</span><span class="n">CmdStatus</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Offered by Char:&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;A great offer.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">barter</span><span class="o">.</span><span class="n">CmdEvaluate</span><span class="p">(),</span> <span class="s2">&quot;TradeItem1&quot;</span><span class="p">,</span> <span class="s2">&quot;A great offer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdAccept</span><span class="p">(),</span>
            <span class="s2">&quot;:Ok then.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Ok then.&quot;</span><span class="se">\n</span><span class="s1">  [You accept the deal.&#39;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem2</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tradeitem3</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBarter.test_cmdtradehelp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBarter.test_cmdtradehelp">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdtradehelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdTrade</span><span class="p">(),</span>
            <span class="s2">&quot;Char2 : Hey wanna trade?&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Hey wanna trade?&quot;&#39;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">barter</span><span class="o">.</span><span class="n">CmdTradeHelp</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Trading commands</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">barter</span><span class="o">.</span><span class="n">CmdFinish</span><span class="p">(),</span>
            <span class="s2">&quot;: Ending.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;You say, &quot;Ending.&quot;</span><span class="se">\n</span><span class="s1">  [You aborted trade. No deal was made.]&#39;</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="c1"># Test wilderness</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">wilderness</span>
<span class="kn">from</span> <span class="nn">evennia</span> <span class="k">import</span> <span class="n">DefaultCharacter</span>


<div class="viewcode-block" id="TestWilderness"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness">[docs]</a><span class="k">class</span> <span class="nc">TestWilderness</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestWilderness.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;char1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char2</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;char2&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWilderness.get_wilderness_script"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.get_wilderness_script">[docs]</a>    <span class="k">def</span> <span class="nf">get_wilderness_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">wilderness</span><span class="o">.</span><span class="n">WildernessScript</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="TestWilderness.test_create_wilderness_default_name"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_create_wilderness_default_name">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_wilderness_default_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wilderness_script</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">w</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWilderness.test_create_wilderness_custom_name"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_create_wilderness_custom_name">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_wilderness_custom_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;customname&quot;</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wilderness_script</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">w</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWilderness.test_enter_wilderness"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_enter_wilderness">[docs]</a>    <span class="k">def</span> <span class="nf">test_enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">()</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">wilderness</span><span class="o">.</span><span class="n">WildernessRoom</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wilderness_script</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">itemcoordinates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWilderness.test_enter_wilderness_custom_coordinates"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_enter_wilderness_custom_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">test_enter_wilderness_custom_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">()</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">wilderness</span><span class="o">.</span><span class="n">WildernessRoom</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wilderness_script</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">itemcoordinates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWilderness.test_enter_wilderness_custom_name"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_enter_wilderness_custom_name">[docs]</a>    <span class="k">def</span> <span class="nf">test_enter_wilderness_custom_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;customnname&quot;</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">wilderness</span><span class="o">.</span><span class="n">WildernessRoom</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWilderness.test_wilderness_correct_exits"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_wilderness_correct_exits">[docs]</a>    <span class="k">def</span> <span class="nf">test_wilderness_correct_exits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">()</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>

        <span class="c1"># By default we enter at a corner (0, 0), so only a few exits should</span>
        <span class="c1"># be visible / traversable</span>
        <span class="n">exits</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">contents</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">destination</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="s2">&quot;view&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="s2">&quot;traverse&quot;</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exits</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">exitsok</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;north&quot;</span><span class="p">,</span> <span class="s2">&quot;northeast&quot;</span><span class="p">,</span> <span class="s2">&quot;east&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">each_exit</span> <span class="ow">in</span> <span class="n">exitsok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exits</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">each_exit</span><span class="p">]))</span>

        <span class="c1"># If we move to another location not on an edge, then all directions</span>
        <span class="c1"># should be visible / traversable</span>
        <span class="n">wilderness</span><span class="o">.</span><span class="n">enter_wilderness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">exits</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">contents</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">destination</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="s2">&quot;view&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="s2">&quot;traverse&quot;</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exits</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">exitsok</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;north&quot;</span><span class="p">,</span>
            <span class="s2">&quot;northeast&quot;</span><span class="p">,</span>
            <span class="s2">&quot;east&quot;</span><span class="p">,</span>
            <span class="s2">&quot;southeast&quot;</span><span class="p">,</span>
            <span class="s2">&quot;south&quot;</span><span class="p">,</span>
            <span class="s2">&quot;southwest&quot;</span><span class="p">,</span>
            <span class="s2">&quot;west&quot;</span><span class="p">,</span>
            <span class="s2">&quot;northwest&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">each_exit</span> <span class="ow">in</span> <span class="n">exitsok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exits</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">each_exit</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TestWilderness.test_room_creation"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_room_creation">[docs]</a>    <span class="k">def</span> <span class="nf">test_room_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Pretend that both char1 and char2 are connected...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">has_account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">has_account</span><span class="p">)</span>

        <span class="n">wilderness</span><span class="o">.</span><span class="n">create_wilderness</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wilderness_script</span><span class="p">()</span>

        <span class="c1"># We should have no unused room after moving the first account in.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unused_rooms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">move_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unused_rooms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># And also no unused room after moving the second one in.</span>
        <span class="n">w</span><span class="o">.</span><span class="n">move_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unused_rooms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># But if char2 moves into char1&#39;s room, we should have one unused room</span>
        <span class="c1"># Which should be char2&#39;s old room that got created.</span>
        <span class="n">w</span><span class="o">.</span><span class="n">move_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unused_rooms</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="c1"># And if char2 moves back out, that unused room should be put back to</span>
        <span class="c1"># use again.</span>
        <span class="n">w</span><span class="o">.</span><span class="n">move_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unused_rooms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWilderness.test_get_new_coordinates"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestWilderness.test_get_new_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_new_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;northeast&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;southeast&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;southwest&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;northwest&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">correct_loc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">directions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># Not compatible with Python 3</span>
            <span class="n">new_loc</span> <span class="o">=</span> <span class="n">wilderness</span><span class="o">.</span><span class="n">get_new_coordinates</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_loc</span><span class="p">,</span> <span class="n">correct_loc</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span></div></div>


<span class="c1"># Testing chargen contrib</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">chargen</span>


<div class="viewcode-block" id="TestChargen"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestChargen">[docs]</a><span class="k">class</span> <span class="nc">TestChargen</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestChargen.test_ooclook"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestChargen.test_ooclook">[docs]</a>    <span class="k">def</span> <span class="nf">test_ooclook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCLook</span><span class="p">(),</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;You have no characters to look at&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCLook</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You, TestAccount, are an OOC ghost without form.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestChargen.test_charcreate"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestChargen.test_charcreate">[docs]</a>    <span class="k">def</span> <span class="nf">test_charcreate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCCharacterCreate</span><span class="p">(),</span>
            <span class="s2">&quot;testchar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;The character testchar was successfully created!&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCCharacterCreate</span><span class="p">(),</span>
            <span class="s2">&quot;testchar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Character testchar already exists.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_character_dbrefs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCLook</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You, TestAccount, are an OOC ghost without form.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">chargen</span><span class="o">.</span><span class="n">CmdOOCLook</span><span class="p">(),</span> <span class="s2">&quot;testchar&quot;</span><span class="p">,</span> <span class="s2">&quot;testchar(&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span></div></div>


<span class="c1"># Testing clothing contrib</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">clothing</span>


<div class="viewcode-block" id="TestClothingCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestClothingCmd">[docs]</a><span class="k">class</span> <span class="nc">TestClothingCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestClothingCmd.test_clothingcommands"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestClothingCmd.test_clothingcommands">[docs]</a>    <span class="k">def</span> <span class="nf">test_clothingcommands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wearer</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">ClothedCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Wearer&quot;</span><span class="p">)</span>
        <span class="n">friend</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">ClothedCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Friend&quot;</span><span class="p">)</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;room&quot;</span><span class="p">)</span>
        <span class="n">wearer</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">room</span>
        <span class="n">friend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">room</span>
        <span class="c1"># Make a test hat</span>
        <span class="n">test_hat</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">Clothing</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test hat&quot;</span><span class="p">)</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clothing_type</span> <span class="o">=</span> <span class="s2">&quot;hat&quot;</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">wearer</span>
        <span class="c1"># Make a test scarf</span>
        <span class="n">test_scarf</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">Clothing</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test scarf&quot;</span><span class="p">)</span>
        <span class="n">test_scarf</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clothing_type</span> <span class="o">=</span> <span class="s2">&quot;accessory&quot;</span>
        <span class="n">test_scarf</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">wearer</span>
        <span class="c1"># Test wear command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdWear</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Usage: wear &lt;obj&gt; [wear style]&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdWear</span><span class="p">(),</span> <span class="s2">&quot;hat&quot;</span><span class="p">,</span> <span class="s2">&quot;Wearer puts on test hat.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdWear</span><span class="p">(),</span>
            <span class="s2">&quot;scarf stylishly&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wearer wears test scarf stylishly.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Test cover command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdCover</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Usage: cover &lt;worn clothing&gt; [with] &lt;clothing object&gt;&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdCover</span><span class="p">(),</span>
            <span class="s2">&quot;hat with scarf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wearer covers test hat with test scarf.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Test remove command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdRemove</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Could not find &#39;&#39;.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdRemove</span><span class="p">(),</span> <span class="s2">&quot;hat&quot;</span><span class="p">,</span> <span class="s2">&quot;You have to take off test scarf first.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdRemove</span><span class="p">(),</span>
            <span class="s2">&quot;scarf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wearer removes test scarf, revealing test hat.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Test uncover command.</span>
        <span class="n">test_scarf</span><span class="o">.</span><span class="n">wear</span><span class="p">(</span><span class="n">wearer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">covered_by</span> <span class="o">=</span> <span class="n">test_scarf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdUncover</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Usage: uncover &lt;worn clothing object&gt;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdUncover</span><span class="p">(),</span> <span class="s2">&quot;hat&quot;</span><span class="p">,</span> <span class="s2">&quot;Wearer uncovers test hat.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="c1"># Test drop command.</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">covered_by</span> <span class="o">=</span> <span class="n">test_scarf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdDrop</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Drop what?&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdDrop</span><span class="p">(),</span>
            <span class="s2">&quot;hat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You can&#39;t drop that because it&#39;s covered by test scarf.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">CmdDrop</span><span class="p">(),</span> <span class="s2">&quot;scarf&quot;</span><span class="p">,</span> <span class="s2">&quot;You drop test scarf.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">)</span>
        <span class="c1"># Test give command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdGive</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Usage: give &lt;inventory object&gt; = &lt;target&gt;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdGive</span><span class="p">(),</span>
            <span class="s2">&quot;hat = Friend&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wearer removes test hat.|You give test hat to Friend.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Test inventory command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">CmdInventory</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You are not carrying or wearing anything.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">wearer</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="TestClothingFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestClothingFunc">[docs]</a><span class="k">class</span> <span class="nc">TestClothingFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestClothingFunc.test_clothingfunctions"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestClothingFunc.test_clothingfunctions">[docs]</a>    <span class="k">def</span> <span class="nf">test_clothingfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wearer</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">ClothedCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Wearer&quot;</span><span class="p">)</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;room&quot;</span><span class="p">)</span>
        <span class="n">wearer</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">room</span>
        <span class="c1"># Make a test hat</span>
        <span class="n">test_hat</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">Clothing</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test hat&quot;</span><span class="p">)</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clothing_type</span> <span class="o">=</span> <span class="s2">&quot;hat&quot;</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">wearer</span>
        <span class="c1"># Make a test shirt</span>
        <span class="n">test_shirt</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">Clothing</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test shirt&quot;</span><span class="p">)</span>
        <span class="n">test_shirt</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clothing_type</span> <span class="o">=</span> <span class="s2">&quot;top&quot;</span>
        <span class="n">test_shirt</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">wearer</span>
        <span class="c1"># Make a test pants</span>
        <span class="n">test_pants</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">Clothing</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test pants&quot;</span><span class="p">)</span>
        <span class="n">test_pants</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clothing_type</span> <span class="o">=</span> <span class="s2">&quot;bottom&quot;</span>
        <span class="n">test_pants</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">wearer</span>

        <span class="n">test_hat</span><span class="o">.</span><span class="n">wear</span><span class="p">(</span><span class="n">wearer</span><span class="p">,</span> <span class="s2">&quot;on the head&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">worn</span><span class="p">,</span> <span class="s2">&quot;on the head&quot;</span><span class="p">)</span>

        <span class="n">test_hat</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">worn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">test_hat</span><span class="o">.</span><span class="n">worn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">test_hat</span><span class="o">.</span><span class="n">at_get</span><span class="p">(</span><span class="n">wearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">test_hat</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">worn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">clothes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_shirt</span><span class="p">,</span> <span class="n">test_hat</span><span class="p">,</span> <span class="n">test_pants</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">order_clothes_list</span><span class="p">(</span><span class="n">clothes_list</span><span class="p">),</span> <span class="p">[</span><span class="n">test_hat</span><span class="p">,</span> <span class="n">test_shirt</span><span class="p">,</span> <span class="n">test_pants</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">test_hat</span><span class="o">.</span><span class="n">wear</span><span class="p">(</span><span class="n">wearer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">test_pants</span><span class="o">.</span><span class="n">wear</span><span class="p">(</span><span class="n">wearer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">get_worn_clothes</span><span class="p">(</span><span class="n">wearer</span><span class="p">),</span> <span class="p">[</span><span class="n">test_hat</span><span class="p">,</span> <span class="n">test_pants</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">clothing</span><span class="o">.</span><span class="n">clothing_type_count</span><span class="p">(</span><span class="n">clothes_list</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;hat&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">clothing</span><span class="o">.</span><span class="n">single_type_count</span><span class="p">(</span><span class="n">clothes_list</span><span class="p">,</span> <span class="s2">&quot;hat&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div></div>


<span class="c1"># Testing custom_gametime</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">custom_gametime</span>


<div class="viewcode-block" id="_testcallback"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests._testcallback">[docs]</a><span class="k">def</span> <span class="nf">_testcallback</span><span class="p">():</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="TestCustomGameTime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime">[docs]</a><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.utils.gametime.gametime&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mf">2975000898.46</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">TestCustomGameTime</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestCustomGameTime.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;timescript&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timescript</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_time_to_tuple"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_time_to_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">test_time_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">time_to_tuple</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">294</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">time_to_tuple</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">3333</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">time_to_tuple</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">418</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_gametime_to_realtime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_gametime_to_realtime">[docs]</a>    <span class="k">def</span> <span class="nf">test_gametime_to_realtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">gametime_to_realtime</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mins</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="mf">86520.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">custom_gametime</span><span class="o">.</span><span class="n">gametime_to_realtime</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_realtime_to_gametime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_realtime_to_gametime">[docs]</a>    <span class="k">def</span> <span class="nf">test_realtime_to_gametime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">realtime_to_gametime</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mins</span><span class="o">=</span><span class="mi">34</span><span class="p">),</span> <span class="mf">349680.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">custom_gametime</span><span class="o">.</span><span class="n">realtime_to_gametime</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mins</span><span class="o">=</span><span class="mi">34</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">custom_gametime</span><span class="o">.</span><span class="n">realtime_to_gametime</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mins</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_custom_gametime"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_custom_gametime">[docs]</a>    <span class="k">def</span> <span class="nf">test_custom_gametime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">custom_gametime</span><span class="p">(),</span> <span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">custom_gametime</span><span class="o">.</span><span class="n">custom_gametime</span><span class="p">(</span><span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_real_seconds_until"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_real_seconds_until">[docs]</a>    <span class="k">def</span> <span class="nf">test_real_seconds_until</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">custom_gametime</span><span class="o">.</span><span class="n">real_seconds_until</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2300</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="mf">31911667199.77</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestCustomGameTime.test_schedule"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestCustomGameTime.test_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">test_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timescript</span> <span class="o">=</span> <span class="n">custom_gametime</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">_testcallback</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timescript</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="mf">1700.7699999809265</span><span class="p">)</span></div></div>


<span class="c1"># Test dice module</span>


<div class="viewcode-block" id="TestDice"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestDice">[docs]</a><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;random.randint&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestDice</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestDice.test_roll_dice"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestDice.test_roll_dice">[docs]</a>    <span class="k">def</span> <span class="nf">test_roll_dice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mocked_randint</span><span class="p">):</span>
        <span class="c1"># we must import dice here for the mocked randint to apply correctly.</span>
        <span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">dice</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dice</span><span class="o">.</span><span class="n">roll_dice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">modifier</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">mocked_randint</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dice</span><span class="o">.</span><span class="n">roll_dice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">conditional</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="p">)),</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dice</span><span class="o">.</span><span class="n">roll_dice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">conditional</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="p">)),</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDice.test_cmddice"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestDice.test_cmddice">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmddice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mocked_randint</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">dice</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">dice</span><span class="o">.</span><span class="n">CmdDice</span><span class="p">(),</span> <span class="s2">&quot;3d6 + 4&quot;</span><span class="p">,</span> <span class="s2">&quot;You roll 3d6 + 4.| Roll(s): 5, 5 and 5. Total result is 19.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dice</span><span class="o">.</span><span class="n">CmdDice</span><span class="p">(),</span> <span class="s2">&quot;100000d1000&quot;</span><span class="p">,</span> <span class="s2">&quot;The maximum roll allowed is 10000d10000.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dice</span><span class="o">.</span><span class="n">CmdDice</span><span class="p">(),</span> <span class="s2">&quot;/secret 3d6 + 4&quot;</span><span class="p">,</span> <span class="s2">&quot;You roll 3d6 + 4 (secret, not echoed).&quot;</span><span class="p">)</span></div></div>


<span class="c1"># Test email-login</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">email_login</span>


<div class="viewcode-block" id="TestEmailLogin"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestEmailLogin">[docs]</a><span class="k">class</span> <span class="nc">TestEmailLogin</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestEmailLogin.test_connect"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestEmailLogin.test_connect">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedConnect</span><span class="p">(),</span>
            <span class="s2">&quot;mytest@test.com test&quot;</span><span class="p">,</span>
            <span class="s2">&quot;The email &#39;mytest@test.com&#39; does not match any accounts.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedCreate</span><span class="p">(),</span>
            <span class="s1">&#39;&quot;mytest&quot; mytest@test.com test11111&#39;</span><span class="p">,</span>
            <span class="s2">&quot;A new account &#39;mytest&#39; was created. Welcome!&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedConnect</span><span class="p">(),</span>
            <span class="s2">&quot;mytest@test.com test11111&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestEmailLogin.test_quit"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestEmailLogin.test_quit">[docs]</a>    <span class="k">def</span> <span class="nf">test_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedQuit</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestEmailLogin.test_unconnectedlook"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestEmailLogin.test_unconnectedlook">[docs]</a>    <span class="k">def</span> <span class="nf">test_unconnectedlook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedLook</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;==========&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestEmailLogin.test_unconnectedhelp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestEmailLogin.test_unconnectedhelp">[docs]</a>    <span class="k">def</span> <span class="nf">test_unconnectedhelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">email_login</span><span class="o">.</span><span class="n">CmdUnconnectedHelp</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You are not yet logged into the game.&quot;</span><span class="p">)</span></div></div>


<span class="c1"># test gendersub contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">gendersub</span>


<div class="viewcode-block" id="TestGenderSub"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestGenderSub">[docs]</a><span class="k">class</span> <span class="nc">TestGenderSub</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestGenderSub.test_setgender"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestGenderSub.test_setgender">[docs]</a>    <span class="k">def</span> <span class="nf">test_setgender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gendersub</span><span class="o">.</span><span class="n">SetGender</span><span class="p">(),</span> <span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;Your gender was set to male.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gendersub</span><span class="o">.</span><span class="n">SetGender</span><span class="p">(),</span> <span class="s2">&quot;ambiguous&quot;</span><span class="p">,</span> <span class="s2">&quot;Your gender was set to ambiguous.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gendersub</span><span class="o">.</span><span class="n">SetGender</span><span class="p">(),</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;Usage: @gender&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestGenderSub.test_gendercharacter"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestGenderSub.test_gendercharacter">[docs]</a>    <span class="k">def</span> <span class="nf">test_gendercharacter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">gendersub</span><span class="o">.</span><span class="n">GenderCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Gendered&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;Test |p gender&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">gendersub</span><span class="o">.</span><span class="n">_RE_GENDER_PRONOUN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">_get_pronoun</span><span class="p">,</span> <span class="n">txt</span><span class="p">),</span> <span class="s2">&quot;Test their gender&quot;</span>
        <span class="p">)</span></div></div>


<span class="c1"># test health bar contrib</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">health_bar</span>


<div class="viewcode-block" id="TestHealthBar"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestHealthBar">[docs]</a><span class="k">class</span> <span class="nc">TestHealthBar</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestHealthBar.test_healthbar"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestHealthBar.test_healthbar">[docs]</a>    <span class="k">def</span> <span class="nf">test_healthbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected_bar_str</span> <span class="o">=</span> <span class="s2">&quot;|[R|w|n|[B|w            test0 / 200test             |n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">health_bar</span><span class="o">.</span><span class="n">display_meter</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pre_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">post_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">),</span>
            <span class="n">expected_bar_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expected_bar_str</span> <span class="o">=</span> <span class="s2">&quot;|[R|w     |n|[B|w       test24 / 200test            |n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">health_bar</span><span class="o">.</span><span class="n">display_meter</span><span class="p">(</span>
                <span class="mi">24</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pre_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">post_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">),</span>
            <span class="n">expected_bar_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expected_bar_str</span> <span class="o">=</span> <span class="s2">&quot;|[Y|w           test100 /|n|[B|w 200test            |n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">health_bar</span><span class="o">.</span><span class="n">display_meter</span><span class="p">(</span>
                <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pre_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">post_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">),</span>
            <span class="n">expected_bar_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expected_bar_str</span> <span class="o">=</span> <span class="s2">&quot;|[G|w           test180 / 200test        |n|[B|w    |n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">health_bar</span><span class="o">.</span><span class="n">display_meter</span><span class="p">(</span>
                <span class="mi">180</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pre_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">post_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">),</span>
            <span class="n">expected_bar_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expected_bar_str</span> <span class="o">=</span> <span class="s2">&quot;|[G|w           test200 / 200test            |n|[B|w|n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">health_bar</span><span class="o">.</span><span class="n">display_meter</span><span class="p">(</span>
                <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pre_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">post_text</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">),</span>
            <span class="n">expected_bar_str</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="c1"># test mail contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">mail</span>


<div class="viewcode-block" id="TestMail"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMail">[docs]</a><span class="k">class</span> <span class="nc">TestMail</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestMail.test_mail"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMail.test_mail">[docs]</a>    <span class="k">def</span> <span class="nf">test_mail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;2&#39; is not a valid mail id.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;test&#39; is not a valid mail id.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;There are no messages in your inbox.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMailCharacter</span><span class="p">(),</span>
            <span class="s2">&quot;Char=Message 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You have received a new @mail from Char|You sent your message.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMailCharacter</span><span class="p">(),</span> <span class="s2">&quot;Char=Message 2&quot;</span><span class="p">,</span> <span class="s2">&quot;You sent your message.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span>
            <span class="s2">&quot;TestAccount2=Message 2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You have received a new @mail from TestAccount2&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;TestAccount=Message 1&quot;</span><span class="p">,</span> <span class="s2">&quot;You sent your message.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;TestAccount=Message 2&quot;</span><span class="p">,</span> <span class="s2">&quot;You sent your message.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;| ID    From              Subject&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;From: TestAccount2&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span>
            <span class="s2">&quot;/forward TestAccount2 = 1/Forward message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You sent your message.|Message forwarded.&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;/reply 2=Reply Message2&quot;</span><span class="p">,</span> <span class="s2">&quot;You sent your message.&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">CmdMail</span><span class="p">(),</span> <span class="s2">&quot;/delete 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Message 2 deleted&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span></div></div>


<span class="c1"># test map builder contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">mapbuilder</span>


<div class="viewcode-block" id="TestMapBuilder"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMapBuilder">[docs]</a><span class="k">class</span> <span class="nc">TestMapBuilder</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestMapBuilder.test_cmdmapbuilder"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMapBuilder.test_cmdmapbuilder">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdmapbuilder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mapbuilder</span><span class="o">.</span><span class="n">CmdMapBuilder</span><span class="p">(),</span>
            <span class="s2">&quot;evennia.contrib.mapbuilder.EXAMPLE1_MAP evennia.contrib.mapbuilder.EXAMPLE1_LEGEND&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;Creating Map...|</span>
<span class="sd">n</span>
<span class="sd"></span>
<span class="sd">n</span>
<span class="sd"></span>
<span class="sd">|Creating Landmass...|&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">mapbuilder</span><span class="o">.</span><span class="n">CmdMapBuilder</span><span class="p">(),</span>
            <span class="s2">&quot;evennia.contrib.mapbuilder.EXAMPLE2_MAP evennia.contrib.mapbuilder.EXAMPLE2_LEGEND&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;Creating Map...|    </span>

<span class="sd"> -- </span>
<span class="sd">        </span>
<span class="sd">   -- </span>

<span class="sd">    </span>
<span class="sd">|Creating Landmass...|&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="c1"># test menu_login</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">menu_login</span>


<div class="viewcode-block" id="TestMenuLogin"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMenuLogin">[docs]</a><span class="k">class</span> <span class="nc">TestMenuLogin</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestMenuLogin.test_cmdunloggedlook"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMenuLogin.test_cmdunloggedlook">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdunloggedlook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">menu_login</span><span class="o">.</span><span class="n">CmdUnloggedinLook</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;======&quot;</span><span class="p">)</span></div></div>


<span class="c1"># test multidescer contrib</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">multidescer</span>


<div class="viewcode-block" id="TestMultidescer"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMultidescer">[docs]</a><span class="k">class</span> <span class="nc">TestMultidescer</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestMultidescer.test_cmdmultidesc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestMultidescer.test_cmdmultidesc">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdmultidesc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span> <span class="s2">&quot;/list&quot;</span><span class="p">,</span> <span class="s2">&quot;Stored descs:</span><span class="se">\n</span><span class="s2">caller:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span> <span class="s2">&quot;test = Desc 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Stored description &#39;test&#39;: </span><span class="se">\&quot;</span><span class="s2">Desc 1</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span> <span class="s2">&quot;test2 = Desc 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Stored description &#39;test2&#39;: </span><span class="se">\&quot;</span><span class="s2">Desc 2</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span> <span class="s2">&quot;/swap test-test2&quot;</span><span class="p">,</span> <span class="s2">&quot;Swapped descs &#39;test&#39; and &#39;test2&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span>
            <span class="s2">&quot;test3 = Desc 3init&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Stored description &#39;test3&#39;: </span><span class="se">\&quot;</span><span class="s2">Desc 3init</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span>
            <span class="s2">&quot;/list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Stored descs:</span><span class="se">\n</span><span class="s2">test3: Desc 3init</span><span class="se">\n</span><span class="s2">test: Desc 1</span><span class="se">\n</span><span class="s2">test2: Desc 2</span><span class="se">\n</span><span class="s2">caller:&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span> <span class="s2">&quot;test3 = Desc 3&quot;</span><span class="p">,</span> <span class="s2">&quot;Stored description &#39;test3&#39;: </span><span class="se">\&quot;</span><span class="s2">Desc 3</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">multidescer</span><span class="o">.</span><span class="n">CmdMultiDesc</span><span class="p">(),</span>
            <span class="s2">&quot;/set test1 + test2 + + test3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test1 Desc 2 Desc 3</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="s2">&quot;The above was set as the current description.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="s2">&quot;test1 Desc 2 Desc 3&quot;</span><span class="p">)</span></div></div>


<span class="c1"># test simpledoor contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">simpledoor</span>


<div class="viewcode-block" id="TestSimpleDoor"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestSimpleDoor">[docs]</a><span class="k">class</span> <span class="nc">TestSimpleDoor</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestSimpleDoor.test_cmdopen"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestSimpleDoor.test_cmdopen">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">simpledoor</span><span class="o">.</span><span class="n">CmdOpen</span><span class="p">(),</span>
            <span class="s2">&quot;newdoor;door:contrib.simpledoor.SimpleDoor,backdoor;door = Room2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Created new Exit &#39;newdoor&#39; from Room to Room2 (aliases: door).|Note: A door-type exit was &quot;</span>
            <span class="s2">&quot;created - ignored eventual custom return-exit type.|Created new Exit &#39;newdoor&#39; from Room2 to Room (aliases: door).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">simpledoor</span><span class="o">.</span><span class="n">CmdOpenCloseDoor</span><span class="p">(),</span> <span class="s2">&quot;newdoor&quot;</span><span class="p">,</span> <span class="s2">&quot;You close newdoor.&quot;</span><span class="p">,</span> <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;close&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">simpledoor</span><span class="o">.</span><span class="n">CmdOpenCloseDoor</span><span class="p">(),</span>
            <span class="s2">&quot;newdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;newdoor is already closed.&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;close&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">simpledoor</span><span class="o">.</span><span class="n">CmdOpenCloseDoor</span><span class="p">(),</span> <span class="s2">&quot;newdoor&quot;</span><span class="p">,</span> <span class="s2">&quot;You open newdoor.&quot;</span><span class="p">,</span> <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">simpledoor</span><span class="o">.</span><span class="n">CmdOpenCloseDoor</span><span class="p">(),</span> <span class="s2">&quot;newdoor&quot;</span><span class="p">,</span> <span class="s2">&quot;newdoor is already open.&quot;</span><span class="p">,</span> <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;open&quot;</span>
        <span class="p">)</span></div></div>


<span class="c1"># test slow_exit contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">slow_exit</span>

<span class="n">slow_exit</span><span class="o">.</span><span class="n">MOVE_DELAY</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stroll&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;walk&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sprint&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>


<div class="viewcode-block" id="_cancellable_mockdelay"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests._cancellable_mockdelay">[docs]</a><span class="k">def</span> <span class="nf">_cancellable_mockdelay</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mock</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestSlowExit"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestSlowExit">[docs]</a><span class="k">class</span> <span class="nc">TestSlowExit</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestSlowExit.test_exit"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestSlowExit.test_exit">[docs]</a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.utils.delay&quot;</span><span class="p">,</span> <span class="n">_cancellable_mockdelay</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exi</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">slow_exit</span><span class="o">.</span><span class="n">SlowExit</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;slowexit&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room2</span>
        <span class="p">)</span>
        <span class="n">exi</span><span class="o">.</span><span class="n">at_traverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">slow_exit</span><span class="o">.</span><span class="n">CmdSetSpeed</span><span class="p">(),</span> <span class="s2">&quot;walk&quot;</span><span class="p">,</span> <span class="s2">&quot;You are now walking.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">slow_exit</span><span class="o">.</span><span class="n">CmdStop</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You stop moving.&quot;</span><span class="p">)</span></div></div>


<span class="c1"># test talking npc contrib</span>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">talking_npc</span>


<div class="viewcode-block" id="TestTalkingNPC"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTalkingNPC">[docs]</a><span class="k">class</span> <span class="nc">TestTalkingNPC</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTalkingNPC.test_talkingnpc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTalkingNPC.test_talkingnpc">[docs]</a>    <span class="k">def</span> <span class="nf">test_talkingnpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npc</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">talking_npc</span><span class="o">.</span><span class="n">TalkingNPC</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;npctalker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">talking_npc</span><span class="o">.</span><span class="n">CmdTalk</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;(You walk up and talk to Char.)&quot;</span><span class="p">)</span>
        <span class="n">npc</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div></div>


<span class="c1"># tests for the tutorial world</span>

<span class="c1"># test tutorial_world/mob</span>

<span class="kn">from</span> <span class="nn">evennia.contrib.tutorial_world</span> <span class="k">import</span> <span class="n">mob</span>


<div class="viewcode-block" id="TestTutorialWorldMob"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldMob">[docs]</a><span class="k">class</span> <span class="nc">TestTutorialWorldMob</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTutorialWorldMob.test_mob"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldMob.test_mob">[docs]</a>    <span class="k">def</span> <span class="nf">test_mob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mobobj</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">mob</span><span class="o">.</span><span class="n">Mob</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;mob&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mobobj</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_dead</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">mobobj</span><span class="o">.</span><span class="n">set_alive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mobobj</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_dead</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">mobobj</span><span class="o">.</span><span class="n">set_dead</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mobobj</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_dead</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">mobobj</span><span class="o">.</span><span class="n">_set_ticker</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
        <span class="c1"># TODO should be expanded with further tests of the modes and damage etc.</span>


<span class="c1">#  test tutorial_world/objects</span>


<span class="kn">from</span> <span class="nn">evennia.contrib.tutorial_world</span> <span class="k">import</span> <span class="n">objects</span> <span class="k">as</span> <span class="n">tutobjects</span>
<span class="kn">from</span> <span class="nn">mock.mock</span> <span class="k">import</span> <span class="n">MagicMock</span>
<span class="kn">from</span> <span class="nn">twisted.trial.unittest</span> <span class="k">import</span> <span class="n">TestCase</span> <span class="k">as</span> <span class="n">TwistedTestCase</span>

<span class="kn">from</span> <span class="nn">twisted.internet.base</span> <span class="k">import</span> <span class="n">DelayedCall</span>

<span class="n">DelayedCall</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="TestTutorialWorldObjects"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects">[docs]</a><span class="k">class</span> <span class="nc">TestTutorialWorldObjects</span><span class="p">(</span><span class="n">TwistedTestCase</span><span class="p">,</span> <span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTutorialWorldObjects.test_tutorialobj"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_tutorialobj">[docs]</a>    <span class="k">def</span> <span class="nf">test_tutorialobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">TutorialObject</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tutobj&quot;</span><span class="p">)</span>
        <span class="n">obj1</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">obj1</span><span class="o">.</span><span class="n">home</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_readable"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_readable">[docs]</a>    <span class="k">def</span> <span class="nf">test_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">readable</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">TutorialReadable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="n">readable</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">readable_text</span> <span class="o">=</span> <span class="s2">&quot;Text to read&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdRead</span><span class="p">(),</span> <span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="s2">&quot;You read book:</span><span class="se">\n</span><span class="s2">  Text to read&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">readable</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_climbable"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_climbable">[docs]</a>    <span class="k">def</span> <span class="nf">test_climbable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">climbable</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">TutorialClimbable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdClimb</span><span class="p">(),</span>
            <span class="s2">&quot;tree&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You climb tree. Having looked around, you climb down again.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">climbable</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tutorial_climbed_tree&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;tutorial_world&quot;</span><span class="p">),</span>
            <span class="s2">&quot;tutorial_climbed_tree&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_obelisk"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_obelisk">[docs]</a>    <span class="k">def</span> <span class="nf">test_obelisk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obelisk</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">Obelisk</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;obelisk&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obelisk</span><span class="o">.</span><span class="n">return_appearance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;|cobelisk(&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_lightsource"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_lightsource">[docs]</a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorial_world.objects.delay&quot;</span><span class="p">,</span> <span class="n">mockdelay</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.scripts.taskhandler.deferLater&quot;</span><span class="p">,</span> <span class="n">mockdeferLater</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_lightsource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">light</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">LightSource</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdLight</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A torch on the floor flickers and dies.|You light torch.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">light</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_crumblingwall"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_crumblingwall">[docs]</a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorial_world.objects.delay&quot;</span><span class="p">,</span> <span class="n">mockdelay</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.scripts.taskhandler.deferLater&quot;</span><span class="p">,</span> <span class="n">mockdeferLater</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_crumblingwall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wall</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">CrumblingWall</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;wall&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room2</span><span class="o">.</span><span class="n">dbref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">button_exposed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">exit_open</span><span class="p">)</span>
        <span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">root_pos</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;yellow&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdShiftRoot</span><span class="p">(),</span>
            <span class="s2">&quot;blue root right&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You shove the root adorned with small blue flowers to the right.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdShiftRoot</span><span class="p">(),</span>
            <span class="s2">&quot;red root left&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You shift the reddish root to the left.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdShiftRoot</span><span class="p">(),</span>
            <span class="s2">&quot;yellow root down&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You shove the root adorned with small yellow flowers downwards.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdShiftRoot</span><span class="p">(),</span>
            <span class="s2">&quot;green root up&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You shift the weedy green root upwards.|Holding aside the root you think you notice something behind it ...&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdPressButton</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You move your fingers over the suspicious depression, then gives it a decisive push. First&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">wall</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># we patch out the delay, so these are closed immediately</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">button_exposed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">wall</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">exit_open</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_weapon"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_weapon">[docs]</a>    <span class="k">def</span> <span class="nf">test_weapon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">weapon</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">TutorialWeapon</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sword&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;Char&quot;</span><span class="p">,</span> <span class="s2">&quot;You stab with sword.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">weapon</span><span class="p">,</span> <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;stab&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;Char&quot;</span><span class="p">,</span> <span class="s2">&quot;You slash with sword.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">weapon</span><span class="p">,</span> <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;slash&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldObjects.test_weaponrack"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldObjects.test_weaponrack">[docs]</a>    <span class="k">def</span> <span class="nf">test_weaponrack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rack</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">TutorialWeaponRack</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;rack&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="n">rack</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">available_weapons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sword&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutobjects</span><span class="o">.</span><span class="n">CmdGetWeapon</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You find Rusty sword.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">rack</span><span class="p">)</span></div></div>


<span class="c1"># test tutorial_world/</span>
<span class="kn">from</span> <span class="nn">evennia.contrib.tutorial_world</span> <span class="k">import</span> <span class="n">rooms</span> <span class="k">as</span> <span class="n">tutrooms</span>


<div class="viewcode-block" id="TestTutorialWorldRooms"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms">[docs]</a><span class="k">class</span> <span class="nc">TestTutorialWorldRooms</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTutorialWorldRooms.test_cmdtutorial"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_cmdtutorial">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdtutorial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">TutorialRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tutroom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">room</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdTutorial</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Sorry, there is no tutorial help available here.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdTutorialSetDetail</span><span class="p">(),</span>
            <span class="s2">&quot;detail;foo;foo2 = A detail&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Detail set: &#39;detail;foo;foo2&#39;: &#39;A detail&#39;&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdTutorialLook</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;tutroom(&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdTutorialLook</span><span class="p">(),</span> <span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="s2">&quot;A detail&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdTutorialLook</span><span class="p">(),</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;A detail&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_weatherroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_weatherroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_weatherroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">WeatherRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;weatherroom&quot;</span><span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">update_weather</span><span class="p">()</span>
        <span class="n">tutrooms</span><span class="o">.</span><span class="n">TICKER_HANDLER</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">update_weather</span><span class="p">,</span> <span class="n">idstring</span><span class="o">=</span><span class="s2">&quot;tutorial&quot;</span>
        <span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_introroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_introroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_introroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">IntroRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;introroom&quot;</span><span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">at_object_receive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_bridgeroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_bridgeroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_bridgeroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">BridgeRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;bridgeroom&quot;</span><span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">update_weather</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdBridgeHelp</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You are trying hard not to fall off the bridge ...&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdLookBridge</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bridgeroom</span><span class="se">\n</span><span class="s2">You are standing very close to the the bridge&#39;s western foundation.&quot;</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="n">room</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">at_object_leave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="n">tutrooms</span><span class="o">.</span><span class="n">TICKER_HANDLER</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">update_weather</span><span class="p">,</span> <span class="n">idstring</span><span class="o">=</span><span class="s2">&quot;tutorial&quot;</span>
        <span class="p">)</span>
        <span class="n">room</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_darkroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_darkroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_darkroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">room</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">DarkRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;darkroom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">CmdDarkHelp</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t help you until&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_teleportroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_teleportroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_teleportroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">TeleportRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;teleportroom&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTutorialWorldRooms.test_outroroom"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTutorialWorldRooms.test_outroroom">[docs]</a>    <span class="k">def</span> <span class="nf">test_outroroom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">create_object</span><span class="p">(</span><span class="n">tutrooms</span><span class="o">.</span><span class="n">OutroRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;outroroom&quot;</span><span class="p">)</span></div></div>


<span class="c1"># test turnbattle</span>
<span class="kn">from</span> <span class="nn">evennia.contrib.turnbattle</span> <span class="k">import</span> <span class="n">tb_basic</span><span class="p">,</span> <span class="n">tb_equip</span><span class="p">,</span> <span class="n">tb_range</span><span class="p">,</span> <span class="n">tb_items</span><span class="p">,</span> <span class="n">tb_magic</span>


<div class="viewcode-block" id="TestTurnBattleBasicCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicCmd">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleBasicCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>

    <span class="c1"># Test basic combat commands</span>
<div class="viewcode-block" id="TestTurnBattleBasicCmd.test_turnbattlecmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicCmd.test_turnbattlecmd">[docs]</a>    <span class="k">def</span> <span class="nf">test_turnbattlecmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">CmdFight</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can&#39;t start a fight if you&#39;ve been defeated!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">CmdPass</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">CmdDisengage</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">CmdRest</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char rests to recover HP.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleEquipCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipCmd">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleEquipCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleEquipCmd.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipCmd.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleEquipCmd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testweapon</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEWeapon</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test weapon&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testarmor</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEArmor</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;test armor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testweapon</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testarmor</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span></div>

    <span class="c1"># Test equipment commands</span>
<div class="viewcode-block" id="TestTurnBattleEquipCmd.test_turnbattleequipcmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipCmd.test_turnbattleequipcmd">[docs]</a>    <span class="k">def</span> <span class="nf">test_turnbattleequipcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Start with equip module specific commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdWield</span><span class="p">(),</span> <span class="s2">&quot;weapon&quot;</span><span class="p">,</span> <span class="s2">&quot;Char wields test weapon.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdUnwield</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char lowers test weapon.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdDon</span><span class="p">(),</span> <span class="s2">&quot;armor&quot;</span><span class="p">,</span> <span class="s2">&quot;Char dons test armor.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdDoff</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char removes test armor.&quot;</span><span class="p">)</span>
        <span class="c1"># Also test the commands that are the same in the basic module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdFight</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can&#39;t start a fight if you&#39;ve been defeated!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdPass</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdDisengage</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">CmdRest</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char rests to recover HP.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleRangeCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeCmd">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleRangeCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
    <span class="c1"># Test range commands</span>
<div class="viewcode-block" id="TestTurnBattleRangeCmd.test_turnbattlerangecmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeCmd.test_turnbattlerangecmd">[docs]</a>    <span class="k">def</span> <span class="nf">test_turnbattlerangecmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Start with range module specific commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdShoot</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdApproach</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdWithdraw</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdStatus</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;HP Remaining: 100 / 100&quot;</span><span class="p">)</span>
        <span class="c1"># Also test the commands that are the same in the basic module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdFight</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;There&#39;s nobody here to fight!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdPass</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdDisengage</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">CmdRest</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char rests to recover HP.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleItemsCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsCmd">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleItemsCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleItemsCmd.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsCmd.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleItemsCmd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testitem</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;test item&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testitem</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span></div>

    <span class="c1"># Test item commands</span>
<div class="viewcode-block" id="TestTurnBattleItemsCmd.test_turnbattleitemcmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsCmd.test_turnbattleitemcmd">[docs]</a>    <span class="k">def</span> <span class="nf">test_turnbattleitemcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdUse</span><span class="p">(),</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;Test item&#39; is not a usable item.&quot;</span><span class="p">)</span>
        <span class="c1"># Also test the commands that are the same in the basic module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdFight</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can&#39;t start a fight if you&#39;ve been defeated!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdPass</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdDisengage</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">CmdRest</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char rests to recover HP.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleMagicCmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicCmd">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleMagicCmd</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>

    <span class="c1"># Test magic commands</span>
<div class="viewcode-block" id="TestTurnBattleMagicCmd.test_turnbattlemagiccmd"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicCmd.test_turnbattlemagiccmd">[docs]</a>    <span class="k">def</span> <span class="nf">test_turnbattlemagiccmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdStatus</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You have 100 / 100 HP and 20 / 20 MP.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdLearnSpell</span><span class="p">(),</span> <span class="s2">&quot;test spell&quot;</span><span class="p">,</span> <span class="s2">&quot;There is no spell with that name.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdCast</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Usage: cast &lt;spell name&gt; = &lt;target&gt;, &lt;target2&gt;&quot;</span><span class="p">)</span>
        <span class="c1"># Also test the commands that are the same in the basic module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdFight</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;There&#39;s nobody here to fight!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdPass</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdDisengage</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You can only do that in combat. (see: help fight)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">CmdRest</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Char rests to recover HP and MP.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleBasicFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleBasicFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleBasicFunc.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicFunc.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleBasicFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Test Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_basic</span><span class="o">.</span><span class="n">TBBasicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Attacker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_basic</span><span class="o">.</span><span class="n">TBBasicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Defender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">TBBasicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Joiner&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTurnBattleBasicFunc.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicFunc.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleBasicFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># Test combat functions</span>
<div class="viewcode-block" id="TestTurnBattleBasicFunc.test_tbbasicfunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleBasicFunc.test_tbbasicfunc">[docs]</a>    <span class="k">def</span> <span class="nf">test_tbbasicfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initiative roll</span>
        <span class="n">initiative</span> <span class="o">=</span> <span class="n">tb_basic</span><span class="o">.</span><span class="n">roll_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">initiative</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">initiative</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># Attack roll</span>
        <span class="n">attack_roll</span> <span class="o">=</span> <span class="n">tb_basic</span><span class="o">.</span><span class="n">get_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">attack_roll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">attack_roll</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Defense roll</span>
        <span class="n">defense_roll</span> <span class="o">=</span> <span class="n">tb_basic</span><span class="o">.</span><span class="n">get_defense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">defense_roll</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Damage roll</span>
        <span class="n">damage_roll</span> <span class="o">=</span> <span class="n">tb_basic</span><span class="o">.</span><span class="n">get_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">damage_roll</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">damage_roll</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="c1"># Apply damage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">tb_basic</span><span class="o">.</span><span class="n">apply_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Resolve attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">tb_basic</span><span class="o">.</span><span class="n">resolve_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="n">attack_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">defense_value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="c1"># Combat cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_attribute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tb_basic</span><span class="o">.</span><span class="n">combat_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_attribute</span><span class="p">)</span>
        <span class="c1"># Is in combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">is_in_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Set up turn handler script for further tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">TBBasicTurnHandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span><span class="p">)</span>
        <span class="c1"># Set the turn handler&#39;s interval very high to keep it from repeating during tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Force turn order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Test is turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_basic</span><span class="o">.</span><span class="n">is_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Spend actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tb_basic</span><span class="o">.</span><span class="n">spend_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">action_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize for combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">983</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">initialize_for_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Start turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">start_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Next turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">next_turn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Turn end check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">turn_end_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Join fight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">join_fight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="TestTurnBattleEquipFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleEquipFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleEquipFunc.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipFunc.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleEquipFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Test Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEquipCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Attacker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEquipCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Defender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEquipCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Joiner&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTurnBattleEquipFunc.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipFunc.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleEquipFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># Test the combat functions in tb_equip too. They work mostly the same.</span>
<div class="viewcode-block" id="TestTurnBattleEquipFunc.test_tbequipfunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleEquipFunc.test_tbequipfunc">[docs]</a>    <span class="k">def</span> <span class="nf">test_tbequipfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initiative roll</span>
        <span class="n">initiative</span> <span class="o">=</span> <span class="n">tb_equip</span><span class="o">.</span><span class="n">roll_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">initiative</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">initiative</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># Attack roll</span>
        <span class="n">attack_roll</span> <span class="o">=</span> <span class="n">tb_equip</span><span class="o">.</span><span class="n">get_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">attack_roll</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">50</span> <span class="ow">and</span> <span class="n">attack_roll</span> <span class="o">&lt;=</span> <span class="mi">150</span><span class="p">)</span>
        <span class="c1"># Defense roll</span>
        <span class="n">defense_roll</span> <span class="o">=</span> <span class="n">tb_equip</span><span class="o">.</span><span class="n">get_defense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">defense_roll</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Damage roll</span>
        <span class="n">damage_roll</span> <span class="o">=</span> <span class="n">tb_equip</span><span class="o">.</span><span class="n">get_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">damage_roll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">damage_roll</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Apply damage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">tb_equip</span><span class="o">.</span><span class="n">apply_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Resolve attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">tb_equip</span><span class="o">.</span><span class="n">resolve_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="n">attack_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">defense_value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="c1"># Combat cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_attribute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tb_equip</span><span class="o">.</span><span class="n">combat_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_attribute</span><span class="p">)</span>
        <span class="c1"># Is in combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">is_in_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Set up turn handler script for further tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">TBEquipTurnHandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span><span class="p">)</span>
        <span class="c1"># Set the turn handler&#39;s interval very high to keep it from repeating during tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Force turn order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Test is turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_equip</span><span class="o">.</span><span class="n">is_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Spend actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tb_equip</span><span class="o">.</span><span class="n">spend_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">action_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize for combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">983</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">initialize_for_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Start turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">start_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Next turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">next_turn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Turn end check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">turn_end_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Join fight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">join_fight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="TestTurnBattleRangeFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleRangeFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleRangeFunc.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeFunc.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleRangeFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Test Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_range</span><span class="o">.</span><span class="n">TBRangeCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Attacker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_range</span><span class="o">.</span><span class="n">TBRangeCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Defender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">TBRangeCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Joiner&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTurnBattleRangeFunc.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeFunc.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleRangeFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># Test combat functions in tb_range too.</span>
<div class="viewcode-block" id="TestTurnBattleRangeFunc.test_tbrangefunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleRangeFunc.test_tbrangefunc">[docs]</a>    <span class="k">def</span> <span class="nf">test_tbrangefunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initiative roll</span>
        <span class="n">initiative</span> <span class="o">=</span> <span class="n">tb_range</span><span class="o">.</span><span class="n">roll_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">initiative</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">initiative</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># Attack roll</span>
        <span class="n">attack_roll</span> <span class="o">=</span> <span class="n">tb_range</span><span class="o">.</span><span class="n">get_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">attack_roll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">attack_roll</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Defense roll</span>
        <span class="n">defense_roll</span> <span class="o">=</span> <span class="n">tb_range</span><span class="o">.</span><span class="n">get_defense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">defense_roll</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Damage roll</span>
        <span class="n">damage_roll</span> <span class="o">=</span> <span class="n">tb_range</span><span class="o">.</span><span class="n">get_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">damage_roll</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">damage_roll</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="c1"># Apply damage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">apply_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Resolve attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">resolve_attack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">attack_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">defense_value</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="c1"># Combat cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_attribute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">combat_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_attribute</span><span class="p">)</span>
        <span class="c1"># Is in combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">is_in_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Set up turn handler script for further tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">TBRangeTurnHandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span><span class="p">)</span>
        <span class="c1"># Set the turn handler&#39;s interval very high to keep it from repeating during tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Force turn order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Test is turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">is_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Spend actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">spend_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">action_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize for combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">983</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">initialize_for_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Set up ranges again, since initialize_for_combat clears them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Start turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">start_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Next turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">next_turn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Turn end check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">turn_end_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Join fight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">join_fight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">])</span>
        <span class="c1"># Now, test for approach/withdraw functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Approach</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">approach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Withdraw</span>
        <span class="n">tb_range</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_range</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTurnBattleItemsFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleItemsFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleItemsFunc.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsFunc.setUp">[docs]</a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.turnbattle.tb_items.tickerhandler&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">MagicMock</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleItemsFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Test Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_items</span><span class="o">.</span><span class="n">TBItemsCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Attacker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_items</span><span class="o">.</span><span class="n">TBItemsCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Defender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">TBItemsCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Joiner&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">TBItemsCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;healing potion&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">item_func</span> <span class="o">=</span> <span class="s2">&quot;heal&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">item_uses</span> <span class="o">=</span> <span class="mi">3</span></div>

<div class="viewcode-block" id="TestTurnBattleItemsFunc.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsFunc.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleItemsFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># Test functions in tb_items.</span>
<div class="viewcode-block" id="TestTurnBattleItemsFunc.test_tbitemsfunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleItemsFunc.test_tbitemsfunc">[docs]</a>    <span class="k">def</span> <span class="nf">test_tbitemsfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initiative roll</span>
        <span class="n">initiative</span> <span class="o">=</span> <span class="n">tb_items</span><span class="o">.</span><span class="n">roll_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">initiative</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">initiative</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># Attack roll</span>
        <span class="n">attack_roll</span> <span class="o">=</span> <span class="n">tb_items</span><span class="o">.</span><span class="n">get_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">attack_roll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">attack_roll</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Defense roll</span>
        <span class="n">defense_roll</span> <span class="o">=</span> <span class="n">tb_items</span><span class="o">.</span><span class="n">get_defense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">defense_roll</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Damage roll</span>
        <span class="n">damage_roll</span> <span class="o">=</span> <span class="n">tb_items</span><span class="o">.</span><span class="n">get_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">damage_roll</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">damage_roll</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="c1"># Apply damage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">apply_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Resolve attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">resolve_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="n">attack_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">defense_value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="c1"># Combat cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_attribute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">combat_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_attribute</span><span class="p">)</span>
        <span class="c1"># Is in combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">is_in_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Set up turn handler script for further tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">TBItemsTurnHandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span><span class="p">)</span>
        <span class="c1"># Set the turn handler&#39;s interval very high to keep it from repeating during tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Force turn order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Test is turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_items</span><span class="o">.</span><span class="n">is_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Spend actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">spend_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">action_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize for combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">983</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">initialize_for_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Start turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">start_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Next turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">next_turn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Turn end check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">turn_end_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Join fight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">join_fight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">])</span>
        <span class="c1"># Now time to test item stuff.</span>
        <span class="c1"># Spend item use</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">spend_item_use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">item_uses</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Use item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">use_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Add contition</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">add_condition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]})</span>
        <span class="c1"># Condition tickdown</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">condition_tickdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]})</span>
        <span class="c1"># Test item functions now!</span>
        <span class="c1"># Item heal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">itemfunc_heal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># Item add condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">itemfunc_add_condition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;Regeneration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]})</span>
        <span class="c1"># Item cure condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Poisoned&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]}</span>
        <span class="n">tb_items</span><span class="o">.</span><span class="n">itemfunc_cure_condition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_healpotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conditions</span> <span class="o">==</span> <span class="p">{})</span></div></div>


<div class="viewcode-block" id="TestTurnBattleMagicFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTurnBattleMagicFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTurnBattleMagicFunc.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicFunc.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleMagicFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">DefaultRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Test Room&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_magic</span><span class="o">.</span><span class="n">TBMagicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Attacker&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="n">tb_magic</span><span class="o">.</span><span class="n">TBMagicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Defender&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">TBMagicCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Joiner&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestTurnBattleMagicFunc.tearDown"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicFunc.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestTurnBattleMagicFunc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testroom</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># Test combat functions in tb_magic.</span>
<div class="viewcode-block" id="TestTurnBattleMagicFunc.test_tbbasicfunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTurnBattleMagicFunc.test_tbbasicfunc">[docs]</a>    <span class="k">def</span> <span class="nf">test_tbbasicfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initiative roll</span>
        <span class="n">initiative</span> <span class="o">=</span> <span class="n">tb_magic</span><span class="o">.</span><span class="n">roll_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">initiative</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">initiative</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># Attack roll</span>
        <span class="n">attack_roll</span> <span class="o">=</span> <span class="n">tb_magic</span><span class="o">.</span><span class="n">get_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">attack_roll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">attack_roll</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Defense roll</span>
        <span class="n">defense_roll</span> <span class="o">=</span> <span class="n">tb_magic</span><span class="o">.</span><span class="n">get_defense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">defense_roll</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># Damage roll</span>
        <span class="n">damage_roll</span> <span class="o">=</span> <span class="n">tb_magic</span><span class="o">.</span><span class="n">get_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">damage_roll</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">damage_roll</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="c1"># Apply damage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">tb_magic</span><span class="o">.</span><span class="n">apply_damage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Resolve attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">tb_magic</span><span class="o">.</span><span class="n">resolve_attack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">,</span> <span class="n">attack_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">defense_value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">hp</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="c1"># Combat cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_attribute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tb_magic</span><span class="o">.</span><span class="n">combat_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_attribute</span><span class="p">)</span>
        <span class="c1"># Is in combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">is_in_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Set up turn handler script for further tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">TBMagicTurnHandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">combat_TurnHandler</span><span class="p">)</span>
        <span class="c1"># Set the turn handler&#39;s interval very high to keep it from repeating during tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># Force turn order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Test is turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tb_magic</span><span class="o">.</span><span class="n">is_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">))</span>
        <span class="c1"># Spend actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tb_magic</span><span class="o">.</span><span class="n">spend_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">action_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="c1"># Initialize for combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">983</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">initialize_for_combat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_LastAction</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Start turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">start_turn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Next turn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">next_turn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Turn end check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Combat_ActionsLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">turn_end_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Join fight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">join_fight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turnhandler</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">fighters</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">joiner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defender</span><span class="p">])</span></div></div>


<span class="c1"># Test tree select</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">tree_select</span>

<span class="n">TREE_MENU_TESTSTR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Foo</span>
<span class="s2">Bar</span>
<span class="s2">-Baz</span>
<span class="s2">--Baz 1</span>
<span class="s2">--Baz 2</span>
<span class="s2">-Qux&quot;&quot;&quot;</span>


<div class="viewcode-block" id="TestTreeSelectFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTreeSelectFunc">[docs]</a><span class="k">class</span> <span class="nc">TestTreeSelectFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestTreeSelectFunc.test_tree_functions"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestTreeSelectFunc.test_tree_functions">[docs]</a>    <span class="k">def</span> <span class="nf">test_tree_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Dash counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tree_select</span><span class="o">.</span><span class="n">dashcount</span><span class="p">(</span><span class="s2">&quot;--test&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Is category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tree_select</span><span class="o">.</span><span class="n">is_category</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Parse options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">tree_select</span><span class="o">.</span><span class="n">parse_opts</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="n">category_index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">==</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Baz 1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Baz 2&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="c1"># Index to selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tree_select</span><span class="o">.</span><span class="n">index_to_selection</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Baz&quot;</span><span class="p">)</span>
        <span class="c1"># Go up one category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">tree_select</span><span class="o">.</span><span class="n">go_up_one_category</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Option list to menu options</span>
        <span class="n">test_optlist</span> <span class="o">=</span> <span class="n">tree_select</span><span class="o">.</span><span class="n">parse_opts</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="n">category_index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">optlist_to_menu_expected_result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;menunode_treeselect&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;newindex&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}],</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;Baz 1&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;menunode_treeselect&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;newindex&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}],</span> <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;Baz 2&quot;</span><span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;menunode_treeselect&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;newindex&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;&lt; Go Back&quot;</span><span class="p">,</span> <span class="s2">&quot;go back&quot;</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">],</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Return to the previous menu.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">tree_select</span><span class="o">.</span><span class="n">optlist_to_menuoptions</span><span class="p">(</span><span class="n">TREE_MENU_TESTSTR</span><span class="p">,</span> <span class="n">test_optlist</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="o">==</span> <span class="n">optlist_to_menu_expected_result</span>
        <span class="p">)</span></div></div>


<span class="c1"># Test field fill</span>

<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">fieldfill</span>

<span class="n">FIELD_TEST_TEMPLATE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;fieldname&quot;</span><span class="p">:</span> <span class="s2">&quot;TextTest&quot;</span><span class="p">,</span> <span class="s2">&quot;fieldtype&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;fieldname&quot;</span><span class="p">:</span> <span class="s2">&quot;NumberTest&quot;</span><span class="p">,</span> <span class="s2">&quot;fieldtype&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;blankmsg&quot;</span><span class="p">:</span> <span class="s2">&quot;Number here!&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;fieldname&quot;</span><span class="p">:</span> <span class="s2">&quot;DefaultText&quot;</span><span class="p">,</span> <span class="s2">&quot;fieldtype&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;Test&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;fieldname&quot;</span><span class="p">:</span> <span class="s2">&quot;DefaultNum&quot;</span><span class="p">,</span> <span class="s2">&quot;fieldtype&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">FIELD_TEST_DATA</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TextTest&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;NumberTest&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DefaultText&quot;</span><span class="p">:</span> <span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="s2">&quot;DefaultNum&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>


<div class="viewcode-block" id="TestFieldFillFunc"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestFieldFillFunc">[docs]</a><span class="k">class</span> <span class="nc">TestFieldFillFunc</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestFieldFillFunc.test_field_functions"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestFieldFillFunc.test_field_functions">[docs]</a>    <span class="k">def</span> <span class="nf">test_field_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">fieldfill</span><span class="o">.</span><span class="n">form_template_to_dict</span><span class="p">(</span><span class="n">FIELD_TEST_TEMPLATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FIELD_TEST_DATA</span><span class="p">)</span></div></div>


<span class="c1"># Test of the unixcommand module</span>

<span class="kn">from</span> <span class="nn">evennia.contrib.unixcommand</span> <span class="k">import</span> <span class="n">UnixCommand</span>


<div class="viewcode-block" id="CmdDummy"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.CmdDummy">[docs]</a><span class="k">class</span> <span class="nc">CmdDummy</span><span class="p">(</span><span class="n">UnixCommand</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A dummy UnixCommand.&quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>

<div class="viewcode-block" id="CmdDummy.init_parser"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.CmdDummy.init_parser">[docs]</a>    <span class="k">def</span> <span class="nf">init_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill out options.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;nb1&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the first number&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;nb2&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the second number&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CmdDummy.func"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.CmdDummy.func">[docs]</a>    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nb1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nb1</span>
        <span class="n">nb2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">nb2</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">nb1</span> <span class="o">*</span> <span class="n">nb2</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> times </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb1</span><span class="p">,</span> <span class="n">nb2</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> * </span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb1</span><span class="p">,</span> <span class="n">nb2</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="TestUnixCommand"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestUnixCommand">[docs]</a><span class="k">class</span> <span class="nc">TestUnixCommand</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestUnixCommand.test_success"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestUnixCommand.test_success">[docs]</a>    <span class="k">def</span> <span class="nf">test_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See the command parsing succeed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdDummy</span><span class="p">(),</span> <span class="s2">&quot;5 10&quot;</span><span class="p">,</span> <span class="s2">&quot;5 * 10 = 50&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdDummy</span><span class="p">(),</span> <span class="s2">&quot;5 10 -v&quot;</span><span class="p">,</span> <span class="s2">&quot;5 times 10 is 50&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestUnixCommand.test_failure"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestUnixCommand.test_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If not provided with the right info, should fail.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdDummy</span><span class="p">(),</span> <span class="s2">&quot;5&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;usage:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dummy: error:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))</span>

        <span class="c1"># If we specify an incorrect number as parameter</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdDummy</span><span class="p">(),</span> <span class="s2">&quot;five ten&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;usage:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dummy: error:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">))</span></div></div>


<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">color_markups</span>


<div class="viewcode-block" id="TestColorMarkup"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestColorMarkup">[docs]</a><span class="k">class</span> <span class="nc">TestColorMarkup</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note: Normally this would be tested by importing the ansi parser and run</span>
<span class="sd">    the mappings through it. This is not possible since the ansi module creates</span>
<span class="sd">    its mapping at the module/class level; since the ansi module is used by so</span>
<span class="sd">    many other modules it appears that trying to overload</span>
<span class="sd">    settings to test it causes issues with unrelated tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestColorMarkup.test_curly_markup"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestColorMarkup.test_curly_markup">[docs]</a>    <span class="k">def</span> <span class="nf">test_curly_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ansi_map</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_ANSI_EXTRA_MAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">ansi_map</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;{r&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">ansi_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;{[X&quot;</span><span class="p">))</span>
        <span class="n">xterm_fg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_XTERM256_EXTRA_FG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{001&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{123&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{455&quot;</span><span class="p">))</span>
        <span class="n">xterm_bg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_XTERM256_EXTRA_BG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[001&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[123&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[455&quot;</span><span class="p">))</span>
        <span class="n">xterm_gfg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_XTERM256_EXTRA_GFG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{=h&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{=e&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{=w&quot;</span><span class="p">))</span>
        <span class="n">xterm_gbg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_XTERM256_EXTRA_GBG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[=a&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[=k&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;{[=z&quot;</span><span class="p">))</span>
        <span class="n">bright_map</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">CURLY_COLOR_ANSI_XTERM256_BRIGHT_BG_EXTRA_MAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bright_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;{[500&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bright_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;{[222&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestColorMarkup.test_mux_markup"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestColorMarkup.test_mux_markup">[docs]</a>    <span class="k">def</span> <span class="nf">test_mux_markup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ansi_map</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_ANSI_EXTRA_MAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">ansi_map</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">r&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">ansi_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">X&quot;</span><span class="p">))</span>
        <span class="n">xterm_fg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_XTERM256_EXTRA_FG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">001&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">123&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_fg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">455&quot;</span><span class="p">))</span>
        <span class="n">xterm_bg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_XTERM256_EXTRA_BG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[001&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[123&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[455&quot;</span><span class="p">))</span>
        <span class="n">xterm_gfg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_XTERM256_EXTRA_GFG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">=h&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">=e&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">=w&quot;</span><span class="p">))</span>
        <span class="n">xterm_gbg</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_XTERM256_EXTRA_GBG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[=a&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[=k&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">xterm_gbg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[=z&quot;</span><span class="p">))</span>
        <span class="n">bright_map</span> <span class="o">=</span> <span class="n">color_markups</span><span class="o">.</span><span class="n">MUX_COLOR_ANSI_XTERM256_BRIGHT_BG_EXTRA_MAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bright_map</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[500&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bright_map</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%c</span><span class="s2">[222&quot;</span><span class="p">)</span></div></div>


<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">random_string_generator</span>

<span class="n">SIMPLE_GENERATOR</span> <span class="o">=</span> <span class="n">random_string_generator</span><span class="o">.</span><span class="n">RandomStringGenerator</span><span class="p">(</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="s2">&quot;[01]</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="TestRandomStringGenerator"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRandomStringGenerator">[docs]</a><span class="k">class</span> <span class="nc">TestRandomStringGenerator</span><span class="p">(</span><span class="n">EvenniaTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestRandomStringGenerator.test_generate"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestRandomStringGenerator.test_generate">[docs]</a>    <span class="k">def</span> <span class="nf">test_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate and fail when exhausted.&quot;&quot;&quot;</span>
        <span class="n">generated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SIMPLE_GENERATOR</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">generated</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;00&quot;</span><span class="p">,</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;11&quot;</span><span class="p">])</span>

        <span class="c1"># At this point, we have generated 4 strings.</span>
        <span class="c1"># We can&#39;t generate one more</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">random_string_generator</span><span class="o">.</span><span class="n">ExhaustedGenerator</span><span class="p">):</span>
            <span class="n">SIMPLE_GENERATOR</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div></div>


<span class="c1"># Test of the Puzzles module</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">evennia.contrib</span> <span class="k">import</span> <span class="n">puzzles</span>
<span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="k">import</span> <span class="n">search</span>


<div class="viewcode-block" id="TestPuzzles"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles">[docs]</a><span class="k">class</span> <span class="nc">TestPuzzles</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestPuzzles.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestPuzzles</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flint&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-steel&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-steel&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;tagcat&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-flint&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-flint&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;tagcat&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-fire&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tag-fire&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;tagcat&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles._assert_msg_matched"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._assert_msg_matched">[docs]</a>    <span class="k">def</span> <span class="nf">_assert_msg_matched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">regexs</span><span class="p">,</span> <span class="n">re_flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">regexs</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">re_flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> didn&#39;t match </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matches</span></div>

<div class="viewcode-block" id="TestPuzzles._assert_recipe"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._assert_recipe">[docs]</a>    <span class="k">def</span> <span class="nf">_assert_recipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_keys</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

        <span class="n">recipes</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">search_script_tag</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">_keys</span><span class="p">(</span><span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">_keys</span><span class="p">(</span><span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">results</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_RECIPE</span><span class="p">,</span>
            <span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dbref</span>
        <span class="k">if</span> <span class="n">and_destroy_it</span><span class="p">:</span>
            <span class="n">recipes</span><span class="p">[</span><span class="n">expected_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">recipe_dbref</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">and_destroy_it</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestPuzzles._assert_no_recipes"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._assert_no_recipes">[docs]</a>    <span class="k">def</span> <span class="nf">_assert_no_recipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">search_script_tag</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">))</span>
        <span class="p">)</span></div>

    <span class="c1"># good recipes</span>
<div class="viewcode-block" id="TestPuzzles._good_recipe"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._good_recipe">[docs]</a>    <span class="k">def</span> <span class="nf">_good_recipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">regexs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Part </span><span class="si">%s</span><span class="s2">\(#\d+\)$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Result </span><span class="si">%s</span><span class="s2">\(#\d+\)$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Puzzle &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2">\(#\d+\) has been created successfully.$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="n">parts</span>
        <span class="n">cmdstr</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdCreatePuzzleRecipe</span><span class="p">(),</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_recipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="p">,</span> <span class="n">expected_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">regexs</span><span class="p">,</span> <span class="n">re_flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recipe_dbref</span></div>

<div class="viewcode-block" id="TestPuzzles._check_room_contents"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._check_room_contents">[docs]</a>    <span class="k">def</span> <span class="nf">_check_room_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">by_obj_key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span>
        <span class="n">room1_contents</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">by_obj_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">room1_contents</span><span class="p">,</span> <span class="n">by_obj_key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                    <span class="n">expected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="p">),</span>
                    <span class="s2">&quot;Expected </span><span class="si">%d</span><span class="s2"> but got </span><span class="si">%d</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="p">),</span> <span class="n">key</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">check_test_tags</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="n">gi</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">((</span><span class="s2">&quot;tag-&quot;</span> <span class="o">+</span> <span class="n">gi</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;tagcat&quot;</span><span class="p">),</span> <span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles._arm"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._arm">[docs]</a>    <span class="k">def</span> <span class="nf">_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
        <span class="n">regexs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s2">&quot;^Puzzle Recipe </span><span class="si">%s</span><span class="s2">\(#\d+\) &#39;</span><span class="si">%s</span><span class="s2">&#39; found.$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
            <span class="sa">r</span><span class="s2">&quot;^Spawning </span><span class="si">%d</span><span class="s2"> parts ...$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Part </span><span class="si">%s</span><span class="s2">\(#\d+\) spawned .*$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Puzzle armed successfully.$&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdArmPuzzle</span><span class="p">(),</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">regexs</span><span class="p">,</span> <span class="n">re_flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles.test_cmdset_puzzle"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_cmdset_puzzle">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmdset_puzzle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.puzzles.PuzzleSystemCmdSet&quot;</span><span class="p">)</span></div>
        <span class="c1"># FIXME: testing nothing, this is just to bump up coverage</span>

<div class="viewcode-block" id="TestPuzzles.test_cmd_puzzle"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_cmd_puzzle">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmd_puzzle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_no_recipes</span><span class="p">()</span>

        <span class="c1"># bad syntax</span>
        <span class="k">def</span> <span class="nf">_bad_syntax</span><span class="p">(</span><span class="n">cmdstr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="n">puzzles</span><span class="o">.</span><span class="n">CmdCreatePuzzleRecipe</span><span class="p">(),</span>
                <span class="n">cmdstr</span><span class="p">,</span>
                <span class="s2">&quot;Usage: @puzzle name,&lt;part1[,...]&gt; = &lt;result1[,...]&gt;&quot;</span><span class="p">,</span>
                <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;nothing =&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;= nothing&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;nothing&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;,nothing&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;name, nothing&quot;</span><span class="p">)</span>
        <span class="n">_bad_syntax</span><span class="p">(</span><span class="s2">&quot;name, nothing =&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_no_recipes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span><span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span><span class="s2">&quot;hot steels&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;furnace&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># bad recipes</span>
        <span class="k">def</span> <span class="nf">_bad_recipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">fail_regex</span><span class="p">):</span>
            <span class="n">cmdstr</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="n">parts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdCreatePuzzleRecipe</span><span class="p">(),</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_no_recipes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fail_regex</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>

        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nothing&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;neither&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;Could not find &#39;nothing&#39;.&quot;</span><span class="p">)</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;nothing&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;Could not find &#39;nothing&#39;.&quot;</span><span class="p">)</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;^Invalid puzzle name &#39;&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;^Invalid location for steel$&quot;</span><span class="p">)</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;^Invalid location for steel$&quot;</span><span class="p">)</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;^Invalid typeclass for Char$&quot;</span><span class="p">)</span>
        <span class="n">_bad_recipe</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;here&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="sa">r</span><span class="s2">&quot;^Invalid typeclass for Room$&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_no_recipes</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestPuzzles.test_cmd_armpuzzle"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_cmd_armpuzzle">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmd_armpuzzle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># bad arms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">puzzles</span><span class="o">.</span><span class="n">CmdArmPuzzle</span><span class="p">(),</span>
            <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A puzzle recipe&#39;s #dbref must be specified&quot;</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdArmPuzzle</span><span class="p">(),</span> <span class="s2">&quot;#1&quot;</span><span class="p">,</span> <span class="s2">&quot;Invalid puzzle &#39;#1&#39;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>

        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># delete proto parts and proto result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># good arm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles._use"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles._use">[docs]</a>    <span class="k">def</span> <span class="nf">_use</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdUsePuzzleParts</span><span class="p">(),</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="TestPuzzles.test_cmd_use"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_cmd_use">[docs]</a>    <span class="k">def</span> <span class="nf">test_cmd_use</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Use what?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;something&quot;</span><span class="p">,</span> <span class="s2">&quot;There is no something around.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;You have no idea how this can be used&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel flint&quot;</span><span class="p">,</span> <span class="s2">&quot;There is no steel flint around.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You have no idea how these can be used&quot;</span><span class="p">)</span>

        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">recipe2_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># although there is steel and flint</span>
        <span class="c1"># those aren&#39;t valid puzzle parts because</span>
        <span class="c1"># the puzzle hasn&#39;t been armed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;You have no idea how this can be used&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You have no idea how these can be used&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># there are duplicated objects now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;Which steel. There are many&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;flint&quot;</span><span class="p">,</span> <span class="s2">&quot;Which flint. There are many&quot;</span><span class="p">)</span>

        <span class="c1"># delete proto parts and proto results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># solve puzzle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;fire&quot;</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
                        <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_MEMBER</span><span class="p">,</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
                        <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># trying again will fail as it was resolved already</span>
        <span class="c1"># and the parts were destroyed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;There is no steel around&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;flint, steel&quot;</span><span class="p">,</span> <span class="s2">&quot;There is no flint around&quot;</span><span class="p">)</span>

        <span class="c1"># arm same puzzle twice so there are duplicated parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># try solving with multiple parts but incomplete set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span>
            <span class="s2">&quot;1-steel, 2-steel&quot;</span><span class="p">,</span> <span class="s2">&quot;You try to utilize these but nothing happens ... something amiss?&quot;</span>
        <span class="p">)</span>

        <span class="c1"># arm the other puzzle. Their parts are identical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe2_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># solve with multiple parts for</span>
        <span class="c1"># multiple puzzles. Both can be solved but</span>
        <span class="c1"># only one is.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span>
            <span class="s2">&quot;1-steel, 2-flint, 3-steel, 3-flint&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Your gears start turning and 2 different ideas come to your mind ... &quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

        <span class="c1"># solve all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;1-steel, 1-flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s2">&quot;|cChar|n performs some kind of tribal dance and |yfire|n seems to appear from thin air&quot;</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="n">check_test_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles.test_puzzleedit"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_puzzleedit">[docs]</a>    <span class="k">def</span> <span class="nf">test_puzzleedit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_puzzleedit</span><span class="p">(</span><span class="n">swt</span><span class="p">,</span> <span class="n">dbref</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">swt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dbref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">cmdstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmdstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">swt</span><span class="p">,</span> <span class="n">dbref</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdEditPuzzle</span><span class="p">(),</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>

        <span class="c1"># delete proto parts and proto results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flint</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># bad syntax</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;A puzzle recipe&#39;s #dbref must be specified.</span><span class="se">\n</span><span class="s2">Usage: @puzzleedit&quot;</span>
        <span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;A puzzle recipe&#39;s #dbref must be specified.</span><span class="se">\n</span><span class="s2">Usage: @puzzleedit&quot;</span><span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;A puzzle recipe&#39;s #dbref must be specified.</span><span class="se">\n</span><span class="s2">Usage: @puzzleedit&quot;</span><span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">recipe_dbref</span><span class="p">,</span>
            <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A puzzle recipe&#39;s #dbref must be specified.</span><span class="se">\n</span><span class="s2">Usage: @puzzleedit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Script(#</span><span class="si">{}</span><span class="s2">) is not a puzzle&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>

        <span class="c1"># edit use_success_message and use_success_location_message</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">recipe_dbref</span><span class="p">,</span>
            <span class="s2">&quot;/use_success_message = Yes!&quot;</span><span class="p">,</span>
            <span class="s2">&quot;makefire(</span><span class="si">%s</span><span class="s2">) use_success_message = Yes!&quot;</span> <span class="o">%</span> <span class="n">recipe_dbref</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">recipe_dbref</span><span class="p">,</span>
            <span class="s2">&quot;/use_success_location_message = </span><span class="si">{result_names}</span><span class="s2"> Yeah baby! </span><span class="si">{caller}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;makefire(</span><span class="si">%s</span><span class="s2">) use_success_location_message = </span><span class="si">{result_names}</span><span class="s2"> Yeah baby! </span><span class="si">{caller}</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">recipe_dbref</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s2">&quot;fire Yeah baby! Char&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

        <span class="c1"># edit mask: exclude location and desc during matching</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">recipe_dbref</span><span class="p">,</span>
            <span class="s2">&quot;/mask = location,desc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;makefire(</span><span class="si">%s</span><span class="s2">) mask = (&#39;location&#39;, &#39;desc&#39;)&quot;</span> <span class="o">%</span> <span class="n">recipe_dbref</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>
        <span class="c1"># change location and desc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;steel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;A solid bar of steel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;steel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;flint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;A flint steel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;flint&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">msg_contents</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s2">&quot;fire Yeah baby! Char&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="c1"># delete</span>
        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;/delete&quot;</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;makefire(</span><span class="si">%s</span><span class="s2">) was deleted&quot;</span> <span class="o">%</span> <span class="n">recipe_dbref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_no_recipes</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestPuzzles.test_puzzleedit_add_remove_parts_results"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_puzzleedit_add_remove_parts_results">[docs]</a>    <span class="k">def</span> <span class="nf">test_puzzleedit_add_remove_parts_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_puzzleedit</span><span class="p">(</span><span class="n">swt</span><span class="p">,</span> <span class="n">dbref</span><span class="p">,</span> <span class="n">rhslist</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">):</span>
            <span class="n">cmdstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">swt</span><span class="p">,</span> <span class="n">dbref</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rhslist</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdEditPuzzle</span><span class="p">(),</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">expmsg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>

        <span class="n">red_steel</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;red steel&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">smoke</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;smoke&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;/addresult&quot;</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;smoke&quot;</span><span class="p">],</span> <span class="s2">&quot;smoke were added to results&quot;</span><span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;/addpart&quot;</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;red steel&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">],</span> <span class="s2">&quot;red steel, steel were added to parts&quot;</span>
        <span class="p">)</span>

        <span class="c1"># create a box so we can put all objects in</span>
        <span class="c1"># so that they can&#39;t be found during puzzle resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_box_all</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">]:</span>
                    <span class="n">o</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span>

        <span class="n">_box_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">,</span> <span class="s2">&quot;red steel&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;steel&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;red steel&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span>
            <span class="s2">&quot;1-steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You try to utilize these but nothing happens ... something amiss?&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;1-steel, flint, red steel, 3-steel&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;smoke&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">_box_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steel</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span>

        <span class="n">_puzzleedit</span><span class="p">(</span><span class="s2">&quot;/delresult&quot;</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="s2">&quot;fire were removed from results&quot;</span><span class="p">)</span>
        <span class="n">_puzzleedit</span><span class="p">(</span>
            <span class="s2">&quot;/delpart&quot;</span><span class="p">,</span> <span class="n">recipe_dbref</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;steel&quot;</span><span class="p">],</span> <span class="s2">&quot;steel, steel were removed from parts&quot;</span>
        <span class="p">)</span>

        <span class="n">_box_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;flint&quot;</span><span class="p">,</span> <span class="s2">&quot;red steel&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;red steel&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;red steel, flint&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;smoke&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fire&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span></div>

<div class="viewcode-block" id="TestPuzzles.test_lspuzzlerecipes_lsarmedpuzzles"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_lspuzzlerecipes_lsarmedpuzzles">[docs]</a>    <span class="k">def</span> <span class="nf">test_lspuzzlerecipes_lsarmedpuzzles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdListPuzzleRecipes</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;^Found 0 puzzle\(s\)\.$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;-+$&quot;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
        <span class="p">)</span>

        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;fire&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdListPuzzleRecipes</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Puzzle &#39;makefire&#39;.*$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Success Caller message:$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Success Location message:$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Mask:$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Parts$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*key: steel$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*key: flint$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Results$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*key: fire$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*key: steel$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*key: flint$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Found 1 puzzle\(s\)\.$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdListArmedPuzzles</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;^Found 0 armed puzzle\(s\)\.$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">],</span>
            <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;makefire&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;steel&quot;</span><span class="p">,</span> <span class="s2">&quot;flint&quot;</span><span class="p">])</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">puzzles</span><span class="o">.</span><span class="n">CmdListArmedPuzzles</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_msg_matched</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Puzzle name: makefire$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*steel.* at \s+ Room.*$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^.*flint.* at \s+ Room.*$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^Found 1 armed puzzle\(s\)\.$&quot;</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;^-+$&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles.test_e2e"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_e2e">[docs]</a>    <span class="k">def</span> <span class="nf">test_e2e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_destroy_objs_in_room</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># parts don&#39;t survive resolution</span>
        <span class="c1"># but produce a large result set</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">axe</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;axe&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">sweat</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sweat&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">dull_axe</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dull axe&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">timber</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;timber&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="s2">&quot;axe&quot;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;sweat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;dull axe&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;timber&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="p">([</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span><span class="s2">&quot;lumberjack&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">_destroy_objs_in_room</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parts</span> <span class="o">+</span> <span class="n">results</span><span class="p">))</span>

        <span class="n">sps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sps</span><span class="p">)}</span>
        <span class="n">expected</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">r</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">)})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;lumberjack&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">srs</span><span class="p">)}</span>
        <span class="n">expected</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">p</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">parts</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="c1"># parts also appear in results</span>
        <span class="c1"># causing a new puzzle to be armed &#39;automatically&#39;</span>
        <span class="c1"># i.e. the puzzle is self-sustaining</span>
        <span class="n">hole</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hole&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">shovel</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;shovel&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">dirt</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dirt&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shovel&quot;</span><span class="p">,</span> <span class="s2">&quot;hole&quot;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dirt&quot;</span><span class="p">,</span> <span class="s2">&quot;hole&quot;</span><span class="p">,</span> <span class="s2">&quot;shovel&quot;</span><span class="p">]</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;digger&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">_destroy_objs_in_room</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parts</span> <span class="o">+</span> <span class="n">results</span><span class="p">))</span>

        <span class="n">nresolutions</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">sps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sps</span><span class="p">)}</span>
        <span class="n">expected</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;dirt&quot;</span><span class="p">:</span> <span class="n">nresolutions</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;digger&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
            <span class="n">nresolutions</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;dirt&quot;</span><span class="p">:</span> <span class="n">nresolutions</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Uppercase puzzle name</span>
        <span class="n">balloon</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Balloon&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Balloon&quot;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Balloon&quot;</span><span class="p">]</span>
        <span class="n">recipe_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;boom!!!&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>

        <span class="n">_destroy_objs_in_room</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">parts</span> <span class="o">+</span> <span class="n">results</span><span class="p">))</span>

        <span class="n">sps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sps</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_dbref</span><span class="p">,</span> <span class="s2">&quot;boom!!!&quot;</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">srs</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles.test_e2e_accumulative"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_e2e_accumulative">[docs]</a>    <span class="k">def</span> <span class="nf">test_e2e_accumulative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">flashlight</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flashlight&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">flashlight_w_1</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">flashlight_w_2</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">flashlight_w_3</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">battery</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="n">battery</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">battery</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">battery</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>

        <span class="c1"># TODO: instead of tagging each flashlight,</span>
        <span class="c1"># arm and resolve each puzzle in order so they all</span>
        <span class="c1"># are tagged correctly</span>
        <span class="c1"># it will be necessary to add/remove parts/results because</span>
        <span class="c1"># each battery is supposed to be consumed during resolution</span>
        <span class="c1"># as the new flashlight has one more battery than before</span>
        <span class="n">flashlight_w_1</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">flashlight_w_2</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>

        <span class="n">recipe_fl1_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;flashlight&quot;</span><span class="p">,</span> <span class="s2">&quot;battery&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">],</span>
            <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">expected_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">recipe_fl2_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">,</span> <span class="s2">&quot;battery&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">],</span>
            <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">recipe_fl3_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;flashlight-3&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">,</span> <span class="s2">&quot;battery&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">],</span>
            <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">expected_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># delete protoparts</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">battery</span><span class="p">,</span> <span class="n">flashlight</span><span class="p">,</span> <span class="n">flashlight_w_1</span><span class="p">,</span> <span class="n">flashlight_w_2</span><span class="p">,</span> <span class="n">flashlight_w_3</span><span class="p">]:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_group_parts</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">excluding</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">dbrefs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">dbref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluding</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                        <span class="n">group</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">group</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">dbref</span><span class="p">)</span>
                    <span class="n">dbrefs</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">dbref</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="n">group</span><span class="p">,</span> <span class="n">dbrefs</span>

        <span class="c1"># arm each puzzle and group its parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_fl1_dbref</span><span class="p">,</span> <span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight&quot;</span><span class="p">])</span>
        <span class="n">fl1_parts</span><span class="p">,</span> <span class="n">fl1_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">([</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_fl2_dbref</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">])</span>
        <span class="n">fl2_parts</span><span class="p">,</span> <span class="n">fl2_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">],</span> <span class="n">excluding</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">fl1_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_fl3_dbref</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">])</span>
        <span class="n">fl3_parts</span><span class="p">,</span> <span class="n">fl3_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">],</span>
            <span class="n">excluding</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fl1_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fl2_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># all batteries have identical protodefs</span>
        <span class="n">battery_1</span> <span class="o">=</span> <span class="n">fl1_dbrefs</span><span class="p">[</span><span class="n">fl1_parts</span><span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">battery_2</span> <span class="o">=</span> <span class="n">fl2_dbrefs</span><span class="p">[</span><span class="n">fl2_parts</span><span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">battery_3</span> <span class="o">=</span> <span class="n">fl3_dbrefs</span><span class="p">[</span><span class="n">fl3_parts</span><span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">protodef_battery_1</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">battery_1</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_battery_1</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="n">protodef_battery_2</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">battery_2</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_battery_2</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="n">protodef_battery_3</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">battery_3</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_battery_3</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">protodef_battery_1</span> <span class="o">==</span> <span class="n">protodef_battery_2</span> <span class="o">==</span> <span class="n">protodef_battery_3</span>

        <span class="c1"># each battery can be used in every other puzzle</span>

        <span class="n">b1_parts_dict</span><span class="p">,</span> <span class="n">b1_puzzlenames</span><span class="p">,</span> <span class="n">b1_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">battery_1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">b1_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">b1_puzzlenames</span><span class="p">,</span> <span class="n">b1_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>

        <span class="n">b2_parts_dict</span><span class="p">,</span> <span class="n">b2_puzzlenames</span><span class="p">,</span> <span class="n">b2_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">battery_2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">b2_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">b2_puzzlenames</span><span class="p">,</span> <span class="n">b2_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>
        <span class="n">b3_parts_dict</span><span class="p">,</span> <span class="n">b3_puzzlenames</span><span class="p">,</span> <span class="n">b3_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">battery_3</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">b3_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">b3_puzzlenames</span><span class="p">,</span> <span class="n">b3_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">battery_1</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">b1_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">battery_2</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">b2_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">battery_3</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">b3_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">b1_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">b2_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">b3_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="n">b1_puzzlenames</span>
            <span class="k">assert</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="n">b2_puzzlenames</span>
            <span class="k">assert</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="n">b3_puzzlenames</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">b1_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">b2_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">b3_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="n">protodef_battery_1</span>
            <span class="o">==</span> <span class="n">protodef_battery_2</span>
            <span class="o">==</span> <span class="n">protodef_battery_3</span>
        <span class="p">)</span>

        <span class="c1"># all flashlights have similar protodefs except their key</span>
        <span class="n">flashlight_1</span> <span class="o">=</span> <span class="n">fl1_dbrefs</span><span class="p">[</span><span class="n">fl1_parts</span><span class="p">[</span><span class="s2">&quot;flashlight&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">flashlight_2</span> <span class="o">=</span> <span class="n">fl2_dbrefs</span><span class="p">[</span><span class="n">fl2_parts</span><span class="p">[</span><span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">flashlight_3</span> <span class="o">=</span> <span class="n">fl3_dbrefs</span><span class="p">[</span><span class="n">fl3_parts</span><span class="p">[</span><span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">protodef_flashlight_1</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">flashlight_1</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_1</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">protodef_flashlight_1</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;flashlight&quot;</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_1</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
        <span class="n">protodef_flashlight_2</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">flashlight_2</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_2</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">protodef_flashlight_2</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;flashlight-w-1&quot;</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_2</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
        <span class="n">protodef_flashlight_3</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">proto_def</span><span class="p">(</span><span class="n">flashlight_3</span><span class="p">,</span> <span class="n">with_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_3</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">protodef_flashlight_3</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;flashlight-w-2&quot;</span>
        <span class="k">del</span> <span class="n">protodef_flashlight_3</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">protodef_flashlight_1</span> <span class="o">==</span> <span class="n">protodef_flashlight_2</span> <span class="o">==</span> <span class="n">protodef_flashlight_3</span>

        <span class="c1"># each flashlight can only be used in its own puzzle</span>

        <span class="n">f1_parts_dict</span><span class="p">,</span> <span class="n">f1_puzzlenames</span><span class="p">,</span> <span class="n">f1_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">flashlight_1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">f1_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">])</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">f1_puzzlenames</span><span class="p">,</span> <span class="n">f1_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>
        <span class="n">f2_parts_dict</span><span class="p">,</span> <span class="n">f2_puzzlenames</span><span class="p">,</span> <span class="n">f2_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">flashlight_2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">f2_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">])</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">f2_puzzlenames</span><span class="p">,</span> <span class="n">f2_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>
        <span class="n">f3_parts_dict</span><span class="p">,</span> <span class="n">f3_puzzlenames</span><span class="p">,</span> <span class="n">f3_protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">flashlight_3</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">f3_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">])</span>
        <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">f3_puzzlenames</span><span class="p">,</span> <span class="n">f3_protodefs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">flashlight_1</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">f1_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">flashlight_2</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">f2_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">flashlight_3</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">f3_parts_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">f1_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">f2_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">f3_puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">):</span>
            <span class="k">assert</span> <span class="n">puzzle_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">,</span> <span class="s2">&quot;puzzle_member&quot;</span><span class="p">]</span>
        <span class="n">protodef_flashlight_1</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;flashlight&quot;</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">f1_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">protodef_flashlight_1</span>
        <span class="n">protodef_flashlight_2</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;flashlight-w-1&quot;</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">f2_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">protodef_flashlight_2</span>
        <span class="n">protodef_flashlight_3</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;flashlight-w-2&quot;</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">f3_protodefs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">protodef_flashlight_3</span>

        <span class="c1"># each battery can be matched with every other flashlight</span>
        <span class="c1"># to potentially resolve each puzzle</span>
        <span class="k">for</span> <span class="n">batt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">battery_1</span><span class="p">,</span> <span class="n">battery_2</span><span class="p">,</span> <span class="n">battery_3</span><span class="p">]:</span>
            <span class="n">parts_dict</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
                <span class="p">[</span><span class="n">batt</span><span class="p">,</span> <span class="n">flashlight_1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="n">flashlight_1</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span>
            <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>
            <span class="n">parts_dict</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
                <span class="p">[</span><span class="n">batt</span><span class="p">,</span> <span class="n">flashlight_2</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="n">flashlight_2</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span>
            <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>
            <span class="n">parts_dict</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_lookups_parts_puzzlenames_protodefs</span><span class="p">(</span>
                <span class="p">[</span><span class="n">batt</span><span class="p">,</span> <span class="n">flashlight_3</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-2&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">batt</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="n">flashlight_3</span><span class="o">.</span><span class="n">dbref</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">puzzlenames</span><span class="p">[</span><span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span>
            <span class="n">_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_puzzles_by_names</span><span class="p">(</span><span class="n">puzzlenames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-2&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight-3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">puzzle_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_puzzles</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">matched_puzzles</span> <span class="o">=</span> <span class="n">puzzles</span><span class="o">.</span><span class="n">_matching_puzzles</span><span class="p">(</span><span class="n">_puzzles</span><span class="p">,</span> <span class="n">puzzlenames</span><span class="p">,</span> <span class="n">protodefs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_puzzles</span><span class="p">)</span>

        <span class="c1"># delete all parts</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">fl1_dbrefs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fl2_dbrefs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fl3_dbrefs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">):</span>
            <span class="n">part</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># arm first puzzle 3 times and group its parts so we can solve</span>
        <span class="c1"># all puzzles with the parts from the 1st armed</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe_fl1_dbref</span><span class="p">,</span> <span class="s2">&quot;flashlight-1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight&quot;</span><span class="p">])</span>
        <span class="n">fl1_parts</span><span class="p">,</span> <span class="n">fl1_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">([</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="s2">&quot;flashlight&quot;</span><span class="p">])</span>

        <span class="c1"># delete the 2 extra flashlights so we can start solving</span>
        <span class="k">for</span> <span class="n">flashlight_dbref</span> <span class="ow">in</span> <span class="n">fl1_parts</span><span class="p">[</span><span class="s2">&quot;flashlight&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">fl1_dbrefs</span><span class="p">[</span><span class="n">flashlight_dbref</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;1-battery, flashlight&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;1-battery, flashlight-w-1&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;battery, flashlight-w-2&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;battery&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-2&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;flashlight-w-3&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestPuzzles.test_e2e_interchangeable_parts_and_results"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestPuzzles.test_e2e_interchangeable_parts_and_results">[docs]</a>    <span class="k">def</span> <span class="nf">test_e2e_interchangeable_parts_and_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Parts and Results can be used in multiple puzzles</span>
        <span class="n">egg</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">flour</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;flour&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">boiling_water</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;boiling water&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">boiled_egg</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;boiled egg&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">dough</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">pasta</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;pasta&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="c1"># Three recipes:</span>
        <span class="c1"># 1. breakfast: egg + boiling water = boiled egg &amp; boiling water</span>
        <span class="c1"># 2. dough: egg + flour = dough</span>
        <span class="c1"># 3. entree: dough + boiling water = pasta &amp; boiling water</span>
        <span class="c1"># tag interchangeable parts according to their puzzles&#39; name</span>
        <span class="n">egg</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;breakfast&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">egg</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">dough</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;entree&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">boiling_water</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;breakfast&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>
        <span class="n">boiling_water</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;entree&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">puzzles</span><span class="o">.</span><span class="n">_PUZZLES_TAG_CATEGORY</span><span class="p">)</span>

        <span class="c1"># create recipes</span>
        <span class="n">recipe1_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;breakfast&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;boiled egg&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">],</span>
            <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">recipe2_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;flour&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;dough&quot;</span><span class="p">],</span> <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">recipe3_dbref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_good_recipe</span><span class="p">(</span>
            <span class="s2">&quot;entree&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;pasta&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">],</span>
            <span class="n">and_destroy_it</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">expected_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># delete protoparts</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">egg</span><span class="p">,</span> <span class="n">flour</span><span class="p">,</span> <span class="n">boiling_water</span><span class="p">,</span> <span class="n">boiled_egg</span><span class="p">,</span> <span class="n">dough</span><span class="p">,</span> <span class="n">pasta</span><span class="p">]:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># arm each puzzle and group its parts</span>
        <span class="k">def</span> <span class="nf">_group_parts</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">excluding</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
            <span class="n">group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">dbrefs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">dbref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluding</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                        <span class="n">group</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">group</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">dbref</span><span class="p">)</span>
                    <span class="n">dbrefs</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">dbref</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="n">group</span><span class="p">,</span> <span class="n">dbrefs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe1_dbref</span><span class="p">,</span> <span class="s2">&quot;breakfast&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">])</span>
        <span class="n">breakfast_parts</span><span class="p">,</span> <span class="n">breakfast_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">([</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe2_dbref</span><span class="p">,</span> <span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;flour&quot;</span><span class="p">])</span>
        <span class="n">dough_parts</span><span class="p">,</span> <span class="n">dough_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;flour&quot;</span><span class="p">],</span> <span class="n">excluding</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">breakfast_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm</span><span class="p">(</span><span class="n">recipe3_dbref</span><span class="p">,</span> <span class="s2">&quot;entree&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">])</span>
        <span class="n">entree_parts</span><span class="p">,</span> <span class="n">entree_dbrefs</span> <span class="o">=</span> <span class="n">_group_parts</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;dough&quot;</span><span class="p">,</span> <span class="s2">&quot;boiling water&quot;</span><span class="p">],</span>
            <span class="n">excluding</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">breakfast_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">dough_dbrefs</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
        <span class="p">)</span>

        <span class="c1"># create a box so we can put all objects in</span>
        <span class="c1"># so that they can&#39;t be found during puzzle resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">create_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_typeclass</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_box_all</span><span class="p">():</span>
            <span class="c1"># print &quot;boxing all\n&quot;, &quot;-&quot;*20</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">]:</span>
                    <span class="n">o</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span>
                    <span class="c1"># print o.key, o.dbref, &quot;boxed&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print &quot;skipped&quot;, o.key, o.dbref</span>
                    <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">_unbox</span><span class="p">(</span><span class="n">dbrefs</span><span class="p">):</span>
            <span class="c1"># print &quot;unboxing&quot;, dbrefs, &quot;\n&quot;, &quot;-&quot;*20</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">dbref</span> <span class="ow">in</span> <span class="n">dbrefs</span><span class="p">:</span>
                    <span class="n">o</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span>
                    <span class="c1"># print &quot;unboxed&quot;, o.key, o.dbref</span>

        <span class="c1"># solve dough puzzle using breakfast&#39;s egg</span>
        <span class="c1"># and dough&#39;s flour. A new dough will be created</span>
        <span class="n">_box_all</span><span class="p">()</span>
        <span class="n">_unbox</span><span class="p">(</span><span class="n">breakfast_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;egg&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">dough_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;flour&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;egg, flour&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>

        <span class="c1"># solve entree puzzle with newly created dough</span>
        <span class="c1"># and breakfast&#39;s boiling water. A new</span>
        <span class="c1"># boiling water and pasta will be created</span>
        <span class="n">_unbox</span><span class="p">(</span><span class="n">breakfast_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;boiling water&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;boiling water, dough&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>

        <span class="c1"># solve breakfast puzzle with dough&#39;s egg</span>
        <span class="c1"># and newly created boiling water. A new</span>
        <span class="c1"># boiling water and boiled egg will be created</span>
        <span class="n">_unbox</span><span class="p">(</span><span class="n">dough_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;egg&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;boiling water, egg&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>

        <span class="c1"># solve entree puzzle using entree&#39;s dough</span>
        <span class="c1"># and newly created boiling water. A new</span>
        <span class="c1"># boiling water and pasta will be created</span>
        <span class="n">_unbox</span><span class="p">(</span><span class="n">entree_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dough&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="s2">&quot;boiling water, dough&quot;</span><span class="p">,</span> <span class="s2">&quot;You are a Genius&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_room_contents</span><span class="p">({</span><span class="s2">&quot;boiling water&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;pasta&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;boiled egg&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span></div></div>


<span class="c1"># Tests for the building_menu contrib</span>
<span class="kn">from</span> <span class="nn">evennia.contrib.building_menu</span> <span class="k">import</span> <span class="n">BuildingMenu</span><span class="p">,</span> <span class="n">CmdNoMatch</span>


<div class="viewcode-block" id="Submenu"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.Submenu">[docs]</a><span class="k">class</span> <span class="nc">Submenu</span><span class="p">(</span><span class="n">BuildingMenu</span><span class="p">):</span>
<div class="viewcode-block" id="Submenu.init"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.Submenu.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestBuildingMenu"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu">[docs]</a><span class="k">class</span> <span class="nc">TestBuildingMenu</span><span class="p">(</span><span class="n">CommandTest</span><span class="p">):</span>
<div class="viewcode-block" id="TestBuildingMenu.setUp"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestBuildingMenu</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span> <span class="o">=</span> <span class="n">BuildingMenu</span><span class="p">(</span><span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_quit"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_quit">[docs]</a>    <span class="k">def</span> <span class="nf">test_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to quit the building menu.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">&quot;building_menu&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">&quot;building_menu&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span>
        <span class="c1"># char1 tries to quit the editor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">&quot;building_menu&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_setattr"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_setattr">[docs]</a>    <span class="k">def</span> <span class="nf">test_setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the simple setattr provided by building menus.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;some new title&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;some new title&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_add_choice_without_key"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_add_choice_without_key">[docs]</a>    <span class="k">def</span> <span class="nf">test_add_choice_without_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to add choices without keys.&quot;&quot;&quot;</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;choice&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">_add_keys_choice</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="s2">&quot;e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ch&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hoi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;choi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hoic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;choic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hoice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;choice&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Adding another key of the same title would break, no more available shortcut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;choice&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">_add_keys_choice</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_callbacks"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">test_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test callbacks in menus.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;room1&quot;</span>

        <span class="k">def</span> <span class="nf">on_enter</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;on_enter:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">menu</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">on_nomatch</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">choice</span><span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;on_nomatch:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">choice</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">on_leave</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;on_leave:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span>
            <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">on_enter</span><span class="o">=</span><span class="n">on_enter</span><span class="p">,</span> <span class="n">on_nomatch</span><span class="o">=</span><span class="n">on_nomatch</span><span class="p">,</span> <span class="n">on_leave</span><span class="o">=</span><span class="n">on_leave</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;on_enter:test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="s2">&quot;on_nomatch:ok,e&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;on_leave:room1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_multi_level"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_multi_level">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test multi-level choices.&quot;&quot;&quot;</span>
        <span class="c1"># Creaste three succeeding menu (t2 is contained in t1, t3 is contained in t2)</span>
        <span class="k">def</span> <span class="nf">on_nomatch_t1</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s2">&quot;whatever&quot;</span><span class="p">)</span>  <span class="c1"># this will be valid since after t1 is a joker</span>

        <span class="k">def</span> <span class="nf">on_nomatch_t2</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s2">&quot;t3&quot;</span><span class="p">)</span>  <span class="c1"># this time the key matters</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;what&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="n">on_nomatch</span><span class="o">=</span><span class="n">on_nomatch_t1</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;t1.*&quot;</span><span class="p">,</span> <span class="n">on_nomatch</span><span class="o">=</span><span class="n">on_nomatch_t2</span><span class="p">)</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;why&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;t1.*.t3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># Move into t1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;t1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>

        <span class="c1"># Move into t2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;t2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>

        <span class="c1"># Move into t3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;t3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">,</span> <span class="n">t3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>

        <span class="c1"># Move back to t2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>

        <span class="c1"># Move back into t1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>

        <span class="c1"># Moves back to the main menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">relevant_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">current_choice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestBuildingMenu.test_submenu"><a class="viewcode-back" href="../../../api/evennia.contrib.html#evennia.contrib.tests.TestBuildingMenu.test_submenu">[docs]</a>    <span class="k">def</span> <span class="nf">test_submenu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test to add sub-menus.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">open_exit</span><span class="p">(</span><span class="n">menu</span><span class="p">):</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">open_submenu</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tests.Submenu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">add_choice</span><span class="p">(</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">on_enter</span><span class="o">=</span><span class="n">open_exit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_building_menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;in&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_building_menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char1</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_building_menu</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">room1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">CmdNoMatch</span><span class="p">(</span><span class="n">building_menu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">menu</span><span class="p">),</span> <span class="s2">&quot;q&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../evennia.html">evennia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<h3>Versions</h3>
<ul>
  <li><a href="../../../../1.0-dev/index.html">1.0-dev (develop branch)</a></li>
  <li><a href="tests.html">0.9.1 (master branch)</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, The Evennia developer community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>