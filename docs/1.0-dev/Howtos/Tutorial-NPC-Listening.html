
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>NPCs that listen to what is said &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NPCs reacting to your presence" href="Tutorial-NPC-Reacting.html" />
    <link rel="prev" title="Give objects weight" href="Howto-Add-Object-Weight.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Tutorial-NPC-Reacting.html" title="NPCs reacting to your presence"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Howto-Add-Object-Weight.html" title="Give objects weight"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Howtos-Overview.html" accesskey="U">Tutorials and Howto’s</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">NPCs that listen to what is said</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">NPCs that listen to what is said</a><ul>
<li><a class="reference internal" href="#assorted-notes">Assorted notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Howto-Add-Object-Weight.html"
                        title="previous chapter">Give objects weight</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Tutorial-NPC-Reacting.html"
                        title="next chapter">NPCs reacting to your presence</a></p>
  <div role="note" aria-label="source link">
    <!--h3>This Page</h3-->
    <ul class="this-page-menu">
      <li><a href="../_sources/Howtos/Tutorial-NPC-Listening.md.txt"
            rel="nofollow">Show Page Source</a></li>
    </ul>
   </div><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="Tutorial-NPC-Listening.html">1.0-dev (develop branch)</a></li>
 <ul>
  <li><a href="../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>

</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="npcs-that-listen-to-what-is-said">
<h1>NPCs that listen to what is said<a class="headerlink" href="#npcs-that-listen-to-what-is-said" title="Permalink to this headline">¶</a></h1>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; say hi 
You say, &quot;hi&quot;
The troll under the bridge answers, &quot;well, well. Hello.&quot;
</pre></div>
</div>
<p>This howto explains how to make an NPC that reacts to characters speaking in their current location. The principle applies to other situations, such as enemies joining a fight or reacting to a character drawing a weapon.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># mygame/typeclasses/npc.py</span>

<span class="kn">from</span> <span class="nn">characters</span> <span class="kn">import</span> <span class="n">Character</span>

<span class="k">class</span> <span class="nc">Npc</span><span class="p">(</span><span class="n">Character</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A NPC typeclass which extends the character class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">at_heard_say</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A simple listener and response. This makes it easy to change for</span>
<span class="sd">        subclasses of NPCs reacting differently to says.       </span>

<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># message will be on the form `&lt;Person&gt; says, &quot;say_text&quot;`</span>
        <span class="c1"># we want to get only say_text without the quotes and any spaces</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;says, &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &quot;&#39;</span><span class="p">)</span>

        <span class="c1"># we&#39;ll make use of this in .msg() below</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">from_obj</span><span class="si">}</span><span class="s2"> said: &#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</pre></div>
</div>
<p>We add a simple method <code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> that formats what it hears. We assume that the message that enters it is on the form <code class="docutils literal notranslate"><span class="pre">Someone</span> <span class="pre">says,</span> <span class="pre">&quot;Hello&quot;</span></code>, and we make sure to only get <code class="docutils literal notranslate"><span class="pre">Hello</span></code> in that example.</p>
<p>We are not actually calling <code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> yet. We’ll handle that next.</p>
<p>When someone in the room speaks to this NPC, its <code class="docutils literal notranslate"><span class="pre">msg</span></code> method will be called. We will modify the
NPCs <code class="docutils literal notranslate"><span class="pre">.msg</span></code> method to catch says so the NPC can respond.</p>
<div class="highlight-python notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><span class="c1"># mygame/typeclasses/npc.py</span>

<span class="kn">from</span> <span class="nn">characters</span> <span class="kn">import</span> <span class="n">Character</span>
<span class="k">class</span> <span class="nc">Npc</span><span class="p">(</span><span class="n">Character</span><span class="p">):</span>

    <span class="c1"># [at_heard_say() goes here]</span>

    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;Custom msg() method reacting to say.&quot;</span>

        <span class="k">if</span> <span class="n">from_obj</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># make sure to not repeat what we ourselves said or we&#39;ll create a loop</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if text comes from a say, `text` is `(&#39;say_text&#39;, {&#39;type&#39;: &#39;say&#39;})`</span>
                <span class="n">say_text</span><span class="p">,</span> <span class="n">is_say</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;say&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_say</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_say</span><span class="p">:</span>
                <span class="c1"># First get the response (if any)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_heard_say</span><span class="p">(</span><span class="n">say_text</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">)</span>
                <span class="c1"># If there is a response</span>
                <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># speak ourselves, using the return</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;say </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>   
    
        <span class="c1"># this is needed if anyone ever puppets this NPC - without it you would never</span>
        <span class="c1"># get any feedback from the server (not even the results of look)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="n">from_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
</pre></div></td></tr></table></div>
</div>
<p>So if the NPC gets a say and that say is not coming from the NPC itself, it will echo it using the
<code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> hook. Some things of note in the above example:</p>
<ul class="simple">
<li><p><strong>Line 15</strong> The <code class="docutils literal notranslate"><span class="pre">text</span></code> input can be on many different forms depending on where this <code class="docutils literal notranslate"><span class="pre">msg</span></code> is called from. If you look at the <a class="reference internal" href="../api/evennia.commands.default.general.html#evennia.commands.default.general.CmdSay" title="evennia.commands.default.general.CmdSay"><span class="xref myst py py-class">code of the ‘say’ command</span></a> you’d find that it will call <code class="docutils literal notranslate"><span class="pre">.msg</span></code>  with <code class="docutils literal notranslate"><span class="pre">(&quot;Hello&quot;,</span> <span class="pre">{&quot;type&quot;:</span> <span class="pre">&quot;say&quot;})</span></code>.  We use this knowledge to figure out if this comes from a <code class="docutils literal notranslate"><span class="pre">say</span></code> or not.</p></li>
<li><p><strong>Line 24</strong>: We use <code class="docutils literal notranslate"><span class="pre">execute_cmd</span></code> to fire the NPCs own <code class="docutils literal notranslate"><span class="pre">say</span></code> command back. This works because the NPC is actually a child of <code class="docutils literal notranslate"><span class="pre">DefaultCharacter</span></code> - so it has the <code class="docutils literal notranslate"><span class="pre">CharacterCmdSet</span></code> on it!  Normally you should use <code class="docutils literal notranslate"><span class="pre">execute_cmd</span></code> only sparingly; it’s usually more efficient to call the actual code used by the Command directly. For this tutorial, invoking the command is shorter to write while making sure all hooks are called</p></li>
<li><p><strong>Line26</strong>: Note the comments about <code class="docutils literal notranslate"><span class="pre">super</span></code> at the end. This will trigger the ‘default’ <code class="docutils literal notranslate"><span class="pre">msg</span></code> (in the parent class) as well. It’s not really necessary as long as no one puppets the NPC (by <code class="docutils literal notranslate"><span class="pre">&#64;ic</span> <span class="pre">&lt;npcname&gt;</span></code>) but it’s wise to keep in there since the puppeting player will be totally blind if <code class="docutils literal notranslate"><span class="pre">msg()</span></code> is never returning anything to them!</p></li>
</ul>
<p>Now that’s done, let’s create an NPC and see what it has to say for itself.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span>
<span class="n">create</span><span class="o">/</span><span class="n">drop</span> <span class="n">Guild</span> <span class="n">Master</span><span class="p">:</span><span class="n">npc</span><span class="o">.</span><span class="n">Npc</span>
</pre></div>
</div>
<p>(you could also give the path as <code class="docutils literal notranslate"><span class="pre">typeclasses.npc.Npc</span></code>, but Evennia will look into the <code class="docutils literal notranslate"><span class="pre">typeclasses</span></code>
folder automatically so this is a little shorter).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; say hi
You say, &quot;hi&quot;
Guild Master says, &quot;Anna said: &#39;hi&#39;&quot;
</pre></div>
</div>
<section id="assorted-notes">
<h2>Assorted notes<a class="headerlink" href="#assorted-notes" title="Permalink to this headline">¶</a></h2>
<p>There are many ways to implement this kind of functionality. An alternative example to overriding
<code class="docutils literal notranslate"><span class="pre">msg</span></code> would be to modify the <code class="docutils literal notranslate"><span class="pre">at_say</span></code> hook on the <em>Character</em> instead. It could detect that it’s
sending to an NPC and call the <code class="docutils literal notranslate"><span class="pre">at_heard_say</span></code> hook directly.</p>
<p>While the tutorial solution has the advantage of being contained only within the NPC class,
combining this with using the Character class gives more direct control over how the NPC will react. Which way to go depends on the design requirements of your particular game.</p>
</section>
</section>


          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Tutorial-NPC-Reacting.html" title="NPCs reacting to your presence"
             >next</a> |</li>
        <li class="right" >
          <a href="Howto-Add-Object-Weight.html" title="Give objects weight"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Howtos-Overview.html" >Tutorials and Howto’s</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">NPCs that listen to what is said</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>