
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.server.evennia_launcher &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.evennia_launcher</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.server.evennia_launcher</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Evennia launcher program</span>

<span class="sd">This is the start point for running Evennia.</span>

<span class="sd">Sets the appropriate environmental variables for managing an Evennia game. It will start and connect</span>
<span class="sd">to the Portal, through which the Server is also controlled. This pprogram</span>

<span class="sd">Run the script with the -h flag to see usage information.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="k">import</span> <span class="n">LooseVersion</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="n">ArgumentParser</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">check_output</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">CalledProcessError</span><span class="p">,</span> <span class="n">STDOUT</span>

<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="k">import</span> <span class="n">amp</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="k">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoints</span>
<span class="kn">import</span> <span class="nn">django</span>
<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="k">import</span> <span class="n">execute_from_command_line</span>
<span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="k">import</span> <span class="n">ProgrammingError</span>

<span class="c1"># Signal processing</span>
<span class="n">SIG</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span>
<span class="n">CTRL_C_EVENT</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Windows SIGINT-like signal</span>

<span class="c1"># Set up the main python paths to Evennia</span>
<span class="n">EVENNIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>

<span class="kn">import</span> <span class="nn">evennia</span>  <span class="c1"># noqa</span>

<span class="n">EVENNIA_LIB</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">evennia</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">EVENNIA_SERVER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_LIB</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">)</span>
<span class="n">EVENNIA_TEMPLATE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_LIB</span><span class="p">,</span> <span class="s2">&quot;game_template&quot;</span><span class="p">)</span>
<span class="n">EVENNIA_PROFILING</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_SERVER</span><span class="p">,</span> <span class="s2">&quot;profiling&quot;</span><span class="p">)</span>
<span class="n">EVENNIA_DUMMYRUNNER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_PROFILING</span><span class="p">,</span> <span class="s2">&quot;dummyrunner.py&quot;</span><span class="p">)</span>

<span class="n">TWISTED_BINARY</span> <span class="o">=</span> <span class="s2">&quot;twistd&quot;</span>

<span class="c1"># Game directory structure</span>
<span class="n">SETTINGFILE</span> <span class="o">=</span> <span class="s2">&quot;settings.py&quot;</span>
<span class="n">SERVERDIR</span> <span class="o">=</span> <span class="s2">&quot;server&quot;</span>
<span class="n">CONFDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">)</span>
<span class="n">SETTINGS_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFDIR</span><span class="p">,</span> <span class="n">SETTINGFILE</span><span class="p">)</span>
<span class="n">SETTINGS_DOTPATH</span> <span class="o">=</span> <span class="s2">&quot;server.conf.settings&quot;</span>
<span class="n">CURRENT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">GAMEDIR</span> <span class="o">=</span> <span class="n">CURRENT_DIR</span>

<span class="c1"># Operational setup</span>

<span class="n">SERVER_LOGFILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">PORTAL_LOGFILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">HTTP_LOGFILE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">SERVER_PIDFILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">PORTAL_PIDFILE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">SERVER_PY_FILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">PORTAL_PY_FILE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">SPROFILER_LOGFILE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">PPROFILER_LOGFILE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">TEST_MODE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ENFORCED_SETTING</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">REACTOR_RUN</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">NO_REACTOR_STOP</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># communication constants</span>

<span class="n">AMP_PORT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">AMP_HOST</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">AMP_INTERFACE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">AMP_CONNECTION</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">SRELOAD</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>  <span class="c1"># server reloading (have portal start a new server)</span>
<span class="n">SSTART</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># server start</span>
<span class="n">PSHUTD</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># portal (+server) shutdown</span>
<span class="n">SSHUTD</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>  <span class="c1"># server-only shutdown</span>
<span class="n">PSTATUS</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>  <span class="c1"># ping server or portal status</span>
<span class="n">SRESET</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>  <span class="c1"># shutdown server in reset mode</span>

<span class="c1"># requirements</span>
<span class="n">PYTHON_MIN</span> <span class="o">=</span> <span class="s2">&quot;3.7&quot;</span>
<span class="n">TWISTED_MIN</span> <span class="o">=</span> <span class="s2">&quot;18.0.0&quot;</span>
<span class="n">DJANGO_MIN</span> <span class="o">=</span> <span class="s2">&quot;2.2.5&quot;</span>
<span class="n">DJANGO_LT</span> <span class="o">=</span> <span class="s2">&quot;3.0&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EVENNIA_ROOT</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EVENNIA_ROOT</span><span class="p">)</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Messages</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>

<span class="n">CREATED_NEW_GAMEDIR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Welcome to Evennia!</span>
<span class="s2">    Created a new Evennia game directory &#39;</span><span class="si">{gamedir}</span><span class="s2">&#39;.</span>

<span class="s2">    You can now optionally edit your new settings file</span>
<span class="s2">    at </span><span class="si">{settings_path}</span><span class="s2">. If you don&#39;t, the defaults</span>
<span class="s2">    will work out of the box. When ready to continue, &#39;cd&#39; to your</span>
<span class="s2">    game directory and run:</span>

<span class="s2">       evennia migrate</span>

<span class="s2">    This initializes the database. To start the server for the first</span>
<span class="s2">    time, run:</span>

<span class="s2">       evennia start</span>

<span class="s2">    Make sure to create a superuser when asked for it (the email is optional)</span>
<span class="s2">    You should now be able to connect to your server on &#39;localhost&#39;, port 4000</span>
<span class="s2">    using a telnet/mud client or http://localhost:4001 using your web browser.</span>
<span class="s2">    If things don&#39;t work, check the log with `evennia --log`. Also make sure</span>
<span class="s2">    ports are open.</span>

<span class="s2">    (Finally, why not run `evennia connections` and make the world aware of</span>
<span class="s2">    your new Evennia project!)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_INPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Command</span>
<span class="s2">      </span><span class="si">{args}</span><span class="s2"> </span><span class="si">{kwargs}</span><span class="s2"></span>
<span class="s2">    raised an error: &#39;</span><span class="si">{traceback}</span><span class="s2">&#39;.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ERROR_NO_ALT_GAMEDIR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    The path &#39;</span><span class="si">{gamedir}</span><span class="s2">&#39; could not be found.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ERROR_NO_GAMEDIR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: No Evennia settings file was found. Evennia looks for the</span>
<span class="s2">    file in your game directory as ./server/conf/settings.py.</span>

<span class="s2">    You must run this command from somewhere inside a valid game</span>
<span class="s2">    directory first created with</span>

<span class="s2">        evennia --init mygamename</span>

<span class="s2">    If you are in a game directory but is missing a settings.py file,</span>
<span class="s2">    it may be because you have git-cloned an existing game directory.</span>
<span class="s2">    The settings.py file is not cloned by git (it&#39;s in .gitignore)</span>
<span class="s2">    since it can contain sensitive and/or server-specific information.</span>
<span class="s2">    You can create a new, empty settings file with</span>

<span class="s2">        evennia --initsettings</span>

<span class="s2">    If cloning the settings file is not a problem you could manually</span>
<span class="s2">    copy over the old settings file or remove its entry in .gitignore</span>

<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">WARNING_MOVING_SUPERUSER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    WARNING: Evennia expects an Account superuser with id=1. No such</span>
<span class="s2">    Account was found. However, another superuser (&#39;</span><span class="si">{other_key}</span><span class="s2">&#39;,</span>
<span class="s2">    id=</span><span class="si">{other_id}</span><span class="s2">) was found in the database. If you just created this</span>
<span class="s2">    superuser and still see this text it is probably due to the</span>
<span class="s2">    database being flushed recently - in this case the database&#39;s</span>
<span class="s2">    internal auto-counter might just start from some value higher than</span>
<span class="s2">    one.</span>

<span class="s2">    We will fix this by assigning the id 1 to Account &#39;</span><span class="si">{other_key}</span><span class="s2">&#39;.</span>
<span class="s2">    Please confirm this is acceptable before continuing.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">WARNING_RUNSERVER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    WARNING: There is no need to run the Django development</span>
<span class="s2">    webserver to test out Evennia web features (the web client</span>
<span class="s2">    will in fact not work since the Django test server knows</span>
<span class="s2">    nothing about MUDs).  Instead, just start Evennia with the</span>
<span class="s2">    webserver component active (this is the default).</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_SETTINGS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: There was an error importing Evennia&#39;s config file</span>
<span class="s2">    </span><span class="si">{settingspath}</span><span class="s2">.</span>
<span class="s2">    There is usually one of three reasons for this:</span>
<span class="s2">        1) You are not running this command from your game directory.</span>
<span class="s2">           Change directory to your game directory and try again (or</span>
<span class="s2">           create a new game directory using evennia --init &lt;dirname&gt;)</span>
<span class="s2">        2) The settings file contains a syntax error. If you see a</span>
<span class="s2">           traceback above, review it, resolve the problem and try again.</span>
<span class="s2">        3) Django is not correctly installed. This usually shows as</span>
<span class="s2">           errors mentioning &#39;DJANGO_SETTINGS_MODULE&#39;. If you run a</span>
<span class="s2">           virtual machine, it might be worth to restart it to see if</span>
<span class="s2">           this resolves the issue.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">settingspath</span><span class="o">=</span><span class="n">SETTINGS_PATH</span>
<span class="p">)</span>

<span class="n">ERROR_INITSETTINGS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: &#39;evennia --initsettings&#39; must be called from the root of</span>
<span class="s2">    your game directory, since it tries to (re)create the new</span>
<span class="s2">    settings.py file in a subfolder server/conf/.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">RECREATED_SETTINGS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (Re)created an empty settings file in server/conf/settings.py.</span>

<span class="s2">    Note that if you were using an existing database, the password</span>
<span class="s2">    salt of this new settings file will be different from the old one.</span>
<span class="s2">    This means that any existing accounts may not be able to log in to</span>
<span class="s2">    their accounts with their old passwords.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_INITMISSING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: &#39;evennia --initmissing&#39; must be called from the root of</span>
<span class="s2">    your game directory, since it tries to create any missing files</span>
<span class="s2">    in the server/ subfolder.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">RECREATED_MISSING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (Re)created any missing directories or files.  Evennia should</span>
<span class="s2">    be ready to run now!</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_DATABASE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Your database does not exist or is not set up correctly.</span>
<span class="s2">    (error was &#39;</span><span class="si">{traceback}</span><span class="s2">&#39;)</span>

<span class="s2">    If you think your database should work, make sure you are running your</span>
<span class="s2">    commands from inside your game directory. If this error persists, run</span>

<span class="s2">       evennia migrate</span>

<span class="s2">    to initialize/update the database according to your settings.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_WINDOWS_WIN32API</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Unable to import win32api, which Twisted requires to run.</span>
<span class="s2">    You may download it from:</span>

<span class="s2">    http://sourceforge.net/projects/pywin32/files/pywin32/</span>

<span class="s2">    If you are running in a virtual environment, browse to the</span>
<span class="s2">    location of the latest win32api exe file for your computer and</span>
<span class="s2">    Python version and copy the url to it; then paste it into a call</span>
<span class="s2">    to easy_install:</span>

<span class="s2">        easy_install http://&lt;url to win32api exe&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">INFO_WINDOWS_BATFILE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    INFO: Since you are running Windows, a file &#39;twistd.bat&#39; was</span>
<span class="s2">    created for you. This is a simple batch file that tries to call</span>
<span class="s2">    the twisted executable. Evennia determined this to be:</span>

<span class="s2">       </span><span class="si">{twistd_path}</span><span class="s2"></span>

<span class="s2">    If you run into errors at startup you might need to edit</span>
<span class="s2">    twistd.bat to point to the actual location of the Twisted</span>
<span class="s2">    executable (usually called twistd.py) on your machine.</span>

<span class="s2">    This procedure is only done once. Run `evennia` again when you</span>
<span class="s2">    are ready to start the server.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">CMDLINE_HELP</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Starts, initializes, manages and operates the Evennia MU* server.</span>
<span class="s2">Most standard django management commands are also accepted.&quot;&quot;&quot;</span>


<span class="n">VERSION_INFO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Evennia </span><span class="si">{version}</span><span class="s2"></span>
<span class="s2">    OS: </span><span class="si">{os}</span><span class="s2"></span>
<span class="s2">    Python: </span><span class="si">{python}</span><span class="s2"></span>
<span class="s2">    Twisted: </span><span class="si">{twisted}</span><span class="s2"></span>
<span class="s2">    Django: </span><span class="si">{django}{about}</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ABOUT_INFO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Evennia MUD/MUX/MU* development system</span>

<span class="s2">    Licence: BSD 3-Clause Licence</span>
<span class="s2">    Web: http://www.evennia.com</span>
<span class="s2">    Irc: #evennia on FreeNode</span>
<span class="s2">    Forum: http://www.evennia.com/discussions</span>
<span class="s2">    Maintainer (2006-10): Greg Taylor</span>
<span class="s2">    Maintainer (2010-):   Griatch (griatch AT gmail DOT com)</span>

<span class="s2">    Use -h for command line options.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">HELP_ENTRY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Evennia has two processes, the &#39;Server&#39; and the &#39;Portal&#39;.</span>
<span class="s2">    External users connect to the Portal while the Server runs the</span>
<span class="s2">    game/database. Restarting the Server will refresh code but not</span>
<span class="s2">    disconnect users.</span>

<span class="s2">    To start a new game, use &#39;evennia --init mygame&#39;.</span>
<span class="s2">    For more ways to operate and manage Evennia, see &#39;evennia -h&#39;.</span>

<span class="s2">    If you want to add unit tests to your game, see</span>
<span class="s2">        https://github.com/evennia/evennia/wiki/Unit-Testing</span>

<span class="s2">    Evennia&#39;s manual is found here:</span>
<span class="s2">        https://github.com/evennia/evennia/wiki</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">MENU</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    +----Evennia Launcher-------------------------------------------+</span>
<span class="s2">    </span><span class="si">{gameinfo}</span><span class="s2"></span>
<span class="s2">    +--- Common operations -----------------------------------------+</span>
<span class="s2">    |  1) Start                       (also restart stopped Server) |</span>
<span class="s2">    |  2) Reload               (stop/start Server in &#39;reload&#39; mode) |</span>
<span class="s2">    |  3) Stop                         (shutdown Portal and Server) |</span>
<span class="s2">    |  4) Reboot                            (shutdown then restart) |</span>
<span class="s2">    +--- Other operations ------------------------------------------+</span>
<span class="s2">    |  5) Reset              (stop/start Server in &#39;shutdown&#39; mode) |</span>
<span class="s2">    |  6) Stop Server only                                          |</span>
<span class="s2">    |  7) Kill Server only            (send kill signal to process) |</span>
<span class="s2">    |  8) Kill Portal + Server                                      |</span>
<span class="s2">    +--- Information -----------------------------------------------+</span>
<span class="s2">    |  9) Tail log files      (quickly see errors - Ctrl-C to exit) |</span>
<span class="s2">    | 10) Status                                                    |</span>
<span class="s2">    | 11) Port info                                                 |</span>
<span class="s2">    +--- Testing ---------------------------------------------------+</span>
<span class="s2">    | 12) Test gamedir             (run gamedir test suite, if any) |</span>
<span class="s2">    | 13) Test Evennia                     (run Evennia test suite) |</span>
<span class="s2">    +---------------------------------------------------------------+</span>
<span class="s2">    |  h) Help               i) About info                q) Abort  |</span>
<span class="s2">    +---------------------------------------------------------------+&quot;&quot;&quot;</span>

<span class="n">ERROR_AMP_UNCONFIGURED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Can&#39;t find server info for connecting. Either run this command from</span>
<span class="s2">    the game dir (it will then use the game&#39;s settings file) or specify</span>
<span class="s2">    the path to your game&#39;s settings file manually with the --settings</span>
<span class="s2">    option.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_LOGDIR_MISSING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: One or more log-file directory locations could not be</span>
<span class="s2">    found:</span>

<span class="s2">    </span><span class="si">{logfiles}</span><span class="s2"></span>

<span class="s2">    This is simple to fix: Just manually create the missing log</span>
<span class="s2">    directory (or directories) and re-launch the server (the log files</span>
<span class="s2">    will be created automatically).</span>

<span class="s2">    (Explanation: Evennia creates the log directory automatically when</span>
<span class="s2">    initializing a new game directory. This error usually happens if</span>
<span class="s2">    you used git to clone a pre-created game directory - since log</span>
<span class="s2">    files are in .gitignore they will not be cloned, which leads to</span>
<span class="s2">    the log directory also not being created.)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_PYTHON_VERSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Python </span><span class="si">{pversion}</span><span class="s2"> used. Evennia requires version</span>
<span class="s2">    </span><span class="si">{python_min}</span><span class="s2"> or higher.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_TWISTED_VERSION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Twisted </span><span class="si">{tversion}</span><span class="s2"> found. Evennia requires</span>
<span class="s2">    version </span><span class="si">{twisted_min}</span><span class="s2"> or higher.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_NOTWISTED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Twisted does not seem to be installed.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_DJANGO_MIN</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Django </span><span class="si">{dversion}</span><span class="s2"> found. Evennia requires at least version </span><span class="si">{django_min}</span><span class="s2"> (but</span>
<span class="s2">    no higher than </span><span class="si">{django_lt}</span><span class="s2">).</span>

<span class="s2">    If you are using a virtualenv, use the command `pip install --upgrade -e evennia` where</span>
<span class="s2">    `evennia` is the folder to where you cloned the Evennia library. If not</span>
<span class="s2">    in a virtualenv you can install django with for example `pip install --upgrade django`</span>
<span class="s2">    or with `pip install django==</span><span class="si">{django_min}</span><span class="s2">` to get a specific version.</span>

<span class="s2">    It&#39;s also a good idea to run `evennia migrate` after this upgrade. Ignore</span>
<span class="s2">    any warnings and don&#39;t run `makemigrate` even if told to.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">NOTE_DJANGO_NEW</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    NOTE: Django </span><span class="si">{dversion}</span><span class="s2"> found. This is newer than Evennia&#39;s</span>
<span class="s2">    recommended version (</span><span class="si">{django_rec}</span><span class="s2">). It might work, but is new</span>
<span class="s2">    enough to not be fully tested yet. Report any issues.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">ERROR_NODJANGO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ERROR: Django does not seem to be installed.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">NOTE_KEYBOARDINTERRUPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    STOP: Caught keyboard interrupt while in interactive mode.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">NOTE_TEST_DEFAULT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TESTING: Using Evennia&#39;s default settings file (evennia.settings_default).</span>
<span class="s2">    (use &#39;evennia test --settings settings.py .&#39; to run only your custom game tests)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">NOTE_TEST_CUSTOM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    TESTING: Using specified settings file &#39;</span><span class="si">{settings_dotpath}</span><span class="s2">&#39;.</span>

<span class="s2">    OBS: Evennia&#39;s full test suite may not pass if the settings are very</span>
<span class="s2">    different from the default (use &#39;evennia test evennia&#39; to run core tests)</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">PROCESS_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    </span><span class="si">{component}</span><span class="s2"> process error: </span><span class="si">{traceback}</span><span class="s2">.</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="n">PORTAL_INFO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{servername}</span><span class="s2"> Portal </span><span class="si">{version}</span><span class="s2"></span>
<span class="s2">    external ports:</span>
<span class="s2">        </span><span class="si">{telnet}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{telnet_ssl}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{ssh}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{webserver_proxy}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{webclient}</span><span class="s2"></span>
<span class="s2">    internal_ports (to Server):</span>
<span class="s2">        </span><span class="si">{webserver_internal}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{amp}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">SERVER_INFO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{servername}</span><span class="s2"> Server </span><span class="si">{version}</span><span class="s2"></span>
<span class="s2">    internal ports (to Portal):</span>
<span class="s2">        </span><span class="si">{webserver}</span><span class="s2"></span>
<span class="s2">        </span><span class="si">{amp}</span><span class="s2"></span>
<span class="s2">    </span><span class="si">{irc_rss}</span><span class="s2"></span>
<span class="s2">    </span><span class="si">{info}</span><span class="s2"></span>
<span class="s2">    </span><span class="si">{errors}</span><span class="s2">&quot;&quot;&quot;</span>


<span class="n">ARG_OPTIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Actions on installed server. One of:</span>
<span class="s2"> start       - launch server+portal if not running</span>
<span class="s2"> reload      - restart server in &#39;reload&#39; mode</span>
<span class="s2"> stop        - shutdown server+portal</span>
<span class="s2"> reboot      - shutdown server+portal, then start again</span>
<span class="s2"> reset       - restart server in &#39;shutdown&#39; mode</span>
<span class="s2"> istart      - start server in foreground (until reload)</span>
<span class="s2"> ipstart     - start portal in foreground</span>
<span class="s2"> sstop       - stop only server</span>
<span class="s2"> kill        - send kill signal to portal+server (force)</span>
<span class="s2"> skill       - send kill signal only to server</span>
<span class="s2"> status      - show server and portal run state</span>
<span class="s2"> info        - show server and portal port info</span>
<span class="s2"> menu        - show a menu of options</span>
<span class="s2"> connections - show connection wizard</span>
<span class="s2">Others, like migrate, test and shell is passed on to Django.&quot;&quot;&quot;</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Private helper functions</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_is_windows</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span>


<span class="k">def</span> <span class="nf">_file_names_compact</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="n">filepath2</span><span class="p">):</span>
    <span class="s2">&quot;Compact the output of filenames with same base dir&quot;</span>
    <span class="n">dirname1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath1</span><span class="p">)</span>
    <span class="n">dirname2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirname1</span> <span class="o">==</span> <span class="n">dirname2</span><span class="p">:</span>
        <span class="n">name2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath2</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="n">name2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="n">filepath2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_print_info</span><span class="p">(</span><span class="n">portal_info_dict</span><span class="p">,</span> <span class="n">server_info_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format info dicts from the Portal/Server for display</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">8</span>

    <span class="k">def</span> <span class="nf">_prepare_dict</span><span class="p">(</span><span class="n">dct</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_strip_empty_lines</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="n">pstr</span><span class="p">,</span> <span class="n">sstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">portal_info_dict</span><span class="p">:</span>
        <span class="n">pdict</span> <span class="o">=</span> <span class="n">_prepare_dict</span><span class="p">(</span><span class="n">portal_info_dict</span><span class="p">)</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="n">_strip_empty_lines</span><span class="p">(</span><span class="n">PORTAL_INFO</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">pdict</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">server_info_dict</span><span class="p">:</span>
        <span class="n">sdict</span> <span class="o">=</span> <span class="n">_prepare_dict</span><span class="p">(</span><span class="n">server_info_dict</span><span class="p">)</span>
        <span class="n">sstr</span> <span class="o">=</span> <span class="n">_strip_empty_lines</span><span class="p">(</span><span class="n">SERVER_INFO</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">sdict</span><span class="p">))</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">pstr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">sstr</span> <span class="k">if</span> <span class="n">sstr</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">maxwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">top_border</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxwidth</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Evennia &quot;</span> <span class="o">+</span> <span class="s2">&quot;---&quot;</span>
    <span class="n">border</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxwidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">top_border</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">info</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">border</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="s2">&quot;Unpack the status information&quot;</span>
    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_get_twistd_cmdline</span><span class="p">(</span><span class="n">pprofiler</span><span class="p">,</span> <span class="n">sprofiler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compile the command line for starting a Twisted application using the &#39;twistd&#39; executable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">portal_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">TWISTED_BINARY</span><span class="p">,</span> <span class="s2">&quot;--python=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PORTAL_PY_FILE</span><span class="p">)]</span>
    <span class="n">server_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">TWISTED_BINARY</span><span class="p">,</span> <span class="s2">&quot;--python=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SERVER_PY_FILE</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
        <span class="c1"># PID files only for UNIX</span>
        <span class="n">portal_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--pidfile=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PORTAL_PIDFILE</span><span class="p">))</span>
        <span class="n">server_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--pidfile=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pprofiler</span><span class="p">:</span>
        <span class="n">portal_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;--savestats&quot;</span><span class="p">,</span> <span class="s2">&quot;--profiler=cprofile&quot;</span><span class="p">,</span> <span class="s2">&quot;--profile=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PPROFILER_LOGFILE</span><span class="p">)]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">sprofiler</span><span class="p">:</span>
        <span class="n">server_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;--savestats&quot;</span><span class="p">,</span> <span class="s2">&quot;--profiler=cprofile&quot;</span><span class="p">,</span> <span class="s2">&quot;--profile=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SPROFILER_LOGFILE</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">portal_cmd</span><span class="p">,</span> <span class="n">server_cmd</span>


<span class="k">def</span> <span class="nf">_reactor_stop</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">NO_REACTOR_STOP</span><span class="p">:</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#  Protocol Evennia launcher - Portal/Server communication</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>


<div class="viewcode-block" id="MsgStatus"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.MsgStatus">[docs]</a><span class="k">class</span> <span class="nc">MsgStatus</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ping between AMP services</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;MsgStatus&quot;</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">String</span><span class="p">())]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="ne">Exception</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;EXCEPTION&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">String</span><span class="p">())]</span></div>


<div class="viewcode-block" id="MsgLauncher2Portal"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.MsgLauncher2Portal">[docs]</a><span class="k">class</span> <span class="nc">MsgLauncher2Portal</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">Command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Message Launcher -&gt; Portal</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;MsgLauncher2Portal&quot;</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">b</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">String</span><span class="p">())]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="ne">Exception</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;EXCEPTION&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="AMPLauncherProtocol"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.AMPLauncherProtocol">[docs]</a><span class="k">class</span> <span class="nc">AMPLauncherProtocol</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">AMP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines callbacks to the launcher</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AMPLauncherProtocol.__init__"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.AMPLauncherProtocol.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_status</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="AMPLauncherProtocol.wait_for_status"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.AMPLauncherProtocol.wait_for_status">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a waiter for a status return.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="AMPLauncherProtocol.receive_status_from_portal"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.AMPLauncherProtocol.receive_status_from_portal">[docs]</a>    <span class="nd">@MsgStatus</span><span class="o">.</span><span class="n">responder</span>
    <span class="k">def</span> <span class="nf">receive_status_from_portal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a status signal from portal - fire next queued</span>
<span class="sd">        callback</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_status</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)}</span></div></div>


<div class="viewcode-block" id="send_instruction"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.send_instruction">[docs]</a><span class="k">def</span> <span class="nf">send_instruction</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send instruction and handle the response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">AMP_CONNECTION</span><span class="p">,</span> <span class="n">REACTOR_RUN</span>

    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AMP_HOST</span><span class="p">,</span> <span class="n">AMP_PORT</span><span class="p">,</span> <span class="n">AMP_INTERFACE</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_AMP_UNCONFIGURED</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_errback</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">errback</span><span class="p">:</span>
            <span class="n">errback</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_connect</span><span class="p">(</span><span class="n">prot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This fires with the protocol when connection is established. We</span>
<span class="sd">        immediately send off the instruction</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">AMP_CONNECTION</span>
        <span class="n">AMP_CONNECTION</span> <span class="o">=</span> <span class="n">prot</span>
        <span class="n">_send</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_connect_fail</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="s2">&quot;This is called if portal is not reachable.&quot;</span>
        <span class="n">errback</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_send</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="n">PSTATUS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMP_CONNECTION</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="n">MsgStatus</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span>
                <span class="n">_callback</span><span class="p">,</span> <span class="n">_errback</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMP_CONNECTION</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span>
                <span class="n">MsgLauncher2Portal</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">_callback</span><span class="p">,</span> <span class="n">_errback</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">AMP_CONNECTION</span><span class="p">:</span>
        <span class="c1"># already connected - send right away</span>
        <span class="k">return</span> <span class="n">_send</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># we must connect first, send once connected</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">TCP4ClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">AMP_HOST</span><span class="p">,</span> <span class="n">AMP_PORT</span><span class="p">)</span>
        <span class="n">deferred</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">connectProtocol</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">AMPLauncherProtocol</span><span class="p">())</span>
        <span class="n">deferred</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">_on_connect</span><span class="p">,</span> <span class="n">_on_connect_fail</span><span class="p">)</span>
        <span class="n">REACTOR_RUN</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">deferred</span></div>


<div class="viewcode-block" id="query_status"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.query_status">[docs]</a><span class="k">def</span> <span class="nf">query_status</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send status ping to portal</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wmap</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;NOT RUNNING&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pstatus</span><span class="p">,</span> <span class="n">sstatus</span><span class="p">,</span> <span class="n">ppid</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">,</span> <span class="n">sinfo</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Portal: </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">Server: </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">wmap</span><span class="p">[</span><span class="n">pstatus</span><span class="p">],</span>
                    <span class="s2">&quot; (pid </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_pid</span><span class="p">(</span><span class="n">PORTAL_PIDFILE</span><span class="p">,</span> <span class="n">ppid</span><span class="p">))</span> <span class="k">if</span> <span class="n">pstatus</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">wmap</span><span class="p">[</span><span class="n">sstatus</span><span class="p">],</span>
                    <span class="s2">&quot; (pid </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_pid</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="n">spid</span><span class="p">))</span> <span class="k">if</span> <span class="n">sstatus</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_errback</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="n">pstatus</span><span class="p">,</span> <span class="n">sstatus</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portal: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Server: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="n">pstatus</span><span class="p">],</span> <span class="n">wmap</span><span class="p">[</span><span class="n">sstatus</span><span class="p">]))</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_callback</span><span class="p">,</span> <span class="n">_errback</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_status_reply"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.wait_for_status_reply">[docs]</a><span class="k">def</span> <span class="nf">wait_for_status_reply</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for an explicit STATUS signal to be sent back from Evennia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">AMP_CONNECTION</span><span class="p">:</span>
        <span class="n">AMP_CONNECTION</span><span class="o">.</span><span class="n">wait_for_status</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Evennia connection established.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_status"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.wait_for_status">[docs]</a><span class="k">def</span> <span class="nf">wait_for_status</span><span class="p">(</span>
    <span class="n">portal_running</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">server_running</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">20</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repeat the status ping until the desired state combination is achieved.</span>

<span class="sd">    Args:</span>
<span class="sd">        portal_running (bool or None): Desired portal run-state. If None, any state</span>
<span class="sd">            is accepted.</span>
<span class="sd">        server_running (bool or None): Desired server run-state. If None, any state</span>
<span class="sd">            is accepted. The portal must be running.</span>
<span class="sd">        callback (callable): Will be called with portal_state, server_state when</span>
<span class="sd">            condition is fulfilled.</span>
<span class="sd">        errback (callable): Will be called with portal_state, server_state if the</span>
<span class="sd">            request is timed out.</span>
<span class="sd">        rate (float): How often to retry.</span>
<span class="sd">        retries (int): How many times to retry before timing out and calling `errback`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">portal_running</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prun</span> <span class="o">==</span> <span class="n">portal_running</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">server_running</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">srun</span> <span class="o">==</span> <span class="n">server_running</span>
        <span class="p">):</span>
            <span class="c1"># the correct state was achieved</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_reactor_stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">errback</span><span class="p">:</span>
                    <span class="n">errback</span><span class="p">(</span><span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection to Evennia timed out. Try again.&quot;</span><span class="p">)</span>
                    <span class="n">_reactor_stop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span>
                    <span class="n">rate</span><span class="p">,</span>
                    <span class="n">wait_for_status</span><span class="p">,</span>
                    <span class="n">portal_running</span><span class="p">,</span>
                    <span class="n">server_running</span><span class="p">,</span>
                    <span class="n">callback</span><span class="p">,</span>
                    <span class="n">errback</span><span class="p">,</span>
                    <span class="n">rate</span><span class="p">,</span>
                    <span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_errback</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Portal not running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">portal_running</span><span class="p">:</span>
            <span class="c1"># this is what we want</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">portal_running</span><span class="p">,</span> <span class="n">server_running</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_reactor_stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">errback</span><span class="p">:</span>
                    <span class="n">errback</span><span class="p">(</span><span class="n">portal_running</span><span class="p">,</span> <span class="n">server_running</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection to Evennia timed out. Try again.&quot;</span><span class="p">)</span>
                    <span class="n">_reactor_stop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span>
                    <span class="n">rate</span><span class="p">,</span>
                    <span class="n">wait_for_status</span><span class="p">,</span>
                    <span class="n">portal_running</span><span class="p">,</span>
                    <span class="n">server_running</span><span class="p">,</span>
                    <span class="n">callback</span><span class="p">,</span>
                    <span class="n">errback</span><span class="p">,</span>
                    <span class="n">rate</span><span class="p">,</span>
                    <span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_callback</span><span class="p">,</span> <span class="n">_errback</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#  Operational functions</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>


<div class="viewcode-block" id="collectstatic"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.collectstatic">[docs]</a><span class="k">def</span> <span class="nf">collectstatic</span><span class="p">():</span>
    <span class="s2">&quot;Run the collectstatic django command&quot;</span>
    <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s2">&quot;collectstatic&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_evennia"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.start_evennia">[docs]</a><span class="k">def</span> <span class="nf">start_evennia</span><span class="p">(</span><span class="n">pprofiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sprofiler</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will start Evennia anew by launching the Evennia Portal (which in turn</span>
<span class="sd">    will start the Server)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">portal_cmd</span><span class="p">,</span> <span class="n">server_cmd</span> <span class="o">=</span> <span class="n">_get_twistd_cmdline</span><span class="p">(</span><span class="n">pprofiler</span><span class="p">,</span> <span class="n">sprofiler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fail</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_server_started</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server started.</span><span class="se">\n</span><span class="s2">Evennia running.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">,</span> <span class="n">sinfo</span> <span class="o">=</span> <span class="n">response</span>
            <span class="n">_print_info</span><span class="p">(</span><span class="n">pinfo</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_portal_started</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;... Portal started.</span><span class="se">\n</span><span class="s2">Server starting </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;(under cProfile)&quot;</span> <span class="k">if</span> <span class="n">sprofiler</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_started</span><span class="p">)</span>
        <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSTART</span><span class="p">,</span> <span class="n">server_cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">ppid</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portal is already running as process </span><span class="si">{pid}</span><span class="s2">. Not restarted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">ppid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">srun</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server is already running as process </span><span class="si">{pid}</span><span class="s2">. Not restarted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">spid</span><span class="p">))</span>
            <span class="n">_reactor_stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server starting </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;(under cProfile)&quot;</span> <span class="k">if</span> <span class="n">sprofiler</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSTART</span><span class="p">,</span> <span class="n">server_cmd</span><span class="p">,</span> <span class="n">_server_started</span><span class="p">,</span> <span class="n">_fail</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portal starting </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;(under cProfile)&quot;</span> <span class="k">if</span> <span class="n">pprofiler</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="c1"># Windows requires special care</span>
                <span class="n">create_no_window</span> <span class="o">=</span> <span class="mh">0x08000000</span>
                <span class="n">Popen</span><span class="p">(</span><span class="n">portal_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">create_no_window</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Popen</span><span class="p">(</span><span class="n">portal_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">PROCESS_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">&quot;Portal&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
            <span class="n">_reactor_stop</span><span class="p">()</span>
        <span class="n">wait_for_status</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_started</span><span class="p">)</span>

    <span class="n">collectstatic</span><span class="p">()</span>
    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="reload_evennia"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.reload_evennia">[docs]</a><span class="k">def</span> <span class="nf">reload_evennia</span><span class="p">(</span><span class="n">sprofiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will instruct the Portal to reboot the Server component. We</span>
<span class="sd">    do this manually by telling the server to shutdown (in reload mode)</span>
<span class="sd">    and wait for the portal to report back, at which point we start the</span>
<span class="sd">    server again. This way we control the process exactly.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">server_cmd</span> <span class="o">=</span> <span class="n">_get_twistd_cmdline</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">sprofiler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_server_restarted</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server re-started.&quot;</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_server_reloaded</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span> <span class="k">if</span> <span class="n">reset</span> <span class="k">else</span> <span class="s2">&quot;reloaded&quot;</span><span class="p">))</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_server_stopped</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_reloaded</span><span class="p">)</span>
        <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSTART</span><span class="p">,</span> <span class="n">server_cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srun</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;resetting&quot;</span> <span class="k">if</span> <span class="n">reset</span> <span class="k">else</span> <span class="s2">&quot;reloading&quot;</span><span class="p">))</span>
            <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_stopped</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">SRESET</span> <span class="k">if</span> <span class="n">reset</span> <span class="k">else</span> <span class="n">SRELOAD</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server down. Re-starting ...&quot;</span><span class="p">)</span>
            <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_restarted</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSTART</span><span class="p">,</span> <span class="n">server_cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia not running. Starting up ...&quot;</span><span class="p">)</span>
        <span class="n">start_evennia</span><span class="p">()</span>

    <span class="n">collectstatic</span><span class="p">()</span>
    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="stop_evennia"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.stop_evennia">[docs]</a><span class="k">def</span> <span class="nf">stop_evennia</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This instructs the Portal to stop the Server and then itself.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_portal_stopped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Portal stopped.</span><span class="se">\n</span><span class="s2">Evennia shut down.&quot;</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_server_stopped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server stopped.</span><span class="se">\n</span><span class="s2">Stopping Portal ...&quot;</span><span class="p">)</span>
        <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSHUTD</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">wait_for_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_stopped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">ppid</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srun</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopping ...&quot;</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSHUTD</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_stopped</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server already stopped.</span><span class="se">\n</span><span class="s2">Stopping Portal ...&quot;</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSHUTD</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">wait_for_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_stopped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia not running.&quot;</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="reboot_evennia"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.reboot_evennia">[docs]</a><span class="k">def</span> <span class="nf">reboot_evennia</span><span class="p">(</span><span class="n">pprofiler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sprofiler</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is essentially an evennia stop &amp;&amp; evennia start except we make sure</span>
<span class="sd">    the system has successfully shut down before starting it again.</span>

<span class="sd">    If evennia was not running, start it.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">AMP_CONNECTION</span>

    <span class="k">def</span> <span class="nf">_portal_stopped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Portal stopped. Evennia shut down. Rebooting ...&quot;</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">AMP_CONNECTION</span>
        <span class="n">AMP_CONNECTION</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start_evennia</span><span class="p">(</span><span class="n">pprofiler</span><span class="p">,</span> <span class="n">sprofiler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_server_stopped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server stopped.</span><span class="se">\n</span><span class="s2">Stopping Portal ...&quot;</span><span class="p">)</span>
        <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSHUTD</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">wait_for_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_stopped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">prun</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">ppid</span><span class="p">,</span> <span class="n">spid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srun</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopping ...&quot;</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSHUTD</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_stopped</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server already stopped.</span><span class="se">\n</span><span class="s2">Stopping Portal ...&quot;</span><span class="p">)</span>
            <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSHUTD</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">wait_for_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_stopped</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia not running. Starting up ...&quot;</span><span class="p">)</span>
        <span class="n">start_evennia</span><span class="p">()</span>

    <span class="n">collectstatic</span><span class="p">()</span>
    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_only_server"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.start_only_server">[docs]</a><span class="k">def</span> <span class="nf">start_only_server</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tell portal to start server (debug)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">portal_cmd</span><span class="p">,</span> <span class="n">server_cmd</span> <span class="o">=</span> <span class="n">_get_twistd_cmdline</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;launcher: Sending to portal: SSTART + </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_cmd</span><span class="p">))</span>
    <span class="n">collectstatic</span><span class="p">()</span>
    <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSTART</span><span class="p">,</span> <span class="n">server_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_server_interactive"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.start_server_interactive">[docs]</a><span class="k">def</span> <span class="nf">start_server_interactive</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the Server under control of the launcher process (foreground)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_iserver</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">server_twistd_cmd</span> <span class="o">=</span> <span class="n">_get_twistd_cmdline</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">server_twistd_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--nodaemon&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Server in interactive mode (stop with Ctrl-C)...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Popen</span><span class="p">(</span><span class="n">server_twistd_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Stopped Server with Ctrl-C.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server stopped (leaving interactive mode).&quot;</span><span class="p">)</span>

    <span class="n">collectstatic</span><span class="p">()</span>
    <span class="n">stop_server_only</span><span class="p">(</span><span class="n">when_stopped</span><span class="o">=</span><span class="n">_iserver</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_portal_interactive"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.start_portal_interactive">[docs]</a><span class="k">def</span> <span class="nf">start_portal_interactive</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the Portal under control of the launcher process (foreground)</span>

<span class="sd">    Notes:</span>
<span class="sd">        In a normal start, the launcher waits for the Portal to start, then</span>
<span class="sd">        tells it to start the Server. Since we can&#39;t do this here, we instead</span>
<span class="sd">        start the Server first and then starts the Portal - the Server will</span>
<span class="sd">        auto-reconnect to the Portal. To allow the Server to be reloaded, this</span>
<span class="sd">        relies on a fixed server server-cmdline stored as a fallback on the</span>
<span class="sd">        portal application in evennia/server/portal/portal.py.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_iportal</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="n">portal_twistd_cmd</span><span class="p">,</span> <span class="n">server_twistd_cmd</span> <span class="o">=</span> <span class="n">_get_twistd_cmdline</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">portal_twistd_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--nodaemon&quot;</span><span class="p">)</span>

        <span class="c1"># starting Server first - it will auto-connect once Portal comes up</span>
        <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
            <span class="c1"># Windows requires special care</span>
            <span class="n">create_no_window</span> <span class="o">=</span> <span class="mh">0x08000000</span>
            <span class="n">Popen</span><span class="p">(</span><span class="n">server_twistd_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">create_no_window</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Popen</span><span class="p">(</span><span class="n">server_twistd_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Portal in interactive mode (stop with Ctrl-C)...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Popen</span><span class="p">(</span><span class="n">portal_twistd_cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Stopped Portal with Ctrl-C.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Portal stopped (leaving interactive mode).&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia must be shut down completely before running Portal in interactive mode.&quot;</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_iportal</span><span class="p">)</span></div>


<div class="viewcode-block" id="stop_server_only"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.stop_server_only">[docs]</a><span class="k">def</span> <span class="nf">stop_server_only</span><span class="p">(</span><span class="n">when_stopped</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Only stop the Server-component of Evennia (this is not useful except for debug)</span>

<span class="sd">    Args:</span>
<span class="sd">        when_stopped (callable): This will be called with no arguments when Server has stopped (or</span>
<span class="sd">            if it had already stopped when this is called).</span>
<span class="sd">        interactive (bool, optional): Set if this is called as part of the interactive reload</span>
<span class="sd">            mechanism.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_server_stopped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">when_stopped</span><span class="p">:</span>
            <span class="n">when_stopped</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Server stopped.&quot;</span><span class="p">)</span>
            <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">srun</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">srun</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopping ...&quot;</span><span class="p">)</span>
            <span class="n">wait_for_status_reply</span><span class="p">(</span><span class="n">_server_stopped</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
                <span class="n">send_instruction</span><span class="p">(</span><span class="n">SRELOAD</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">send_instruction</span><span class="p">(</span><span class="n">SSHUTD</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">when_stopped</span><span class="p">:</span>
                <span class="n">when_stopped</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server is not running.&quot;</span><span class="p">)</span>
                <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia is not running.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Evennia normally first, then use `istart` to switch to interactive mode.&quot;</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_info"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.query_info">[docs]</a><span class="k">def</span> <span class="nf">query_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the info strings from the running Evennia</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_got_status</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">pinfo</span><span class="p">,</span> <span class="n">sinfo</span> <span class="o">=</span> <span class="n">_parse_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">_print_info</span><span class="p">(</span><span class="n">pinfo</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">)</span>
        <span class="n">_reactor_stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_portal_running</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">query_status</span><span class="p">(</span><span class="n">_got_status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_portal_not_running</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evennia is not running.&quot;</span><span class="p">)</span>

    <span class="n">send_instruction</span><span class="p">(</span><span class="n">PSTATUS</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_portal_running</span><span class="p">,</span> <span class="n">_portal_not_running</span><span class="p">)</span></div>


<div class="viewcode-block" id="tail_log_files"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.tail_log_files">[docs]</a><span class="k">def</span> <span class="nf">tail_log_files</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">start_lines1</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">start_lines2</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tail two logfiles interactively, combining their output to stdout</span>

<span class="sd">    When first starting, this will display the tail of the log files. After</span>
<span class="sd">    that it will poll the log files repeatedly and display changes.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename1 (str): Path to first log file.</span>
<span class="sd">        filename2 (str): Path to second log file.</span>
<span class="sd">        start_lines1 (int): How many lines to show from existing first log.</span>
<span class="sd">        start_lines2 (int): How many lines to show from existing second log.</span>
<span class="sd">        rate (int, optional): How often to poll the log file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">REACTOR_RUN</span>

    <span class="k">def</span> <span class="nf">_file_changed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">prev_size</span><span class="p">):</span>
        <span class="s2">&quot;Get size of file in bytes, get diff compared with previous size&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">new_size</span> <span class="o">!=</span> <span class="n">prev_size</span><span class="p">,</span> <span class="n">new_size</span>

    <span class="k">def</span> <span class="nf">_get_new_lines</span><span class="p">(</span><span class="n">filehandle</span><span class="p">,</span> <span class="n">old_linecount</span><span class="p">):</span>
        <span class="s2">&quot;count lines, get the ones not counted before&quot;</span>

        <span class="k">def</span> <span class="nf">_block</span><span class="p">(</span><span class="n">filehandle</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
            <span class="s2">&quot;File block generator for quick traversal&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dat</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">yield</span> <span class="n">dat</span>

        <span class="c1"># count number of lines in file</span>
        <span class="n">new_linecount</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">blck</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">blck</span> <span class="ow">in</span> <span class="n">_block</span><span class="p">(</span><span class="n">filehandle</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">new_linecount</span> <span class="o">&lt;</span> <span class="n">old_linecount</span><span class="p">:</span>
            <span class="c1"># this happens if the file was cycled or manually deleted/edited.</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot; ** Log file </span><span class="si">{filename}</span><span class="s2"> has cycled or been edited. &quot;</span>
                <span class="s2">&quot;Restarting log. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filehandle</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">new_linecount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old_linecount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">lines_to_get</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_linecount</span> <span class="o">-</span> <span class="n">old_linecount</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines_to_get</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">old_linecount</span>

        <span class="n">lines_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4098</span>
        <span class="n">block_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_found</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lines_to_get</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># scan backwards in file, starting from the end</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">block_count</span> <span class="o">*</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="c1"># file too small for current seek, include entire file</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">lines_found</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">lines_found</span> <span class="o">=</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">block_count</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># only actually return the new lines</span>
        <span class="k">return</span> <span class="n">lines_found</span><span class="p">[</span><span class="o">-</span><span class="n">lines_to_get</span><span class="p">:],</span> <span class="n">new_linecount</span>

    <span class="k">def</span> <span class="nf">_tail_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will cycle repeatedly, printing new lines&quot;&quot;&quot;</span>

        <span class="c1"># poll for changes</span>
        <span class="n">has_changed</span><span class="p">,</span> <span class="n">file_size</span> <span class="o">=</span> <span class="n">_file_changed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_changed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandle</span><span class="p">:</span>
                    <span class="n">new_lines</span><span class="p">,</span> <span class="n">line_count</span> <span class="o">=</span> <span class="n">_get_new_lines</span><span class="p">(</span><span class="n">filehandle</span><span class="p">,</span> <span class="n">line_count</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="c1"># the log file might not exist yet. Wait a little, then try again ...</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># don&#39;t show any lines from old file</span>
                    <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">max_lines</span><span class="p">:</span>
                    <span class="c1"># show some lines from first startup</span>
                    <span class="n">new_lines</span> <span class="o">=</span> <span class="n">new_lines</span><span class="p">[</span><span class="o">-</span><span class="n">max_lines</span><span class="p">:]</span>

                <span class="c1"># print to stdout without line break (log has its own line feeds)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># set up the next poll</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">_tail_file</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_tail_file</span><span class="p">,</span> <span class="n">filename1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="n">start_lines1</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_tail_file</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="n">start_lines2</span><span class="p">)</span>

    <span class="n">REACTOR_RUN</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Environment setup</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>


<div class="viewcode-block" id="evennia_version"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.evennia_version">[docs]</a><span class="k">def</span> <span class="nf">evennia_version</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the Evennia version info from the main package.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">evennia</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># even if evennia is not found, we should not crash here.</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;git rev-parse --short HEAD&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">EVENNIA_ROOT</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (rev </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
        <span class="c1"># move on if git is not answering</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">version</span></div>


<span class="n">EVENNIA_VERSION</span> <span class="o">=</span> <span class="n">evennia_version</span><span class="p">()</span>


<div class="viewcode-block" id="check_main_evennia_dependencies"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.check_main_evennia_dependencies">[docs]</a><span class="k">def</span> <span class="nf">check_main_evennia_dependencies</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks and imports the Evennia dependencies. This must be done</span>
<span class="sd">    already before the paths are set up.</span>

<span class="sd">    Returns:</span>
<span class="sd">        not_error (bool): True if no dependency error was found.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Python</span>
    <span class="n">pversion</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">pversion</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">PYTHON_MIN</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_PYTHON_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pversion</span><span class="o">=</span><span class="n">pversion</span><span class="p">,</span> <span class="n">python_min</span><span class="o">=</span><span class="n">PYTHON_MIN</span><span class="p">))</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Twisted</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">twisted</span>

        <span class="n">tversion</span> <span class="o">=</span> <span class="n">twisted</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">tversion</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">TWISTED_MIN</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_TWISTED_VERSION</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tversion</span><span class="o">=</span><span class="n">tversion</span><span class="p">,</span> <span class="n">twisted_min</span><span class="o">=</span><span class="n">TWISTED_MIN</span><span class="p">))</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_NOTWISTED</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Django</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dversion</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">django</span><span class="o">.</span><span class="n">VERSION</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
        <span class="c1"># only the main version (1.5, not 1.5.4.0)</span>
        <span class="n">dversion_main</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dversion</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">dversion</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">DJANGO_MIN</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">ERROR_DJANGO_MIN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">dversion</span><span class="o">=</span><span class="n">dversion_main</span><span class="p">,</span> <span class="n">django_min</span><span class="o">=</span><span class="n">DJANGO_MIN</span><span class="p">,</span> <span class="n">django_lt</span><span class="o">=</span><span class="n">DJANGO_LT</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">DJANGO_LT</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">dversion_main</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">NOTE_DJANGO_NEW</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dversion</span><span class="o">=</span><span class="n">dversion_main</span><span class="p">,</span> <span class="n">django_rec</span><span class="o">=</span><span class="n">DJANGO_LT</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_NODJANGO</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># return True/False if error was reported or not</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">error</span></div>


<div class="viewcode-block" id="set_gamedir"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.set_gamedir">[docs]</a><span class="k">def</span> <span class="nf">set_gamedir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set GAMEDIR based on path, by figuring out where the setting file</span>
<span class="sd">    is inside the directory tree. This allows for running the launcher</span>
<span class="sd">    from elsewhere than the top of the gamedir folder.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">GAMEDIR</span>

    <span class="n">Ndepth</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndepth</span><span class="p">):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;server&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">gpath</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings_path</span><span class="p">):</span>
                <span class="n">GAMEDIR</span> <span class="o">=</span> <span class="n">gpath</span>
                <span class="k">return</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_NO_GAMEDIR</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_secret_key"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.create_secret_key">[docs]</a><span class="k">def</span> <span class="nf">create_secret_key</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Randomly create the secret key for the settings file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">string</span>

    <span class="n">secret_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">secret_key</span><span class="p">)</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secret_key</span><span class="p">[:</span><span class="mi">40</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">secret_key</span></div>


<div class="viewcode-block" id="create_settings_file"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.create_settings_file">[docs]</a><span class="k">def</span> <span class="nf">create_settings_file</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">secret_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the template settings file to build a working settings file.</span>

<span class="sd">    Args:</span>
<span class="sd">        init (bool): This is part of the normal evennia --init</span>
<span class="sd">            operation.  If false, this function will copy a fresh</span>
<span class="sd">            template file in (asking if it already exists).</span>
<span class="sd">        secret_settings (bool, optional): If False, create settings.py, otherwise</span>
<span class="sd">            create the secret_settings.py file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">secret_settings</span><span class="p">:</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_settings.py&quot;</span><span class="p">)</span>
        <span class="n">setting_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">create_secret_key</span><span class="p">()}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">)</span>
        <span class="n">setting_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;settings_default&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_LIB</span><span class="p">,</span> <span class="s2">&quot;settings_default.py&quot;</span><span class="p">),</span>
            <span class="s2">&quot;servername&quot;</span><span class="p">:</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">GAMEDIR</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">create_secret_key</span><span class="p">(),</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">init</span><span class="p">:</span>
        <span class="c1"># if not --init mode, settings file may already exist from before</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_path</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already exists. Do you want to reset it? y/[N]&gt; &quot;</span> <span class="o">%</span> <span class="n">settings_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborted.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reset the settings file.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">secret_settings</span><span class="p">:</span>
            <span class="n">default_settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">EVENNIA_TEMPLATE</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_settings.py&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_TEMPLATE</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;conf&quot;</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default_settings_path</span><span class="p">,</span> <span class="n">settings_path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">settings_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">settings_string</span> <span class="o">=</span> <span class="n">settings_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">setting_dict</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">settings_string</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_game_directory"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.create_game_directory">[docs]</a><span class="k">def</span> <span class="nf">create_game_directory</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a new game directory named dirname</span>
<span class="sd">    at the current path. This means copying the</span>
<span class="sd">    template directory from evennia&#39;s root.</span>

<span class="sd">    Args:</span>
<span class="sd">        dirname (str): The directory name to create.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">GAMEDIR</span>
    <span class="n">GAMEDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">dirname</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot create new Evennia game dir: &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists.&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c1"># copy template directory</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">EVENNIA_TEMPLATE</span><span class="p">,</span> <span class="n">GAMEDIR</span><span class="p">)</span>
    <span class="c1"># rename gitignore to .gitignore</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="s2">&quot;gitignore&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="s2">&quot;.gitignore&quot;</span><span class="p">))</span>

    <span class="c1"># pre-build settings file in the new GAMEDIR</span>
    <span class="n">create_settings_file</span><span class="p">()</span>
    <span class="n">create_settings_file</span><span class="p">(</span><span class="n">secret_settings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_superuser"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.create_superuser">[docs]</a><span class="k">def</span> <span class="nf">create_superuser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the superuser account</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Create a superuser below. The superuser is Account #1, the &#39;owner&#39; &quot;</span>
        <span class="s2">&quot;account of the server. Email is optional and can be empty.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s2">&quot;createsuperuser&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_database"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.check_database">[docs]</a><span class="k">def</span> <span class="nf">check_database</span><span class="p">(</span><span class="n">always_return</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check so the database exists.</span>

<span class="sd">    Args:</span>
<span class="sd">        always_return (bool, optional): If set, will always return True/False</span>
<span class="sd">            also on critical errors. No output will be printed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        exists (bool): `True` if the database exists, otherwise `False`.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check so a database exists and is accessible</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connection</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">get_table_list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># django 1.8+</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">tableinfo</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tableinfo</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tables</span> <span class="ow">and</span> <span class="s2">&quot;accounts_accountdb&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="c1"># database exists and seems set up. Initialize evennia.</span>
        <span class="n">evennia</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
    <span class="c1"># Try to get Account#1</span>
    <span class="kn">from</span> <span class="nn">evennia.accounts.models</span> <span class="k">import</span> <span class="n">AccountDB</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">ProgrammingError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">always_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_DATABASE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">traceback</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c1"># no superuser yet. We need to create it.</span>

        <span class="n">other_superuser</span> <span class="o">=</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other_superuser</span><span class="p">:</span>
            <span class="c1"># Another superuser was found, but not with id=1. This may</span>
            <span class="c1"># happen if using flush (the auto-id starts at a higher</span>
            <span class="c1"># value). Wwe copy this superuser into id=1. To do</span>
            <span class="c1"># this we must deepcopy it, delete it then save the copy</span>
            <span class="c1"># with the new id. This allows us to avoid the UNIQUE</span>
            <span class="c1"># constraint on usernames.</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other_superuser</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">other_id</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
            <span class="n">other_key</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">username</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">WARNING_MOVING_SUPERUSER</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">other_key</span><span class="o">=</span><span class="n">other_key</span><span class="p">,</span> <span class="n">other_id</span><span class="o">=</span><span class="n">other_id</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="n">res</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                <span class="c1"># ask for permission</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Continue [Y]/N: &quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># continue with the</span>
            <span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>

            <span class="n">new</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="n">other</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">new</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">create_superuser</span><span class="p">()</span>
            <span class="n">check_database</span><span class="p">(</span><span class="n">always_return</span><span class="o">=</span><span class="n">always_return</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="getenv"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.getenv">[docs]</a><span class="k">def</span> <span class="nf">getenv</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get current environment and add PYTHONPATH.</span>

<span class="sd">    Returns:</span>
<span class="sd">        env (dict): Environment global dict.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span> <span class="k">if</span> <span class="n">_is_windows</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span></div>


<div class="viewcode-block" id="get_pid"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.get_pid">[docs]</a><span class="k">def</span> <span class="nf">get_pid</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the PID (Process ID) by trying to access an PID file.</span>

<span class="sd">    Args:</span>
<span class="sd">        pidfile (str): The path of the pid file.</span>
<span class="sd">        default (int, optional): What to return if file does not exist.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pid (str): The process id or `default`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pid</span>
    <span class="k">return</span> <span class="n">default</span></div>


<div class="viewcode-block" id="del_pid"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.del_pid">[docs]</a><span class="k">def</span> <span class="nf">del_pid</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The pidfile should normally be removed after a process has</span>
<span class="sd">    finished, but when sending certain signals they remain, so we need</span>
<span class="sd">    to clean them manually.</span>

<span class="sd">    Args:</span>
<span class="sd">        pidfile (str): The path of the pid file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pidfile</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="kill"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.kill">[docs]</a><span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">pidfile</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">killsignal</span><span class="o">=</span><span class="n">SIG</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a kill signal to a process based on PID. A customized</span>
<span class="sd">    success/error message will be returned. If clean=True, the system</span>
<span class="sd">    will attempt to manually remove the pid file. On Windows, no arguments</span>
<span class="sd">    are useful since Windows has no ability to direct signals except to all</span>
<span class="sd">    children of a console.</span>

<span class="sd">    Args:</span>
<span class="sd">        pidfile (str): The path of the pidfile to get the PID from. This is ignored</span>
<span class="sd">            on Windows.</span>
<span class="sd">        component (str, optional): Usually one of &#39;Server&#39; or &#39;Portal&#39;. This is</span>
<span class="sd">            ignored on Windows.</span>
<span class="sd">        errback (callable, optional): Called if signal failed to send. This</span>
<span class="sd">            is ignored on Windows.</span>
<span class="sd">        callback (callable, optional): Called if kill signal was sent successfully.</span>
<span class="sd">            This is ignored on Windows.</span>
<span class="sd">        killsignal (int, optional): Signal identifier for signal to send. This is</span>
<span class="sd">            ignored on Windows.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
        <span class="c1"># Windows signal sending is very limited.</span>
        <span class="kn">from</span> <span class="nn">win32api</span> <span class="k">import</span> <span class="n">GenerateConsoleCtrlEvent</span><span class="p">,</span> <span class="n">SetConsoleCtrlHandler</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Windows can only send a SIGINT-like signal to</span>
            <span class="c1"># *every* process spawned off the same console, so we must</span>
            <span class="c1"># avoid killing ourselves here.</span>
            <span class="n">SetConsoleCtrlHandler</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">GenerateConsoleCtrlEvent</span><span class="p">(</span><span class="n">CTRL_C_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="c1"># We must catch and ignore the interrupt sent.</span>
            <span class="k">pass</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sent kill signal to all spawned processes&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Linux/Unix/Mac can send kill signal directly to specific PIDs.</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pidfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">killsignal</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{component}</span><span class="s2"> (</span><span class="si">{pid}</span><span class="s2">) cannot be stopped. &quot;</span>
                    <span class="s2">&quot;The PID file &#39;</span><span class="si">{pidfile}</span><span class="s2">&#39; seems stale. &quot;</span>
                    <span class="s2">&quot;Try removing it manually.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">pidfile</span><span class="o">=</span><span class="n">pidfile</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sent kill signal to </span><span class="si">{component}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">errback</span><span class="p">:</span>
            <span class="n">errback</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Could not send kill signal - </span><span class="si">{component}</span><span class="s2"> does &quot;</span>
                <span class="s2">&quot;not appear to be running.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="show_version_info"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.show_version_info">[docs]</a><span class="k">def</span> <span class="nf">show_version_info</span><span class="p">(</span><span class="n">about</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display version info.</span>

<span class="sd">    Args:</span>
<span class="sd">        about (bool): Include ABOUT info as well as version numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        version_info (str): A complete version info string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">twisted</span>

    <span class="k">return</span> <span class="n">VERSION_INFO</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">EVENNIA_VERSION</span><span class="p">,</span>
        <span class="n">about</span><span class="o">=</span><span class="n">ABOUT_INFO</span> <span class="k">if</span> <span class="n">about</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">python</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">twisted</span><span class="o">=</span><span class="n">twisted</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short</span><span class="p">(),</span>
        <span class="n">django</span><span class="o">=</span><span class="n">django</span><span class="o">.</span><span class="n">get_version</span><span class="p">(),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="error_check_python_modules"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.error_check_python_modules">[docs]</a><span class="k">def</span> <span class="nf">error_check_python_modules</span><span class="p">(</span><span class="n">show_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import settings modules in settings. This will raise exceptions on</span>
<span class="sd">    pure python-syntax issues which are hard to catch gracefully with</span>
<span class="sd">    exceptions in the engine (since they are formatting errors in the</span>
<span class="sd">    python source files themselves). Best they fail already here</span>
<span class="sd">    before we get any further.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        show_warnings (bool): If non-fatal warning messages should be shown.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

    <span class="k">def</span> <span class="nf">_imp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;helper method&quot;</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">fromlist</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="n">mod</span><span class="p">,</span> <span class="n">fromlist</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">fromlist</span><span class="p">])</span>

    <span class="c1"># check the historical deprecations</span>
    <span class="kn">from</span> <span class="nn">evennia.server</span> <span class="k">import</span> <span class="n">deprecations</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">deprecations</span><span class="o">.</span><span class="n">check_errors</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">DeprecationWarning</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">show_warnings</span><span class="p">:</span>
        <span class="n">deprecations</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="c1"># core modules</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">COMMAND_PARSER</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SEARCH_AT_RESULT</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CONNECTION_SCREEN_MODULE</span><span class="p">)</span>
    <span class="c1"># imp(settings.AT_INITIAL_SETUP_HOOK_MODULE, split=False)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOCK_FUNC_MODULES</span><span class="p">:</span>
        <span class="n">_imp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">evennia.commands</span> <span class="k">import</span> <span class="n">cmdsethandler</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdsethandler</span><span class="o">.</span><span class="n">import_cmdset</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CMDSET_UNLOGGEDIN</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: CMDSET_UNLOGGED failed to load!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdsethandler</span><span class="o">.</span><span class="n">import_cmdset</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CMDSET_CHARACTER</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: CMDSET_CHARACTER failed to load&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdsethandler</span><span class="o">.</span><span class="n">import_cmdset</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CMDSET_ACCOUNT</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: CMDSET_ACCOUNT failed to load&quot;</span><span class="p">)</span>
    <span class="c1"># typeclasses</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_ACCOUNT_TYPECLASS</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span><span class="p">)</span>
    <span class="n">_imp</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_SCRIPT_TYPECLASS</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># Options</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>


<div class="viewcode-block" id="init_game_directory"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.init_game_directory">[docs]</a><span class="k">def</span> <span class="nf">init_game_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">need_gamedir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to analyze the given path to find settings.py - this defines</span>
<span class="sd">    the game directory and also sets PYTHONPATH as well as the django</span>
<span class="sd">    path.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to new game directory, including its name.</span>
<span class="sd">        check_db (bool, optional): Check if the databae exists.</span>
<span class="sd">        need_gamedir (bool, optional): set to False if Evennia doesn&#39;t require to</span>
<span class="sd">            be run in a valid game directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set the GAMEDIR path</span>
    <span class="k">if</span> <span class="n">need_gamedir</span><span class="p">:</span>
        <span class="n">set_gamedir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Add gamedir to python path</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GAMEDIR</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">TEST_MODE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">need_gamedir</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ENFORCED_SETTING</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">NOTE_TEST_CUSTOM</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings_dotpath</span><span class="o">=</span><span class="n">SETTINGS_DOTPATH</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SETTINGS_DOTPATH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">NOTE_TEST_DEFAULT</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;evennia.settings_default&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SETTINGS_DOTPATH</span>

    <span class="c1"># required since django1.7</span>
    <span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="c1"># test existence of the settings module</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;No module named&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">traceback</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_SETTINGS</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># this will both check the database and initialize the evennia dir.</span>
    <span class="k">if</span> <span class="n">check_db</span><span class="p">:</span>
        <span class="n">check_database</span><span class="p">()</span>

    <span class="c1"># if we don&#39;t have to check the game directory, return right away</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">need_gamedir</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># set up the Evennia executables and log file locations</span>
    <span class="k">global</span> <span class="n">AMP_PORT</span><span class="p">,</span> <span class="n">AMP_HOST</span><span class="p">,</span> <span class="n">AMP_INTERFACE</span>
    <span class="k">global</span> <span class="n">SERVER_PY_FILE</span><span class="p">,</span> <span class="n">PORTAL_PY_FILE</span>
    <span class="k">global</span> <span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="n">PORTAL_LOGFILE</span><span class="p">,</span> <span class="n">HTTP_LOGFILE</span>
    <span class="k">global</span> <span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="n">PORTAL_PIDFILE</span>
    <span class="k">global</span> <span class="n">SPROFILER_LOGFILE</span><span class="p">,</span> <span class="n">PPROFILER_LOGFILE</span>
    <span class="k">global</span> <span class="n">EVENNIA_VERSION</span>

    <span class="n">AMP_PORT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AMP_PORT</span>
    <span class="n">AMP_HOST</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AMP_HOST</span>
    <span class="n">AMP_INTERFACE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AMP_INTERFACE</span>

    <span class="n">SERVER_PY_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_LIB</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;server.py&quot;</span><span class="p">)</span>
    <span class="n">PORTAL_PY_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_LIB</span><span class="p">,</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="s2">&quot;portal&quot;</span><span class="p">,</span> <span class="s2">&quot;portal.py&quot;</span><span class="p">)</span>

    <span class="n">SERVER_PIDFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;server.pid&quot;</span><span class="p">)</span>
    <span class="n">PORTAL_PIDFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;portal.pid&quot;</span><span class="p">)</span>

    <span class="n">SPROFILER_LOGFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;server.prof&quot;</span><span class="p">)</span>
    <span class="n">PPROFILER_LOGFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;portal.prof&quot;</span><span class="p">)</span>

    <span class="n">SERVER_LOGFILE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_LOG_FILE</span>
    <span class="n">PORTAL_LOGFILE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PORTAL_LOG_FILE</span>
    <span class="n">HTTP_LOGFILE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">HTTP_LOG_FILE</span>

    <span class="c1"># verify existence of log file dir (this can be missing e.g.</span>
    <span class="c1"># if the game dir itself was cloned since log files are in .gitignore)</span>
    <span class="n">logdirs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">logfile</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="n">PORTAL_LOGFILE</span><span class="p">,</span> <span class="n">HTTP_LOGFILE</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pathtup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">pathtup</span> <span class="ow">in</span> <span class="n">logdirs</span><span class="p">):</span>
        <span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (log file </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathtup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pathtup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">pathtup</span> <span class="ow">in</span> <span class="n">logdirs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pathtup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_LOGDIR_MISSING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfiles</span><span class="o">=</span><span class="n">errstr</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
        <span class="c1"># We need to handle Windows twisted separately. We create a</span>
        <span class="c1"># batchfile in game/server, linking to the actual binary</span>

        <span class="k">global</span> <span class="n">TWISTED_BINARY</span>
        <span class="c1"># Windows requires us to use the absolute path for the bat file.</span>
        <span class="n">server_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">TWISTED_BINARY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">server_path</span><span class="p">,</span> <span class="s2">&quot;twistd.bat&quot;</span><span class="p">)</span>

        <span class="c1"># add path so system can find the batfile</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">,</span> <span class="n">SERVERDIR</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;win32api&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_WINDOWS_WIN32API</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">batpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EVENNIA_SERVER</span><span class="p">,</span> <span class="n">TWISTED_BINARY</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">batpath</span><span class="p">):</span>
            <span class="c1"># Test for executable twisted batch file. This calls the</span>
            <span class="c1"># twistd.py executable that is usually not found on the</span>
            <span class="c1"># path in Windows.  It&#39;s not enough to locate</span>
            <span class="c1"># scripts.twistd, what we want is the executable script</span>
            <span class="c1"># C:\PythonXX/Scripts/twistd.py. Alas we cannot hardcode</span>
            <span class="c1"># this location since we don&#39;t know if user has Python in</span>
            <span class="c1"># a non-standard location. So we try to figure it out.</span>
            <span class="n">twistd</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;twisted.scripts.twistd&quot;</span><span class="p">)</span>
            <span class="n">twistd_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">twistd</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

            <span class="c1"># note that we hope the twistd package won&#39;t change here, since we</span>
            <span class="c1"># try to get to the executable by relative path.</span>
            <span class="c1"># Update: In 2016, it seems Twisted 16 has changed the name of</span>
            <span class="c1"># of its executable from &#39;twistd.py&#39; to &#39;twistd.exe&#39;.</span>
            <span class="n">twistd_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">twistd_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;twistd.exe&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">batpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bat_file</span><span class="p">:</span>
                <span class="c1"># build a custom bat file for windows</span>
                <span class="n">bat_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;@&quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%%</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="n">twistd_path</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">INFO_WINDOWS_BATFILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">twistd_path</span><span class="o">=</span><span class="n">twistd_path</span><span class="p">))</span></div>


<div class="viewcode-block" id="run_dummyrunner"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.run_dummyrunner">[docs]</a><span class="k">def</span> <span class="nf">run_dummyrunner</span><span class="p">(</span><span class="n">number_of_dummies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start an instance of the dummyrunner</span>

<span class="sd">    Args:</span>
<span class="sd">        number_of_dummies (int): The number of dummy accounts to start.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The dummy accounts&#39; behavior can be customized by adding a</span>
<span class="sd">        `dummyrunner_settings.py` config file in the game&#39;s conf/</span>
<span class="sd">        directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">number_of_dummies</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">number_of_dummies</span><span class="p">))</span> <span class="k">if</span> <span class="n">number_of_dummies</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">cmdstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">EVENNIA_DUMMYRUNNER</span><span class="p">,</span> <span class="s2">&quot;-N&quot;</span><span class="p">,</span> <span class="n">number_of_dummies</span><span class="p">]</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SETTINGS_PATH</span><span class="p">,</span> <span class="s2">&quot;dummyrunner_settings.py&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
        <span class="n">cmdstr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">config_file</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call</span><span class="p">(</span><span class="n">cmdstr</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="c1"># this signals the dummyrunner to stop cleanly and should</span>
        <span class="c1"># not lead to a traceback here.</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="run_connect_wizard"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.run_connect_wizard">[docs]</a><span class="k">def</span> <span class="nf">run_connect_wizard</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the linking wizard, for adding new external connections.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.connection_wizard</span> <span class="k">import</span> <span class="n">ConnectionWizard</span><span class="p">,</span> <span class="n">node_start</span>

    <span class="n">wizard</span> <span class="o">=</span> <span class="n">ConnectionWizard</span><span class="p">()</span>
    <span class="n">node_start</span><span class="p">(</span><span class="n">wizard</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_settings"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.list_settings">[docs]</a><span class="k">def</span> <span class="nf">list_settings</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the server settings. We only display the Evennia specific</span>
<span class="sd">    settings here. The result will be printed to the terminal.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (str or list): Setting key or keys to inspect.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>
    <span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="k">import</span> <span class="n">evtable</span>

    <span class="n">evsettings</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">SETTINGS_DOTPATH</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ALL&quot;</span><span class="p">:</span>
        <span class="c1"># show a list of all keys</span>
        <span class="c1"># a specific key</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">evtable</span><span class="o">.</span><span class="n">EvTable</span><span class="p">()</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">evsettings</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">),</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="o">*</span><span class="n">confs</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># a specific key</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">evtable</span><span class="o">.</span><span class="n">EvTable</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">131</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">evsettings</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">confs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_menu"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.run_menu">[docs]</a><span class="k">def</span> <span class="nf">run_menu</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This launches an interactive menu.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># menu loop</span>
        <span class="n">gamedir</span> <span class="o">=</span> <span class="s2">&quot;/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">GAMEDIR</span><span class="p">))</span>
        <span class="n">leninfo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamedir</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">61</span> <span class="o">-</span> <span class="n">leninfo</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamedir</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">MENU</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gameinfo</span><span class="o">=</span><span class="n">line</span><span class="p">))</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot; option &gt; &quot;</span><span class="p">)</span>

        <span class="c1"># quitting and help</span>
        <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">HELP_ENTRY</span><span class="p">)</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;press &lt;return&gt; to continue ...&quot;</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">show_version_info</span><span class="p">(</span><span class="n">about</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;press &lt;return&gt; to continue ...&quot;</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># options</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a valid option.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">start_evennia</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">reload_evennia</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">stop_evennia</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">reboot_evennia</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">reload_evennia</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">stop_server_only</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This option is not supported on Windows.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Server&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This option is not supported on Windows.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Server&quot;</span><span class="p">)</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">PORTAL_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Portal&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">SERVER_LOGFILE</span><span class="p">:</span>
                <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tail_log_files</span><span class="p">(</span><span class="n">PORTAL_LOGFILE</span><span class="p">,</span> <span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;   Tailing logfiles </span><span class="si">{}</span><span class="s2"> (Ctrl-C to exit) ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_file_names_compact</span><span class="p">(</span><span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="n">PORTAL_LOGFILE</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">query_status</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">query_info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &#39;evennia --settings settings.py test .&#39; ...&quot;</span><span class="p">)</span>
            <span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;--settings&quot;</span><span class="p">,</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">inp</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &#39;evennia test evennia&#39; ...&quot;</span><span class="p">)</span>
            <span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;evennia&quot;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">getenv</span><span class="p">())</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a valid option.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../api/evennia.server.evennia_launcher.html#evennia.server.evennia_launcher.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the evennia launcher main program.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up argument parser</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">CMDLINE_HELP</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--gamedir&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;altgamedir&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;location of gamedir (default: current location)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--init&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;init&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;gamename&gt;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;creates a new gamedir &#39;name&#39; at current location&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--log&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;tail_log&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;tail the portal and server logfiles and print to stdout&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--list&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;listsetting&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;all|&lt;key&gt;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;list settings, use &#39;all&#39; to list all available keys&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--settings&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;altsettings&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;start evennia with alternative settings file from</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot; gamedir/server/conf/. (default is settings.py)&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--initsettings&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;initsettings&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;create a new, empty settings file as</span><span class="se">\n</span><span class="s2"> gamedir/server/conf/settings.py&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--initmissing&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;initmissing&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;checks for missing secret_settings or server logs</span><span class="se">\n</span><span class="s2"> directory, and adds them if needed&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--profiler&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;profiler&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;start given server component under the Python profiler&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--dummyrunner&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dummyrunner&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;N&gt;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;test a server by connecting &lt;N&gt; dummy accounts to it&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;show_version&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show version info&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;noop&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">ARG_OPTIONS</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">epilog</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Common Django-admin commands are shell, dbshell, test and migrate.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;See the Django documentation for more management commands.&quot;</span>
    <span class="p">)</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">unknown_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="c1"># handle arguments</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">operation</span>

    <span class="c1"># make sure we have everything</span>
    <span class="n">check_main_evennia_dependencies</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="c1"># show help pane</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">CMDLINE_HELP</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">altgamedir</span><span class="p">:</span>
        <span class="c1"># use alternative gamedir path</span>
        <span class="k">global</span> <span class="n">GAMEDIR</span>
        <span class="n">altgamedir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">altgamedir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">altgamedir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">init</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_NO_ALT_GAMEDIR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gamedir</span><span class="o">=</span><span class="n">altgamedir</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="n">GAMEDIR</span> <span class="o">=</span> <span class="n">altgamedir</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">init</span><span class="p">:</span>
        <span class="c1"># initialization of game directory</span>
        <span class="n">create_game_directory</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">CREATED_NEW_GAMEDIR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">gamedir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="n">settings_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="n">SETTINGS_PATH</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">show_version</span><span class="p">:</span>
        <span class="c1"># show the version info</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">show_version_info</span><span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">altsettings</span><span class="p">:</span>
        <span class="c1"># use alternative settings file</span>
        <span class="k">global</span> <span class="n">SETTINGSFILE</span><span class="p">,</span> <span class="n">SETTINGS_DOTPATH</span><span class="p">,</span> <span class="n">ENFORCED_SETTING</span>
        <span class="n">sfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">altsettings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SETTINGSFILE</span> <span class="o">=</span> <span class="n">sfile</span>
        <span class="n">ENFORCED_SETTING</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">SETTINGS_DOTPATH</span> <span class="o">=</span> <span class="s2">&quot;server.conf.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sfile</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using settings file &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SETTINGSFILE</span><span class="p">,</span> <span class="n">SETTINGS_DOTPATH</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">initsettings</span><span class="p">:</span>
        <span class="c1"># create new settings file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">create_settings_file</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">RECREATED_SETTINGS</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_INITSETTINGS</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">initmissing</span><span class="p">:</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SERVERDIR</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;    ... Created missing log dir </span><span class="si">{log_path}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFDIR</span><span class="p">,</span> <span class="s2">&quot;secret_settings.py&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_path</span><span class="p">):</span>
                <span class="n">create_settings_file</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">secret_settings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;    ... Created missing secret_settings.py file as </span><span class="si">{settings_path}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">RECREATED_MISSING</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    ... No missing resources to create/init. You are good to go.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ERROR_INITMISSING</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tail_log</span><span class="p">:</span>
        <span class="c1"># set up for tailing the log files</span>
        <span class="k">global</span> <span class="n">NO_REACTOR_STOP</span>
        <span class="n">NO_REACTOR_STOP</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SERVER_LOGFILE</span><span class="p">:</span>
            <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># adjust how many lines we show from existing logs</span>
        <span class="n">start_lines1</span><span class="p">,</span> <span class="n">start_lines2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;reload&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;noop&quot;</span><span class="p">):</span>
            <span class="n">start_lines1</span><span class="p">,</span> <span class="n">start_lines2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">tail_log_files</span><span class="p">(</span><span class="n">PORTAL_LOGFILE</span><span class="p">,</span> <span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="n">start_lines1</span><span class="p">,</span> <span class="n">start_lines2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;   Tailing logfiles </span><span class="si">{}</span><span class="s2"> (Ctrl-C to exit) ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_file_names_compact</span><span class="p">(</span><span class="n">SERVER_LOGFILE</span><span class="p">,</span> <span class="n">PORTAL_LOGFILE</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dummyrunner</span><span class="p">:</span>
        <span class="c1"># launch the dummy runner</span>
        <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">run_dummyrunner</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dummyrunner</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">listsetting</span><span class="p">:</span>
        <span class="c1"># display all current server settings</span>
        <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">list_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">listsetting</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;menu&quot;</span><span class="p">:</span>
        <span class="c1"># launch menu for operation</span>
        <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">run_menu</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;istart&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ipstart&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reload&quot;</span><span class="p">,</span>
        <span class="s2">&quot;restart&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reboot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sstop&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kill&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skill&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sstart&quot;</span><span class="p">,</span>
        <span class="s2">&quot;connections&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># operate the server directly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SERVER_LOGFILE</span><span class="p">:</span>
            <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span>
            <span class="n">query_status</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="n">query_info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
            <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">error_check_python_modules</span><span class="p">(</span><span class="n">show_warnings</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tail_log</span><span class="p">)</span>
            <span class="n">start_evennia</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;istart&quot;</span><span class="p">:</span>
            <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">error_check_python_modules</span><span class="p">(</span><span class="n">show_warnings</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tail_log</span><span class="p">)</span>
            <span class="n">start_server_interactive</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;ipstart&quot;</span><span class="p">:</span>
            <span class="n">start_portal_interactive</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;reload&quot;</span><span class="p">,</span> <span class="s2">&quot;restart&quot;</span><span class="p">):</span>
            <span class="n">reload_evennia</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;reboot&quot;</span><span class="p">:</span>
            <span class="n">reboot_evennia</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;reset&quot;</span><span class="p">:</span>
            <span class="n">reload_evennia</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">profiler</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
            <span class="n">stop_evennia</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;sstop&quot;</span><span class="p">:</span>
            <span class="n">stop_server_only</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;sstart&quot;</span><span class="p">:</span>
            <span class="n">start_only_server</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;kill&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This option is not supported on Windows.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Server&quot;</span><span class="p">)</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">PORTAL_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Portal&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;skill&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_windows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This option is not supported on Windows.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kill</span><span class="p">(</span><span class="n">SERVER_PIDFILE</span><span class="p">,</span> <span class="s2">&quot;Server&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;connections&quot;</span><span class="p">:</span>
            <span class="n">run_connect_wizard</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">option</span> <span class="o">!=</span> <span class="s2">&quot;noop&quot;</span><span class="p">:</span>
        <span class="c1"># pass-through to django manager, but set things up first</span>
        <span class="n">check_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">need_gamedir</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># handle special django commands</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;runserver&quot;</span><span class="p">,</span> <span class="s2">&quot;testserver&quot;</span><span class="p">):</span>
            <span class="c1"># we don&#39;t want the django test-webserver</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">WARNING_RUNSERVER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;makemessages&quot;</span><span class="p">,</span> <span class="s2">&quot;compilemessages&quot;</span><span class="p">):</span>
            <span class="c1"># some commands don&#39;t require the presence of a game directory to work</span>
            <span class="n">need_gamedir</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="s2">&quot;makemigrations&quot;</span><span class="p">,</span> <span class="s2">&quot;createsuperuser&quot;</span><span class="p">):</span>
            <span class="c1"># some django commands requires the database to exist,</span>
            <span class="c1"># or evennia._init to have run before they work right.</span>
            <span class="n">check_db</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">TEST_MODE</span>
            <span class="n">TEST_MODE</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">init_game_directory</span><span class="p">(</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">check_db</span><span class="o">=</span><span class="n">check_db</span><span class="p">,</span> <span class="n">need_gamedir</span><span class="o">=</span><span class="n">need_gamedir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;migrate&quot;</span><span class="p">:</span>
            <span class="c1"># we need to bypass some checks here for the first db creation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_database</span><span class="p">(</span><span class="n">always_return</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">option</span><span class="p">]</span> <span class="o">+</span> <span class="n">unknown_args</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># pass on to the core django manager - re-parse the entire input line</span>
        <span class="c1"># but keep &#39;evennia&#39; as the name instead of django-admin. This is</span>
        <span class="c1"># an exit condition.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-script\.pyw?|\.exe)?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tail_log</span><span class="p">:</span>
        <span class="c1"># no input; print evennia info (don&#39;t pring if we&#39;re tailing log)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ABOUT_INFO</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">REACTOR_RUN</span><span class="p">:</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># start Evennia from the command line</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3>Versions</h3>
<ul>
  <li><a href="evennia_launcher.html">1.0-dev (develop branch)</a></li>
  <li><a href="../../../../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.evennia_launcher</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>