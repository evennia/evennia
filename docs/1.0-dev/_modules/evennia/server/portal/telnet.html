
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.server.portal.telnet &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.telnet</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="telnet.html">1.0-dev (develop branch)</a></li>
   <ul>
    <li><a href="../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>
</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.server.portal.telnet</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module implements the telnet protocol.</span>

<span class="sd">This depends on a generic session module that implements</span>
<span class="sd">the actual login procedure of the game, tracks</span>
<span class="sd">sessions etc.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">twisted.conch.telnet</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ECHO</span><span class="p">,</span>
    <span class="n">GA</span><span class="p">,</span>
    <span class="n">IAC</span><span class="p">,</span>
    <span class="n">LINEMODE</span><span class="p">,</span>
    <span class="n">LINEMODE_EDIT</span><span class="p">,</span>
    <span class="n">LINEMODE_TRAPSIG</span><span class="p">,</span>
    <span class="n">MODE</span><span class="p">,</span>
    <span class="n">NOP</span><span class="p">,</span>
    <span class="n">NULL</span><span class="p">,</span>
    <span class="n">WILL</span><span class="p">,</span>
    <span class="n">WONT</span><span class="p">,</span>
    <span class="n">StatefulTelnetProtocol</span><span class="p">,</span>
    <span class="n">Telnet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
<span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">LoopingCall</span>

<span class="kn">from</span> <span class="nn">evennia.server.portal</span> <span class="kn">import</span> <span class="n">mssp</span><span class="p">,</span> <span class="n">naws</span><span class="p">,</span> <span class="n">suppress_ga</span><span class="p">,</span> <span class="n">telnet_oob</span><span class="p">,</span> <span class="n">ttype</span>
<span class="kn">from</span> <span class="nn">evennia.server.portal.mccp</span> <span class="kn">import</span> <span class="n">MCCP</span><span class="p">,</span> <span class="n">Mccp</span><span class="p">,</span> <span class="n">mccp_compress</span>
<span class="kn">from</span> <span class="nn">evennia.server.portal.mxp</span> <span class="kn">import</span> <span class="n">Mxp</span><span class="p">,</span> <span class="n">mxp_parse</span>
<span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="kn">import</span> <span class="n">ansi</span>
<span class="kn">from</span> <span class="nn">evennia.utils.utils</span> <span class="kn">import</span> <span class="n">class_from_module</span><span class="p">,</span> <span class="n">to_bytes</span>

<span class="n">_RE_N</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|n$&quot;</span><span class="p">)</span>
<span class="n">_RE_LEND</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;\n$|\r$|\r\n$|\r\x00$|&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="n">_RE_LINEBREAK</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;\n\r|\r\n|\n|\r&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="n">_RE_SCREENREADER_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCREENREADER_REGEX_STRIP</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
<span class="p">)</span>
<span class="n">_IDLE_COMMAND</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IDLE_COMMAND</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># identify HTTP indata</span>
<span class="n">_HTTP_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">b</span><span class="s2">&quot;(GET|HEAD|POST|PUT|DELETE|TRACE|OPTIONS|CONNECT|PATCH) (.*? HTTP/[0-9]\.[0-9])&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span>
<span class="p">)</span>

<span class="n">_HTTP_WARNING</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is Evennia&#39;s Telnet port and cannot be used for regular HTTP traffic.</span>
<span class="sd">    Use a telnet client to connect here and point your browser to the server&#39;s</span>
<span class="sd">    dedicated web port instead.</span>

<span class="sd">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">_BASE_SESSION_CLASS</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_SESSION_CLASS</span><span class="p">)</span>


<div class="viewcode-block" id="TelnetServerFactory"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetServerFactory">[docs]</a><span class="k">class</span> <span class="nc">TelnetServerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This exists only to name this better in logs.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">noisy</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="TelnetServerFactory.logPrefix"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetServerFactory.logPrefix">[docs]</a>    <span class="k">def</span> <span class="nf">logPrefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Telnet&quot;</span></div></div>


<div class="viewcode-block" id="TelnetProtocol"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol">[docs]</a><span class="k">class</span> <span class="nc">TelnetProtocol</span><span class="p">(</span><span class="n">Telnet</span><span class="p">,</span> <span class="n">StatefulTelnetProtocol</span><span class="p">,</span> <span class="n">_BASE_SESSION_CLASS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each player connecting over telnet (ie using most traditional mud</span>
<span class="sd">    clients) gets a telnet protocol instance assigned to them.  All</span>
<span class="sd">    communication between game and player goes through here.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TelnetProtocol.__init__"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_key</span> <span class="o">=</span> <span class="s2">&quot;telnet&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.dataReceived"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.dataReceived">[docs]</a>    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unused by default, but a good place to put debug printouts</span>
<span class="sd">        of incoming data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(f&quot;telnet dataReceived: {data}&quot;)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dataReceived</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="kn">import</span> <span class="n">logger</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malformed telnet input: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.connectionMade"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.connectionMade">[docs]</a>    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called when the connection is first established.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># important in order to work normally with standard telnet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">LINEMODE</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wont_linemode</span><span class="p">)</span>
        <span class="c1"># initialize the session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">client</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">client_address</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># this number is counted down for every handshake that completes.</span>
        <span class="c1"># when it reaches 0 the portal/server syncs their data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handshakes</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># suppress-go-ahead, naws, ttype, mccp, mssp, msdp, gmcp, mxp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_key</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">sessionhandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="p">[</span><span class="s2">&quot;ENCODING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENCODINGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENCODINGS</span> <span class="k">else</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="c1"># add this new connection to sessionhandler so</span>
        <span class="c1"># the Server becomes aware of it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># change encoding to ENCODINGS[0] which reflects Telnet default encoding</span>

        <span class="c1"># suppress go-ahead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sga</span> <span class="o">=</span> <span class="n">suppress_ga</span><span class="o">.</span><span class="n">SuppressGA</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># negotiate client size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naws</span> <span class="o">=</span> <span class="n">naws</span><span class="o">.</span><span class="n">Naws</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># negotiate ttype (client info)</span>
        <span class="c1"># Obs: mudlet ttype does not seem to work if we start mccp before ttype. /Griatch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="o">=</span> <span class="n">ttype</span><span class="o">.</span><span class="n">Ttype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># negotiate mccp (data compression) - turn this off for wireshark analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccp</span> <span class="o">=</span> <span class="n">Mccp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># negotiate mssp (crawler communication)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mssp</span> <span class="o">=</span> <span class="n">mssp</span><span class="o">.</span><span class="n">Mssp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># oob communication (MSDP, GMCP) - two handshake calls!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oob</span> <span class="o">=</span> <span class="n">telnet_oob</span><span class="o">.</span><span class="n">TelnetOOB</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># mxp support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mxp</span> <span class="o">=</span> <span class="n">Mxp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">evennia.utils.utils</span> <span class="kn">import</span> <span class="n">delay</span>

        <span class="c1"># timeout the handshakes in case the client doesn&#39;t reply at all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handshake_delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handshake_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TCP/IP keepalive watches for dead links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">setTcpKeepAlive</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># The TCP/IP keepalive is not enough for some networks;</span>
        <span class="c1"># we have to complement it with a NOP keep-alive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="p">[</span><span class="s2">&quot;NOPKEEPALIVE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_nop_keepalive</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_wont_linemode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Client refuses do(linemode). This is common for MUD-specific</span>
<span class="sd">        clients, but we must ask for the sake of raw telnet. We ignore</span>
<span class="sd">        this error.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_send_nop_keepalive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send NOP keepalive unless flag is set</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOPKEEPALIVE&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">IAC</span> <span class="o">+</span> <span class="n">NOP</span><span class="p">)</span>

<div class="viewcode-block" id="TelnetProtocol.toggle_nop_keepalive"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.toggle_nop_keepalive">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_nop_keepalive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allow to toggle the NOP keepalive for those sad clients that</span>
<span class="sd">        can&#39;t even handle a NOP instruction. This is turned off by the</span>
<span class="sd">        protocol_flag NOPKEEPALIVE (settable e.g. by the default</span>
<span class="sd">        `option` command).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span> <span class="o">=</span> <span class="n">LoopingCall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_nop_keepalive</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nop_keep_alive</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.handshake_done"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.handshake_done">[docs]</a>    <span class="k">def</span> <span class="nf">handshake_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called by all telnet extensions once they are finished.</span>
<span class="sd">        When all have reported, a sync with the server is performed.</span>
<span class="sd">        The system will force-call this sync after a small time to handle</span>
<span class="sd">        clients that don&#39;t reply to handshakes at all.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handshakes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handshakes</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handshakes</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handshakes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># do the sync</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.at_login"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.at_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when this session gets authenticated by the server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TelnetProtocol.enableRemote"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.enableRemote">[docs]</a>    <span class="k">def</span> <span class="nf">enableRemote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This sets up the remote-activated options we allow for this protocol.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (char): The telnet option to enable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            enable (bool): If this option should be enabled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="n">LINEMODE</span><span class="p">:</span>
            <span class="c1"># make sure to activate line mode with local editing for all clients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requestNegotiation</span><span class="p">(</span>
                <span class="n">LINEMODE</span><span class="p">,</span> <span class="n">MODE</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">LINEMODE_EDIT</span><span class="p">)</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="n">LINEMODE_TRAPSIG</span><span class="p">)),</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">option</span> <span class="o">==</span> <span class="n">ttype</span><span class="o">.</span><span class="n">TTYPE</span>
                <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">naws</span><span class="o">.</span><span class="n">NAWS</span>
                <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">MCCP</span>
                <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">mssp</span><span class="o">.</span><span class="n">MSSP</span>
                <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">ECHO</span>
                <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">suppress_ga</span><span class="o">.</span><span class="n">SUPPRESS_GA</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.disableRemote"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.disableRemote">[docs]</a>    <span class="k">def</span> <span class="nf">disableRemote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">option</span> <span class="o">==</span> <span class="n">LINEMODE</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">ttype</span><span class="o">.</span><span class="n">TTYPE</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">naws</span><span class="o">.</span><span class="n">NAWS</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">MCCP</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">mssp</span><span class="o">.</span><span class="n">MSSP</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">ECHO</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">suppress_ga</span><span class="o">.</span><span class="n">SUPPRESS_GA</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.enableLocal"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.enableLocal">[docs]</a>    <span class="k">def</span> <span class="nf">enableLocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call to allow the activation of options for this protocol</span>

<span class="sd">        Args:</span>
<span class="sd">            option (char): The telnet option to enable locally.</span>

<span class="sd">        Returns:</span>
<span class="sd">            enable (bool): If this option should be enabled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">option</span> <span class="o">==</span> <span class="n">LINEMODE</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">MCCP</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">ECHO</span>
            <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="n">suppress_ga</span><span class="o">.</span><span class="n">SUPPRESS_GA</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.disableLocal"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.disableLocal">[docs]</a>    <span class="k">def</span> <span class="nf">disableLocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disable a given option locally.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (char): The telnet option to disable locally.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="n">LINEMODE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="n">ECHO</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="n">MCCP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccp</span><span class="o">.</span><span class="n">no_mccp</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">disableLocal</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="kn">import</span> <span class="n">logger</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span></div>

<div class="viewcode-block" id="TelnetProtocol.connectionLost"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.connectionLost">[docs]</a>    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this is executed when the connection is lost for whatever</span>
<span class="sd">        reason. it can also be called directly, from the disconnect</span>
<span class="sd">        method</span>

<span class="sd">        Args:</span>
<span class="sd">            reason (str): Motivation for losing connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span></div>

<div class="viewcode-block" id="TelnetProtocol.applicationDataReceived"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.applicationDataReceived">[docs]</a>    <span class="k">def</span> <span class="nf">applicationDataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Telnet method called when non-telnet-command data is coming in</span>
<span class="sd">        over the telnet connection. We pass it on to the game engine</span>
<span class="sd">        directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str): Incoming data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">:</span>
            <span class="c1"># this is an ancient type of keepalive used by some</span>
            <span class="c1"># legacy clients. There should never be a reason to send a</span>
            <span class="c1"># lone NULL character so this seems to be a safe thing to</span>
            <span class="c1"># support for backwards compatibility. It also stops the</span>
            <span class="c1"># NULL from continuously popping up as an unknown command.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">_IDLE_COMMAND</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_RE_LINEBREAK</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">_HTTP_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># guard against HTTP request on the Telnet port; we</span>
                <span class="c1"># block and kill the connection.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_HTTP_WARNING</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># buffer exists, it is terminated by the first line feed</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
            <span class="c1"># if the last data split is empty, it means all splits have</span>
            <span class="c1"># line breaks, if not, it is unterminated and must be</span>
            <span class="c1"># buffered.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># send all data chunks</span>
        <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_in</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">dat</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook overloading the one used in plain telnet</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">mccp_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

<div class="viewcode-block" id="TelnetProtocol.sendLine"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.sendLine">[docs]</a>    <span class="k">def</span> <span class="nf">sendLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook overloading the one used by linereceiver.</span>

<span class="sd">        Args:</span>
<span class="sd">            line (str): Line to send.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># escape IAC in line mode, and correctly add \r\n (the TELNET end-of-line)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">IAC</span><span class="p">,</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">IAC</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FORCEDENDLINE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOGOAHEAD&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">GA</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mccp_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span></div>

    <span class="c1"># Session hooks</span>

<div class="viewcode-block" id="TelnetProtocol.disconnect"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic hook for the engine to call in order to</span>
<span class="sd">        disconnect this protocol.</span>

<span class="sd">        Args:</span>
<span class="sd">            reason (str, optional): Reason for disconnecting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">((</span><span class="n">reason</span><span class="p">,),</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.data_in"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.data_in">[docs]</a>    <span class="k">def</span> <span class="nf">data_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data User -&gt; Evennia</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): Options from the protocol.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from evennia.server.profiling.timetrace import timetrace  # DEBUG</span>
        <span class="c1"># text = timetrace(text, &quot;telnet.data_in&quot;)  # DEBUG</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">data_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.data_out"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.data_out">[docs]</a>    <span class="k">def</span> <span class="nf">data_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data Evennia -&gt; User</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): Options to the protocol</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># send_* methods</span>

<div class="viewcode-block" id="TelnetProtocol.send_text"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.send_text">[docs]</a>    <span class="k">def</span> <span class="nf">send_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send text data. This is an in-band telnet operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The first argument is always the text string to send. No other arguments</span>
<span class="sd">                are considered.</span>
<span class="sd">        Keyword Args:</span>
<span class="sd">            options (dict): Send-option flags</span>

<span class="sd">               - mxp: Enforce MXP link support.</span>
<span class="sd">               - ansi: Enforce no ANSI colors.</span>
<span class="sd">               - xterm256: Enforce xterm256 colors, regardless of TTYPE.</span>
<span class="sd">               - noxterm256: Enforce no xterm256 color support, regardless of TTYPE.</span>
<span class="sd">               - nocolor: Strip all Color, regardless of ansi/xterm256 setting.</span>
<span class="sd">               - raw: Pass string through without any ansi processing</span>
<span class="sd">                    (i.e. include Evennia ansi markers but do not</span>
<span class="sd">                    convert them into ansi tokens)</span>
<span class="sd">               - echo: Turn on/off line echo on the client. Turn</span>
<span class="sd">                    off line echo for client, for example for password.</span>
<span class="sd">                    Note that it must be actively turned back on again!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># handle arguments</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span>
        <span class="n">xterm256</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;xterm256&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XTERM256&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TTYPE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">useansi</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ansi&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ANSI&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TTYPE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RAW&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">nocolor</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nocolor&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOCOLOR&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xterm256</span> <span class="ow">or</span> <span class="n">useansi</span><span class="p">))</span>
        <span class="n">echo</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mxp</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mxp&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MXP&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">screenreader</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;screenreader&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SCREENREADER&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">screenreader</span><span class="p">:</span>
            <span class="c1"># screenreader mode cleans up output</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">ansi</span><span class="o">.</span><span class="n">parse_ansi</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">strip_ansi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xterm256</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mxp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">_RE_SCREENREADER_REGEX</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;send_prompt&quot;</span><span class="p">):</span>
            <span class="c1"># send a prompt instead.</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">text</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
                <span class="c1"># processing</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">ansi</span><span class="o">.</span><span class="n">parse_ansi</span><span class="p">(</span>
                    <span class="n">_RE_N</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;||n&quot;</span> <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;|n&quot;</span><span class="p">),</span>
                    <span class="n">strip_ansi</span><span class="o">=</span><span class="n">nocolor</span><span class="p">,</span>
                    <span class="n">xterm256</span><span class="o">=</span><span class="n">xterm256</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">mxp</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">mxp_parse</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">IAC</span><span class="p">,</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">IAC</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;NOPROMPTGOAHEAD&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOGOAHEAD&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">GA</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mccp_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">echo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># turn on/off echo. Note that this is a bit turned around since we use</span>
                <span class="c1"># echo as if we are &quot;turning off the client&#39;s echo&quot; when telnet really</span>
                <span class="c1"># handles it the other way around.</span>
                <span class="k">if</span> <span class="n">echo</span><span class="p">:</span>
                    <span class="c1"># by telling the client that WE WON&#39;T echo, the client knows</span>
                    <span class="c1"># that IT should echo. This is the expected behavior from</span>
                    <span class="c1"># our perspective.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mccp_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">WONT</span> <span class="o">+</span> <span class="n">ECHO</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># by telling the client that WE WILL echo, the client can</span>
                    <span class="c1"># safely turn OFF its OWN echo.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mccp_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">WILL</span> <span class="o">+</span> <span class="n">ECHO</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="c1"># no processing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we need to make sure to kill the color at the end in order</span>
                <span class="c1"># to match the webclient output.</span>
                <span class="n">linetosend</span> <span class="o">=</span> <span class="n">ansi</span><span class="o">.</span><span class="n">parse_ansi</span><span class="p">(</span>
                    <span class="n">_RE_N</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;||n&quot;</span> <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;|n&quot;</span><span class="p">),</span>
                    <span class="n">strip_ansi</span><span class="o">=</span><span class="n">nocolor</span><span class="p">,</span>
                    <span class="n">xterm256</span><span class="o">=</span><span class="n">xterm256</span><span class="p">,</span>
                    <span class="n">mxp</span><span class="o">=</span><span class="n">mxp</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">mxp</span><span class="p">:</span>
                    <span class="n">linetosend</span> <span class="o">=</span> <span class="n">mxp_parse</span><span class="p">(</span><span class="n">linetosend</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="n">linetosend</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.send_prompt"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.send_prompt">[docs]</a>    <span class="k">def</span> <span class="nf">send_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a prompt - a text without a line end. See send_text for argument options.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;send_prompt&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetProtocol.send_default"><a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet.html#evennia.server.portal.telnet.TelnetProtocol.send_default">[docs]</a>    <span class="k">def</span> <span class="nf">send_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send other oob data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdname</span> <span class="o">==</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oob</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.telnet</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>