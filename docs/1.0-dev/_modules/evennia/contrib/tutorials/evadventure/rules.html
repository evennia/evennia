
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.contrib.tutorials.evadventure.rules &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.tutorials.evadventure.rules</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="rules.html">1.0-dev (develop branch)</a></li>
  <li><a href="../../../../../../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>
</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.contrib.tutorials.evadventure.rules</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MUD ruleset based on the _Knave_ OSR tabletop RPG by Ben Milton (modified for MUD use).</span>

<span class="sd">The rules are divided into a set of classes. While each class (except chargen) could</span>
<span class="sd">also have been stand-alone functions, having them as classes makes it a little easier</span>
<span class="sd">to use them as the base for your own variation (tweaking values etc).</span>

<span class="sd">- Roll-engine: Class with methods for making all dice rolls needed by the rules. Knave only</span>
<span class="sd">  has a few resolution rolls, but we define helper methods for different actions the</span>
<span class="sd">  character will be able to do in-code.</span>
<span class="sd">- Character generation - this is a container used for holding, tweaking and setting</span>
<span class="sd">  all character data during character generation. At the end it will save itself</span>
<span class="sd">  onto the Character for permanent storage.</span>
<span class="sd">- Improvement - this container holds rules used with experience to improve the</span>
<span class="sd">  character over time.</span>
<span class="sd">- Charsheet - a container with tools for visually displaying the character sheet in-game.</span>

<span class="sd">This module presents several singletons to import</span>

<span class="sd">- `dice` - the `EvAdventureRollEngine` for all random resolution and table-rolling.</span>
<span class="sd">- `character_sheet` - the `EvAdventureCharacterSheet` visualizer.</span>
<span class="sd">- `improvement` - the EvAdventureImprovement` class for handling char xp and leveling.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>

<span class="kn">from</span> <span class="nn">.enums</span> <span class="kn">import</span> <span class="n">Ability</span>
<span class="kn">from</span> <span class="nn">.random_tables</span> <span class="kn">import</span> <span class="n">death_and_dismemberment</span> <span class="k">as</span> <span class="n">death_table</span>

<span class="c1"># Basic rolls</span>


<div class="viewcode-block" id="EvAdventureRollEngine"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine">[docs]</a><span class="k">class</span> <span class="nc">EvAdventureRollEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This groups all dice rolls of EvAdventure. These could all have been normal functions, but we</span>
<span class="sd">    are group them in a class to make them easier to partially override and replace later.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EvAdventureRollEngine.roll"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.roll">[docs]</a>    <span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roll_string</span><span class="p">,</span> <span class="n">max_number</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: In evennia/contribs/rpg/dice/ is a more powerful dice roller with</span>
<span class="sd">        more features, such as modifiers, secret rolls etc. This is much simpler and only</span>
<span class="sd">        gets a simple sum of normal rpg-dice.</span>

<span class="sd">        Args:</span>
<span class="sd">            roll_string (str): A roll using standard rpg syntax, &lt;number&gt;d&lt;diesize&gt;, like</span>
<span class="sd">                1d6, 2d10 etc. Max die-size is 1000.</span>
<span class="sd">            max_number (int): The max number of dice to roll. Defaults to 10, which is usually</span>
<span class="sd">                more than enough.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The rolled result - sum of all dice rolled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If roll_string is not on the right format or otherwise doesn&#39;t validate.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Since we may see user input to this function, we make sure to validate the inputs (we</span>
<span class="sd">            wouldn&#39;t bother much with that if it was just for developer use).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_diesize</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">roll_string</span> <span class="o">=</span> <span class="n">roll_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roll_string</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dice roll &#39;</span><span class="si">{</span><span class="n">roll_string</span><span class="si">}</span><span class="s2">&#39; was not recognized. Must be `&lt;number&gt;d&lt;dicesize&gt;`.&quot;</span>
            <span class="p">)</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">diesize</span> <span class="o">=</span> <span class="n">roll_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">diesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">diesize</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number and dice-size of &#39;</span><span class="si">{</span><span class="n">roll_string</span><span class="si">}</span><span class="s2">&#39; must be numerical.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="n">max_number</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid number of dice rolled (must be between 1 and </span><span class="si">{</span><span class="n">max_number</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">diesize</span> <span class="o">&gt;</span> <span class="n">max_diesize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid die-size used (must be between 1 and </span><span class="si">{</span><span class="n">max_diesize</span><span class="si">}</span><span class="s2"> sides)&quot;</span><span class="p">)</span>

        <span class="c1"># At this point we know we have valid input - roll and add dice together</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">diesize</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">))</span></div>

<div class="viewcode-block" id="EvAdventureRollEngine.roll_with_advantage_or_disadvantage"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.roll_with_advantage_or_disadvantage">[docs]</a>    <span class="k">def</span> <span class="nf">roll_with_advantage_or_disadvantage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advantage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disadvantage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base roll of d20, or 2d20, based on dis/advantage given.</span>

<span class="sd">        Args:</span>
<span class="sd">            bonus (int): The ability bonus to apply, like strength or charisma.</span>
<span class="sd">            advantage (bool): Roll 2d20 and use the bigger number.</span>
<span class="sd">            disadvantage (bool): Roll 2d20 and use the smaller number.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Disadvantage and advantage cancel each other out.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">advantage</span> <span class="ow">or</span> <span class="n">disadvantage</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">advantage</span> <span class="ow">and</span> <span class="n">disadvantage</span><span class="p">):</span>
            <span class="c1"># normal roll, or advantage cancels disadvantage</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d20&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">advantage</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d20&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d20&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d20&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d20&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="EvAdventureRollEngine.saving_throw"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.saving_throw">[docs]</a>    <span class="k">def</span> <span class="nf">saving_throw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">character</span><span class="p">,</span>
        <span class="n">bonus_type</span><span class="o">=</span><span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">advantage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">disadvantage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">modifier</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A saving throw without a clear enemy to beat. In _Knave_ all unopposed saving</span>
<span class="sd">        throws always tries to beat 15, so (d20 + bonus + modifier) &gt; 15.</span>

<span class="sd">        Args:</span>
<span class="sd">            character (Object): The one attempting to save themselves.</span>
<span class="sd">            bonus_type (enum.Ability): The ability bonus to apply, like strength or</span>
<span class="sd">                charisma.</span>
<span class="sd">            target (int, optional): Used for opposed throws (in Knave any regular</span>
<span class="sd">                saving through must always beat 15).</span>
<span class="sd">            advantage (bool, optional): Roll 2d20 and use the bigger number.</span>
<span class="sd">            disadvantage (bool, optional): Roll 2d20 and use the smaller number.</span>
<span class="sd">            modifier (int, optional): An additional +/- modifier to the roll.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple `(bool, str, str)`. The bool indicates if the save was passed or not.</span>
<span class="sd">                The second element is the quality of the roll - None (normal),</span>
<span class="sd">                &quot;critical fail&quot; and &quot;critical success&quot;. Last element is a text detailing</span>
<span class="sd">                the roll, for display purposes.</span>
<span class="sd">        Notes:</span>
<span class="sd">            Advantage and disadvantage cancel each other out.</span>

<span class="sd">        Example:</span>
<span class="sd">            Trying to overcome the effects of poison, roll d20 + Constitution-bonus above 15.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bonus</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">bonus_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dice_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_with_advantage_or_disadvantage</span><span class="p">(</span><span class="n">advantage</span><span class="p">,</span> <span class="n">disadvantage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dice_roll</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">Ability</span><span class="o">.</span><span class="n">CRITICAL_FAILURE</span>
        <span class="k">elif</span> <span class="n">dice_roll</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">Ability</span><span class="o">.</span><span class="n">CRITICAL_SUCCESS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dice_roll</span> <span class="o">+</span> <span class="n">bonus</span> <span class="o">+</span> <span class="n">modifier</span> <span class="o">&gt;</span> <span class="n">target</span>

        <span class="c1"># determine text output</span>
        <span class="n">rolltxt</span> <span class="o">=</span> <span class="s2">&quot;d20 &quot;</span>
        <span class="k">if</span> <span class="n">advantage</span> <span class="ow">and</span> <span class="n">disadvantage</span><span class="p">:</span>
            <span class="n">rolltxt</span> <span class="o">=</span> <span class="s2">&quot;d20 (advantage canceled by disadvantage)&quot;</span>
        <span class="k">elif</span> <span class="n">advantage</span><span class="p">:</span>
            <span class="n">rolltxt</span> <span class="o">=</span> <span class="s2">&quot;|g2d20|n (advantage: picking highest) &quot;</span>
        <span class="k">elif</span> <span class="n">disadvantage</span><span class="p">:</span>
            <span class="n">rolltxt</span> <span class="o">=</span> <span class="s2">&quot;|r2d20|n (disadvantage: picking lowest) &quot;</span>
        <span class="n">bontxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(+</span><span class="si">{</span><span class="n">bonus</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">modtxt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modifier</span><span class="p">:</span>
            <span class="n">modtxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; + </span><span class="si">{</span><span class="n">modifier</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">modifier</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">qualtxt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">quality</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">!)&quot;</span> <span class="k">if</span> <span class="n">quality</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;rolled </span><span class="si">{</span><span class="n">dice_roll</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">rolltxt</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;+ </span><span class="si">{</span><span class="n">bonus_type</span><span class="o">.</span><span class="n">value</span><span class="si">}{</span><span class="n">bontxt</span><span class="si">}{</span><span class="n">modtxt</span><span class="si">}</span><span class="s2"> vs &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> -&gt; |w</span><span class="si">{</span><span class="n">result</span><span class="si">}{</span><span class="n">qualtxt</span><span class="si">}</span><span class="s2">|n&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">dice_roll</span> <span class="o">+</span> <span class="n">bonus</span> <span class="o">+</span> <span class="n">modifier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">txt</span></div>

<div class="viewcode-block" id="EvAdventureRollEngine.opposed_saving_throw"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.opposed_saving_throw">[docs]</a>    <span class="k">def</span> <span class="nf">opposed_saving_throw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">attacker</span><span class="p">,</span>
        <span class="n">defender</span><span class="p">,</span>
        <span class="n">attack_type</span><span class="o">=</span><span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
        <span class="n">defense_type</span><span class="o">=</span><span class="n">Ability</span><span class="o">.</span><span class="n">ARMOR</span><span class="p">,</span>
        <span class="n">advantage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">disadvantage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">modifier</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An saving throw that tries to beat an active opposing side.</span>

<span class="sd">        Args:</span>
<span class="sd">            attacker (Character): The attacking party.</span>
<span class="sd">            defender (Character): The one defending.</span>
<span class="sd">            attack_type (str): Which ability to use in the attack, like &#39;strength&#39; or &#39;willpower&#39;.</span>
<span class="sd">                Minimum is always 1.</span>
<span class="sd">            defense_type (str): Which ability to defend with, in addition to &#39;armor&#39;.</span>
<span class="sd">                Minimum is always 11 (bonus + 10 is always the defense in _Knave_).</span>
<span class="sd">            advantage (bool): Roll 2d20 and use the bigger number.</span>
<span class="sd">            disadvantage (bool): Roll 2d20 and use the smaller number.</span>
<span class="sd">            modifier (int): An additional +/- modifier to the roll.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (bool, str, str): If the attack succeed or not. The second element is the</span>
<span class="sd">                quality of the roll - None (normal), &quot;critical fail&quot; and &quot;critical success&quot;. Last</span>
<span class="sd">                element is a text that summarizes the details of the roll.</span>
<span class="sd">        Notes:</span>
<span class="sd">            Advantage and disadvantage cancel each other out.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># what is stored on the character/npc is the bonus; we add 10 to get the defense target</span>
        <span class="n">defender_defense</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">defender</span><span class="p">,</span> <span class="n">defense_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_throw</span><span class="p">(</span>
            <span class="n">attacker</span><span class="p">,</span>
            <span class="n">bonus_type</span><span class="o">=</span><span class="n">attack_type</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">defender_defense</span><span class="p">,</span>
            <span class="n">advantage</span><span class="o">=</span><span class="n">advantage</span><span class="p">,</span>
            <span class="n">disadvantage</span><span class="o">=</span><span class="n">disadvantage</span><span class="p">,</span>
            <span class="n">modifier</span><span class="o">=</span><span class="n">modifier</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Roll vs </span><span class="si">{</span><span class="n">defense_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">defender_defense</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="n">txt</span></div>

<div class="viewcode-block" id="EvAdventureRollEngine.roll_random_table"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.roll_random_table">[docs]</a>    <span class="k">def</span> <span class="nf">roll_random_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dieroll</span><span class="p">,</span> <span class="n">table_choices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a roll on a random table.</span>

<span class="sd">        Args:</span>
<span class="sd">            dieroll (str): The dice to roll, like 1d6, 1d20, 3d6 etc).</span>
<span class="sd">            table_choices (iterable): If a list of single elements, the die roll</span>
<span class="sd">                should fully encompass the table, like a 1d20 roll for a table</span>
<span class="sd">                with 20 elements. If each element is a tuple, the first element</span>
<span class="sd">                of the tuple is assumed to be a string &#39;X-Y&#39; indicating the</span>
<span class="sd">                range of values that should match the roll.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The result of the random roll.</span>

<span class="sd">        Example:</span>
<span class="sd">            `roll table_choices = [(&#39;1-5&#39;, &quot;Blue&quot;), (&#39;6-9&#39;: &quot;Red&quot;), (&#39;10&#39;, &quot;Purple&quot;)]`</span>

<span class="sd">        Notes:</span>
<span class="sd">            If the roll is outside of the listing, the closest edge value is used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">roll_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dieroll</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_choices</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="c1"># tuple with range conditional, like (&#39;1-5&#39;, &quot;Blue&quot;) or (&#39;10&#39;, &quot;Purple&quot;)</span>
            <span class="n">max_range</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">min_range</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">valrange</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span> <span class="ow">in</span> <span class="n">table_choices</span><span class="p">:</span>

                <span class="n">minval</span><span class="p">,</span> <span class="o">*</span><span class="n">maxval</span> <span class="o">=</span> <span class="n">valrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">minval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">minval</span><span class="p">))</span>
                <span class="n">maxval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">maxval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">maxval</span> <span class="k">else</span> <span class="n">minval</span><span class="p">)</span>

                <span class="c1"># we store the largest/smallest values so far in case we need to use them</span>
                <span class="n">max_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_range</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>
                <span class="n">min_range</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_range</span><span class="p">,</span> <span class="n">minval</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">minval</span> <span class="o">&lt;=</span> <span class="n">roll_result</span> <span class="o">&lt;=</span> <span class="n">maxval</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">choice</span>

            <span class="c1"># if we have no result, we are outside of the range, we pick the edge values. It is also</span>
            <span class="c1"># possible the range contains &#39;gaps&#39;, but that&#39;d be an error in the random table itself.</span>
            <span class="k">if</span> <span class="n">roll_result</span> <span class="o">&gt;</span> <span class="n">max_range</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">table_choices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">table_choices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># regular list - one line per value.</span>
            <span class="n">roll_result</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table_choices</span><span class="p">),</span> <span class="n">roll_result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">table_choices</span><span class="p">[</span><span class="n">roll_result</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></div>

    <span class="c1"># specific rolls / actions</span>

<div class="viewcode-block" id="EvAdventureRollEngine.morale_check"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.morale_check">[docs]</a>    <span class="k">def</span> <span class="nf">morale_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A morale check is done for NPCs/monsters. It&#39;s done with a 2d6 against</span>
<span class="sd">        their morale.</span>

<span class="sd">        Args:</span>
<span class="sd">            defender (NPC): The entity trying to defend its morale.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: False if morale roll failed, True otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;2d6&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">defender</span><span class="o">.</span><span class="n">morale</span></div>

<div class="viewcode-block" id="EvAdventureRollEngine.heal_from_rest"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.heal_from_rest">[docs]</a>    <span class="k">def</span> <span class="nf">heal_from_rest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A meal and a full night&#39;s rest allow for regaining 1d8 + Const bonus HP.</span>

<span class="sd">        Args:</span>
<span class="sd">            character (Character): The one resting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">character</span><span class="o">.</span><span class="n">heal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">character</span><span class="o">.</span><span class="n">constitution</span><span class="p">)</span></div>

    <span class="n">death_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;weakened&quot;</span><span class="p">:</span> <span class="s2">&quot;strength&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unsteady&quot;</span><span class="p">:</span> <span class="s2">&quot;dexterity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sickly&quot;</span><span class="p">:</span> <span class="s2">&quot;constitution&quot;</span><span class="p">,</span>
        <span class="s2">&quot;addled&quot;</span><span class="p">:</span> <span class="s2">&quot;intelligence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rattled&quot;</span><span class="p">:</span> <span class="s2">&quot;wisdom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;disfigured&quot;</span><span class="p">:</span> <span class="s2">&quot;charisma&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="EvAdventureRollEngine.roll_death"><a class="viewcode-back" href="../../../../../api/evennia.contrib.tutorials.evadventure.rules.html#evennia.contrib.tutorials.evadventure.rules.EvAdventureRollEngine.roll_death">[docs]</a>    <span class="k">def</span> <span class="nf">roll_death</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Happens when hitting &lt;= 0 hp. unless dead,</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_random_table</span><span class="p">(</span><span class="s2">&quot;1d8&quot;</span><span class="p">,</span> <span class="n">death_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;dead&quot;</span><span class="p">:</span>
            <span class="n">character</span><span class="o">.</span><span class="n">at_death</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># survives with degraded abilities (1d4 roll)</span>
            <span class="n">abi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_map</span><span class="p">[</span><span class="n">result</span><span class="p">]</span>

            <span class="n">current_abi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">abi</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d4&quot;</span><span class="p">)</span>

            <span class="n">current_abi</span> <span class="o">-=</span> <span class="n">loss</span>

            <span class="k">if</span> <span class="n">current_abi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
                <span class="c1"># can&#39;t lose more - die</span>
                <span class="n">character</span><span class="o">.</span><span class="n">at_death</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># refresh health, but get permanent ability loss</span>
                <span class="n">new_hp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="s2">&quot;1d4&quot;</span><span class="p">)</span>
                <span class="n">character</span><span class="o">.</span><span class="n">heal</span><span class="p">(</span><span class="n">new_hp</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">abi</span><span class="p">,</span> <span class="n">current_abi</span><span class="p">)</span>

                <span class="n">character</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="mi">78</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|yYou survive your brush with death, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but are |r</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">|y and permanently |rlose </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">abi</span><span class="si">}</span><span class="s2">|y.|n</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;|GYou recover |g</span><span class="si">{</span><span class="n">new_hp</span><span class="si">}</span><span class="s2">|G health|.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="mi">78</span>
                <span class="p">)</span></div></div>


<span class="c1"># singletons</span>

<span class="c1"># access rolls e.g. with rules.dice.opposed_saving_throw(...)</span>
<span class="n">dice</span> <span class="o">=</span> <span class="n">EvAdventureRollEngine</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.tutorials.evadventure.rules</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>