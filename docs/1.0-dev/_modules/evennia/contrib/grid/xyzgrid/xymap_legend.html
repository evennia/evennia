
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.contrib.grid.xyzgrid.xymap_legend &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.grid.xyzgrid.xymap_legend</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="xymap_legend.html">1.0-dev (develop branch)</a></li>
   <ul>
    <li><a href="../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>
</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.contrib.grid.xyzgrid.xymap_legend</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># Map legend components</span>

<span class="sd">Each map-legend component is either a &#39;mapnode&#39; - something that represents and actual in-game</span>
<span class="sd">location (usually a room) or a &#39;maplink&#39; - something connecting nodes together. The start of a link</span>
<span class="sd">usually shows as an Exit, but the length of the link has no in-game equivalent.</span>

<span class="sd">----</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">zeros</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="se">\n</span><span class="s2">The XYZgrid contrib requires &quot;</span>
        <span class="s2">&quot;the SciPy package. Install with `pip install scipy&#39;.&quot;</span>
    <span class="p">)</span>

<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">django_exceptions</span>

<span class="kn">from</span> <span class="nn">evennia.prototypes</span> <span class="kn">import</span> <span class="n">spawner</span>
<span class="kn">from</span> <span class="nn">evennia.utils.utils</span> <span class="kn">import</span> <span class="n">class_from_module</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">BIGVAL</span><span class="p">,</span> <span class="n">MAPSCAN</span><span class="p">,</span> <span class="n">REVERSE_DIRECTIONS</span><span class="p">,</span> <span class="n">MapError</span><span class="p">,</span> <span class="n">MapParserError</span>

<span class="n">NodeTypeclass</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">ExitTypeclass</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">UUID_XYZ_NAMESPACE</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;xyzgrid&quot;</span><span class="p">)</span>


<span class="c1"># Nodes/Links</span>


<div class="viewcode-block" id="MapNode"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode">[docs]</a><span class="k">class</span> <span class="nc">MapNode</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This represents a &#39;room&#39; node on the map. Note that the map system deals with two grids, the</span>
<span class="sd">    finer `xygrid`, which is the per-character grid on the map, and the `XYgrid` which contains only</span>
<span class="sd">    the even-integer coordinates and also represents in-game coordinates/rooms. MapNodes are always</span>
<span class="sd">    located on even X,Y coordinates on the map grid and in-game.</span>

<span class="sd">    MapNodes will also handle the syncing of themselves and all outgoing links to the grid.</span>

<span class="sd">    Attributes on the node class:</span>

<span class="sd">    - `symbol` (str) - The character to parse from the map into this node. By default this</span>
<span class="sd">      is &#39;#&#39; and must be a single character, with the exception of `\\</span>
<span class="sd">    - `display_symbol` (str or `None`) - This is what is used to visualize this node later. This</span>
<span class="sd">      symbol must still only have a visual size of 1, but you could e.g. use some fancy unicode</span>
<span class="sd">      character (be aware of encodings to different clients though) or, commonly, add color</span>
<span class="sd">      tags around it. For further customization, the `.get_display_symbol` method</span>
<span class="sd">      can return a dynamically determined display symbol. If set to `None`, the `symbol` is used.</span>
<span class="sd">    - `interrupt_path` (bool): If this is set, the shortest-path algorithm will include this</span>
<span class="sd">      node as normally, but the auto-stepper will stop when reaching it, even if not having reached</span>
<span class="sd">      its target yet. This is useful for marking &#39;points of interest&#39; along a route, or places where</span>
<span class="sd">      you are not expected to be able to continue without some further in-game action not covered by</span>
<span class="sd">      the map (such as a guard or locked gate etc).</span>
<span class="sd">    - `prototype` (dict) - The default `prototype` dict to use for reproducing this map component</span>
<span class="sd">      on the game grid. This is used if not overridden specifically for this coordinate. If this</span>
<span class="sd">      is not given, nothing will be spawned for this coordinate (a &#39;virtual&#39; node can be useful</span>
<span class="sd">      for various reasons, mostly map-transitions).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># symbol used to identify this link on the map</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="c1"># if printing this node should show another symbol. If set</span>
    <span class="c1"># to the empty string, use `symbol`.</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># this will interrupt a shortest-path step (useful for &#39;points&#39; of interest, stop before</span>
    <span class="c1"># a door etc).</span>
    <span class="n">interrupt_path</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># the prototype to use for mapping this to the grid.</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># internal use. Set during generation, but is also used for identification of the node</span>
    <span class="n">node_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># this should always be left True for Nodes and avoids inifinite loops during querying.</span>
    <span class="n">multilink</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># default values to use if the exit doesn&#39;t have a &#39;spawn_aliases&#39; iterable</span>
    <span class="n">direction_spawn_defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;north&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;northeast&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;north-east&quot;</span><span class="p">),</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;east&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;southeast&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;south-east&quot;</span><span class="p">),</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;south&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;southwest&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;south-west&quot;</span><span class="p">),</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;west&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;northwest&quot;</span><span class="p">,</span> <span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;north-west&quot;</span><span class="p">),</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;do&quot;</span><span class="p">),</span>
        <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="MapNode.__init__"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">node_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xymap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the mapnode.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (int): Coordinate on xygrid.</span>
<span class="sd">            y (int): Coordinate on xygrid.</span>
<span class="sd">            Z (int or str): Name/Z-pos of this map.</span>
<span class="sd">            node_index (int): This identifies this node with a running</span>
<span class="sd">                index number required for pathfinding. This is used</span>
<span class="sd">                internally and should not be set manually.</span>
<span class="sd">            symbol (str, optional): Set during parsing - allows to override</span>
<span class="sd">                the symbol based on what&#39;s set in the legend.</span>
<span class="sd">            xymap (XYMap, optional): The map object this sits on.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1"># map name, usually</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span> <span class="o">=</span> <span class="n">xymap</span>

        <span class="c1"># XYgrid coordinate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_index</span> <span class="o">=</span> <span class="n">node_index</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>

        <span class="c1"># this indicates linkage in 8 cardinal directions on the string-map,</span>
        <span class="c1"># n,ne,e,se,s,sw,w,nw and link that to a node (always)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># first MapLink in each direction - used by grid syncing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># this maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># lowest direction to a given neighbor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortest_route_to_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># maps the directions (on the xygrid NOT on XYgrid!) taken if stepping</span>
        <span class="c1"># out from this node in a  given direction until you get to the end node.</span>
        <span class="c1"># This catches eventual longer link chains that would otherwise be lost</span>
        <span class="c1"># {startdirection: [direction, ...], ...}</span>
        <span class="c1"># where the directional path-lists also include the start-direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_steps_to_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># direction-names of the closest neighbors to the node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closest_neighbor_names</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;MapNode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_index</span><span class="si">}</span><span class="s2"> XY=(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="MapNode.log"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;log messages using the xygrid parent&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapNode.generate_prototype_key"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.generate_prototype_key">[docs]</a>    <span class="k">def</span> <span class="nf">generate_prototype_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a deterministic prototype key to allow for users to apply prototypes without</span>
<span class="sd">        needing a separate new name for every one.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">UUID_XYZ_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))))</span></div>

<div class="viewcode-block" id="MapNode.build_links"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.build_links">[docs]</a>    <span class="k">def</span> <span class="nf">build_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called by the map parser when this node is encountered. It tells the node</span>
<span class="sd">        to scan in all directions and follow any found links to other nodes. Since there</span>
<span class="sd">        could be multiple steps to reach another node, the system will iterate down each</span>
<span class="sd">        path and store it once and for all.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This sets up all data needed for later use of this node in pathfinding and</span>
<span class="sd">            other operations. The method can&#39;t run immediately when the node is created</span>
<span class="sd">            since a complete parsed xygrid is required.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">xygrid</span>

        <span class="c1"># we must use the xygrid coordinates</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>

        <span class="c1"># scan in all directions for links</span>
        <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="ow">in</span> <span class="n">MAPSCAN</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span>

            <span class="k">if</span> <span class="n">lx</span> <span class="ow">in</span> <span class="n">xygrid</span> <span class="ow">and</span> <span class="n">ly</span> <span class="ow">in</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">lx</span><span class="p">]:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">lx</span><span class="p">][</span><span class="n">ly</span><span class="p">]</span>

                <span class="c1"># just because there is a link here, doesn&#39;t mean it has a</span>
                <span class="c1"># connection in this direction. If so, the `end_node` will be None.</span>
                <span class="n">end_node</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">REVERSE_DIRECTIONS</span><span class="p">[</span><span class="n">direction</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">end_node</span><span class="p">:</span>
                    <span class="c1"># the link could be followed to an end node!</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">first_links</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>

                    <span class="c1"># check the actual direction-alias to use, since this may be</span>
                    <span class="c1"># different than the xygrid cardinal directions. There must be</span>
                    <span class="c1"># no duplicates out of this node or there will be a</span>
                    <span class="c1"># multi-match error later!</span>
                    <span class="n">first_step_name</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">direction_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">first_step_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">closest_neighbor_names</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;has more than one outgoing direction &#39;</span><span class="si">{</span><span class="n">first_step_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                            <span class="s2">&quot;All directions out of a node must be unique.&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">closest_neighbor_names</span><span class="p">[</span><span class="n">first_step_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span>

                    <span class="n">node_index</span> <span class="o">=</span> <span class="n">end_node</span><span class="o">.</span><span class="n">node_index</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">node_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_node</span>
                    <span class="c1"># this is useful for map building later - there could be multiple</span>
                    <span class="c1"># links tied together until getting to the node</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_steps_to_node</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span>

                    <span class="c1"># used for building the shortest path. Note that we store the</span>
                    <span class="c1"># aliased link directions here, for quick display by the</span>
                    <span class="c1"># shortest-route solver</span>
                    <span class="n">shortest_route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_route_to_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_index</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">BIGVAL</span><span class="p">))[</span>
                        <span class="mi">2</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;</span> <span class="n">shortest_route</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shortest_route_to_node</span><span class="p">[</span><span class="n">node_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_step_name</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapNode.linkweights"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.linkweights">[docs]</a>    <span class="k">def</span> <span class="nf">linkweights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nnodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve all the weights for the direct links to all other nodes. This is</span>
<span class="sd">        used for the efficient generation of shortest-paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            nnodes (int): The total number of nodes</span>

<span class="sd">        Returns:</span>
<span class="sd">            scipy.array: Array of weights of the direct links to other nodes.</span>
<span class="sd">                The weight will be 0 for nodes not directly connected to one another.</span>

<span class="sd">        Notes:</span>
<span class="sd">            A node can at most have 8 connections (the cardinal directions).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">link_graph</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node_index</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">link_graph</span><span class="p">[</span><span class="n">node_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">return</span> <span class="n">link_graph</span></div>

<div class="viewcode-block" id="MapNode.get_display_symbol"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.get_display_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">get_display_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook to override for customizing how the display_symbol is determined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The display-symbol to use. This must visually be a single character</span>
<span class="sd">            but could have color markers, use a unicode font etc.</span>

<span class="sd">        Notes:</span>
<span class="sd">            By default, just setting .display_symbol is enough.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span></div>

<div class="viewcode-block" id="MapNode.get_spawn_xyz"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.get_spawn_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_spawn_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should return the XYZ-coordinates for spawning this node. This normally</span>
<span class="sd">        the XYZ of the current map, but for traversal-nodes, it can also be the location</span>
<span class="sd">        on another map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: The (X, Y, Z) coords to spawn this node at.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span></div>

<div class="viewcode-block" id="MapNode.get_exit_spawn_name"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.get_exit_spawn_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_exit_spawn_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">return_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the spawn name for the exit being created by this link.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction (str): The cardinal direction (n,ne etc) the want the</span>
<span class="sd">                exit name/aliases for.</span>
<span class="sd">            return_aliases (bool, optional): Also return all aliases.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str or tuple: The key of the spawned exit, or a tuple (key, alias, alias, ...)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_links</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span><span class="o">.</span><span class="n">spawn_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_spawn_defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;unknown&quot;</span><span class="p">,))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_aliases</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="MapNode.spawn"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.spawn">[docs]</a>    <span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an actual in-game room from this node.</span>

<span class="sd">        This should be called as part of the node-sync step of the map sync. The reason is</span>
<span class="sd">        that the exits (next step) requires all nodes to exist before they can link up</span>
<span class="sd">        to their destinations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">NodeTypeclass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NodeTypeclass</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.xyzroom</span> <span class="kn">import</span> <span class="n">XYZRoom</span> <span class="k">as</span> <span class="n">NodeTypeclass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="p">:</span>
            <span class="c1"># no prototype means we can&#39;t spawn anything -</span>
            <span class="c1"># a &#39;virtual&#39; node.</span>
            <span class="k">return</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spawn_xyz</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nodeobj</span> <span class="o">=</span> <span class="n">NodeTypeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">django_exceptions</span><span class="o">.</span><span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="c1"># create a new entity, using the specified typeclass (if there&#39;s one) and</span>
            <span class="c1"># with proper coordinates etc</span>
            <span class="n">typeclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">typeclass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MapError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The prototype </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="si">}</span><span class="s2"> for this node has no &#39;typeclass&#39; key.&quot;</span><span class="p">,</span> <span class="bp">self</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  spawning room at xyz=</span><span class="si">{</span><span class="n">xyz</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">typeclass</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">Typeclass</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">typeclass</span><span class="p">)</span>
            <span class="n">nodeobj</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;An empty room&quot;</span><span class="p">),</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  updating existing room (if changed) at xyz=</span><span class="si">{</span><span class="n">xyz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">):</span>
            <span class="c1"># make sure there is a prototype_key in prototype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_prototype_key</span><span class="p">()</span>

        <span class="c1"># apply prototype to node. This will not override the XYZ tags since</span>
        <span class="c1"># these are not in the prototype and exact=False</span>
        <span class="n">spawner</span><span class="o">.</span><span class="n">batch_update_objects_with_prototype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="n">nodeobj</span><span class="p">],</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapNode.spawn_links"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.spawn_links">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build actual in-game exits based on the links out of this room.</span>

<span class="sd">        Args:</span>
<span class="sd">            directions (list, optional): If given, this should be a list of supported</span>
<span class="sd">                directions (n, ne, etc). Only links in these directions will be spawned</span>
<span class="sd">                for this node.</span>

<span class="sd">        This should be called after all `sync_node_to_grid` operations have finished across</span>
<span class="sd">        the entire XYZgrid. This creates/syncs all exits to their locations and destinations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="p">:</span>
            <span class="c1"># no exits to spawn out of a &#39;virtual&#39; node.</span>
            <span class="k">return</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">direction_limits</span> <span class="o">=</span> <span class="n">directions</span>

        <span class="k">global</span> <span class="n">ExitTypeclass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ExitTypeclass</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.xyzroom</span> <span class="kn">import</span> <span class="n">XYZExit</span> <span class="k">as</span> <span class="n">ExitTypeclass</span>

        <span class="n">maplinks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exit_spawn_name</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">):</span>
                <span class="c1"># generate a deterministic prototype_key if it doesn&#39;t exist</span>
                <span class="n">link</span><span class="o">.</span><span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_prototype_key</span><span class="p">()</span>
            <span class="n">maplinks</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>

        <span class="c1"># remove duplicates</span>
        <span class="n">linkobjs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exitobj</span> <span class="ow">in</span> <span class="n">ExitTypeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">):</span>
            <span class="n">linkobjs</span><span class="p">[</span><span class="n">exitobj</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exitobj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exitkey</span><span class="p">,</span> <span class="n">exitobjs</span> <span class="ow">in</span> <span class="n">linkobjs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">exitobj</span> <span class="ow">in</span> <span class="n">exitobjs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  deleting duplicate </span><span class="si">{</span><span class="n">exitkey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">exitobj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># we need to search for exits in all directions since some</span>
        <span class="c1"># may have been removed since last sync</span>
        <span class="n">linkobjs</span> <span class="o">=</span> <span class="p">{</span><span class="n">exi</span><span class="o">.</span><span class="n">db_key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">exi</span> <span class="k">for</span> <span class="n">exi</span> <span class="ow">in</span> <span class="n">ExitTypeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)}</span>

        <span class="c1"># figure out if the topology changed between grid and map (will always</span>
        <span class="c1"># build all exits first run)</span>
        <span class="n">differing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">maplinks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">linkobjs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">differing_key</span> <span class="ow">in</span> <span class="n">differing_keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">differing_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">maplinks</span><span class="p">:</span>
                <span class="c1"># an exit without a maplink - delete the exit-object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  deleting exit at xyz=</span><span class="si">{</span><span class="n">xyz</span><span class="si">}</span><span class="s2">, direction=</span><span class="si">{</span><span class="n">differing_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">linkobjs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">differing_key</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># missing in linkobjs - create a new exit</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">maplinks</span><span class="p">[</span><span class="n">differing_key</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">direction_limits</span> <span class="ow">and</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">direction_limits</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">exitnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
                <span class="n">prot</span> <span class="o">=</span> <span class="n">maplinks</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">prototype</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">typeclass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MapError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The prototype </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prototype</span><span class="si">}</span><span class="s2"> for this node has no &#39;typeclass&#39; key.&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  spawning/updating exit xyz=</span><span class="si">{</span><span class="n">xyz</span><span class="si">}</span><span class="s2">, direction=</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">typeclass</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="n">Typeclass</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">typeclass</span><span class="p">)</span>
                <span class="n">exi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                    <span class="n">xyz_destination</span><span class="o">=</span><span class="n">exitnode</span><span class="o">.</span><span class="n">get_spawn_xyz</span><span class="p">(),</span>
                    <span class="n">aliases</span><span class="o">=</span><span class="n">aliases</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

                <span class="n">linkobjs</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">exi</span>

        <span class="c1"># apply prototypes to catch any changes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">linkobj</span> <span class="ow">in</span> <span class="n">linkobjs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">spawner</span><span class="o">.</span><span class="n">batch_update_objects_with_prototype</span><span class="p">(</span>
                <span class="n">maplinks</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">prototype</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="n">linkobj</span><span class="p">],</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="MapNode.unspawn"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapNode.unspawn">[docs]</a>    <span class="k">def</span> <span class="nf">unspawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all spawned objects related to this node and all links.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">NodeTypeclass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NodeTypeclass</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.room</span> <span class="kn">import</span> <span class="n">XYZRoom</span> <span class="k">as</span> <span class="n">NodeTypeclass</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nodeobj</span> <span class="o">=</span> <span class="n">NodeTypeclass</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">django_exceptions</span><span class="o">.</span><span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="c1"># no object exists</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodeobj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TransitionMapNode"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.TransitionMapNode">[docs]</a><span class="k">class</span> <span class="nc">TransitionMapNode</span><span class="p">(</span><span class="n">MapNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This node acts as an end-node for a link that actually leads to a specific node on another</span>
<span class="sd">    map. It is not actually represented by a separate room in-game.</span>

<span class="sd">    This teleportation is not understood by the pathfinder, so why it will be possible to pathfind</span>
<span class="sd">    to this node, it really represents a map transition. Only a single link must ever be connected</span>
<span class="sd">    to this node.</span>

<span class="sd">    Properties:</span>
<span class="sd">    - `target_map_xyz` (tuple) - the (X, Y, Z) coordinate of a node on the other map to teleport</span>
<span class="sd">        to when moving to this node. This should not be another TransitionMapNode (see below for</span>
<span class="sd">        how to make a two-way link).</span>

<span class="sd">    Examples:</span>
<span class="sd">    ::</span>

<span class="sd">        map1   map2</span>

<span class="sd">        #-T    #-    - one-way transition from map1 -&gt; map2.</span>
<span class="sd">        #-T    T-#   - two-way. Both TransitionMapNodes links to the coords of the</span>
<span class="sd">                       actual rooms (`#`) on the other map (NOT to the `T`s)!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="c1"># X,Y,Z coordinates of target node</span>
    <span class="n">taget_map_xyz</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="TransitionMapNode.get_spawn_xyz"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.TransitionMapNode.get_spawn_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_spawn_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure to return the coord of the *target* - this will be used when building</span>
<span class="sd">        the exit to this node (since the prototype is None, this node itself will not be built).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="kc">True</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_map_xyz</span> <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;unset&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;(Z=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">Z</span><span class="si">}</span><span class="s2">) has not defined its &quot;</span>
                <span class="s2">&quot;`.target_map_xyz` property. It must point &quot;</span>
                <span class="s2">&quot;to another valid xymap (Z coordinate).&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_map_xyz</span></div>

<div class="viewcode-block" id="TransitionMapNode.build_links"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.TransitionMapNode.build_links">[docs]</a>    <span class="k">def</span> <span class="nf">build_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check so we don&#39;t have too many links&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_links</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span><span class="s2">&quot;may have at most one link connecting to it.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink">[docs]</a><span class="k">class</span> <span class="nc">MapLink</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This represents one or more links between an &#39;incoming direction&#39;</span>
<span class="sd">    and an &#39;outgoing direction&#39;. It&#39;s like a railway track between</span>
<span class="sd">    MapNodes. A Link can be placed on any location in the grid, but even when</span>
<span class="sd">    on an integer XY position they still don&#39;t represent an actual in-game place</span>
<span class="sd">    but just a link between such places (the Nodes).</span>

<span class="sd">    Each link has a &#39;weight&#39; &gt;=1,  this indicates how &#39;slow&#39;</span>
<span class="sd">    it is to traverse that link. This is used by the Dijkstra algorithm</span>
<span class="sd">    to find the &#39;fastest&#39; route to a point. By default this weight is 1</span>
<span class="sd">    for every link, but a locked door, terrain etc could increase this</span>
<span class="sd">    and have the shortest-path algorithm prefer to use another route.</span>

<span class="sd">    Attributes on the link class:</span>

<span class="sd">    - `symbol` (str) - The character to parse from the map into this node. This must be a single</span>
<span class="sd">      character, with the exception of `\\`.</span>
<span class="sd">    - `display_symbol` (str or None)  - This is what is used to visualize this node later. This</span>
<span class="sd">      symbol must still only have a visual size of 1, but you could e.g. use some fancy unicode</span>
<span class="sd">      character (be aware of encodings to different clients though) or, commonly, add color</span>
<span class="sd">      tags around it. For further customization, the `.get_display_symbol` can be used.</span>
<span class="sd">    - `default_weight` (int) - Each link direction covered by this link can have its separate</span>
<span class="sd">      weight, this is used if none is specified in a particular direction. This value must be &gt;= 1,</span>
<span class="sd">      and can be higher than 1 if a link should be less favored.</span>
<span class="sd">    - `directions` (dict) - this specifies which link edge to which other link-edge this link</span>
<span class="sd">      is connected; A link connecting the link&#39;s sw edge to its easted edge would be written</span>
<span class="sd">      as `{&#39;sw&#39;: &#39;e&#39;}` and read &#39;connects from southwest to east&#39;. Note that if you want the</span>
<span class="sd">      link to go both ways, also the inverse (east to southwest) must also be added.</span>
<span class="sd">    - `weights (dict)` This maps a link&#39;s start direction to a weight. So for the</span>
<span class="sd">      `{&#39;sw&#39;: &#39;e&#39;}` link, a weight would be given as `{&#39;sw&#39;: 2}`. If not given, a link will</span>
<span class="sd">      use the `default_weight`.</span>
<span class="sd">    - `average_long_link_weights` (bool): This applies to the *first* link out of a node only.</span>
<span class="sd">      When tracing links to another node, multiple links could be involved, each with a weight.</span>
<span class="sd">      So for a link chain with default weights, `#---#` would give a total weight of 3. With this</span>
<span class="sd">      setting, the weight will be 3 / 3 = 1. That is, for evenly weighted links, the length</span>
<span class="sd">      of the link doesn&#39;t matter.</span>
<span class="sd">    - `direction_aliases` (dict): When displaying a direction during pathfinding, one may want</span>
<span class="sd">      to display a different &#39;direction&#39; than the cardinal on-map one. For example &#39;up&#39; may be</span>
<span class="sd">      visualized on the map as a &#39;n&#39; movement, but the found path over this link should show</span>
<span class="sd">      as &#39;u&#39;. In that case, the alias would be `{&#39;n&#39;: &#39;u&#39;}`.</span>
<span class="sd">    - `multilink` (bool): If set, this link accepts links from all directions. It will usually</span>
<span class="sd">      use a custom get_direction to determine what these are based on surrounding topology. This</span>
<span class="sd">      setting is necessary to avoid infinite loops when such multilinks are next to each other.</span>
<span class="sd">    - `interrupt_path` (bool): If set, a shortest-path solution will include this link as normal,</span>
<span class="sd">      but will stop short of actually moving past this link.</span>
<span class="sd">    - `prototype` (dict) - The default `prototype` dict to use for reproducing this map component</span>
<span class="sd">      on the game grid. This is only relevant for the *first* link out of a Node (the continuation</span>
<span class="sd">      of the link is only used to determine its destination). This can be overridden on a</span>
<span class="sd">      per-direction basis.</span>
<span class="sd">    - `spawn_aliases` (dict): A mapping {direction: (key, alias, alias, ...) to use when spawning</span>
<span class="sd">      actual exits from this link. If not given, a sane set of defaults (n=(north, n) etc) will be</span>
<span class="sd">      used. This is required if you use any custom directions outside of the cardinal directions +</span>
<span class="sd">      up/down. The exit&#39;s key (useful for auto-walk) is usually retrieved by calling</span>
<span class="sd">      `node.get_exit_spawn_name(direction)`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># symbol for identifying this link on the map</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># if `None`, use .symbol</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default_weight</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># This setting only applies if this is the *first* link in a chain of multiple links. Usually,</span>
    <span class="c1"># when multiple links are used to tie together two nodes, the default is to average the weight</span>
    <span class="c1"># across all links. With this disabled, the weights will be added and a long link will be</span>
    <span class="c1"># considered &#39;longer&#39; by the pathfinder.</span>
    <span class="n">average_long_link_weights</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># this indicates linkage start:end in 8 cardinal directions on the string-map,</span>
    <span class="c1"># n,ne,e,se,s,sw,w,nw. A link is described as {startpos:endpoit}, like connecting</span>
    <span class="c1"># the named corners with a line. If the inverse direction is also possible, it</span>
    <span class="c1"># must also be specified. So a south-northward, two-way link would be described</span>
    <span class="c1"># as {&quot;s&quot;: &quot;n&quot;, &quot;n&quot;: &quot;s&quot;}. The get_direction method can be customized to</span>
    <span class="c1"># return something else.</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># for displaying the directions during pathfinding, you may want to show a different</span>
    <span class="c1"># direction than the cardinal one. For example, &#39;up&#39; may be &#39;n&#39; on the map, but</span>
    <span class="c1"># the direction when moving should be &#39;u&#39;. This would be a alias {&#39;n&#39;: &#39;u&#39;}.</span>
    <span class="n">direction_aliases</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># this is required for pathfinding and contains cardinal directions (n, ne etc) only.</span>
    <span class="c1"># Each weight is defined as {startpos:weight}, where</span>
    <span class="c1"># the startpos is the direction of the cell (n,ne etc) where the link *starts*. The</span>
    <span class="c1"># weight is a value &gt; 0, smaller than BIGVAL. The get_weight method can be</span>
    <span class="c1"># customized to modify to return something else.</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># this shortcuts neighbors trying to figure out if they can connect to this link</span>
    <span class="c1"># - if this is set, they always can (similarly as to a node)</span>
    <span class="n">multilink</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># this link does not block/reroute pathfinding, but makes the actual path always stop when</span>
    <span class="c1"># trying to cross it.</span>
    <span class="n">interrupt_path</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># prototype for the first link out of a node.</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># used for spawning and maps {direction: (key, alias, alias, ...) for use for the exits spawned</span>
    <span class="c1"># in this direction. Used unless the exit&#39;s prototype contain an explicit key - then that will</span>
    <span class="c1"># take precedence. If neither that nor this is not given, sane defaults (&#39;n&#39;=(&#39;north&#39;,&#39;n&#39;), etc)</span>
    <span class="c1"># will be used.</span>
    <span class="n">spawn_aliases</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="MapLink.__init__"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xymap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the link.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (int): The xygrid x coordinate</span>
<span class="sd">            y (int): The xygrid y coordinate.</span>
<span class="sd">            X (int or str): The name/Z-coord of this map we are on.</span>
<span class="sd">            symbol (str, optional): Set during parsing, allows to override</span>
<span class="sd">                the default symbol with the one set in the legend.</span>
<span class="sd">            xymap (XYMap, optional): The map object this sits on.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span> <span class="o">=</span> <span class="n">xymap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span>

        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;LinkNode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39; XY=(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="MapLink.generate_prototype_key"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.generate_prototype_key">[docs]</a>    <span class="k">def</span> <span class="nf">generate_prototype_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a deterministic prototype key to allow for users to apply prototypes without</span>
<span class="sd">        needing a separate new name for every one.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args (str): These are used to further seed the key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">UUID_XYZ_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))))</span></div>

<div class="viewcode-block" id="MapLink.traverse"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.traverse">[docs]</a>    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">,</span> <span class="n">_weight</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_linklen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively traverse the links out of this LinkNode.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_direction (str): The direction (n, ne etc) from which</span>
<span class="sd">                this traversal originates for this link.</span>
<span class="sd">        Kwargs:</span>
<span class="sd">            _weight (int): Internal use.</span>
<span class="sd">            _linklen (int): Internal use.</span>
<span class="sd">            _steps (list): Internal use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: The (node, weight, links) result of the traversal, where links</span>
<span class="sd">                is a list of directions (n, ne etc) that describes how to to get</span>
<span class="sd">                to the node on the grid. This includes the first direction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MapParserError: If a link lead to nowhere.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">xygrid</span>

        <span class="n">end_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(</span><span class="n">start_direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end_direction</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># is perfectly okay to not be linking back on the first step (to a node)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;was connected to from the direction </span><span class="si">{</span><span class="n">start_direction</span><span class="si">}</span><span class="s2">, but &quot;</span>
                <span class="s2">&quot;is not set up to link in that direction.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># note that if `get_direction` returns an unknown direction, this will be equivalent</span>
        <span class="c1"># to pointing to an empty location, which makes sense</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">MAPSCAN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">end_direction</span><span class="p">,</span> <span class="p">(</span><span class="n">BIGVAL</span><span class="p">,</span> <span class="n">BIGVAL</span><span class="p">))</span>
        <span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_target</span> <span class="o">=</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">end_x</span><span class="p">][</span><span class="n">end_y</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># check if we have some special action up our sleeve</span>
            <span class="n">next_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_empty_target</span><span class="p">(</span><span class="n">start_direction</span><span class="p">,</span> <span class="n">end_direction</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_target</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;points to empty space in the direction </span><span class="si">{</span><span class="n">end_direction</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">_weight</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weight</span><span class="p">(</span><span class="n">start_direction</span><span class="p">,</span> <span class="n">_weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">next_target</span><span class="p">,</span> <span class="s2">&quot;node_index&quot;</span><span class="p">):</span>
            <span class="c1"># we reached a node, this is the end of the link.</span>
            <span class="c1"># we average the weight across all traversed link segments.</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">next_target</span><span class="p">,</span>
                <span class="n">_weight</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_linklen</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_long_link_weights</span> <span class="k">else</span> <span class="n">_weight</span><span class="p">,</span>
                <span class="n">_steps</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we hit another link. Progress recursively.</span>
            <span class="k">return</span> <span class="n">next_target</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span>
                <span class="n">REVERSE_DIRECTIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">end_direction</span><span class="p">,</span> <span class="n">end_direction</span><span class="p">),</span>
                <span class="n">_weight</span><span class="o">=</span><span class="n">_weight</span><span class="p">,</span>
                <span class="n">_linklen</span><span class="o">=</span><span class="n">_linklen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">_steps</span><span class="o">=</span><span class="n">_steps</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="MapLink.get_linked_neighbors"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.get_linked_neighbors">[docs]</a>    <span class="k">def</span> <span class="nf">get_linked_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper to get all directions to which there appears to be a</span>
<span class="sd">        visual link/node. This does not trace the length of the link and check weights etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            directions (list, optional): Only scan in these directions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Mapping {direction: node_or_link} wherever such was found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directions</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="n">REVERSE_DIRECTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="n">xygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">xygrid</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">MAPSCAN</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
            <span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">dy</span>
            <span class="k">if</span> <span class="n">end_x</span> <span class="ow">in</span> <span class="n">xygrid</span> <span class="ow">and</span> <span class="n">end_y</span> <span class="ow">in</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">end_x</span><span class="p">]:</span>
                <span class="c1"># there is is something there, we need to check if it is either</span>
                <span class="c1"># a map node or a link connecting in our direction</span>
                <span class="n">node_or_link</span> <span class="o">=</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">end_x</span><span class="p">][</span><span class="n">end_y</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">node_or_link</span><span class="o">.</span><span class="n">multilink</span> <span class="ow">or</span> <span class="n">node_or_link</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
                    <span class="n">links</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_or_link</span>
        <span class="k">return</span> <span class="n">links</span></div>

<div class="viewcode-block" id="MapLink.at_empty_target"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.at_empty_target">[docs]</a>    <span class="k">def</span> <span class="nf">at_empty_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">,</span> <span class="n">end_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called by `.traverse` when it finds this link pointing to nowhere.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_direction (str): The direction (n, ne etc) from which</span>
<span class="sd">                this traversal originates for this link.</span>
<span class="sd">            end_direction (str): The direction found from `get_direction` earlier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MapNode, MapLink or None: The next target to go to from here. `None` if this</span>
<span class="sd">            is an error that should be reported.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is usually a mapping error (returning `None`) but may have practical use, such as</span>
<span class="sd">            teleporting or transitioning to another map.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MapLink.get_direction"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook to override for customizing how the directions are</span>
<span class="sd">        determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_direction (str): The starting direction (n, ne etc).</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The &#39;out&#39; direction side of the link - where the link</span>
<span class="sd">                leads to.</span>

<span class="sd">        Example:</span>
<span class="sd">            With the default legend, if the link is a straght vertical link</span>
<span class="sd">            (`|`) and `start_direction` is `s` (link is approached from</span>
<span class="sd">            from the south side), then this function will return `n&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_direction</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapLink.get_weight"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.get_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">,</span> <span class="n">current_weight</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook to override for customizing how the weights are determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_direction (str): The starting direction (n, ne etc).</span>
<span class="sd">            current_weight (int): This can have an existing value if</span>
<span class="sd">                we are progressing down a multi-step path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The weight to use for a link from `start_direction`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_weight</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapLink.get_display_symbol"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapLink.get_display_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">get_display_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook to override for customizing how the display_symbol is determined.</span>
<span class="sd">        This is called after all other hooks, at map visualization.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The display-symbol to use. This must visually be a single character</span>
<span class="sd">            but could have color markers, use a unicode font etc.</span>

<span class="sd">        Notes:</span>
<span class="sd">            By default, just setting .display_symbol is enough.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span></div></div>


<div class="viewcode-block" id="SmartRerouterMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartRerouterMapLink">[docs]</a><span class="k">class</span> <span class="nc">SmartRerouterMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A &#39;smart&#39; link without visible direction, but which uses its topological surroundings</span>
<span class="sd">    to figure out how it connects. All such links are two-way. It can be used to create &#39;knees&#39; and</span>
<span class="sd">    multi-crossings of links. Remember that this is still a link, so user will not &#39;stop&#39; at it,</span>
<span class="sd">    even if placed on an XY position!</span>

<span class="sd">    If there are links on cardinally opposite sites, these are considered pass-throughs, and</span>
<span class="sd">    If determining the path of a set of input/output directions this is not possible, or there is an</span>
<span class="sd">    uneven number of links, an `MapParserError` is raised.</span>

<span class="sd">    Example with the RedirectLink:</span>
<span class="sd">    ::</span>
<span class="sd">          /</span>
<span class="sd">        -o    - this is ok, there can only be one path, e-ne</span>

<span class="sd">         |</span>
<span class="sd">        -o-   - equivalent to &#39;+&#39;, one n-s and one w-e link crossing</span>
<span class="sd">         |</span>

<span class="sd">        \|/</span>
<span class="sd">        -o-   - all are passing straight through</span>
<span class="sd">        /|\</span>

<span class="sd">        -o-   - w-e pass straight through, other link is sw-s</span>
<span class="sd">        /|</span>

<span class="sd">        -o    - invalid; impossible to know which input goes to which output</span>
<span class="sd">        /|</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">multilink</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SmartRerouterMapLink.get_direction"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartRerouterMapLink.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically determine the direction based on a source direction and grid topology.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all visually connected links</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">unhandled_links</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_linked_neighbors</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># get all straight lines (n-s, sw-ne etc) we can trace through</span>
            <span class="c1"># the dynamic link and remove them from the unhandled_links list</span>
            <span class="n">unhandled_links_copy</span> <span class="o">=</span> <span class="n">unhandled_links</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">unhandled_links_copy</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">REVERSE_DIRECTIONS</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="ow">in</span> <span class="n">unhandled_links_copy</span><span class="p">:</span>
                    <span class="n">directions</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">REVERSE_DIRECTIONS</span><span class="p">[</span>
                        <span class="n">unhandled_links</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">unhandled_links</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
                    <span class="p">]</span>

            <span class="c1"># check if we have any non-cross-through paths left to handle</span>
            <span class="n">n_unhandled</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unhandled_links</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_unhandled</span><span class="p">:</span>
                <span class="c1"># still remaining unhandled links. If there&#39;s not exactly</span>
                <span class="c1"># one &#39;incoming&#39; and one &#39;outgoing&#39; we can&#39;t figure out</span>
                <span class="c1"># where to go in a non-ambiguous way.</span>
                <span class="k">if</span> <span class="n">n_unhandled</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">links</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unhandled_links</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;cannot determine how to connect in/out directions </span><span class="si">{</span><span class="n">links</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span>
                    <span class="p">)</span>

                <span class="n">directions</span><span class="p">[</span><span class="n">unhandled_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">unhandled_links</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">directions</span><span class="p">[</span><span class="n">unhandled_links</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">unhandled_links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_direction</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SmartTeleporterMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartTeleporterMapLink">[docs]</a><span class="k">class</span> <span class="nc">SmartTeleporterMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The teleport link works by connecting to nowhere - and will then continue</span>
<span class="sd">    on another teleport link with the same symbol elsewhere on the map. The teleport</span>
<span class="sd">    symbol must connect to only one other link (not to a node).</span>

<span class="sd">    For this to work, there must be exactly one other teleport with the same `.symbol` on the map.</span>
<span class="sd">    The two teleports will always operate as two-way connections, but by making the &#39;out-link&#39; on</span>
<span class="sd">    one side one-way, the effect will be that of a one-way teleport.</span>

<span class="sd">    Example:</span>
<span class="sd">    ::</span>

<span class="sd">          t #</span>
<span class="sd">         /  |   -  moving ne from the left node will bring the user to the rightmost node</span>
<span class="sd">       -#   t      as if the two teleporters were connected (two way).</span>

<span class="sd">       -#-t t&gt;# - one-way teleport from left to right.</span>

<span class="sd">       -#t       - invalid, may only connect to another link</span>

<span class="sd">       -#-t-#    - invalid, only one connected link is allowed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>
    <span class="c1"># usually invisible</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">direction_name</span> <span class="o">=</span> <span class="s2">&quot;teleport&quot;</span>

<div class="viewcode-block" id="SmartTeleporterMapLink.__init__"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartTeleporterMapLink.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paired_teleporter</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SmartTeleporterMapLink.at_empty_target"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartTeleporterMapLink.at_empty_target">[docs]</a>    <span class="k">def</span> <span class="nf">at_empty_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">,</span> <span class="n">end_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called during traversal, when finding an unknown direction out of the link (same as</span>
<span class="sd">        targeting a link at an empty spot on the grid). This will also search for</span>
<span class="sd">        a unique, matching teleport to send to.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_direction (str): The direction (n, ne etc) from which this traversal originates</span>
<span class="sd">                for this link.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TeleporterMapLink: The paired teleporter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MapParserError: We raise this explicitly rather than returning `None` if we don&#39;t find</span>
<span class="sd">                another teleport. This avoids us getting the default (and in this case confusing)</span>
<span class="sd">                &#39;pointing to an empty space&#39; error we&#39;d get if returning `None`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">xygrid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">paired_teleporter</span><span class="p">:</span>
            <span class="c1"># scan for another teleporter</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
            <span class="n">found_teleporters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xygrid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">node_or_link</span> <span class="ow">in</span> <span class="n">xygrid</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node_or_link</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">symbol</span> <span class="ow">and</span> <span class="n">node_or_link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                        <span class="n">found_teleporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_or_link</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_teleporters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span><span class="s2">&quot;found no matching teleporter to link to.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_teleporters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                    <span class="s2">&quot;found too many matching teleporters (must be exactly one more): &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">found_teleporters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">other_teleporter</span> <span class="o">=</span> <span class="n">found_teleporters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># link the two so we don&#39;t need to scan again for the other one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paired_teleporter</span> <span class="o">=</span> <span class="n">other_teleporter</span>
            <span class="n">other_teleporter</span><span class="o">.</span><span class="n">paired_teleporter</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paired_teleporter</span></div>

<div class="viewcode-block" id="SmartTeleporterMapLink.get_direction"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartTeleporterMapLink.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figure out the connected link and paired teleport.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linked_neighbors</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span><span class="s2">&quot;must have exactly one link connected to it.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">direction</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">neighbors</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s2">&quot;node_index&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                    <span class="s2">&quot;can only connect to a Link. Found </span><span class="si">{link}</span><span class="s2"> in &quot;</span> <span class="s2">&quot;direction </span><span class="si">{direction}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span>
                <span class="p">)</span>
            <span class="c1"># the string &#39;teleport&#39; will not be understood by the traverser, leading to</span>
            <span class="c1"># this being interpreted as an empty target and the `at_empty_target`</span>
            <span class="c1"># hook firing when trying to traverse this link.</span>
            <span class="n">direction_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_name</span>
            <span class="k">if</span> <span class="n">start_direction</span> <span class="o">==</span> <span class="n">direction_name</span><span class="p">:</span>
                <span class="c1"># called while traversing another teleport</span>
                <span class="c1"># - we must make sure we can always access/leave the teleport.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction_name</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">direction_name</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># called while traversing a normal link</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="n">start_direction</span><span class="p">:</span> <span class="n">direction_name</span><span class="p">,</span> <span class="n">direction_name</span><span class="p">:</span> <span class="n">direction</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_direction</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SmartMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartMapLink">[docs]</a><span class="k">class</span> <span class="nc">SmartMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A &#39;smart&#39; link withot visible direction, but which uses its topological surroundings</span>
<span class="sd">    to figure out how it connects. Unlike the `SmartRerouterMapLink`, this link type is</span>
<span class="sd">    also a &#39;direction&#39; of its own and can thus connect directly to nodes. It can only describe</span>
<span class="sd">    one transition and will prefer connecting two nodes if there are other possibilities. If the</span>
<span class="sd">    linking is unclear or there are more than two nodes directly neighboring, a MapParserError will</span>
<span class="sd">    be raised.  If two nodes are not found, it will link to any combination of links- or nodes as</span>
<span class="sd">    long as it can un-ambiguously determine which direction they lead.</span>

<span class="sd">    Placing a smart-link directly between two nodes/links will always be a two-way connection,</span>
<span class="sd">    whereas if it connects a node with another link, it will be a one-way connection in the</span>
<span class="sd">    direction of the link.</span>

<span class="sd">    Example with the up-down directions:</span>
<span class="sd">    ::</span>

<span class="sd">        #</span>
<span class="sd">        u     - moving up in BOTH directions will bring you to the other node (two-way)</span>
<span class="sd">        #</span>

<span class="sd">        #</span>
<span class="sd">        d     - this better represents the &#39;real&#39; up/down behavior.</span>
<span class="sd">        u</span>
<span class="sd">        #</span>

<span class="sd">        #</span>
<span class="sd">        |     - one-way up from the lower node to the upper</span>
<span class="sd">        u</span>
<span class="sd">        #</span>

<span class="sd">        #-#</span>
<span class="sd">        u     - okay since the up-link prioritizes the nodes</span>
<span class="sd">        #</span>

<span class="sd">        #u#</span>
<span class="sd">        u    - invalid since top-left node has two &#39;up&#39; directions to go to</span>
<span class="sd">        #</span>

<span class="sd">        #     |</span>
<span class="sd">        u# or u-   - invalid.</span>
<span class="sd">        #     |</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">multilink</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SmartMapLink.get_direction"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SmartMapLink.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Figure out the direction from a specific source direction based on grid topology.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all visually connected links</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linked_neighbors</span><span class="p">()</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">direction</span>
                <span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span> <span class="s2">&quot;node_index&quot;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># prefer link to these two nodes</span>
                <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">directions</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">REVERSE_DIRECTIONS</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
                    <span class="n">directions</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">REVERSE_DIRECTIONS</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MapParserError</span><span class="p">(</span>
                    <span class="s2">&quot;must have exactly two connections - either directly to &quot;</span>
                    <span class="s2">&quot;two nodes or connecting directly to one node and with exactly one other &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;link direction. The neighbor(s) in directions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">neighbors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> do &quot;</span>
                    <span class="s2">&quot;not fulfill these criteria.&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_direction</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InvisibleSmartMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.InvisibleSmartMapLink">[docs]</a><span class="k">class</span> <span class="nc">InvisibleSmartMapLink</span><span class="p">(</span><span class="n">SmartMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a smart maplink that does not show as such on the map - instead it will figure out</span>
<span class="sd">    how it should look had it been one of the &#39;normal&#39; cardinal-direction links and display</span>
<span class="sd">    itself as that instead. This doesn&#39;t change its functionality, only the symbol shown</span>
<span class="sd">    on the map display. This only works for cardinal-direction links.</span>

<span class="sd">    It makes use of `display_symbol_aliases` mapping, which maps a sorted set of</span>
<span class="sd">    `((start, end), (end, start))` (two-way) or `((start, end),)` (one-way) directions</span>
<span class="sd">    to a symbol in the current map legend - this is the symbol alias to use. The matching</span>
<span class="sd">    MapLink or MapNode will be initialized at the current position only for the purpose of getting</span>
<span class="sd">    its display_symbol.</span>

<span class="sd">    Example:</span>
<span class="sd">        display_symbol_aliases = `{((&#39;n&#39;, &#39;s&#39;), (&#39;s&#39;, n&#39;)): &#39;|&#39;, ...}`</span>

<span class="sd">    If no `display_symbol_aliases` are given, the regular display_symbol is used.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># this allows for normal movement directions even if the invisible-node</span>
    <span class="c1"># is marked with a different symbol.</span>
    <span class="n">direction_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="s2">&quot;nw&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># replace current link position with what the smart links &quot;should&quot; look like</span>
    <span class="n">display_symbol_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">((</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)):</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),):</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)):</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">)):</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),):</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),):</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">)):</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">)):</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="InvisibleSmartMapLink.get_display_symbol"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.InvisibleSmartMapLink.get_display_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">get_display_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The SmartMapLink already calculated the directions before this, so we</span>
<span class="sd">        just need to figure out what to replace this with in order to make this &#39;invisible&#39;</span>

<span class="sd">        Depending on how we are connected, we figure out how the &#39;normal&#39; link</span>
<span class="sd">        should look and use that instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_cached_display_symbol&quot;</span><span class="p">):</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xymap</span><span class="o">.</span><span class="n">legend</span>
            <span class="n">default_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_symbol</span> <span class="o">=</span> <span class="n">default_symbol</span>

            <span class="n">dirtuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

            <span class="n">replacement_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_symbol_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dirtuple</span><span class="p">,</span> <span class="n">default_symbol</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">replacement_symbol</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
                <span class="n">node_or_link_class</span> <span class="o">=</span> <span class="n">legend</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">replacement_symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node_or_link_class</span><span class="p">:</span>
                    <span class="c1"># initiate class in the current location and run get_display_symbol</span>
                    <span class="c1"># to get what it would show.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_symbol</span> <span class="o">=</span> <span class="n">node_or_link_class</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">get_display_symbol</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_symbol</span></div></div>


<span class="c1"># ----------------------------------</span>
<span class="c1"># Default nodes and link classes</span>


<div class="viewcode-block" id="BasicMapNode"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.BasicMapNode">[docs]</a><span class="k">class</span> <span class="nc">BasicMapNode</span><span class="p">(</span><span class="n">MapNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A map node/room&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_room&quot;</span></div>


<div class="viewcode-block" id="InterruptMapNode"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.InterruptMapNode">[docs]</a><span class="k">class</span> <span class="nc">InterruptMapNode</span><span class="p">(</span><span class="n">MapNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A point of interest node/room. Pathfinder will ignore but auto-stepper will</span>
<span class="sd">    stop here if passing through. Beginner-Tutorial from here is fine.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="n">interrupt_path</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_room&quot;</span></div>


<div class="viewcode-block" id="MapTransitionNode"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.MapTransitionNode">[docs]</a><span class="k">class</span> <span class="nc">MapTransitionNode</span><span class="p">(</span><span class="n">TransitionMapNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition-target node to other map. This is not actually spawned in-game.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># important to leave None!</span>
    <span class="n">target_map_xyz</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># must be set manually</span></div>


<div class="viewcode-block" id="NSMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.NSMapLink">[docs]</a><span class="k">class</span> <span class="nc">NSMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, North-South link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
    <span class="n">display_symbol</span> <span class="o">=</span> <span class="s2">&quot;||&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="EWMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.EWMapLink">[docs]</a><span class="k">class</span> <span class="nc">EWMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, East-West link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="NESWMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.NESWMapLink">[docs]</a><span class="k">class</span> <span class="nc">NESWMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, NorthWest-SouthWest link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="SENWMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SENWMapLink">[docs]</a><span class="k">class</span> <span class="nc">SENWMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, SouthEast-NorthWest link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="s2">&quot;se&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="PlusMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.PlusMapLink">[docs]</a><span class="k">class</span> <span class="nc">PlusMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, crossing North-South and East-West links&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="CrossMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.CrossMapLink">[docs]</a><span class="k">class</span> <span class="nc">CrossMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two-way, crossing NorthEast-SouthWest and SouthEast-NorthWest links&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="s2">&quot;se&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="NSOneWayMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.NSOneWayMapLink">[docs]</a><span class="k">class</span> <span class="nc">NSOneWayMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One-way North-South link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="SNOneWayMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.SNOneWayMapLink">[docs]</a><span class="k">class</span> <span class="nc">SNOneWayMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One-way South-North link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;^&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="EWOneWayMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.EWOneWayMapLink">[docs]</a><span class="k">class</span> <span class="nc">EWOneWayMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One-way East-West link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="WEOneWayMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.WEOneWayMapLink">[docs]</a><span class="k">class</span> <span class="nc">WEOneWayMapLink</span><span class="p">(</span><span class="n">MapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;One-way West-East link&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="UpMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.UpMapLink">[docs]</a><span class="k">class</span> <span class="nc">UpMapLink</span><span class="p">(</span><span class="n">SmartMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Up direction. Note that this stays on the same z-coord so it&#39;s a &#39;fake&#39; up.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;u&quot;</span>

    <span class="c1"># all movement over this link is &#39;up&#39;, regardless of where on the xygrid we move.</span>
    <span class="n">direction_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">spawn_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">direction_aliases</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="DownMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.DownMapLink">[docs]</a><span class="k">class</span> <span class="nc">DownMapLink</span><span class="p">(</span><span class="n">UpMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Down direction. Note that this stays on the same z-coord, so it&#39;s a &#39;fake&#39; down.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>
    <span class="c1"># all movement over this link is &#39;down&#39;, regardless of where on the xygrid we move.</span>
    <span class="n">direction_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">spawn_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">direction</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">direction_aliases</span><span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="InterruptMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.InterruptMapLink">[docs]</a><span class="k">class</span> <span class="nc">InterruptMapLink</span><span class="p">(</span><span class="n">InvisibleSmartMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A (still passable) link. Pathfinder will treat this as any link, but auto-stepper</span>
<span class="sd">    will always abort before crossing this link - so this must be crossed manually.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span>
    <span class="n">interrupt_path</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="BlockedMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.BlockedMapLink">[docs]</a><span class="k">class</span> <span class="nc">BlockedMapLink</span><span class="p">(</span><span class="n">InvisibleSmartMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Causes the shortest-path algorithm to consider this a blocked path. The block will not show up</span>
<span class="sd">    in the map display (and exit can be traversed normally), pathfinder will just not include this</span>
<span class="sd">    link in any paths.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="n">BIGVAL</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="s2">&quot;xyz_exit&quot;</span></div>


<div class="viewcode-block" id="RouterMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.RouterMapLink">[docs]</a><span class="k">class</span> <span class="nc">RouterMapLink</span><span class="p">(</span><span class="n">SmartRerouterMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A link that connects other links to build &#39;knees&#39;, pass-throughs etc.&quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span></div>


<div class="viewcode-block" id="TeleporterMapLink"><a class="viewcode-back" href="../../../../../api/evennia.contrib.grid.xyzgrid.xymap_legend.html#evennia.contrib.grid.xyzgrid.xymap_legend.TeleporterMapLink">[docs]</a><span class="k">class</span> <span class="nc">TeleporterMapLink</span><span class="p">(</span><span class="n">SmartTeleporterMapLink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Teleporter links. Must appear in pairs on the same xy map. To make it one-way, add additional</span>
<span class="sd">    one-way link out of the teleporter on one side.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span></div>


<span class="c1"># all map components; used as base if not overridden</span>
<span class="n">LEGEND</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># nodes</span>
    <span class="s2">&quot;#&quot;</span><span class="p">:</span> <span class="n">BasicMapNode</span><span class="p">,</span>
    <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">MapTransitionNode</span><span class="p">,</span>
    <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="n">InterruptMapNode</span><span class="p">,</span>
    <span class="c1"># links</span>
    <span class="s2">&quot;|&quot;</span><span class="p">:</span> <span class="n">NSMapLink</span><span class="p">,</span>
    <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">EWMapLink</span><span class="p">,</span>
    <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="n">NESWMapLink</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">SENWMapLink</span><span class="p">,</span>
    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">CrossMapLink</span><span class="p">,</span>
    <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">PlusMapLink</span><span class="p">,</span>
    <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="n">NSOneWayMapLink</span><span class="p">,</span>
    <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="n">SNOneWayMapLink</span><span class="p">,</span>
    <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">EWOneWayMapLink</span><span class="p">,</span>
    <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">WEOneWayMapLink</span><span class="p">,</span>
    <span class="s2">&quot;o&quot;</span><span class="p">:</span> <span class="n">RouterMapLink</span><span class="p">,</span>
    <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">UpMapLink</span><span class="p">,</span>
    <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">DownMapLink</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">BlockedMapLink</span><span class="p">,</span>
    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">InterruptMapLink</span><span class="p">,</span>
    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">TeleporterMapLink</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>

          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.grid.xyzgrid.xymap_legend</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>