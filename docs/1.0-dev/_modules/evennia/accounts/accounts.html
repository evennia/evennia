
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.accounts.accounts &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.accounts.accounts</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="accounts.html">1.0-dev (develop branch)</a></li>
 <ul>
  <li><a href="../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>

</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.accounts.accounts</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Typeclass for Account objects.</span>

<span class="sd">Note that this object is primarily intended to</span>
<span class="sd">store OOC information, not game info! This</span>
<span class="sd">object represents the actual user (not their</span>
<span class="sd">character) and has NO actual presence in the</span>
<span class="sd">game world (this is handled by the associated</span>
<span class="sd">character object, so you should customize that</span>
<span class="sd">instead for most things).</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">getrandbits</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">password_validation</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">import_string</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">evennia.accounts.manager</span> <span class="kn">import</span> <span class="n">AccountManager</span>
<span class="kn">from</span> <span class="nn">evennia.accounts.models</span> <span class="kn">import</span> <span class="n">AccountDB</span>
<span class="kn">from</span> <span class="nn">evennia.commands.cmdsethandler</span> <span class="kn">import</span> <span class="n">CmdSetHandler</span>
<span class="kn">from</span> <span class="nn">evennia.comms.models</span> <span class="kn">import</span> <span class="n">ChannelDB</span>
<span class="kn">from</span> <span class="nn">evennia.objects.models</span> <span class="kn">import</span> <span class="n">ObjectDB</span>
<span class="kn">from</span> <span class="nn">evennia.scripts.scripthandler</span> <span class="kn">import</span> <span class="n">ScriptHandler</span>
<span class="kn">from</span> <span class="nn">evennia.server.models</span> <span class="kn">import</span> <span class="n">ServerConfig</span>
<span class="kn">from</span> <span class="nn">evennia.server.signals</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SIGNAL_ACCOUNT_POST_CREATE</span><span class="p">,</span>
    <span class="n">SIGNAL_OBJECT_POST_PUPPET</span><span class="p">,</span>
    <span class="n">SIGNAL_OBJECT_POST_UNPUPPET</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">evennia.server.throttle</span> <span class="kn">import</span> <span class="n">Throttle</span>
<span class="kn">from</span> <span class="nn">evennia.typeclasses.attributes</span> <span class="kn">import</span> <span class="n">ModelAttributeBackend</span><span class="p">,</span> <span class="n">NickHandler</span>
<span class="kn">from</span> <span class="nn">evennia.typeclasses.models</span> <span class="kn">import</span> <span class="n">TypeclassBase</span>
<span class="kn">from</span> <span class="nn">evennia.utils</span> <span class="kn">import</span> <span class="n">class_from_module</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">evennia.utils.optionhandler</span> <span class="kn">import</span> <span class="n">OptionHandler</span>
<span class="kn">from</span> <span class="nn">evennia.utils.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">is_iter</span><span class="p">,</span>
    <span class="n">lazy_property</span><span class="p">,</span>
    <span class="n">make_iter</span><span class="p">,</span>
    <span class="n">to_str</span><span class="p">,</span>
    <span class="n">variable_from_module</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;DefaultAccount&quot;</span><span class="p">,</span> <span class="s2">&quot;DefaultGuest&quot;</span><span class="p">)</span>

<span class="n">_SESSIONS</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">_AT_SEARCH_RESULT</span> <span class="o">=</span> <span class="n">variable_from_module</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">SEARCH_AT_RESULT</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">_MULTISESSION_MODE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MULTISESSION_MODE</span>
<span class="n">_AUTO_CREATE_CHARACTER_WITH_ACCOUNT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTO_CREATE_CHARACTER_WITH_ACCOUNT</span>
<span class="n">_AUTO_PUPPET_ON_LOGIN</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTO_PUPPET_ON_LOGIN</span>
<span class="n">_MAX_NR_SIMULTANEOUS_PUPPETS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_NR_SIMULTANEOUS_PUPPETS</span>
<span class="n">_MAX_NR_CHARACTERS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_NR_CHARACTERS</span>
<span class="n">_CMDSET_ACCOUNT</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CMDSET_ACCOUNT</span>
<span class="n">_MUDINFO_CHANNEL</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_CONNECT_CHANNEL</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_CMDHANDLER</span> <span class="o">=</span> <span class="kc">None</span>


<span class="c1"># Create throttles for too many account-creations and login attempts</span>
<span class="n">CREATION_THROTTLE</span> <span class="o">=</span> <span class="n">Throttle</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;creation&quot;</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CREATION_THROTTLE_LIMIT</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CREATION_THROTTLE_TIMEOUT</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">LOGIN_THROTTLE</span> <span class="o">=</span> <span class="n">Throttle</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_THROTTLE_LIMIT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_THROTTLE_TIMEOUT</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">AccountSessionHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages the session(s) attached to an account.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the handler.</span>

<span class="sd">        Args:</span>
<span class="sd">            account (Account): The Account on which this handler is defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the sessions linked to this object.</span>

<span class="sd">        Args:</span>
<span class="sd">            sessid (int, optional): Specify a given session by</span>
<span class="sd">                session id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sessions (list): A list of Session objects. If `sessid`</span>
<span class="sd">                is given, this is a list with one (or zero) elements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_SESSIONS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_SESSIONS</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">evennia.server.sessionhandler</span> <span class="kn">import</span> <span class="n">SESSIONS</span> <span class="k">as</span> <span class="n">_SESSIONS</span>
        <span class="k">if</span> <span class="n">sessid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_iter</span><span class="p">(</span><span class="n">_SESSIONS</span><span class="o">.</span><span class="n">session_from_account</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">sessid</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SESSIONS</span><span class="o">.</span><span class="n">sessions_from_account</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias to get(), returning all sessions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sessions (list): All sessions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get amount of sessions connected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sesslen (int): Number of sessions handled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>


<div class="viewcode-block" id="DefaultAccount"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount">[docs]</a><span class="k">class</span> <span class="nc">DefaultAccount</span><span class="p">(</span><span class="n">AccountDB</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">TypeclassBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the base Typeclass for all Accounts. Accounts represent</span>
<span class="sd">    the person playing the game and tracks account info, password</span>
<span class="sd">    etc. They are OOC entities without presence in-game. An Account</span>
<span class="sd">    can connect to a Character Object in order to &quot;enter&quot; the</span>
<span class="sd">    game.</span>

<span class="sd">    Account Typeclass API:</span>

<span class="sd">    * Available properties (only available on initiated typeclass objects)</span>

<span class="sd">     - key (string) - name of account</span>
<span class="sd">     - name (string)- wrapper for user.username</span>
<span class="sd">     - aliases (list of strings) - aliases to the object. Will be saved to</span>
<span class="sd">            database as AliasDB entries but returned as strings.</span>
<span class="sd">     - dbref (int, read-only) - unique #id-number. Also &quot;id&quot; can be used.</span>
<span class="sd">     - date_created (string) - time stamp of object creation</span>
<span class="sd">     - permissions (list of strings) - list of permission strings</span>
<span class="sd">     - user (User, read-only) - django User authorization object</span>
<span class="sd">     - obj (Object) - game object controlled by account. &#39;character&#39; can also</span>
<span class="sd">                     be used.</span>
<span class="sd">     - sessions (list of Sessions) - sessions connected to this account</span>
<span class="sd">     - is_superuser (bool, read-only) - if the connected user is a superuser</span>

<span class="sd">    * Handlers</span>

<span class="sd">     - locks - lock-handler: use locks.add() to add new lock strings</span>
<span class="sd">     - db - attribute-handler: store/retrieve database attributes on this</span>
<span class="sd">                              self.db.myattr=val, val=self.db.myattr</span>
<span class="sd">     - ndb - non-persistent attribute handler: same as db but does not</span>
<span class="sd">                                  create a database entry when storing data</span>
<span class="sd">     - scripts - script-handler. Add new scripts to object with scripts.add()</span>
<span class="sd">     - cmdset - cmdset-handler. Use cmdset.add() to add new cmdsets to object</span>
<span class="sd">     - nicks - nick-handler. New nicks with nicks.add().</span>

<span class="sd">    * Helper methods</span>

<span class="sd">     - msg(text=None, from_obj=None, session=None, options=None, **kwargs)</span>
<span class="sd">     - execute_cmd(raw_string)</span>
<span class="sd">     - search(ostring, global_search=False, attribute_name=None,</span>
<span class="sd">                      use_nicks=False, location=None,</span>
<span class="sd">                      ignore_errors=False, account=False)</span>
<span class="sd">     - is_typeclass(typeclass, exact=False)</span>
<span class="sd">     - swap_typeclass(new_typeclass, clean_attributes=False, no_default=True)</span>
<span class="sd">     - access(accessing_obj, access_type=&#39;read&#39;, default=False, no_superuser_bypass=False)</span>
<span class="sd">     - check_permstring(permstring)</span>

<span class="sd">    * Hook methods</span>

<span class="sd">     basetype_setup()</span>
<span class="sd">     at_account_creation()</span>

<span class="sd">     &gt; note that the following hooks are also found on Objects and are</span>
<span class="sd">       usually handled on the character level:</span>

<span class="sd">     - at_init()</span>
<span class="sd">     - at_access()</span>
<span class="sd">     - at_cmdset_get(**kwargs)</span>
<span class="sd">     - at_first_login()</span>
<span class="sd">     - at_post_login(session=None)</span>
<span class="sd">     - at_disconnect()</span>
<span class="sd">     - at_message_receive()</span>
<span class="sd">     - at_message_send()</span>
<span class="sd">     - at_server_reload()</span>
<span class="sd">     - at_server_shutdown()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">AccountManager</span><span class="p">()</span>

    <span class="c1"># properties</span>
<div class="viewcode-block" id="DefaultAccount.cmdset"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.cmdset">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">cmdset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CmdSetHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.scripts"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.scripts">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ScriptHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.nicks"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.nicks">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">nicks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NickHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ModelAttributeBackend</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.sessions"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.sessions">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AccountSessionHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.options"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.options">[docs]</a>    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OptionHandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">options_dict</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">OPTIONS_ACCOUNT_DEFAULT</span><span class="p">,</span>
            <span class="n">savefunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
            <span class="n">loadfunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">save_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;option&quot;</span><span class="p">},</span>
            <span class="n">load_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;option&quot;</span><span class="p">},</span>
        <span class="p">)</span></div>

    <span class="c1"># Do not make this a lazy property; the web UI will not refresh it!</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">characters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get playable characters list</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c1"># Rebuild the list if legacy code left null values after deletion</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span> <span class="o">=</span> <span class="n">objs</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">objs</span>

<div class="viewcode-block" id="DefaultAccount.uses_screenreader"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.uses_screenreader">[docs]</a>    <span class="k">def</span> <span class="nf">uses_screenreader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shortcut to determine if a session uses a screenreader. If no session given,</span>
<span class="sd">        will return true if any of the sessions use a screenreader.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session, optional): The session to check for screen reader.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SCREENREADER&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SCREENREADER&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.get_display_name"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.get_display_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">looker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is used by channels and other OOC communications methods to give a</span>
<span class="sd">        custom display of this account&#39;s input.</span>

<span class="sd">        Args:</span>
<span class="sd">            looker (Account): The one that will see this name.</span>
<span class="sd">            **kwargs: Unused by default, can be used to pass game-specific data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name, possibly modified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;|c</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">|n&quot;</span></div>

    <span class="c1"># session-related methods</span>

<div class="viewcode-block" id="DefaultAccount.disconnect_session_from_account"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.disconnect_session_from_account">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect_session_from_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access method for disconnecting a given session from the</span>
<span class="sd">        account (connection happens automatically in the</span>
<span class="sd">        sessionhandler)</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): Session to disconnect.</span>
<span class="sd">            reason (str, optional): Eventual reason for the disconnect.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_SESSIONS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_SESSIONS</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">evennia.server.sessionhandler</span> <span class="kn">import</span> <span class="n">SESSIONS</span> <span class="k">as</span> <span class="n">_SESSIONS</span>
        <span class="n">_SESSIONS</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span></div>

    <span class="c1"># puppeting operations</span>

<div class="viewcode-block" id="DefaultAccount.puppet_object"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.puppet_object">[docs]</a>    <span class="k">def</span> <span class="nf">puppet_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the given session to control (puppet) the given object (usually</span>
<span class="sd">        a Character type).</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): session to use for puppeting</span>
<span class="sd">            obj (Object): the object to start puppeting</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If puppeting is not possible, the</span>
<span class="sd">                `exception.msg` will contain the reason.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># safety checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Object not found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Session not found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_puppet</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
            <span class="c1"># already puppeting this object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are already puppeting this object.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;puppet&quot;</span><span class="p">):</span>
            <span class="c1"># no access</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to puppet &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">:</span>
            <span class="c1"># object already puppeted</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="c1"># we may take over another of our sessions</span>
                    <span class="c1"># output messages to the affected sessions</span>
                    <span class="k">if</span> <span class="n">_MULTISESSION_MODE</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="n">txt1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sharing |c</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n with another of your sessions.&quot;</span>
                        <span class="n">txt2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|c</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n|G is now shared from another of your sessions.|n&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">txt1</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">txt2</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">txt1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Taking over |c</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n from another of your sessions.&quot;</span>
                        <span class="n">txt2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|c</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n|R is now acted from another of your sessions.|n&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">txt1</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">txt2</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unpuppet_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                <span class="c1"># controlled by another account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;|c</span><span class="si">{key}</span><span class="s2">|R is already puppeted by another Account.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">puppet</span><span class="p">:</span>
            <span class="c1"># cleanly unpuppet eventual previous object puppeted by this session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unpuppet_object</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># if we get to this point the character is ready to puppet or it</span>
        <span class="c1"># was left with a lingering account/session reference from an unclean</span>
        <span class="c1"># server kill or similar</span>

        <span class="c1"># check so we are not puppeting too much already</span>
        <span class="k">if</span> <span class="n">_MAX_NR_SIMULTANEOUS_PUPPETS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">already_puppeted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_puppets</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_superuser</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_permstring</span><span class="p">(</span><span class="s2">&quot;Developer&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_puppeted</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_puppets</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">_MAX_NR_SIMULTANEOUS_PUPPETS</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot control any more puppets (max </span><span class="si">{</span><span class="n">_MAX_NR_SIMULTANEOUS_PUPPETS</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># do the puppeting</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">at_pre_puppet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># used to track in case of crash so we can clean up later</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;puppeted&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="p">)</span>

        <span class="c1"># do the connection</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">session</span><span class="o">.</span><span class="n">puid</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span>
        <span class="n">session</span><span class="o">.</span><span class="n">puppet</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="c1"># re-cache locks to make sure superuser bypass is updated</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">cache_lock_bypass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c1"># final hook</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">at_post_puppet</span><span class="p">()</span>
        <span class="n">SIGNAL_OBJECT_POST_PUPPET</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.unpuppet_object"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.unpuppet_object">[docs]</a>    <span class="k">def</span> <span class="nf">unpuppet_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disengage control over an object.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session or list): The session or a list of</span>
<span class="sd">                sessions to disengage from their puppets.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError With message about error.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">make_iter</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">puppet</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="c1"># do the disconnect, but only if we are the last session to puppet</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">at_pre_unpuppet</span><span class="p">()</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">at_post_unpuppet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;puppeted&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="p">)</span>
                <span class="n">SIGNAL_OBJECT_POST_UNPUPPET</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># Just to be sure we&#39;re always clear.</span>
            <span class="n">session</span><span class="o">.</span><span class="n">puppet</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">session</span><span class="o">.</span><span class="n">puid</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DefaultAccount.unpuppet_all"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.unpuppet_all">[docs]</a>    <span class="k">def</span> <span class="nf">unpuppet_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnect all puppets. This is called by server before a</span>
<span class="sd">        reset/shutdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpuppet_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span></div>

<div class="viewcode-block" id="DefaultAccount.get_puppet"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.get_puppet">[docs]</a>    <span class="k">def</span> <span class="nf">get_puppet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an object puppeted by this session through this account. This is</span>
<span class="sd">        the main method for retrieving the puppeted object from the</span>
<span class="sd">        account&#39;s end.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): Find puppeted object based on this session</span>

<span class="sd">        Returns:</span>
<span class="sd">            puppet (Object): The matching puppeted object, if any.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">puppet</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DefaultAccount.get_all_puppets"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.get_all_puppets">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_puppets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all currently puppeted objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            puppets (list): All puppeted objects currently controlled</span>
<span class="sd">                by this Account.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">puppet</span> <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">puppet</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__get_single_puppet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a legacy convenience link for use with `MULTISESSION_MODE`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            puppets (Object or list): Users of `MULTISESSION_MODE` 0 or 1 will</span>
<span class="sd">                always get the first puppet back. Users of higher `MULTISESSION_MODE`s will</span>
<span class="sd">                get a list of all puppeted objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">puppets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_puppets</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_MULTISESSION_MODE</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">puppets</span> <span class="ow">and</span> <span class="n">puppets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">puppets</span>

    <span class="n">character</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__get_single_puppet</span><span class="p">)</span>
    <span class="n">puppet</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__get_single_puppet</span><span class="p">)</span>

    <span class="c1"># utility methods</span>
<div class="viewcode-block" id="DefaultAccount.is_banned"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.is_banned">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_banned</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if a given username or IP is banned.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            ip (str, optional): IP address.</span>
<span class="sd">            username (str, optional): Username.</span>

<span class="sd">        Returns:</span>
<span class="sd">            is_banned (bool): Whether either is banned or not.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Check IP and/or name bans</span>
        <span class="n">bans</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">conf</span><span class="p">(</span><span class="s2">&quot;server_bans&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bans</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">username</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">bans</span> <span class="k">if</span> <span class="n">username</span><span class="p">)</span>
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">bans</span> <span class="k">if</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DefaultAccount.get_username_validators"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.get_username_validators">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_username_validators</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">validator_config</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;AUTH_USERNAME_VALIDATORS&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves and instantiates validators for usernames.</span>

<span class="sd">        Args:</span>
<span class="sd">            validator_config (list): List of dicts comprising the battery of</span>
<span class="sd">                validators to apply to a username.</span>

<span class="sd">        Returns:</span>
<span class="sd">            validators (list): List of instantiated Validator objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="n">validator_config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">klass</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">validator</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The module in NAME could not be imported: </span><span class="si">{</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Check your AUTH_USERNAME_VALIDATORS setting.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass</span><span class="p">(</span><span class="o">**</span><span class="n">validator</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="p">{})))</span>
        <span class="k">return</span> <span class="n">objs</span></div>

<div class="viewcode-block" id="DefaultAccount.authenticate"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.authenticate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the given username/password against the database to see if the</span>
<span class="sd">        credentials are valid.</span>

<span class="sd">        Note that this simply checks credentials and returns a valid reference</span>
<span class="sd">        to the user-- it does not log them in!</span>

<span class="sd">        To finish the job:</span>
<span class="sd">        After calling this from a Command, associate the account with a Session:</span>
<span class="sd">        - session.sessionhandler.login(session, account)</span>

<span class="sd">        ...or after calling this from a View, associate it with an HttpRequest:</span>
<span class="sd">        - django.contrib.auth.login(account, request)</span>

<span class="sd">        Args:</span>
<span class="sd">            username (str): Username of account</span>
<span class="sd">            password (str): Password of account</span>
<span class="sd">            ip (str, optional): IP address of client</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            session (Session, optional): Session requesting authentication</span>

<span class="sd">        Returns:</span>
<span class="sd">            account (DefaultAccount, None): Account whose credentials were</span>
<span class="sd">                provided if not banned.</span>
<span class="sd">            errors (list): Error messages of any failures.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ip</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

        <span class="c1"># See if authentication is currently being throttled</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">LOGIN_THROTTLE</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Too many login failures; please try again in a few minutes.&quot;</span><span class="p">))</span>

            <span class="c1"># With throttle active, do not log continued hits-- it is a</span>
            <span class="c1"># waste of storage and can be abused to make your logs harder to</span>
            <span class="c1"># read and/or fill up your disk.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Check IP and/or name bans</span>
        <span class="n">banned</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_banned</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">banned</span><span class="p">:</span>
            <span class="c1"># this is a banned IP or name!</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;|rYou have been banned and cannot continue from here.&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If you feel this ban is in error, please email an admin.|x&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_sec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication Denied (Banned): </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> (IP: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="n">LOGIN_THROTTLE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;Too many sightings of banned artifact.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Authenticate and get Account object</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="p">:</span>
            <span class="c1"># User-facing message</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Username and/or password is incorrect.&quot;</span><span class="p">))</span>

            <span class="c1"># Log auth failures while throttle is inactive</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_sec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication Failure: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> (IP: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

            <span class="c1"># Update throttle</span>
            <span class="k">if</span> <span class="n">ip</span><span class="p">:</span>
                <span class="n">LOGIN_THROTTLE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Too many authentication failures.&quot;</span><span class="p">))</span>

            <span class="c1"># Try to call post-failure hook</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">account</span> <span class="o">=</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_account_from_name</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">account</span><span class="p">:</span>
                    <span class="n">account</span><span class="o">.</span><span class="n">at_failed_login</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Account successfully authenticated</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_sec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication Success: </span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2"> (IP: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">,</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="DefaultAccount.normalize_username"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.normalize_username">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">normalize_username</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django: Applies NFKC Unicode normalization to usernames so that visually</span>
<span class="sd">        identical characters with different Unicode code points are considered</span>
<span class="sd">        identical.</span>

<span class="sd">        (This deals with the Turkish &quot;i&quot; problem and similar</span>
<span class="sd">        annoyances. Only relevant if you go out of your way to allow Unicode</span>
<span class="sd">        usernames though-- Evennia accepts ASCII by default.)</span>

<span class="sd">        In this case we&#39;re simply piggybacking on this feature to apply</span>
<span class="sd">        additional normalization per Evennia&#39;s standards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DefaultAccount</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">normalize_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="c1"># strip excessive spaces in accountname</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">username</span></div>

<div class="viewcode-block" id="DefaultAccount.validate_username"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.validate_username">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the given username against the username validator associated with</span>
<span class="sd">        Account objects, and also checks the database to make sure it is unique.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (str): Username to validate</span>

<span class="sd">        Returns:</span>
<span class="sd">            valid (bool): Whether or not the password passed validation</span>
<span class="sd">            errors (list): Error messages of any failures</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Make sure we&#39;re at least using the default validator</span>
        <span class="n">validators</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_username_validators</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validators</span><span class="p">:</span>
            <span class="n">validators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">username_validator</span><span class="p">]</span>

        <span class="c1"># Try username against all enabled validators</span>
        <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="n">validators</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># Disqualify if any check failed</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">valid</span><span class="p">,</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="DefaultAccount.validate_password"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.validate_password">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_password</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the given password against the list of Django validators enabled</span>
<span class="sd">        in the server.conf file.</span>

<span class="sd">        Args:</span>
<span class="sd">            password (str): Password to validate</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            account (DefaultAccount, optional): Account object to validate the</span>
<span class="sd">                password for. Optional, but Django includes some validators to</span>
<span class="sd">                do things like making sure users aren&#39;t setting passwords to the</span>
<span class="sd">                same value as their username. If left blank, these user-specific</span>
<span class="sd">                checks are skipped.</span>

<span class="sd">        Returns:</span>
<span class="sd">            valid (bool): Whether or not the password passed validation</span>
<span class="sd">            error (ValidationError, None): Any validation error(s) raised. Multiple</span>
<span class="sd">                errors can be nested within a single object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Validation returns None on success; invert it and return a more sensible bool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">password_validation</span><span class="o">.</span><span class="n">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">account</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">valid</span><span class="p">,</span> <span class="n">error</span></div>

<div class="viewcode-block" id="DefaultAccount.set_password"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.set_password">[docs]</a>    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the given password to the account. Logs and triggers the `at_password_change` hook.</span>

<span class="sd">        Args:</span>
<span class="sd">            password (str): Password to set.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is called by Django also when logging in; it should not be mixed up with</span>
<span class="sd">            validation, since that would mean old passwords in the database (pre validation checks)</span>
<span class="sd">            could get invalidated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_sec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password successfully changed for </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_password_change</span><span class="p">()</span></div>

<div class="viewcode-block" id="DefaultAccount.create_character"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.create_character">[docs]</a>    <span class="k">def</span> <span class="nf">create_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a character linked to this account.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str, optional): If not given, use the same name as the account.</span>
<span class="sd">            typeclass (str, optional): Typeclass to use for this character. If</span>
<span class="sd">                not given, use settings.BASE_CHARACTER_TYPECLASS.</span>
<span class="sd">            permissions (list, optional): If not given, use the account&#39;s permissions.</span>
<span class="sd">            ip (str, optional): The client IP creating this character. Will fall back to the</span>
<span class="sd">                one stored for the account if not given.</span>
<span class="sd">            kwargs (any): Other kwargs will be used in the create_call.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Object: A new character of the `character_typeclass` type. None on an error.</span>
<span class="sd">            list or None: A list of errors, or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parse inputs</span>
        <span class="n">character_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="n">character_ip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">creator_ip</span><span class="p">)</span>
        <span class="n">character_permissions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>

        <span class="c1"># Load the appropriate Character class</span>
        <span class="n">character_typeclass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">character_typeclass</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">character_typeclass</span> <span class="k">if</span> <span class="n">character_typeclass</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span>
        <span class="p">)</span>
        <span class="n">Character</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">character_typeclass</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;location&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">START_LOCATION</span><span class="p">)</span>

        <span class="c1"># Create the character</span>
        <span class="n">character</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">character_key</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">character_ip</span><span class="p">,</span>
            <span class="n">typeclass</span><span class="o">=</span><span class="n">character_typeclass</span><span class="p">,</span>
            <span class="n">permissions</span><span class="o">=</span><span class="n">character_permissions</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">character</span><span class="p">:</span>
            <span class="c1"># Update playable character list</span>
            <span class="k">if</span> <span class="n">character</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">character</span><span class="p">)</span>

            <span class="c1"># We need to set this to have @ic auto-connect to this character</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_last_puppet</span> <span class="o">=</span> <span class="n">character</span>
        <span class="k">return</span> <span class="n">character</span><span class="p">,</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="DefaultAccount.create"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an Account (or Account/Character pair for MULTISESSION_MODE&lt;2)</span>
<span class="sd">        with default (or overridden) permissions and having joined them to the</span>
<span class="sd">        appropriate default channels.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            username (str): Username of Account owner</span>
<span class="sd">            password (str): Password of Account owner</span>
<span class="sd">            email (str, optional): Email address of Account owner</span>
<span class="sd">            ip (str, optional): IP address of requesting connection</span>
<span class="sd">            guest (bool, optional): Whether or not this is to be a Guest account</span>

<span class="sd">            permissions (str, optional): Default permissions for the Account</span>
<span class="sd">            typeclass (str, optional): Typeclass to use for new Account</span>
<span class="sd">            character_typeclass (str, optional): Typeclass to use for new char</span>
<span class="sd">                when applicable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            account (Account): Account if successfully created; None if not</span>
<span class="sd">            errors (list): List of error messages in string form</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">account</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">guest</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;guest&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">permissions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">PERMISSION_ACCOUNT_DEFAULT</span><span class="p">)</span>
        <span class="n">typeclass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ip</span> <span class="ow">and</span> <span class="n">CREATION_THROTTLE</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You are creating too many accounts. Please log into an existing account.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Normalize username</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">normalize_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="c1"># Validate username</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">guest</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validate_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="c1"># this echoes the restrictions made by django&#39;s auth</span>
                <span class="c1"># module (except not allowing spaces, for convenience of</span>
                <span class="c1"># logging in).</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Validate password</span>
        <span class="c1"># Have to create a dummy Account object to check username similarity</span>
        <span class="n">valid</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="bp">cls</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># Check IP and/or name bans</span>
        <span class="n">banned</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_banned</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">banned</span><span class="p">:</span>
            <span class="c1"># this is a banned IP or name!</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;|rYou have been banned and cannot continue from here.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If you feel this ban is in error, please email an admin.|x&quot;</span>
            <span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="c1"># everything&#39;s ok. Create the new account.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">account</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_account</span><span class="p">(</span>
                    <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_sec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account Created: </span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2"> (IP: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;There was an error creating the Account. &quot;</span>
                        <span class="s2">&quot;If this problem persists, contact an admin.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

            <span class="c1"># This needs to be set so the engine knows this account is</span>
            <span class="c1"># logging in for the first time. (so it knows to call the right</span>
            <span class="c1"># hooks during login later)</span>
            <span class="n">account</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">FIRST_LOGIN</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Record IP address of creation, if available</span>
            <span class="k">if</span> <span class="n">ip</span><span class="p">:</span>
                <span class="n">account</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">creator_ip</span> <span class="o">=</span> <span class="n">ip</span>

            <span class="c1"># join the new account to the public channel</span>
            <span class="n">pchannel</span> <span class="o">=</span> <span class="n">ChannelDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_CHANNELS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;key&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pchannel</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pchannel</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;New account &#39;</span><span class="si">{account.key}</span><span class="s2">&#39; could not connect to public channel!&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">account</span> <span class="ow">and</span> <span class="n">_AUTO_CREATE_CHARACTER_WITH_ACCOUNT</span><span class="p">:</span>
                <span class="c1"># Auto-create a character to go with this account</span>

                <span class="n">character</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">create_character</span><span class="p">(</span>
                    <span class="n">typeclass</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character_typeclass&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errs</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># We are in the middle between logged in and -not, so we have</span>
            <span class="c1"># to handle tracebacks ourselves at this point. If we don&#39;t,</span>
            <span class="c1"># we won&#39;t see any errors at all.</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;An error occurred. Please e-mail an admin if the problem persists.&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>

        <span class="c1"># Update the throttle to indicate a new account was created from this IP</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">guest</span><span class="p">:</span>
            <span class="n">CREATION_THROTTLE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;Too many accounts being created.&quot;</span><span class="p">)</span>
        <span class="n">SIGNAL_ACCOUNT_POST_CREATE</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">account</span><span class="p">,</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="DefaultAccount.delete"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the account persistently.</span>

<span class="sd">        Notes:</span>
<span class="sd">            `*args` and `**kwargs` are passed on to the base delete</span>
<span class="sd">             mechanism (these are usually not used).</span>

<span class="sd">        Return:</span>
<span class="sd">            bool: If deletion was successful. Only time it fails would be</span>
<span class="sd">                if the Account was already deleted. Note that even on a failure,</span>
<span class="sd">                connected resources (nicks/aliases etc) will still have been</span>
<span class="sd">                deleted.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1"># unpuppeting all objects and disconnecting the user, if any</span>
            <span class="c1"># sessions remain (should usually be handled from the</span>
            <span class="c1"># deleting command)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpuppet_object</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c1"># no puppet to disconnect from</span>
                <span class="k">pass</span>
            <span class="n">session</span><span class="o">.</span><span class="n">sessionhandler</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Account being deleted.&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nicks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># methods inherited from database model</span>

<div class="viewcode-block" id="DefaultAccount.msg"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.msg">[docs]</a>    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evennia -&gt; User</span>
<span class="sd">        This is the main route for sending data back to the user from the</span>
<span class="sd">        server.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str or tuple, optional): The message to send. This</span>
<span class="sd">                is treated internally like any send-command, so its</span>
<span class="sd">                value can be a tuple if sending multiple arguments to</span>
<span class="sd">                the `text` oob command.</span>
<span class="sd">            from_obj (Object or Account or list, optional): Object sending. If given, its</span>
<span class="sd">                at_msg_send() hook will be called. If iterable, call on all entities.</span>
<span class="sd">            session (Session or list, optional): Session object or a list of</span>
<span class="sd">                Sessions to receive this send. If given, overrules the</span>
<span class="sd">                default send behavior for the current</span>
<span class="sd">                MULTISESSION_MODE.</span>
<span class="sd">            options (list): Protocol-specific options. Passed on to the protocol.</span>
<span class="sd">        Keyword Args:</span>
<span class="sd">            any (dict): All other keywords are passed on to the protocol.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_obj</span><span class="p">:</span>
            <span class="c1"># call hook</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">make_iter</span><span class="p">(</span><span class="n">from_obj</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">at_msg_send</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">to_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># this may not be assigned.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_msg_receive</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># abort message to this account</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># this may not be assigned.</span>
            <span class="k">pass</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>

        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># sanitize text before sending across the wire</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">to_str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

        <span class="c1"># session relay</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="n">make_iter</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.execute_cmd"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.execute_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">execute_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do something as this account. This method is never called normally,</span>
<span class="sd">        but only when the account object itself is supposed to execute the</span>
<span class="sd">        command. It takes account nicks into account, but not nicks of</span>
<span class="sd">        eventual puppets.</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_string (str): Raw command input coming from the command line.</span>
<span class="sd">            session (Session, optional): The session to be responsible</span>
<span class="sd">                for the command-send</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): Other keyword arguments will be added to the</span>
<span class="sd">                found command object instance as variables before it</span>
<span class="sd">                executes. This is unused by default Evennia but may be</span>
<span class="sd">                used to set flags and change operating parameters for</span>
<span class="sd">                commands at run-time.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># break circular import issues</span>
        <span class="k">global</span> <span class="n">_CMDHANDLER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_CMDHANDLER</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">evennia.commands.cmdhandler</span> <span class="kn">import</span> <span class="n">cmdhandler</span> <span class="k">as</span> <span class="n">_CMDHANDLER</span>
        <span class="n">raw_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nicks</span><span class="o">.</span><span class="n">nickreplace</span><span class="p">(</span>
            <span class="n">raw_string</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inputline&quot;</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">),</span> <span class="n">include_account</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">_MULTISESSION_MODE</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># for these modes we use the first/only session</span>
            <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">sessions</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">_CMDHANDLER</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">,</span> <span class="n">callertype</span><span class="o">=</span><span class="s2">&quot;account&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># channel receive hooks</span>

<div class="viewcode-block" id="DefaultAccount.at_pre_channel_msg"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_pre_channel_msg">[docs]</a>    <span class="k">def</span> <span class="nf">at_pre_channel_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">senders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by the Channel just before passing a message into `channel_msg`.</span>
<span class="sd">        This allows for tweak messages per-user and also to abort the</span>
<span class="sd">        receive on the receiver-level.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The message sent to the channel.</span>
<span class="sd">            channel (Channel): The sending channel.</span>
<span class="sd">            senders (list, optional): Accounts or Objects acting as senders.</span>
<span class="sd">                For most normal messages, there is only a single sender. If</span>
<span class="sd">                there are no senders, this may be a broadcasting message.</span>
<span class="sd">            **kwargs: These are additional keywords passed into `channel_msg`.</span>
<span class="sd">                If `no_prefix=True` or `emit=True` are passed, the channel</span>
<span class="sd">                prefix will not be added (`[channelname]: ` by default)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str or None: Allows for customizing the message for this recipient.</span>
<span class="sd">                If returning `None` (or `False`) message-receiving is aborted.</span>
<span class="sd">                The returning string will be passed into `self.channel_msg`.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This support posing/emotes by starting channel-send with : or ;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">senders</span><span class="p">:</span>
            <span class="n">sender_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sender</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">sender</span> <span class="ow">in</span> <span class="n">senders</span><span class="p">)</span>
            <span class="n">message_lstrip</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">message_lstrip</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)):</span>
                <span class="c1"># this is a pose, should show as e.g. &quot;User1 smiles to channel&quot;</span>
                <span class="n">spacing</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">message_lstrip</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">))</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sender_string</span><span class="si">}{</span><span class="n">spacing</span><span class="si">}{</span><span class="n">message_lstrip</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># normal message</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sender_string</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;no_prefix&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;emit&quot;</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">channel_prefix</span><span class="p">()</span> <span class="o">+</span> <span class="n">message</span>

        <span class="k">return</span> <span class="n">message</span></div>

<div class="viewcode-block" id="DefaultAccount.channel_msg"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.channel_msg">[docs]</a>    <span class="k">def</span> <span class="nf">channel_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">senders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This performs the actions of receiving a message to an un-muted</span>
<span class="sd">        channel.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The message sent to the channel.</span>
<span class="sd">            channel (Channel): The sending channel.</span>
<span class="sd">            senders (list, optional): Accounts or Objects acting as senders.</span>
<span class="sd">                For most normal messages, there is only a single sender. If</span>
<span class="sd">                there are no senders, this may be a broadcasting message or</span>
<span class="sd">                similar.</span>
<span class="sd">            **kwargs: These are additional keywords originally passed into</span>
<span class="sd">                `Channel.msg`.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Before this, `Channel.at_pre_channel_msg` will fire, which offers a way</span>
<span class="sd">            to customize the message for the receiver on the channel-level.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;from_channel&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span>
            <span class="n">from_obj</span><span class="o">=</span><span class="n">senders</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;from_channel&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_post_channel_msg"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_post_channel_msg">[docs]</a>    <span class="k">def</span> <span class="nf">at_post_channel_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">senders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by `self.channel_msg` after message was received.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The message sent to the channel.</span>
<span class="sd">            channel (Channel): The sending channel.</span>
<span class="sd">            senders (list, optional): Accounts or Objects acting as senders.</span>
<span class="sd">                For most normal messages, there is only a single sender. If</span>
<span class="sd">                there are no senders, this may be a broadcasting message.</span>
<span class="sd">            **kwargs: These are additional keywords passed into `channel_msg`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># search method</span>

<div class="viewcode-block" id="DefaultAccount.search"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">searchdata</span><span class="p">,</span>
        <span class="n">return_puppet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">search_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">typeclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nofound_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">multimatch_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_nicks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is similar to `DefaultObject.search` but defaults to searching</span>
<span class="sd">        for Accounts only.</span>

<span class="sd">        Args:</span>
<span class="sd">            searchdata (str or int): Search criterion, the Account&#39;s</span>
<span class="sd">                key or dbref to search for.</span>
<span class="sd">            return_puppet (bool, optional): Instructs the method to</span>
<span class="sd">                return matches as the object the Account controls rather</span>
<span class="sd">                than the Account itself (or None) if nothing is puppeted).</span>
<span class="sd">            search_object (bool, optional): Search for Objects instead of</span>
<span class="sd">                Accounts. This is used by e.g. the @examine command when</span>
<span class="sd">                wanting to examine Objects while OOC.</span>
<span class="sd">            typeclass (Account typeclass, optional): Limit the search</span>
<span class="sd">                only to this particular typeclass. This can be used to</span>
<span class="sd">                limit to specific account typeclasses or to limit the search</span>
<span class="sd">                to a particular Object typeclass if `search_object` is True.</span>
<span class="sd">            nofound_string (str, optional): A one-time error message</span>
<span class="sd">                to echo if `searchdata` leads to no matches. If not given,</span>
<span class="sd">                will fall back to the default handler.</span>
<span class="sd">            multimatch_string (str, optional): A one-time error</span>
<span class="sd">                message to echo if `searchdata` leads to multiple matches.</span>
<span class="sd">                If not given, will fall back to the default handler.</span>
<span class="sd">            use_nicks (bool, optional): Use account-level nick replacement.</span>
<span class="sd">            quiet (bool, optional): If set, will not show any error to the user,</span>
<span class="sd">                and will also lead to returning a list of matches.</span>

<span class="sd">        Return:</span>
<span class="sd">            match (Account, Object or None): A single Account or Object match.</span>
<span class="sd">            list: If `quiet=True` this is a list of 0, 1 or more Account or Object matches.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Extra keywords are ignored, but are allowed in call in</span>
<span class="sd">            order to make API more consistent with</span>
<span class="sd">            objects.objects.DefaultObject.search.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle me, self and *me, *self</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">searchdata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># handle wrapping of common terms</span>
            <span class="k">if</span> <span class="n">searchdata</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;me&quot;</span><span class="p">,</span> <span class="s2">&quot;*me&quot;</span><span class="p">,</span> <span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;*self&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>
        <span class="n">searchdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nicks</span><span class="o">.</span><span class="n">nickreplace</span><span class="p">(</span>
            <span class="n">searchdata</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;account&quot;</span><span class="p">,),</span> <span class="n">include_account</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">search_object</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">object_search</span><span class="p">(</span><span class="n">searchdata</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">account_search</span><span class="p">(</span><span class="n">searchdata</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_puppet</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">puppet</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">_AT_SEARCH_RESULT</span><span class="p">(</span>
                <span class="n">matches</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">searchdata</span><span class="p">,</span>
                <span class="n">nofound_string</span><span class="o">=</span><span class="n">nofound_string</span><span class="p">,</span>
                <span class="n">multimatch_string</span><span class="o">=</span><span class="n">multimatch_string</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">and</span> <span class="n">return_puppet</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">puppet</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">matches</span></div>

<div class="viewcode-block" id="DefaultAccount.access"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.access">[docs]</a>    <span class="k">def</span> <span class="nf">access</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">accessing_obj</span><span class="p">,</span> <span class="n">access_type</span><span class="o">=</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_superuser_bypass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if another object has permission to access this</span>
<span class="sd">        object in whatever way.</span>

<span class="sd">        Args:</span>
<span class="sd">          accessing_obj (Object): Object trying to access this one.</span>
<span class="sd">          access_type (str, optional): Type of access sought.</span>
<span class="sd">          default (bool, optional): What to return if no lock of</span>
<span class="sd">            access_type was found</span>
<span class="sd">          no_superuser_bypass (bool, optional): Turn off superuser</span>
<span class="sd">            lock bypassing. Be careful with this one.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">          kwargs (any): Passed to the at_access hook along with the result.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result (bool): Result of access check.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">access</span><span class="p">(</span>
            <span class="n">accessing_obj</span><span class="p">,</span>
            <span class="n">access_type</span><span class="o">=</span><span class="n">access_type</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">no_superuser_bypass</span><span class="o">=</span><span class="n">no_superuser_bypass</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_access</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">accessing_obj</span><span class="p">,</span> <span class="n">access_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">idle_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the idle time of the least idle session in seconds. If</span>
<span class="sd">        no sessions are connected it returns nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idle</span> <span class="o">=</span> <span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">cmd_last_visible</span> <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">idle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">idle</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the maximum connection time of all connected sessions</span>
<span class="sd">        in seconds. Returns nothing if there are no sessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">conn_time</span> <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># account hooks</span>

<div class="viewcode-block" id="DefaultAccount.basetype_setup"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.basetype_setup">[docs]</a>    <span class="k">def</span> <span class="nf">basetype_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This sets up the basic properties for an account. Overload this</span>
<span class="sd">        with at_account_creation rather than changing this method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A basic security setup</span>
        <span class="n">lockstring</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;examine:perm(Admin);edit:perm(Admin);&quot;</span>
            <span class="s2">&quot;delete:perm(Admin);boot:perm(Admin);msg:all();&quot;</span>
            <span class="s2">&quot;noidletimeout:perm(Builder) or perm(noidletimeout)&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lockstring</span><span class="p">)</span>

        <span class="c1"># The ooc account cmdset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">add_default</span><span class="p">(</span><span class="n">_CMDSET_ACCOUNT</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_account_creation"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_account_creation">[docs]</a>    <span class="k">def</span> <span class="nf">at_account_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called once, the very first time the account is created</span>
<span class="sd">        (i.e. first time they register with the game). It&#39;s a good</span>
<span class="sd">        place to store attributes all accounts should have, like</span>
<span class="sd">        configuration values etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set an (empty) attribute holding the characters this account has</span>
        <span class="n">lockstring</span> <span class="o">=</span> <span class="s2">&quot;attrread:perm(Admins);attredit:perm(Admins);attrcreate:perm(Admins);&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;_playable_characters&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">lockstring</span><span class="o">=</span><span class="n">lockstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;_saved_protocol_flags&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">lockstring</span><span class="o">=</span><span class="n">lockstring</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_init"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_init">[docs]</a>    <span class="k">def</span> <span class="nf">at_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is always called whenever this object is initiated --</span>
<span class="sd">        that is, whenever it its typeclass is cached from memory. This</span>
<span class="sd">        happens on-demand first time the object is used or activated</span>
<span class="sd">        in some way after being created but also after each server</span>
<span class="sd">        restart or reload. In the case of account objects, this usually</span>
<span class="sd">        happens the moment the account logs in or reconnects after a</span>
<span class="sd">        reload.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># Note that the hooks below also exist in the character object&#39;s</span>
    <span class="c1"># typeclass. You can often ignore these and rely on the character</span>
    <span class="c1"># ones instead, unless you are implementing a multi-character game</span>
    <span class="c1"># and have some things that should be done regardless of which</span>
    <span class="c1"># character is currently connected to this account.</span>

<div class="viewcode-block" id="DefaultAccount.at_first_save"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_first_save">[docs]</a>    <span class="k">def</span> <span class="nf">at_first_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a generic hook called by Evennia when this object is</span>
<span class="sd">        saved to the database the very first time.  You generally</span>
<span class="sd">        don&#39;t override this method but the hooks called by it.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basetype_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_account_creation</span><span class="p">()</span>
        <span class="c1"># initialize Attribute/TagProperties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_evennia_properties</span><span class="p">()</span>

        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">PERMISSION_ACCOUNT_DEFAULT</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_createdict&quot;</span><span class="p">):</span>
            <span class="c1"># this will only be set if the utils.create_account</span>
            <span class="c1"># function was used to create the object.</span>
            <span class="n">cdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createdict</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbid</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;db_key&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_key</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">updates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="n">updates</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locks&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;locks&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">):</span>
                <span class="n">permissions</span> <span class="o">=</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;permissions&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">):</span>
                <span class="c1"># this should be a list of tags, tuples (key, category) or (key, category, data)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">batch_add</span><span class="p">(</span><span class="o">*</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">):</span>
                <span class="c1"># this should be tuples (key, val, ...)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">batch_add</span><span class="p">(</span><span class="o">*</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nattributes&quot;</span><span class="p">):</span>
                <span class="c1"># this should be a dict of nattrname:value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;nattributes&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nattributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createdict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">batch_add</span><span class="p">(</span><span class="o">*</span><span class="n">permissions</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_access"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_access">[docs]</a>    <span class="k">def</span> <span class="nf">at_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">accessing_obj</span><span class="p">,</span> <span class="n">access_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is triggered after an access-call on this Account has</span>
<span class="sd">            completed.</span>

<span class="sd">        Args:</span>
<span class="sd">            result (bool): The result of the access check.</span>
<span class="sd">            accessing_obj (any): The object requesting the access</span>
<span class="sd">                check.</span>
<span class="sd">            access_type (str): The type of access checked.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): These are passed on from the access check</span>
<span class="sd">                and can be used to relay custom instructions from the</span>
<span class="sd">                check mechanism.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method cannot affect the result of the lock check and</span>
<span class="sd">            its return value is not used in any way. It can be used</span>
<span class="sd">            e.g.  to customize error messages in a central location or</span>
<span class="sd">            create other effects based on the access result.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_cmdset_get"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_cmdset_get">[docs]</a>    <span class="k">def</span> <span class="nf">at_cmdset_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called just *before* cmdsets on this account are requested by</span>
<span class="sd">        the command handler. The cmdsets are available as</span>
<span class="sd">        `self.cmdset`. If changes need to be done on the fly to the</span>
<span class="sd">        cmdset before passing them on to the cmdhandler, this is the</span>
<span class="sd">        place to do it.  This is called also if the account currently</span>
<span class="sd">        have no cmdsets. kwargs are usually not used unless the</span>
<span class="sd">        cmdset is generated dynamically.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_first_login"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_first_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_first_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called the very first time this account logs into the game.</span>
<span class="sd">        Note that this is called *before* at_pre_login, so no session</span>
<span class="sd">        is established and usually no character is yet assigned at</span>
<span class="sd">        this point. This hook is intended for account-specific setup</span>
<span class="sd">        like configurations.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_password_change"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_password_change">[docs]</a>    <span class="k">def</span> <span class="nf">at_password_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called after a successful password set/modify.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_pre_login"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_pre_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_pre_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called every time the user logs in, just before the actual</span>
<span class="sd">        login-state is set.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_send_to_connect_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for loading and sending to the comm channel dedicated to</span>
<span class="sd">        connection messages. This will also be sent to the mudinfo channel.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): A message to send to the connect channel.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_MUDINFO_CHANNEL</span><span class="p">,</span> <span class="n">_CONNECT_CHANNEL</span>
        <span class="k">if</span> <span class="n">_MUDINFO_CHANNEL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">CHANNEL_MUDINFO</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_MUDINFO_CHANNEL</span> <span class="o">=</span> <span class="n">ChannelDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">db_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CHANNEL_MUDINFO</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">ChannelDB</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_MUDINFO</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">_CONNECT_CHANNEL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">CHANNEL_CONNECTINFO</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_CONNECT_CHANNEL</span> <span class="o">=</span> <span class="n">ChannelDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">db_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CHANNEL_CONNECTINFO</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">ChannelDB</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_CONNECT_CHANNEL</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">USE_TZ</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%02i</span><span class="s2">-</span><span class="si">%02i</span><span class="s2">-</span><span class="si">%02i</span><span class="s2">(</span><span class="si">%02i</span><span class="s2">:</span><span class="si">%02i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_MUDINFO_CHANNEL</span><span class="p">:</span>
            <span class="n">_MUDINFO_CHANNEL</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_CONNECT_CHANNEL</span><span class="p">:</span>
            <span class="n">_CONNECT_CHANNEL</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DefaultAccount.at_post_login"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_post_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_post_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called at the end of the login process, just before letting</span>
<span class="sd">        the account loose.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session, optional): Session logging in, if any.</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is called *before* an eventual Character&#39;s</span>
<span class="sd">            `at_post_login` hook. By default it is used to set up</span>
<span class="sd">            auto-puppeting based on `MULTISESSION_MODE`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if we have saved protocol flags on ourselves, load them here.</span>
        <span class="n">protocol_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_saved_protocol_flags&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">protocol_flags</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">update_flags</span><span class="p">(</span><span class="o">**</span><span class="n">protocol_flags</span><span class="p">)</span>

        <span class="c1"># inform the client that we logged in through an OOB message</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">logged_in</span><span class="o">=</span><span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_send_to_connect_channel</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;|G</span><span class="si">{key}</span><span class="s2"> connected|n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_AUTO_PUPPET_ON_LOGIN</span><span class="p">:</span>
            <span class="c1"># in this mode we try to auto-connect to our last connected object, if any</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">puppet_object</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_last_puppet</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The Character does not exist.&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In this mode we don&#39;t auto-connect but by default end up at a character selection</span>
            <span class="c1"># screen. We execute look on the account.</span>
            <span class="c1"># we make sure to clean up the _playable_characters list in case</span>
            <span class="c1"># any was deleted in the interim.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span> <span class="k">if</span> <span class="n">char</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">at_look</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_failed_login"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_failed_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_failed_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by the login process if a user account is targeted correctly</span>
<span class="sd">        but provided with an invalid password. By default it does nothing,</span>
<span class="sd">        but exists to be overridden.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (session): Session logging in.</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_disconnect"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">at_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called just before user is disconnected.</span>

<span class="sd">        Args:</span>
<span class="sd">            reason (str, optional): The reason given for the disconnect,</span>
<span class="sd">                (echoed to the connection channel by default).</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">reason</span> <span class="k">if</span> <span class="n">reason</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_to_connect_channel</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;|R</span><span class="si">{key}</span><span class="s2"> disconnected</span><span class="si">{reason}</span><span class="s2">|n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DefaultAccount.at_post_disconnect"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_post_disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">at_post_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called *after* disconnection is complete. No messages</span>
<span class="sd">        can be relayed to the account from here. After this call, the</span>
<span class="sd">        account should not be accessed any more, making this a good</span>
<span class="sd">        spot for deleting it (in the case of a guest account account,</span>
<span class="sd">        for example).</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_msg_receive"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_msg_receive">[docs]</a>    <span class="k">def</span> <span class="nf">at_msg_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook is called whenever someone sends a message to this</span>
<span class="sd">        object using the `msg` method.</span>

<span class="sd">        Note that from_obj may be None if the sender did not include</span>
<span class="sd">        itself as an argument to the obj.msg() call - so you have to</span>
<span class="sd">        check for this. .</span>

<span class="sd">        Consider this a pre-processing method before msg is passed on</span>
<span class="sd">        to the user session. If this method returns False, the msg</span>
<span class="sd">        will not be passed on.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str, optional): The message received.</span>
<span class="sd">            from_obj (any, optional): The object sending the message.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            This includes any keywords sent to the `msg` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            receive (bool): If this message should be received.</span>

<span class="sd">        Notes:</span>
<span class="sd">            If this method returns False, the `msg` operation</span>
<span class="sd">            will abort without sending the message.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DefaultAccount.at_msg_send"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_msg_send">[docs]</a>    <span class="k">def</span> <span class="nf">at_msg_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a hook that is called when *this* object sends a</span>
<span class="sd">        message to another object with `obj.msg(text, to_obj=obj)`.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str, optional): Text to send.</span>
<span class="sd">            to_obj (any, optional): The object to send to.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            Keywords passed from msg()</span>

<span class="sd">        Notes:</span>
<span class="sd">            Since this method is executed by `from_obj`, if no `from_obj`</span>
<span class="sd">            was passed to `DefaultCharacter.msg` this hook will never</span>
<span class="sd">            get called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_server_reload"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_server_reload">[docs]</a>    <span class="k">def</span> <span class="nf">at_server_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook is called whenever the server is shutting down for</span>
<span class="sd">        restart/reboot. If you want to, for example, save</span>
<span class="sd">        non-persistent properties across a restart, this is the place</span>
<span class="sd">        to do it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="DefaultAccount.at_server_shutdown"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_server_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">at_server_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook is called whenever the server is shutting down fully</span>
<span class="sd">        (i.e. not for a restart).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="n">ooc_appearance_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">--------------------------------------------------------------------</span>
<span class="si">{header}</span><span class="s2"></span>

<span class="si">{sessions}</span><span class="s2"></span>

<span class="s2">  |whelp|n - more commands</span>
<span class="s2">  |wpublic &lt;text&gt;|n - talk on public channel</span>
<span class="s2">  |wcharcreate &lt;name&gt; [=description]|n - create new character</span>
<span class="s2">  |wchardelete &lt;name&gt;|n - delete a character</span>
<span class="s2">  |wic &lt;name&gt;|n - enter the game as character (|wooc|n to get back here)</span>
<span class="s2">  |wic|n - enter the game as latest character controlled.</span>

<span class="si">{characters}</span><span class="s2"></span>
<span class="si">{footer}</span><span class="s2"></span>
<span class="s2">--------------------------------------------------------------------</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<div class="viewcode-block" id="DefaultAccount.at_look"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultAccount.at_look">[docs]</a>    <span class="k">def</span> <span class="nf">at_look</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when this object executes a look. It allows to customize</span>
<span class="sd">        just what this means.</span>

<span class="sd">        Args:</span>
<span class="sd">            target (Object or list, optional): An object or a list</span>
<span class="sd">                objects to inspect. This is normally a list of characters.</span>
<span class="sd">            session (Session, optional): The session doing this look.</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        Returns:</span>
<span class="sd">            look_string (str): A prepared look string, ready to send</span>
<span class="sd">                off to any recipient (usually to ourselves)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_iter</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="c1"># single target - just show it</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;return_appearance&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">return_appearance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> has no in-game appearance.&quot;</span>

        <span class="c1"># multiple targets - this is a list of characters</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tar</span> <span class="k">for</span> <span class="n">tar</span> <span class="ow">in</span> <span class="n">target</span> <span class="k">if</span> <span class="n">tar</span><span class="p">)</span> <span class="k">if</span> <span class="n">target</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">ncars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">nsess</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nsess</span><span class="p">:</span>
            <span class="c1"># no sessions, nothing to report</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># header text</span>
        <span class="n">txt_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Account |g</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n (you are Out-of-Character)&quot;</span>

        <span class="c1"># sessions</span>
        <span class="n">sess_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">isess</span><span class="p">,</span> <span class="n">sess</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sessions</span><span class="p">):</span>
            <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">sess</span><span class="o">.</span><span class="n">address</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sess</span><span class="o">.</span><span class="n">protocol_key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ip_addr</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">sess_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;|w* </span><span class="si">{</span><span class="n">isess</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">|n&quot;</span>
                <span class="k">if</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">sessid</span> <span class="o">==</span> <span class="n">sess</span><span class="o">.</span><span class="n">sessid</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">isess</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">sess_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sess_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">txt_sessions</span> <span class="o">=</span> <span class="s2">&quot;|wConnected session(s):|n</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_strings</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">characters</span><span class="p">:</span>
            <span class="n">txt_characters</span> <span class="o">=</span> <span class="s2">&quot;You don&#39;t have a character yet. Use |wcharcreate|n.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_chars</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;unlimited&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_superuser</span> <span class="ow">or</span> <span class="n">_MAX_NR_CHARACTERS</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">_MAX_NR_CHARACTERS</span>
            <span class="p">)</span>

            <span class="n">char_strings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
                <span class="n">csessions</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">csessions</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">csessions</span><span class="p">:</span>
                        <span class="c1"># character is already puppeted</span>
                        <span class="n">sid</span> <span class="o">=</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">sessions</span> <span class="ow">and</span> <span class="n">sessions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">sess</span> <span class="ow">and</span> <span class="n">sid</span><span class="p">:</span>
                            <span class="n">char_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot; - |G</span><span class="si">{</span><span class="n">char</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="si">}</span><span class="s2">] &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(played by you in session </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">char_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot; - |R</span><span class="si">{</span><span class="n">char</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="si">}</span><span class="s2">] &quot;</span>
                                <span class="s2">&quot;(played by someone else)&quot;</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># character is &quot;free to puppet&quot;</span>
                    <span class="n">char_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">char</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

            <span class="n">txt_characters</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Available character(s) (</span><span class="si">{</span><span class="n">ncars</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_chars</span><span class="si">}</span><span class="s2">, |wic &lt;name&gt;|n to play):|n</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_strings</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ooc_appearance_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">txt_header</span><span class="p">,</span>
            <span class="n">sessions</span><span class="o">=</span><span class="n">txt_sessions</span><span class="p">,</span>
            <span class="n">characters</span><span class="o">=</span><span class="n">txt_characters</span><span class="p">,</span>
            <span class="n">footer</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="DefaultGuest"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest">[docs]</a><span class="k">class</span> <span class="nc">DefaultGuest</span><span class="p">(</span><span class="n">DefaultAccount</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used for guest logins. Unlike Accounts, Guests and</span>
<span class="sd">    their characters are deleted after disconnection.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DefaultGuest.create"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards request to cls.authenticate(); returns a DefaultGuest object</span>
<span class="sd">        if one is available for use.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultGuest.authenticate"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest.authenticate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets or creates a Guest account object.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            ip (str, optional): IP address of requester; used for ban checking,</span>
<span class="sd">                throttling and logging</span>

<span class="sd">        Returns:</span>
<span class="sd">            account (Object): Guest account object, if available</span>
<span class="sd">            errors (list): List of error messages accrued during this request.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">account</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># check if guests are enabled.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">GUEST_ENABLED</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Guest accounts are not enabled on this server.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find an available guest name.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">GUEST_LIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">AccountDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username__iexact</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;All guest accounts are in use. Please try again later.&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="n">LOGIN_THROTTLE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;Too many requests for Guest access.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># build a new account with the found guest username</span>
                <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%016x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
                <span class="n">home</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GUEST_HOME</span>
                <span class="n">permissions</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PERMISSION_GUEST_DEFAULT</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_GUEST_TYPECLASS</span>

                <span class="c1"># Call parent class creator</span>
                <span class="n">account</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DefaultGuest</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">guest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
                    <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span><span class="p">,</span>
                    <span class="n">home</span><span class="o">=</span><span class="n">home</span><span class="p">,</span>
                    <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">characters</span><span class="p">:</span>
                    <span class="c1"># this can happen for multisession_mode &gt; 1. For guests we</span>
                    <span class="c1"># always auto-create a character, regardless of multi-session-mode.</span>
                    <span class="n">character</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">create_character</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">errs</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">account</span><span class="p">,</span> <span class="n">errors</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># We are in the middle between logged in and -not, so we have</span>
            <span class="c1"># to handle tracebacks ourselves at this point. If we don&#39;t,</span>
            <span class="c1"># we won&#39;t see any errors at all.</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;An error occurred. Please e-mail an admin if the problem persists.&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">errors</span>

        <span class="k">return</span> <span class="n">account</span><span class="p">,</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="DefaultGuest.at_post_login"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest.at_post_login">[docs]</a>    <span class="k">def</span> <span class="nf">at_post_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By default, Guests only have one character regardless of which</span>
<span class="sd">        MAX_NR_CHARACTERS we use. They also always auto-puppet a matching</span>
<span class="sd">        character and don&#39;t get a choice.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session, optional): Session connecting.</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_to_connect_channel</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;|G</span><span class="si">{key}</span><span class="s2"> connected|n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">puppet_object</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_last_puppet</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefaultGuest.at_server_shutdown"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest.at_server_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">at_server_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We repeat the functionality of `at_disconnect()` here just to</span>
<span class="sd">        be on the safe side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">at_server_shutdown</span><span class="p">()</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span>
        <span class="k">if</span> <span class="n">characters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">character</span><span class="p">:</span>
                    <span class="n">character</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="DefaultGuest.at_post_disconnect"><a class="viewcode-back" href="../../../api/evennia.accounts.accounts.html#evennia.accounts.accounts.DefaultGuest.at_post_disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">at_post_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Once having disconnected, destroy the guest&#39;s characters and</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (dict): Arbitrary, optional arguments for users</span>
<span class="sd">                overriding the call (unused by default).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">at_post_disconnect</span><span class="p">()</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_playable_characters</span>
        <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">character</span><span class="p">:</span>
                <span class="n">character</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.accounts.accounts</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>