<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.server.portal.portalsessionhandler &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.portalsessionhandler</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.server.portal.portalsessionhandler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Sessionhandler for portal sessions.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">namedtuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twisted.internet</span><span class="w"> </span><span class="kn">import</span> <span class="n">reactor</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">evennia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.server.portal.amp</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCONN</span><span class="p">,</span> <span class="n">PCONNSYNC</span><span class="p">,</span> <span class="n">PDISCONN</span><span class="p">,</span> <span class="n">PDISCONNALL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.server.sessionhandler</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_trace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">class_from_module</span>

<span class="c1"># module import</span>
<span class="n">_MOD_IMPORT</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># global throttles</span>
<span class="n">_MAX_CONNECTION_RATE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_CONNECTION_RATE</span><span class="p">)</span>
<span class="c1"># per-session throttles</span>
<span class="n">_MAX_COMMAND_RATE</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_COMMAND_RATE</span><span class="p">)</span>
<span class="n">_MAX_CHAR_LIMIT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MAX_CHAR_LIMIT</span><span class="p">)</span>

<span class="n">_MIN_TIME_BETWEEN_CONNECTS</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">_MAX_CONNECTION_RATE</span><span class="p">)</span>
<span class="n">_MIN_TIME_BETWEEN_COMMANDS</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">_MAX_COMMAND_RATE</span><span class="p">)</span>

<span class="n">_ERROR_COMMAND_OVERFLOW</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">COMMAND_RATE_WARNING</span>
<span class="n">_ERROR_MAX_CHAR</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_CHAR_LIMIT_WARNING</span>

<span class="n">_CONNECTION_QUEUE</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

<span class="n">DUMMYSESSION</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;DummySession&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sessid&quot;</span><span class="p">])(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># -------------------------------------------------------------</span>
<span class="c1"># Portal-SessionHandler class</span>
<span class="c1"># -------------------------------------------------------------</span>

<span class="n">DOS_PROTECTION_MSG</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">{servername}</span><span class="s2"> DoS protection is active.You are queued to connect in </span><span class="si">{num}</span><span class="s2"> seconds ...&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="PortalSessionHandler">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PortalSessionHandler</span><span class="p">(</span><span class="n">SessionHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object holds the sessions connected to the portal at any time.</span>
<span class="sd">    It is synced with the server&#39;s equivalent SessionHandler over the AMP</span>
<span class="sd">    connection.</span>

<span class="sd">    Sessions register with the handler using the connect() method. This</span>
<span class="sd">    will assign a new unique sessionid to the session and send that sessid</span>
<span class="sd">    to the server using the AMP connection.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PortalSessionHandler.__init__">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init the handler</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_sessid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_task</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PortalSessionHandler.at_server_connection">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.at_server_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">at_server_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the Portal establishes connection with the Server.</span>
<span class="sd">        At this point, the AMP connection is already established.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="PortalSessionHandler.generate_sessid">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.generate_sessid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_sessid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simply generates a sessid that&#39;s guaranteed to be unique for this Portal run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sessid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_sessid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_sessid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_sessid</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_sessid</span></div>


<div class="viewcode-block" id="PortalSessionHandler.connect">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by protocol at first connect. This adds a not-yet</span>
<span class="sd">        authenticated session using an ever-increasing counter for</span>
<span class="sd">        sessid.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (PortalSession): The Session connecting.</span>

<span class="sd">        Notes:</span>
<span class="sd">            We implement a throttling mechanism here to limit the speed at</span>
<span class="sd">            which new connections are accepted - this is both a stop</span>
<span class="sd">            against DoS attacks as well as helps using the Dummyrunner</span>
<span class="sd">            tester with a large number of connector dummies.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_CONNECTION_QUEUE</span>

        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># assign if we are first-connectors</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">sessid</span><span class="p">:</span>
                <span class="c1"># if the session already has a sessid (e.g. being inherited in the</span>
                <span class="c1"># case of a webclient auto-reconnect), keep it</span>
                <span class="n">session</span><span class="o">.</span><span class="n">sessid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_sessid</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">server_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">_CONNECTION_QUEUE</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_CONNECTION_QUEUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">DOS_PROTECTION_MSG</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">servername</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SERVERNAME</span><span class="p">,</span>
                                <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_CONNECTION_QUEUE</span><span class="p">)</span> <span class="o">*</span> <span class="n">_MIN_TIME_BETWEEN_CONNECTS</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="p">{},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_last</span> <span class="o">&lt;</span> <span class="n">_MIN_TIME_BETWEEN_CONNECTS</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_task</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_task</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span>
                    <span class="n">_MIN_TIME_BETWEEN_CONNECTS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_last</span> <span class="o">=</span> <span class="n">now</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_CONNECTION_QUEUE</span><span class="p">:</span>
                <span class="c1"># keep launching tasks until queue is empty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_task</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span>
                    <span class="n">_MIN_TIME_BETWEEN_CONNECTS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_last</span> <span class="o">=</span> <span class="n">now</span>

        <span class="k">if</span> <span class="n">_CONNECTION_QUEUE</span><span class="p">:</span>
            <span class="c1"># sync with server-side</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">_CONNECTION_QUEUE</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">sessdata</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_sync_data</span><span class="p">()</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">sessid</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span>
            <span class="n">session</span><span class="o">.</span><span class="n">server_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="o">.</span><span class="n">send_AdminPortal2Server</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">PCONN</span><span class="p">,</span> <span class="n">sessiondata</span><span class="o">=</span><span class="n">sessdata</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="PortalSessionHandler.sync">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.sync">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by the protocol of an already connected session. This</span>
<span class="sd">        can be used to sync the session info in a delayed manner, such</span>
<span class="sd">        as when negotiation and handshakes are delayed.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (PortalSession): Session to sync.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">sessid</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">server_connected</span><span class="p">:</span>
            <span class="c1"># only use if session already has sessid and has already connected</span>
            <span class="c1"># once to the server - if so we must re-sync woth the server, otherwise</span>
            <span class="c1"># we skip this step.</span>
            <span class="n">sessdata</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_sync_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="p">:</span>
                <span class="c1"># we only send sessdata that should not have changed</span>
                <span class="c1"># at the server level at this point</span>
                <span class="n">sessdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sessdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span>
                    <span class="ow">in</span> <span class="p">(</span>
                        <span class="s2">&quot;protocol_key&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;address&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sessid&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;csessid&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;conn_time&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;protocol_flags&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;server_data&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="o">.</span><span class="n">send_AdminPortal2Server</span><span class="p">(</span>
                    <span class="n">session</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">PCONNSYNC</span><span class="p">,</span> <span class="n">sessiondata</span><span class="o">=</span><span class="n">sessdata</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="PortalSessionHandler.disconnect">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.disconnect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called from portal when the connection is closed from the</span>
<span class="sd">        portal side.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (PortalSession): Session to disconnect.</span>
<span class="sd">            delete (bool, optional): Delete the session from</span>
<span class="sd">                the handler. Only time to not do this is when</span>
<span class="sd">                this is called from a loop, such as from</span>
<span class="sd">                self.disconnect_all().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_CONNECTION_QUEUE</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">_CONNECTION_QUEUE</span><span class="p">:</span>
            <span class="c1"># connection was already dropped before we had time</span>
            <span class="c1"># to forward this to the Server, so now we just remove it.</span>
            <span class="n">_CONNECTION_QUEUE</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">sessid</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_disconnect_all&quot;</span><span class="p">):</span>
            <span class="c1"># if this was called directly from the protocol, the</span>
            <span class="c1"># connection is already dead and we just need to cleanup</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">sessid</span><span class="p">]</span>

        <span class="c1"># Tell the Server to disconnect its version of the Session as well.</span>
        <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="o">.</span><span class="n">send_AdminPortal2Server</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">PDISCONN</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PortalSessionHandler.disconnect_all">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.disconnect_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnect all sessions, informing the Server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">TEST_ENVIRONMENT</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_callback</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">sessionhandler</span><span class="p">):</span>
            <span class="c1"># we set a watchdog to stop self.disconnect from deleting</span>
            <span class="c1"># sessions while we are looping over them.</span>
            <span class="n">sessionhandler</span><span class="o">.</span><span class="n">_disconnect_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessionhandler</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">session</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">sessionhandler</span><span class="o">.</span><span class="n">_disconnect_all</span>

        <span class="c1"># inform Server; wait until finished sending before we continue</span>
        <span class="c1"># removing all the sessions.</span>

        <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="o">.</span><span class="n">send_AdminPortal2Server</span><span class="p">(</span>
            <span class="n">DUMMYSESSION</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">PDISCONNALL</span>
        <span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">_callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="PortalSessionHandler.server_connect">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.server_connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">server_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by server to force the initialization of a new protocol</span>
<span class="sd">        instance. Server wants this instance to get a unique sessid and to be</span>
<span class="sd">        connected back as normal. This is used to initiate irc/rss etc</span>
<span class="sd">        connections.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol_path (str): Full python path to the class factory</span>
<span class="sd">                for the protocol used, eg</span>
<span class="sd">                &#39;evennia.server.portal.irc.IRCClientFactory&#39;</span>
<span class="sd">            config (dict): Dictionary of configuration options, fed as</span>
<span class="sd">                `**kwarg` to protocol class `__init__` method.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If The correct factory class is not found.</span>

<span class="sd">        Notes:</span>
<span class="sd">            The called protocol class must have a method start()</span>
<span class="sd">            that calls the portalsession.connect() as a normal protocol.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_MOD_IMPORT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_MOD_IMPORT</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">variable_from_module</span> <span class="k">as</span> <span class="n">_MOD_IMPORT</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">clsname</span> <span class="o">=</span> <span class="n">protocol_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">_MOD_IMPORT</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">clsname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;ServerConnect: protocol factory &#39;</span><span class="si">%s</span><span class="s2">&#39; not found.&quot;</span> <span class="o">%</span> <span class="n">protocol_path</span><span class="p">)</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">protocol</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="PortalSessionHandler.server_disconnect">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.server_disconnect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">server_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by server to force a disconnect by sessid.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (portalsession): Session to disconnect.</span>
<span class="sd">            reason (str, optional): Motivation for disconnect.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">sessid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c1"># in case sess.disconnect doesn&#39;t delete it</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">sessid</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">session</span></div>


<div class="viewcode-block" id="PortalSessionHandler.server_disconnect_all">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.server_disconnect_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">server_disconnect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by server when forcing a clean disconnect for everyone.</span>

<span class="sd">        Args:</span>
<span class="sd">            reason (str, optional): Motivation for disconnect.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">session</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="PortalSessionHandler.server_logged_in">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.server_logged_in">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">server_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The server tells us that the session has been authenticated.</span>
<span class="sd">        Update it. Called by the Server.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): Session logging in.</span>
<span class="sd">            data (dict): The session sync data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span><span class="o">.</span><span class="n">load_sync_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">at_login</span><span class="p">()</span></div>


<div class="viewcode-block" id="PortalSessionHandler.server_session_sync">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.server_session_sync">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">server_session_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serversessions</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Server wants to save data to the portal, maybe because it&#39;s</span>
<span class="sd">        about to shut down. We don&#39;t overwrite any sessions here, just</span>
<span class="sd">        update them in-place.</span>

<span class="sd">        Args:</span>
<span class="sd">            serversessions (dict): This is a dictionary</span>

<span class="sd">                `{sessid:{property:value},...}` describing</span>
<span class="sd">                the properties to sync on all sessions.</span>
<span class="sd">            clean (bool): If True, remove any Portal sessions that are</span>
<span class="sd">                not included in serversessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_save</span> <span class="o">=</span> <span class="p">[</span><span class="n">sessid</span> <span class="k">for</span> <span class="n">sessid</span> <span class="ow">in</span> <span class="n">serversessions</span> <span class="k">if</span> <span class="n">sessid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="c1"># save protocols</span>
        <span class="k">for</span> <span class="n">sessid</span> <span class="ow">in</span> <span class="n">to_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">sessid</span><span class="p">]</span><span class="o">.</span><span class="n">load_sync_data</span><span class="p">(</span><span class="n">serversessions</span><span class="p">[</span><span class="n">sessid</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
            <span class="c1"># disconnect out-of-sync missing protocols</span>
            <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">sessid</span> <span class="k">for</span> <span class="n">sessid</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">sessid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_save</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sessid</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_disconnect</span><span class="p">(</span><span class="n">sessid</span><span class="p">)</span></div>


<div class="viewcode-block" id="PortalSessionHandler.count_loggedin">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.count_loggedin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_loggedin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_unloggedin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count loggedin connections, alternatively count all connections.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_unloggedin (bool): Also count sessions that have</span>
<span class="sd">            not yet authenticated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            count (int): Number of sessions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sessions</span><span class="p">(</span><span class="n">include_unloggedin</span><span class="o">=</span><span class="n">include_unloggedin</span><span class="p">))</span></div>


<div class="viewcode-block" id="PortalSessionHandler.sessions_from_csessid">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.sessions_from_csessid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sessions_from_csessid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csessid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a session id, retrieve the session (this is primarily</span>
<span class="sd">        intended to be called by web clients)</span>

<span class="sd">        Args:</span>
<span class="sd">            csessid (int): Session id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            session (list): The matching session, if found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">sess</span>
            <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sessions</span><span class="p">(</span><span class="n">include_unloggedin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;csessid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sess</span><span class="o">.</span><span class="n">csessid</span> <span class="ow">and</span> <span class="n">sess</span><span class="o">.</span><span class="n">csessid</span> <span class="o">==</span> <span class="n">csessid</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="PortalSessionHandler.announce_all">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.announce_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">announce_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send message to all connected sessions.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str):  Message to relay.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This will create an on-the fly text-type</span>
<span class="sd">            send command.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="p">[[</span><span class="n">message</span><span class="p">],</span> <span class="p">{}])</span></div>


<div class="viewcode-block" id="PortalSessionHandler.data_in">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.data_in">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by portal sessions for relaying data coming</span>
<span class="sd">        in from the protocol to the server.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (PortalSession): Session receiving data.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): Other data from protocol.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Data is serialized before passed on.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_MAX_CHAR_LIMIT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_CHAR_LIMIT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="p">[[</span><span class="n">_ERROR_MAX_CHAR</span><span class="p">],</span> <span class="p">{}])</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># if there is a problem to send, we continue</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">command_counter_reset</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">command_counter_reset</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">command_counter_reset</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">command_counter_reset</span> <span class="o">=</span> <span class="n">now</span>
                <span class="n">session</span><span class="o">.</span><span class="n">command_counter</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># global command-rate limit</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">command_counter_reset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="c1"># more than a second since resetting the counter. Refresh.</span>
                <span class="n">session</span><span class="o">.</span><span class="n">command_counter_reset</span> <span class="o">=</span> <span class="n">now</span>
                <span class="n">session</span><span class="o">.</span><span class="n">command_counter</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">session</span><span class="o">.</span><span class="n">command_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">command_counter</span> <span class="o">*</span> <span class="n">_MIN_TIME_BETWEEN_COMMANDS</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="p">[[</span><span class="n">_ERROR_COMMAND_OVERFLOW</span><span class="p">],</span> <span class="p">{}])</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="p">:</span>
                <span class="c1"># this can happen if someone connects before AMP connection</span>
                <span class="c1"># was established (usually on first start)</span>
                <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_in</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># scrub data</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_senddata</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># relay data to Server</span>
            <span class="n">session</span><span class="o">.</span><span class="n">cmd_last</span> <span class="o">=</span> <span class="n">now</span>
            <span class="n">evennia</span><span class="o">.</span><span class="n">EVENNIA_PORTAL_SERVICE</span><span class="o">.</span><span class="n">amp_protocol</span><span class="o">.</span><span class="n">send_MsgPortal2Server</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># eventual local echo (text input only)</span>
            <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">session</span><span class="o">.</span><span class="n">protocol_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCALECHO&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_out</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="PortalSessionHandler.data_out">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.portalsessionhandler.html#evennia.server.portal.portalsessionhandler.PortalSessionHandler.data_out">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by server for having the portal relay messages and data</span>
<span class="sd">        to the correct session protocol.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): Session sending data.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            kwargs (any): Each key is a command instruction to the</span>
<span class="sd">                protocol on the form key = [[args],{kwargs}]. This will</span>
<span class="sd">                call a method send_&lt;key&gt; on the protocol. If no such</span>
<span class="sd">                method exits, it sends the data to a method send_default.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from evennia.server.profiling.timetrace import timetrace  # DEBUG</span>
        <span class="c1"># text = timetrace(text, &quot;portalsessionhandler.data_out&quot;)  # DEBUG</span>

        <span class="c1"># distribute outgoing data to the correct session methods.</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cmdname</span><span class="p">,</span> <span class="p">(</span><span class="n">cmdargs</span><span class="p">,</span> <span class="n">cmdkwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">funcname</span> <span class="o">=</span> <span class="s2">&quot;send_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
                    <span class="c1"># better to use hassattr here over try..except</span>
                    <span class="c1"># - avoids hiding AttributeErrors in the call.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)(</span><span class="o">*</span><span class="n">cmdargs</span><span class="p">,</span> <span class="o">**</span><span class="n">cmdkwargs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">log_trace</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># note that send_default always takes cmdname</span>
                        <span class="c1"># as arg too.</span>
                        <span class="n">session</span><span class="o">.</span><span class="n">send_default</span><span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">cmdargs</span><span class="p">,</span> <span class="o">**</span><span class="n">cmdkwargs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">log_trace</span><span class="p">()</span></div>
</div>



<span class="c1"># This will be filled in when the portal boots.</span>
<span class="n">PORTAL_SESSIONS</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.portalsessionhandler</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>