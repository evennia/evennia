<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.server.portal.telnet_oob &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.telnet_oob</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.server.portal.telnet_oob</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Telnet OOB (Out of band communication)</span>

<span class="sd">OOB protocols allow for asynchronous communication between Evennia and</span>
<span class="sd">compliant telnet clients. The &quot;text&quot; type of send command will always</span>
<span class="sd">be sent &quot;in-band&quot;, appearing in the client&#39;s main text output. OOB</span>
<span class="sd">commands, by contrast, can have many forms and it is up to the client</span>
<span class="sd">how and if they are handled.  Examples of OOB instructions could be to</span>
<span class="sd">instruct the client to play sounds or to update a graphical health</span>
<span class="sd">bar.</span>

<span class="sd">Note that in Evennia&#39;s Web client, all send commands are &quot;OOB</span>
<span class="sd">commands&quot;, (including the &quot;text&quot; one), there is no equivalence to</span>
<span class="sd">MSDP/GMCP for the webclient since it doesn&#39;t need it.</span>

<span class="sd">This implements the following telnet OOB communication protocols:</span>

<span class="sd">- MSDP (Mud Server Data Protocol), as per http://tintin.sourceforge.net/msdp/</span>
<span class="sd">- GMCP (Generic Mud Communication Protocol) as per</span>
<span class="sd">  http://www.ironrealms.com/rapture/manual/files/FeatGMCP-txt.html#Generic_MUD_Communication_Protocol%28GMCP%29</span>

<span class="sd">----</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>

<span class="c1"># General Telnet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twisted.conch.telnet</span><span class="w"> </span><span class="kn">import</span> <span class="n">IAC</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="n">SE</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_iter</span>

<span class="c1"># MSDP-relevant telnet cmd/opt-codes</span>
<span class="n">MSDP</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">69</span><span class="p">])</span>
<span class="n">MSDP_VAR</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="n">MSDP_VAL</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
<span class="n">MSDP_TABLE_OPEN</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
<span class="n">MSDP_TABLE_CLOSE</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">4</span><span class="p">])</span>

<span class="n">MSDP_ARRAY_OPEN</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span>
<span class="n">MSDP_ARRAY_CLOSE</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">6</span><span class="p">])</span>

<span class="c1"># GMCP</span>
<span class="n">GMCP</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mi">201</span><span class="p">])</span>


<span class="c1"># pre-compiled regexes</span>
<span class="c1"># returns 2-tuple</span>
<span class="n">msdp_regex_table</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">rb</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">\s*(\w*?)\s*</span><span class="si">%s</span><span class="s2">\s*</span><span class="si">%s</span><span class="s2">(.*?)</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MSDP_VAR</span><span class="p">,</span> <span class="n">MSDP_VAL</span><span class="p">,</span> <span class="n">MSDP_TABLE_OPEN</span><span class="p">,</span> <span class="n">MSDP_TABLE_CLOSE</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># returns 2-tuple</span>
<span class="n">msdp_regex_array</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">rb</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">\s*(\w*?)\s*</span><span class="si">%s</span><span class="s2">\s*</span><span class="si">%s</span><span class="s2">(.*?)</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MSDP_VAR</span><span class="p">,</span> <span class="n">MSDP_VAL</span><span class="p">,</span> <span class="n">MSDP_ARRAY_OPEN</span><span class="p">,</span> <span class="n">MSDP_ARRAY_CLOSE</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">msdp_regex_var</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MSDP_VAR</span><span class="p">)</span>
<span class="n">msdp_regex_val</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rb</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MSDP_VAL</span><span class="p">)</span>

<span class="n">EVENNIA_TO_GMCP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;client_options&quot;</span><span class="p">:</span> <span class="s2">&quot;Core.Supports.Get&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_inputfuncs&quot;</span><span class="p">:</span> <span class="s2">&quot;Core.Commands.Get&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_value&quot;</span><span class="p">:</span> <span class="s2">&quot;Char.Value.Get&quot;</span><span class="p">,</span>
    <span class="s2">&quot;repeat&quot;</span><span class="p">:</span> <span class="s2">&quot;Char.Repeat.Update&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;Char.Monitor.Update&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># MSDP/GMCP communication handler</span>


<div class="viewcode-block" id="TelnetOOB">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TelnetOOB</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the MSDP and GMCP protocols.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TelnetOOB.__init__">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates by storing the protocol on itself and trying to</span>
<span class="sd">        determine if the client supports MSDP.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol (Protocol): The active protocol.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">protocol_flags</span><span class="p">[</span><span class="s2">&quot;OOB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MSDP</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GMCP</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># ask for the available protocols and assign decoders</span>
        <span class="c1"># (note that handshake_done() will be called twice!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">negotiationMap</span><span class="p">[</span><span class="n">MSDP</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_msdp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">negotiationMap</span><span class="p">[</span><span class="n">GMCP</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_gmcp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">will</span><span class="p">(</span><span class="n">MSDP</span><span class="p">)</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_msdp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_msdp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">will</span><span class="p">(</span><span class="n">GMCP</span><span class="p">)</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_gmcp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_gmcp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oob_reported</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="TelnetOOB.no_msdp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.no_msdp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">no_msdp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Client reports No msdp supported or wanted.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (Option): Not used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no msdp, check GMCP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">handshake_done</span><span class="p">()</span></div>


<div class="viewcode-block" id="TelnetOOB.do_msdp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.do_msdp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_msdp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Client reports that it supports msdp.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (Option): Not used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MSDP</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">protocol_flags</span><span class="p">[</span><span class="s2">&quot;OOB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">handshake_done</span><span class="p">()</span></div>


<div class="viewcode-block" id="TelnetOOB.no_gmcp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.no_gmcp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">no_gmcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this is reached, it means neither MSDP nor GMCP is</span>
<span class="sd">        supported.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (Option): Not used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">handshake_done</span><span class="p">()</span></div>


<div class="viewcode-block" id="TelnetOOB.do_gmcp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.do_gmcp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_gmcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when client confirms that it can do MSDP or GMCP.</span>

<span class="sd">        Args:</span>
<span class="sd">            option (Option): Not used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GMCP</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">protocol_flags</span><span class="p">[</span><span class="s2">&quot;OOB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">handshake_done</span><span class="p">()</span></div>


    <span class="c1"># encoders</span>

<div class="viewcode-block" id="TelnetOOB.encode_msdp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.encode_msdp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode_msdp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode into a valid MSDP command.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdname (str): Name of send instruction.</span>
<span class="sd">            args, kwargs (any): Arguments to OOB command.</span>

<span class="sd">        Notes:</span>
<span class="sd">            The output of this encoding will be</span>
<span class="sd">            MSDP structures on these forms:</span>
<span class="sd">            ::</span>

<span class="sd">                [cmdname, [], {}]           -&gt; VAR cmdname VAL &quot;&quot;</span>
<span class="sd">                [cmdname, [arg], {}]        -&gt; VAR cmdname VAL arg</span>
<span class="sd">                [cmdname, [args],{}]        -&gt; VAR cmdname VAL ARRAYOPEN VAL arg VAL arg ... ARRAYCLOSE</span>
<span class="sd">                [cmdname, [], {kwargs}]     -&gt; VAR cmdname VAL TABLEOPEN VAR key VAL val ... TABLECLOSE</span>
<span class="sd">                [cmdname, [args], {kwargs}] -&gt; VAR cmdname VAL ARRAYOPEN VAL arg VAL arg ... ARRAYCLOSE</span>
<span class="sd">                                               VAR cmdname VAL TABLEOPEN VAR key VAL val ... TABLECLOSE</span>

<span class="sd">            Further nesting is not supported, so if an array argument</span>
<span class="sd">            consists of an array (for example), that array will be</span>
<span class="sd">            json-converted to a string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msdp_cmdname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{msdp_var}{msdp_cmdname}{msdp_val}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msdp_var</span><span class="o">=</span><span class="n">MSDP_VAR</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">msdp_cmdname</span><span class="o">=</span><span class="n">cmdname</span><span class="p">,</span> <span class="n">msdp_val</span><span class="o">=</span><span class="n">MSDP_VAL</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">msdp_cmdname</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># print(&quot;encode_msdp in:&quot;, cmdname, args, kwargs)  # DEBUG</span>

        <span class="n">msdp_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">msdp_args</span> <span class="o">=</span> <span class="n">msdp_cmdname</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msdp_args</span> <span class="o">+=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msdp_args</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{msdp_array_open}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="si">{msdp_args}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="si">{msdp_array_close}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">msdp_array_open</span><span class="o">=</span><span class="n">MSDP_ARRAY_OPEN</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                        <span class="n">msdp_array_close</span><span class="o">=</span><span class="n">MSDP_ARRAY_CLOSE</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                        <span class="n">msdp_args</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MSDP_VAL</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">args</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">msdp_kwargs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">msdp_kwargs</span> <span class="o">=</span> <span class="n">msdp_cmdname</span>
            <span class="n">msdp_kwargs</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{msdp_table_open}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="si">{msdp_kwargs}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="si">{msdp_table_close}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">msdp_table_open</span><span class="o">=</span><span class="n">MSDP_TABLE_OPEN</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                    <span class="n">msdp_table_close</span><span class="o">=</span><span class="n">MSDP_TABLE_CLOSE</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                    <span class="n">msdp_kwargs</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MSDP_VAR</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">key</span><span class="p">,</span> <span class="n">MSDP_VAL</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">msdp_string</span> <span class="o">=</span> <span class="n">msdp_args</span> <span class="o">+</span> <span class="n">msdp_kwargs</span>

        <span class="c1"># print(&quot;msdp_string:&quot;, msdp_string)  # DEBUG</span>
        <span class="k">return</span> <span class="n">msdp_string</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>


<div class="viewcode-block" id="TelnetOOB.encode_gmcp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.encode_gmcp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">encode_gmcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode into GMCP messages.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdname (str): GMCP OOB command name.</span>
<span class="sd">            args, kwargs (any): Arguments to OOB command.</span>

<span class="sd">        Notes:</span>
<span class="sd">            GMCP messages will be outgoing on the following</span>
<span class="sd">            form (the non-JSON cmdname at the start is what</span>
<span class="sd">            IRE games use, supposedly, and what clients appear</span>
<span class="sd">            to have adopted). A cmdname without Package will end</span>
<span class="sd">            up in the Core package, while Core package names will</span>
<span class="sd">            be stripped on the Evennia side.</span>
<span class="sd">            ::</span>

<span class="sd">                [cmd_name, [], {}]          -&gt; Cmd.Name</span>
<span class="sd">                [cmd_name, [arg], {}]       -&gt; Cmd.Name arg</span>
<span class="sd">                [cmd_name, [args],{}]       -&gt; Cmd.Name [args]</span>
<span class="sd">                [cmd_name, [], {kwargs}]    -&gt; Cmd.Name {kwargs}</span>
<span class="sd">                [cmdname, [args, {kwargs}]  -&gt; Core.Cmdname [[args],{kwargs}]</span>

<span class="sd">            For more flexibility with certain clients, if `cmd_name` is capitalized,</span>
<span class="sd">            Evennia will leave its current capitalization (So CMD_nAmE would be sent</span>
<span class="sd">            as CMD.nAmE but cMD_Name would be Cmd.Name)</span>

<span class="sd">        Notes:</span>
<span class="sd">            There are also a few default mappings between evennia outputcmds and GMCP:</span>
<span class="sd">            ::</span>

<span class="sd">                client_options -&gt; Core.Supports.Get</span>
<span class="sd">                get_inputfuncs -&gt; Core.Commands.Get</span>
<span class="sd">                get_value      -&gt; Char.Value.Get</span>
<span class="sd">                repeat         -&gt; Char.Repeat.Update</span>
<span class="sd">                monitor        -&gt; Char.Monitor.Update</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cmdname</span> <span class="ow">in</span> <span class="n">EVENNIA_TO_GMCP</span><span class="p">:</span>
            <span class="n">gmcp_cmdname</span> <span class="o">=</span> <span class="n">EVENNIA_TO_GMCP</span><span class="p">[</span><span class="n">cmdname</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">cmdname</span><span class="p">:</span>
            <span class="c1"># enforce initial capitalization of each command part, leaving fully-capitalized sections intact</span>
            <span class="n">gmcp_cmdname</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gmcp_cmdname</span> <span class="o">=</span> <span class="s2">&quot;Core.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmdname</span> <span class="k">if</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">istitle</span><span class="p">()</span> <span class="k">else</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">gmcp_string</span> <span class="o">=</span> <span class="n">gmcp_cmdname</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">gmcp_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gmcp_cmdname</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gmcp_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gmcp_cmdname</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># only kwargs</span>
            <span class="n">gmcp_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gmcp_cmdname</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="c1"># print(&quot;gmcp string&quot;, gmcp_string)  # DEBUG</span>
        <span class="k">return</span> <span class="n">gmcp_string</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>


<div class="viewcode-block" id="TelnetOOB.decode_msdp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.decode_msdp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decode_msdp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes incoming MSDP data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str or list): MSDP data.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Clients should always send MSDP data on</span>
<span class="sd">            one of the following forms:</span>
<span class="sd">            ::</span>

<span class="sd">                cmdname &#39;&#39;          -&gt; [cmdname, [], {}]</span>
<span class="sd">                cmdname val         -&gt; [cmdname, [val], {}]</span>
<span class="sd">                cmdname array       -&gt; [cmdname, [array], {}]</span>
<span class="sd">                cmdname table       -&gt; [cmdname, [], {table}]</span>
<span class="sd">                cmdname array cmdname table -&gt; [cmdname, [array], {table}]</span>

<span class="sd">            Observe that all MSDP_VARS are used to identify cmdnames,</span>
<span class="sd">            so if there are multiple arrays with the same cmdname</span>
<span class="sd">            given, they will be merged into one argument array, same</span>
<span class="sd">            for tables. Different MSDP_VARS (outside tables) will be</span>
<span class="sd">            identified as separate cmdnames.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># print(&quot;decode_msdp in:&quot;, data)  # DEBUG</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># decode tables</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">msdp_regex_table</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span> <span class="k">else</span> <span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">varval</span> <span class="ow">in</span> <span class="n">msdp_regex_var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">table</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">msdp_regex_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">varval</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var</span><span class="p">:</span>
                    <span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># decode arrays from all that was not a table</span>
        <span class="n">data_no_tables</span> <span class="o">=</span> <span class="n">msdp_regex_table</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">msdp_regex_array</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">data_no_tables</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrays</span> <span class="k">else</span> <span class="n">arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">msdp_regex_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># decode remainders from all that were not tables or arrays</span>
        <span class="n">data_no_tables_or_arrays</span> <span class="o">=</span> <span class="n">msdp_regex_array</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data_no_tables</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">varval</span> <span class="ow">in</span> <span class="n">msdp_regex_var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_no_tables_or_arrays</span><span class="p">):</span>
            <span class="c1"># get remaining varvals after cleaning away tables/arrays. If mathcing</span>
            <span class="c1"># an existing key in arrays, it will be added as an argument to that command,</span>
            <span class="c1"># otherwise it will be treated as a command without argument.</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">msdp_regex_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">cmds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># merge matching table/array/variables together</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">table</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arrays</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">arr</span><span class="p">,</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">var</span><span class="p">],</span> <span class="p">{}]</span>

        <span class="c1"># remap the &#39;generic msdp commands&#39; to avoid colliding with builtins etc</span>
        <span class="c1"># by prepending &quot;msdp_&quot;</span>
        <span class="n">lower_case</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">remap</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;send&quot;</span><span class="p">,</span> <span class="s2">&quot;unreport&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">remap</span> <span class="ow">in</span> <span class="n">lower_case</span><span class="p">:</span>
                <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;msdp_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remap</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lower_case</span><span class="p">[</span><span class="n">remap</span><span class="p">])</span>

        <span class="c1"># print(&quot;msdp data in:&quot;, cmds)  # DEBUG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">data_in</span><span class="p">(</span><span class="o">**</span><span class="n">cmds</span><span class="p">)</span></div>


<div class="viewcode-block" id="TelnetOOB.decode_gmcp">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.decode_gmcp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decode_gmcp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decodes incoming GMCP data on the form &#39;varname &lt;structure&gt;&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str or list): GMCP data.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Clients send data on the form &quot;Module.Submodule.Cmdname &lt;structure&gt;&quot;.</span>
<span class="sd">            We assume the structure is valid JSON.</span>

<span class="sd">            The following is parsed into Evennia&#39;s formal structure:</span>
<span class="sd">            ::</span>

<span class="sd">                Core.Name                         -&gt; [name, [], {}]</span>
<span class="sd">                Core.Name string                  -&gt; [name, [string], {}]</span>
<span class="sd">                Core.Name [arg, arg,...]          -&gt; [name, [args], {}]</span>
<span class="sd">                Core.Name {key:arg, key:arg, ...} -&gt; [name, [], {kwargs}]</span>
<span class="sd">                Core.Name [[args], {kwargs}]      -&gt; [name, [args], {kwargs}]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># print(&quot;decode_gmcp in:&quot;, data)  # DEBUG</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmdname</span><span class="p">,</span> <span class="n">structure</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">cmdname</span><span class="p">,</span> <span class="n">structure</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
            <span class="n">cmdname</span> <span class="o">=</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># maybe the structure is not json-serialized at all</span>
                <span class="k">pass</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">is_iter</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">cmdname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;core_&quot;</span><span class="p">):</span>
                <span class="c1"># if Core.cmdname, then use cmdname</span>
                <span class="n">cmdname</span> <span class="o">=</span> <span class="n">cmdname</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">data_in</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">cmdname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span> <span class="p">[</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]})</span></div>


    <span class="c1"># access methods</span>

<div class="viewcode-block" id="TelnetOOB.data_out">
<a class="viewcode-back" href="../../../../api/evennia.server.portal.telnet_oob.html#evennia.server.portal.telnet_oob.TelnetOOB.data_out">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a MSDP- or GMCP-valid subnegotiation across the protocol.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdname (str): OOB-command name.</span>
<span class="sd">            args, kwargs (any): Arguments to OOB command.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">MSDP</span><span class="p">:</span>
            <span class="n">encoded_oob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_msdp</span><span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">IAC</span> <span class="o">+</span> <span class="n">SB</span> <span class="o">+</span> <span class="n">MSDP</span> <span class="o">+</span> <span class="n">encoded_oob</span> <span class="o">+</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">SE</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GMCP</span><span class="p">:</span>
            <span class="n">encoded_oob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_gmcp</span><span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">()</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">IAC</span> <span class="o">+</span> <span class="n">SB</span> <span class="o">+</span> <span class="n">GMCP</span> <span class="o">+</span> <span class="n">encoded_oob</span> <span class="o">+</span> <span class="n">IAC</span> <span class="o">+</span> <span class="n">SE</span><span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.server.portal.telnet_oob</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>