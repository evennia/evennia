<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.commands.default.building &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.commands.default.building</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.commands.default.building</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Building and world design commands</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.paginator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Q</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">evennia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterruptCommand</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.commands.cmdhandler</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_cmdset_providers</span><span class="p">,</span> <span class="n">get_and_merge_cmdsets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.locks.lockhandler</span><span class="w"> </span><span class="kn">import</span> <span class="n">LockException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.objects.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectDB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.prototypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">menus</span> <span class="k">as</span> <span class="n">olc_menus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.prototypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">prototypes</span> <span class="k">as</span> <span class="n">protlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.prototypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">spawner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.scripts.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScriptDB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create</span><span class="p">,</span> <span class="n">funcparser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.ansi</span><span class="w"> </span><span class="kn">import</span> <span class="n">raw</span> <span class="k">as</span> <span class="n">ansi_raw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.dbserialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">deserialize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.eveditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvEditor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.evmore</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvMore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.evtable</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvTable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">class_from_module</span><span class="p">,</span>
    <span class="n">crop</span><span class="p">,</span>
    <span class="n">dbref</span><span class="p">,</span>
    <span class="n">display_len</span><span class="p">,</span>
    <span class="n">format_grid</span><span class="p">,</span>
    <span class="n">get_all_typeclasses</span><span class="p">,</span>
    <span class="n">inherits_from</span><span class="p">,</span>
    <span class="n">interactive</span><span class="p">,</span>
    <span class="n">list_to_string</span><span class="p">,</span>
    <span class="n">variable_from_module</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">COMMAND_DEFAULT_CLASS</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">)</span>

<span class="n">_FUNCPARSER</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_ATTRFUNCPARSER</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># _KEY_REGEX = re.compile(r&quot;(?P&lt;attr&gt;.*?)(?P&lt;key&gt;(\[.*\]\ *)+)?$&quot;)</span>
<span class="n">_KEY_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;attr&gt;[^\[]*)(?P&lt;key&gt;(\[[^\]]*\]\ *)+)?$&quot;</span><span class="p">)</span>

<span class="c1"># limit symbol import for API</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;ObjManipCommand&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdSetObjAlias&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdCopy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdCpAttr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdMvAttr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdCreate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdDesc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdDestroy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdDig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdTunnel&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdLink&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdUnLink&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdSetHome&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdListCmdSets&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdName&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdOpen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdSetAttribute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdTypeclass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdWipe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdLock&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdExamine&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdFind&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdTeleport&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdScripts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdObjects&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdTag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CmdSpawn&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># used by set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_eval</span> <span class="k">as</span> <span class="n">_LITERAL_EVAL</span>  <span class="c1"># noqa</span>

<span class="n">LIST_APPEND_CHAR</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

<span class="c1"># used by find</span>
<span class="n">CHAR_TYPECLASS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span>
<span class="n">ROOM_TYPECLASS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span>
<span class="n">EXIT_TYPECLASS</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span>
<span class="n">_DEFAULT_WIDTH</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CLIENT_DEFAULT_WIDTH</span>

<span class="n">_PROTOTYPE_PARENTS</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="ObjManipCommand">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ObjManipCommand">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ObjManipCommand</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a parent class for some of the defining objmanip commands</span>
<span class="sd">    since they tend to have some more variables to define new objects.</span>

<span class="sd">    Each object definition can have several components. First is</span>
<span class="sd">    always a name, followed by an optional alias list and finally an</span>
<span class="sd">    some optional data, such as a typeclass or a location. A comma &#39;,&#39;</span>
<span class="sd">    separates different objects. Like this:</span>

<span class="sd">        name1;alias;alias;alias:option, name2;alias;alias ...</span>

<span class="sd">    Spaces between all components are stripped.</span>

<span class="sd">    A second situation is attribute manipulation. Such commands</span>
<span class="sd">    are simpler and offer combinations</span>

<span class="sd">        objname/attr/attr/attr, objname/attr, ...</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># OBS - this is just a parent - it&#39;s not intended to actually be</span>
    <span class="c1"># included in a commandset on its own!</span>

    <span class="c1"># used by get_object_typeclass as defaults.</span>
    <span class="n">default_typeclasses</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_OBJECT_TYPECLASS</span><span class="p">,</span>
        <span class="s2">&quot;character&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span><span class="p">,</span>
        <span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span><span class="p">,</span>
        <span class="s2">&quot;exit&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ObjManipCommand.parse">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ObjManipCommand.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We need to expand the default parsing to get all</span>
<span class="sd">        the cases, see the module doc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all the normal parsing done (switches etc)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="n">obj_defs</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>  <span class="c1"># stores left- and right-hand side of &#39;=&#39;</span>
        <span class="n">obj_attrs</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[])</span>  <span class="c1"># &quot;</span>

        <span class="k">for</span> <span class="n">iside</span><span class="p">,</span> <span class="n">arglist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lhslist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhslist</span><span class="p">)):</span>
            <span class="c1"># lhslist/rhslist is already split by &#39;,&#39; at this point</span>
            <span class="k">for</span> <span class="n">objdef</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">:</span>
                <span class="n">aliases</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">attrs</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">objdef</span><span class="p">:</span>
                    <span class="n">objdef</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">objdef</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">objdef</span><span class="p">:</span>
                    <span class="n">objdef</span><span class="p">,</span> <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">objdef</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">alias</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">objdef</span><span class="p">:</span>
                    <span class="n">objdef</span><span class="p">,</span> <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">objdef</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># Should an attribute key is specified, ie. we&#39;re working</span>
                    <span class="c1"># on a dict, what we want is to lowercase attribute name</span>
                    <span class="c1"># as usual but to preserve dict key case as one would</span>
                    <span class="c1"># expect:</span>
                    <span class="c1">#</span>
                    <span class="c1"># set box/MyAttr = {&#39;FooBar&#39;: 1}</span>
                    <span class="c1"># Created attribute box/myattr [category:None] = {&#39;FooBar&#39;: 1}</span>
                    <span class="c1"># set box/MyAttr[&#39;FooBar&#39;] = 2</span>
                    <span class="c1"># Modified attribute box/myattr [category:None] = {&#39;FooBar&#39;: 2}</span>
                    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="k">match</span>
                        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">part</span> <span class="ow">and</span> <span class="p">(</span><span class="n">match</span> <span class="o">:=</span> <span class="n">_KEY_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                    <span class="p">):</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;attr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="c1"># reappend untouched key, if present</span>
                        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
                            <span class="n">attr</span> <span class="o">+=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                        <span class="n">_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">_attrs</span>
                <span class="c1"># store data</span>
                <span class="n">obj_defs</span><span class="p">[</span><span class="n">iside</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">objdef</span><span class="p">,</span> <span class="s2">&quot;option&quot;</span><span class="p">:</span> <span class="n">option</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">:</span> <span class="n">aliases</span><span class="p">})</span>
                <span class="n">obj_attrs</span><span class="p">[</span><span class="n">iside</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">objdef</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">option</span><span class="p">})</span>

        <span class="c1"># store for future access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span> <span class="o">=</span> <span class="n">obj_defs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span> <span class="o">=</span> <span class="n">obj_defs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span> <span class="o">=</span> <span class="n">obj_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objattr</span> <span class="o">=</span> <span class="n">obj_attrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="ObjManipCommand.get_object_typeclass">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ObjManipCommand.get_object_typeclass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_object_typeclass</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cmd_create&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Typeclass&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook is called by build commands to determine which typeclass to use for a specific</span>
<span class="sd">        purpose.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj_type (str, optional): The type of object that is being created. Defaults to</span>
<span class="sd">                &quot;object&quot;. Evennia provides &quot;room&quot;, &quot;exit&quot;, and &quot;character&quot; by default, but this can be</span>
<span class="sd">                extended.</span>
<span class="sd">            typeclass (str, optional): The typeclass that was requested by the player. Defaults to</span>
<span class="sd">                None.  Can also be an actual class.</span>
<span class="sd">            method (str, optional): The method that is calling this hook. Defaults to &quot;cmd_create&quot;.</span>
<span class="sd">                Others are &quot;cmd_dig&quot;, &quot;cmd_open&quot;, &quot;cmd_tunnel&quot;, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the typeclass to use and a list of errors. (which might be</span>
<span class="sd">                empty.)</span>

<span class="sd">        Notes:</span>
<span class="sd">            Although intended to be used with typeclasses, as long as this hook returns a class with</span>
<span class="sd">            a create method, which accepts the same API as DefaultObject.create(), build commands</span>
<span class="sd">            and other places should take it. While not used by default, one could picture using this</span>
<span class="sd">            for things like autodetecting which room to build next based on the current location.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found_typeclass</span> <span class="o">=</span> <span class="n">typeclass</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_typeclasses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_typeclass</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;No typeclass found for object type &#39;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">type_class</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">class_from_module</span><span class="p">(</span><span class="n">found_typeclass</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">TYPECLASS_PATHS</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">found_typeclass</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">found_typeclass</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Typeclass &#39;</span><span class="si">{</span><span class="n">found_typeclass</span><span class="si">}</span><span class="s2">&#39; could not be imported.&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_class</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Typeclass &#39;</span><span class="si">{</span><span class="n">found_typeclass</span><span class="si">}</span><span class="s2">&#39; is not creatable.&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">type_class</span><span class="p">,</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="CmdSetObjAlias">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetObjAlias">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdSetObjAlias</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    adding permanent aliases for object</span>

<span class="sd">    Usage:</span>
<span class="sd">      alias &lt;obj&gt; [= [alias[,alias,alias,...]]]</span>
<span class="sd">      alias &lt;obj&gt; =</span>
<span class="sd">      alias/category &lt;obj&gt; = [alias[,alias,...]:&lt;category&gt;</span>
<span class="sd">      alias/delete &lt;obj&gt; = &lt;alias&gt;</span>

<span class="sd">    Switches:</span>
<span class="sd">      category - requires ending input with :category, to store the</span>
<span class="sd">        given aliases with the given category.</span>
<span class="sd">      delete - deletes all occurrences of the given alias, regardless</span>
<span class="sd">        of category</span>

<span class="sd">    Assigns aliases to an object so it can be referenced by more</span>
<span class="sd">    than one name. Assign empty to remove all aliases from object. If</span>
<span class="sd">    assigning a category, all aliases given will be using this category.</span>

<span class="sd">    Observe that this is not the same thing as personal aliases</span>
<span class="sd">    created with the &#39;nick&#39; command! Aliases set with alias are</span>
<span class="sd">    changing the object in question, making those aliases usable</span>
<span class="sd">    by everyone.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@alias&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="s2">&quot;setobjalias&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(setobjalias) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;cmd_create&quot;</span>

<div class="viewcode-block" id="CmdSetObjAlias.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetObjAlias.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the aliases.&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Usage: alias &lt;obj&gt; [= [alias[,alias ...]]]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>

        <span class="c1"># Find the object to receive/delete aliases</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># no =, and not deleting, so we just list aliases on object.</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Aliases for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">),</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;[category:&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">category</span><span class="p">)</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span> <span class="ow">in</span> <span class="n">aliases</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No aliases exist for &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have permission to do that.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># we have given an empty =, so delete aliases.</span>
            <span class="c1"># as a side-effect, &#39;alias/delete obj&#39; and &#39;alias/delete obj=&#39;</span>
            <span class="c1"># will also be caught here, which is fine</span>
            <span class="n">old_aliases</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">old_aliases</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Cleared aliases from </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">old_aliases</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No aliases to clear.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># delete all matching keys, regardless of category</span>
            <span class="n">existed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                    <span class="n">existed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">existed</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Alias &#39;</span><span class="si">%s</span><span class="s2">&#39; deleted from </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no alias &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
                <span class="n">rhs</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;If specifying the /category switch, the category must be given &quot;</span>
                    <span class="s2">&quot;as :category at the end.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>

        <span class="c1"># merge the old and new aliases (if any)</span>
        <span class="n">old_aliases</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">new_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">rhs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">alias</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="c1"># make the aliases only appear once</span>
        <span class="n">old_aliases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_aliases</span><span class="p">)</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">old_aliases</span><span class="p">))</span>

        <span class="c1"># save back to object.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

        <span class="c1"># we need to trigger this here, since this will force</span>
        <span class="c1"># (default) Exits to rebuild their Exit commands with the new</span>
        <span class="c1"># aliases</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">at_cmdset_get</span><span class="p">(</span><span class="n">force_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># report all aliases on the object</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s2">&quot;Alias(es) for &#39;</span><span class="si">%s</span><span class="s2">&#39; set to &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="p">),</span>
                <span class="s2">&quot; (category: &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdCopy">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCopy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdCopy</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    copy an object and its properties</span>

<span class="sd">    Usage:</span>
<span class="sd">      copy &lt;original obj&gt; [= &lt;new_name&gt;][;alias;alias..]</span>
<span class="sd">      [:&lt;new_location&gt;] [,&lt;new_name2&gt; ...]</span>

<span class="sd">    Create one or more copies of an object. If you don&#39;t supply any targets,</span>
<span class="sd">    one exact copy of the original object will be created with the name *_copy.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@copy&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(copy) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdCopy.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCopy.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uses ObjManipCommand.parse()&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;Usage: copy &lt;obj&gt; [=&lt;new_name&gt;[;alias;alias..]]&quot;</span>
                <span class="s2">&quot;[:&lt;new_location&gt;] [, &lt;new_name2&gt;...]&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># this has no target =, so an identical new object is created.</span>
            <span class="n">from_obj_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
            <span class="n">from_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">from_obj_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">to_obj_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_copy&quot;</span> <span class="o">%</span> <span class="n">from_obj_name</span>
            <span class="n">to_obj_aliases</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">_copy&quot;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">from_obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">copiedobj</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span>
                <span class="n">from_obj</span><span class="p">,</span> <span class="n">new_key</span><span class="o">=</span><span class="n">to_obj_name</span><span class="p">,</span> <span class="n">new_aliases</span><span class="o">=</span><span class="n">to_obj_aliases</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">copiedobj</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Identical copy of </span><span class="si">%s</span><span class="s2">, named &#39;</span><span class="si">%s</span><span class="s2">&#39; was created.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">from_obj_name</span><span class="p">,</span>
                    <span class="n">to_obj_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;There was an error copying </span><span class="si">%s</span><span class="s2">.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we have specified =. This might mean many object targets</span>
            <span class="n">from_obj_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">from_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">from_obj_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">objdef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">:</span>
                <span class="c1"># loop through all possible copy-to targets</span>
                <span class="n">to_obj_name</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">to_obj_aliases</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span>
                <span class="n">to_obj_location</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;option&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">to_obj_location</span><span class="p">:</span>
                    <span class="n">to_obj_location</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">to_obj_location</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">to_obj_location</span><span class="p">:</span>
                        <span class="k">return</span>

                <span class="n">copiedobj</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span>
                    <span class="n">from_obj</span><span class="p">,</span>
                    <span class="n">new_key</span><span class="o">=</span><span class="n">to_obj_name</span><span class="p">,</span>
                    <span class="n">new_location</span><span class="o">=</span><span class="n">to_obj_location</span><span class="p">,</span>
                    <span class="n">new_aliases</span><span class="o">=</span><span class="n">to_obj_aliases</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">copiedobj</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="n">from_obj_name</span><span class="si">}</span><span class="s2"> to &#39;</span><span class="si">{</span><span class="n">to_obj_name</span><span class="si">}</span><span class="s2">&#39; (aliases: </span><span class="si">{</span><span class="n">to_obj_aliases</span><span class="si">}</span><span class="s2">).&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;There was an error copying </span><span class="si">{</span><span class="n">from_obj_name</span><span class="si">}</span><span class="s2"> to &#39;</span><span class="si">{</span><span class="n">to_obj_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="c1"># we are done, echo to user</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdCpAttr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdCpAttr</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    copy attributes between objects</span>

<span class="sd">    Usage:</span>
<span class="sd">      cpattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="sd">      cpattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt; [,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>
<span class="sd">      cpattr[/switch] &lt;attr&gt;[:category] = &lt;obj1&gt;/&lt;attr1&gt;[:category] [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="sd">      cpattr[/switch] &lt;attr&gt; = &lt;obj1&gt;[,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>

<span class="sd">    Switches:</span>
<span class="sd">      move - delete the attribute from the source object after copying.</span>

<span class="sd">    Example:</span>
<span class="sd">      cpattr coolness = Anna/chillout, Anna/nicety, Tom/nicety</span>
<span class="sd">      -&gt;</span>
<span class="sd">      copies the coolness attribute (defined on yourself), to attributes</span>
<span class="sd">      on Anna and Tom.</span>

<span class="sd">      cpattr box/width:dimension = tube/width:dimension</span>
<span class="sd">      -&gt;</span>
<span class="sd">      copies the box&#39;s width attribute in the dimension category, to be the</span>
<span class="sd">      tube&#39;s width attribute in the dimension category</span>

<span class="sd">    Copy the attribute one object to one or more attributes on another object.</span>
<span class="sd">    If you don&#39;t supply a source object, yourself is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@cpattr&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;move&quot;</span><span class="p">,)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(cpattr) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdCpAttr.check_from_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr.check_from_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_from_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook for overriding on subclassed commands. Checks to make sure a</span>
<span class="sd">        caller can copy the attr from the object in question. If not, return a</span>
<span class="sd">        false value and the command will abort. An error message should be</span>
<span class="sd">        provided by this function.</span>

<span class="sd">        If clear is True, user is attempting to move the attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CmdCpAttr.check_to_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr.check_to_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_to_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook for overriding on subclassed commands. Checks to make sure a</span>
<span class="sd">        caller can write to the specified attribute on the specified object.</span>
<span class="sd">        If not, return a false value and the attribute will be skipped. An</span>
<span class="sd">        error message should be provided by this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CmdCpAttr.check_has_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr.check_has_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_has_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook for overriding on subclassed commands. Do any preprocessing</span>
<span class="sd">        required and verify an object has an attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have an attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">}{</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1">]&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CmdCpAttr.get_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr.get_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hook for overriding on subclassed commands. Do any preprocessing</span>
<span class="sd">        required and get the attribute from the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdCpAttr.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCpAttr.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the copying.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Usage:</span>
<span class="s2">            cpattr[/switch] &lt;obj&gt;/&lt;attr&gt;[:category] = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="s2">            cpattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt; [,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>
<span class="s2">            cpattr[/switch] &lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="s2">            cpattr[/switch] &lt;attr&gt; = &lt;obj1&gt;[,&lt;obj2&gt;,&lt;obj3&gt;,...]&quot;&quot;&quot;</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">lhs_objattr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span>
        <span class="n">to_objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objattr</span>
        <span class="n">from_obj_name</span> <span class="o">=</span> <span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">from_obj_attrs</span> <span class="o">=</span> <span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>
        <span class="n">from_obj_category</span> <span class="o">=</span> <span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>  <span class="c1"># None if unset</span>
        <span class="n">from_obj_category_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">from_obj_category</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">from_obj_category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_obj_attrs</span><span class="p">:</span>
            <span class="c1"># this means the from_obj_name is actually an attribute</span>
            <span class="c1"># name on self.</span>
            <span class="n">from_obj_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">from_obj_name</span><span class="p">]</span>
            <span class="n">from_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">from_obj_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_obj</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">to_objs</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You have to supply both source object and target(s).&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># copy to all to_obj:ects</span>
        <span class="k">if</span> <span class="s2">&quot;move&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">clear</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clear</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_from_attr</span><span class="p">(</span>
            <span class="n">from_obj</span><span class="p">,</span> <span class="n">from_obj_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">from_obj_category</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">from_obj_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_has_attr</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">from_obj_category</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">from_obj_attrs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">from_obj_attrs</span><span class="p">)))</span> <span class="ow">and</span> <span class="n">clear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|RCannot have duplicate source names when moving!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">to_obj</span> <span class="ow">in</span> <span class="n">to_objs</span><span class="p">:</span>
            <span class="n">to_obj_name</span> <span class="o">=</span> <span class="n">to_obj</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">to_obj_attrs</span> <span class="o">=</span> <span class="n">to_obj</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>
            <span class="n">to_obj_category</span> <span class="o">=</span> <span class="n">to_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
            <span class="n">to_obj_category_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">to_obj_category</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">to_obj_category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">to_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">to_obj_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">to_obj</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Could not find object &#39;</span><span class="si">{</span><span class="n">to_obj_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">inum</span><span class="p">,</span> <span class="n">from_attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">from_obj_attrs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">to_attr</span> <span class="o">=</span> <span class="n">to_obj_attrs</span><span class="p">[</span><span class="n">inum</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="c1"># if there are too few attributes given</span>
                    <span class="c1"># on the to_obj, we copy the original name instead.</span>
                    <span class="n">to_attr</span> <span class="o">=</span> <span class="n">from_attr</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_to_attr</span><span class="p">(</span><span class="n">to_obj</span><span class="p">,</span> <span class="n">to_attr</span><span class="p">,</span> <span class="n">to_obj_category</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">from_attr</span><span class="p">,</span> <span class="n">from_obj_category</span><span class="p">)</span>
                <span class="n">to_obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">to_attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">to_obj_category</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clear</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">from_obj</span> <span class="o">==</span> <span class="n">to_obj</span> <span class="ow">and</span> <span class="n">from_attr</span> <span class="o">==</span> <span class="n">to_attr</span><span class="p">):</span>
                    <span class="n">from_obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">from_attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">from_obj_category</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Moved </span><span class="si">{</span><span class="n">from_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">from_attr</span><span class="si">}{</span><span class="n">from_obj_category_str</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">to_obj_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">to_attr</span><span class="si">}{</span><span class="n">to_obj_category_str</span><span class="si">}</span><span class="s2">. (value:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Copied </span><span class="si">{</span><span class="n">from_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">from_attr</span><span class="si">}{</span><span class="n">from_obj_category_str</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">to_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">to_attr</span><span class="si">}{</span><span class="n">to_obj_category_str</span><span class="si">}</span><span class="s2">. (value:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="CmdMvAttr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdMvAttr">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdMvAttr</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    move attributes between objects</span>

<span class="sd">    Usage:</span>
<span class="sd">      mvattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="sd">      mvattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt; [,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>
<span class="sd">      mvattr[/switch] &lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="sd">      mvattr[/switch] &lt;attr&gt; = &lt;obj1&gt;[,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>

<span class="sd">    Switches:</span>
<span class="sd">      copy - Don&#39;t delete the original after moving.</span>

<span class="sd">    Move an attribute from one object to one or more attributes on another</span>
<span class="sd">    object. If you don&#39;t supply a source object, yourself is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@mvattr&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;copy&quot;</span><span class="p">,)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(mvattr) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdMvAttr.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdMvAttr.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do the moving</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Usage:</span>
<span class="s2">      mvattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="s2">      mvattr[/switch] &lt;obj&gt;/&lt;attr&gt; = &lt;obj1&gt; [,&lt;obj2&gt;,&lt;obj3&gt;,...]</span>
<span class="s2">      mvattr[/switch] &lt;attr&gt; = &lt;obj1&gt;/&lt;attr1&gt; [,&lt;obj2&gt;/&lt;attr2&gt;,&lt;obj3&gt;/&lt;attr3&gt;,...]</span>
<span class="s2">      mvattr[/switch] &lt;attr&gt; = &lt;obj1&gt;[,&lt;obj2&gt;,&lt;obj3&gt;,...]&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># simply use cpattr for all the functionality</span>
        <span class="k">if</span> <span class="s2">&quot;copy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">(</span><span class="s2">&quot;cpattr </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">(</span><span class="s2">&quot;cpattr/move </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdCreate">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCreate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdCreate</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create new objects</span>

<span class="sd">    Usage:</span>
<span class="sd">      create[/drop] &lt;objname&gt;[;alias;alias...][:typeclass], &lt;objname&gt;...</span>

<span class="sd">    switch:</span>
<span class="sd">       drop - automatically drop the new object into your current</span>
<span class="sd">              location (this is not echoed). This also sets the new</span>
<span class="sd">              object&#39;s home to the current location rather than to you.</span>

<span class="sd">    Creates one or more new objects. If typeclass is given, the object</span>
<span class="sd">    is created as a child of this typeclass. The typeclass script is</span>
<span class="sd">    assumed to be located under types/ and any further</span>
<span class="sd">    directory structure is given in Python notation. So if you have a</span>
<span class="sd">    correct typeclass &#39;RedButton&#39; defined in</span>
<span class="sd">    types/examples/red_button.py, you could create a new</span>
<span class="sd">    object of this type like this:</span>

<span class="sd">       create/drop button;red : examples.red_button.RedButton</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@create&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(create) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdCreate.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdCreate.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Usage: create[/drop] &lt;newname&gt;[;alias;alias...] [:typeclass.path]&quot;</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># create the objects</span>
        <span class="k">for</span> <span class="n">objdef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span>

            <span class="n">obj_typeclass</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_typeclass</span><span class="p">(</span>
                <span class="n">obj_type</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;option&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_typeclass</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">obj</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">obj_typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">account</span><span class="o">=</span><span class="n">caller</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                <span class="n">location</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="n">home</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="n">aliases</span><span class="o">=</span><span class="n">aliases</span><span class="p">,</span>
                <span class="n">report_to</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;You create a new </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (aliases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You create a new </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>

            <span class="k">if</span> <span class="s2">&quot;drop&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">move_type</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_desc_load</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">caller</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">evmenu_target</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_desc_save</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save line buffer to the desc prop. This should</span>
<span class="sd">    return True if successful and also report its status to the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">evmenu_target</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">buf</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Saved.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_desc_quit</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;evmenu_target&quot;</span><span class="p">)</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Exited editor.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="CmdDesc">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDesc">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdDesc</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    describe an object or the current room.</span>

<span class="sd">    Usage:</span>
<span class="sd">      desc [&lt;obj&gt; =] &lt;description&gt;</span>

<span class="sd">    Switches:</span>
<span class="sd">      edit - Open up a line editor for more advanced editing.</span>

<span class="sd">    Sets the &quot;desc&quot; attribute on an object. If an object is not given,</span>
<span class="sd">    describe the current room.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@desc&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">,)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(desc) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdDesc.edit_handler">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDesc.edit_handler">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rYou may specify a value, or use the edit switch, but not both.|n&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">location</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rYou can&#39;t describe oblivion.|n&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to edit the description of </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">evmenu_target</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="c1"># launch the editor</span>
        <span class="n">EvEditor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span>
            <span class="n">loadfunc</span><span class="o">=</span><span class="n">_desc_load</span><span class="p">,</span>
            <span class="n">savefunc</span><span class="o">=</span><span class="n">_desc_save</span><span class="p">,</span>
            <span class="n">quitfunc</span><span class="o">=</span><span class="n">_desc_quit</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span>
            <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="CmdDesc.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDesc.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define command&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="s2">&quot;edit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: desc [&lt;obj&gt; =] &lt;description&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;edit&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_handler</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># We have an =</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rYou don&#39;t have a location to describe.|n&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The description was set on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to edit the description of </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdDestroy">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDestroy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdDestroy</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    permanently delete objects</span>

<span class="sd">    Usage:</span>
<span class="sd">       destroy[/switches] [obj, obj2, obj3, [dbref-dbref], ...]</span>

<span class="sd">    Switches:</span>
<span class="sd">       override - The destroy command will usually avoid accidentally</span>
<span class="sd">                  destroying account objects. This switch overrides this safety.</span>
<span class="sd">       force - destroy without confirmation.</span>
<span class="sd">    Examples:</span>
<span class="sd">       destroy house, roof, door, 44-78</span>
<span class="sd">       destroy 5-10, flower, 45</span>
<span class="sd">       destroy/force north</span>

<span class="sd">    Destroys one or many objects. If dbrefs are used, a range to delete can be</span>
<span class="sd">    given, e.g. 4-10. Also the end points will be deleted. This command</span>
<span class="sd">    displays a confirmation before destroying, to make sure of your choice.</span>
<span class="sd">    You can specify the /force switch to bypass this confirmation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@destroy&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@delete&quot;</span><span class="p">,</span> <span class="s2">&quot;@del&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;override&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(destroy) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="n">confirm</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set to False to always bypass confirmation</span>
    <span class="n">default_confirm</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>  <span class="c1"># what to assume if just pressing enter (yes/no)</span>

<div class="viewcode-block" id="CmdDestroy.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDestroy.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the command.&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhslist</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: destroy[/switches] [obj, obj2, obj3, [dbref-dbref],...]&quot;</span><span class="p">)</span>
            <span class="n">delete</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">delobj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># helper function for deleting a single object</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Object </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">db_key</span><span class="si">}</span><span class="s2"> was already deleted.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objname</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You don&#39;t have permission to delete </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span> <span class="ow">and</span> <span class="s2">&quot;override&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Object </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2"> is controlled by an active account. Use /override to&quot;</span>
                        <span class="s2">&quot; delete anyway.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">dbid</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_HOME</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You are trying to delete |c</span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2">|n, which is set as DEFAULT_HOME. &quot;</span>
                        <span class="s2">&quot;Re-point settings.DEFAULT_HOME to another &quot;</span>
                        <span class="s2">&quot;object before continuing.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># check if object to delete had exits or objects inside it</span>
                <span class="n">obj_exits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">exits</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;exits&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">()</span>
                <span class="n">obj_contents</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">contents</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">()</span>
                <span class="n">had_exits</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">obj_exits</span><span class="p">)</span>
                <span class="n">had_objs</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">entity</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">obj_contents</span> <span class="k">if</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj_exits</span><span class="p">)</span>

                <span class="c1"># do the deletion</span>
                <span class="n">okay</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2"> not deleted, probably because delete() returned False.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2"> was destroyed.&quot;</span>
                    <span class="k">if</span> <span class="n">had_exits</span><span class="p">:</span>
                        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Exits to and from </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2"> were destroyed as well.&quot;</span>
                    <span class="k">if</span> <span class="n">had_objs</span><span class="p">:</span>
                        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Objects inside </span><span class="si">{</span><span class="n">objname</span><span class="si">}</span><span class="s2"> were moved to their homes.&quot;</span>
            <span class="k">return</span> <span class="n">string</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">objname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhslist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delete</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">objname</span><span class="p">:</span>
                <span class="c1"># might be a range of dbrefs</span>
                <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">dbref</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">reqhash</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">objname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">dmin</span> <span class="ow">and</span> <span class="n">dmax</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dbref</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dmin</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbref</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot; (Objects to destroy must either be local or specified with a unique #dbref.)&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">objs</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;force&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">confirm</span><span class="p">):</span>
            <span class="n">confirm</span> <span class="o">=</span> <span class="s2">&quot;Are you sure you want to destroy &quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">confirm</span> <span class="o">+=</span> <span class="n">objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">confirm</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confirm</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;#</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">])</span>
            <span class="n">confirm</span> <span class="o">+=</span> <span class="s2">&quot; [yes]/no?&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_confirm</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="k">else</span> <span class="s2">&quot; yes/[no]&quot;</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">confirm</span><span class="p">)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_confirm</span> <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">answer</span>

            <span class="k">if</span> <span class="n">answer</span> <span class="ow">and</span> <span class="n">answer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Canceled: Either accept the default by pressing return or specify yes/no.&quot;</span>
                <span class="p">)</span>
                <span class="n">delete</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Canceled: No object was destroyed.&quot;</span><span class="p">)</span>
                <span class="n">delete</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delobj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="CmdDig">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdDig</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    build new rooms and connect them to the current location</span>

<span class="sd">    Usage:</span>
<span class="sd">      dig[/switches] &lt;roomname&gt;[;alias;alias...][:typeclass]</span>
<span class="sd">            [= &lt;exit_to_there&gt;[;alias][:typeclass]]</span>
<span class="sd">               [, &lt;exit_to_here&gt;[;alias][:typeclass]]</span>

<span class="sd">    Switches:</span>
<span class="sd">       tel or teleport - move yourself to the new room</span>

<span class="sd">    Examples:</span>
<span class="sd">       dig kitchen = north;n, south;s</span>
<span class="sd">       dig house:myrooms.MyHouseTypeclass</span>
<span class="sd">       dig sheer cliff;cliff;sheer = climb up, climb down</span>

<span class="sd">    This command is a convenient way to build rooms quickly; it creates the</span>
<span class="sd">    new room and you can optionally set up exits back and forth between your</span>
<span class="sd">    current room and the new one. You can add as many aliases as you</span>
<span class="sd">    like to the name of the room and the exits in question; an example</span>
<span class="sd">    would be &#39;north;no;n&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@dig&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;teleport&quot;</span><span class="p">,)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(dig) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;cmd_dig&quot;</span>

    <span class="c1"># lockstring of newly created rooms, for easy overloading.</span>
    <span class="c1"># Will be formatted with the {id} of the creating object.</span>
    <span class="n">new_room_lockstring</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;control:id(</span><span class="si">{id}</span><span class="s2">) or perm(Admin); &quot;</span>
        <span class="s2">&quot;delete:id(</span><span class="si">{id}</span><span class="s2">) or perm(Admin); &quot;</span>
        <span class="s2">&quot;edit:id(</span><span class="si">{id}</span><span class="s2">) or perm(Admin)&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="CmdDig.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdDig.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the digging. Inherits variables from ObjManipCommand.parse()&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Usage: dig[/teleport] &lt;roomname&gt;[;alias;alias...][:parent] [= &lt;exit_there&gt;&quot;</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;[;alias;alias..][:parent]] &quot;</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;[, &lt;exit_back_here&gt;[;alias;alias..][:parent]]&quot;</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">room</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">room</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You must supply a new room name.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span>

        <span class="c1"># Create the new room</span>
        <span class="n">room_typeclass</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_typeclass</span><span class="p">(</span>
            <span class="n">obj_type</span><span class="o">=</span><span class="s2">&quot;room&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">room</span><span class="p">[</span><span class="s2">&quot;option&quot;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating room:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">room_typeclass</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># create room</span>
        <span class="n">new_room</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">room_typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">room</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">aliases</span><span class="o">=</span><span class="n">room</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">],</span>
            <span class="n">report_to</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
            <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating room:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_room</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_room</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_room</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="n">room_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created room </span><span class="si">{</span><span class="n">new_room</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">new_room</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">alias_string</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">new_room</span><span class="o">.</span><span class="n">typeclass_path</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="c1"># create exit to room</span>

        <span class="n">exit_to_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">exit_back_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">:</span>
            <span class="n">to_exit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">to_exit</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">exit_to_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No exit created to new room.&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">location</span><span class="p">:</span>
                <span class="n">exit_to_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You cannot create an exit from a None-location.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Build the exit to the new room from the current one</span>
                <span class="n">exit_typeclass</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_typeclass</span><span class="p">(</span>
                    <span class="n">obj_type</span><span class="o">=</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">to_exit</span><span class="p">[</span><span class="s2">&quot;option&quot;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_typeclass</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">new_to_exit</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">exit_typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">to_exit</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">destination</span><span class="o">=</span><span class="n">new_room</span><span class="p">,</span>
                    <span class="n">aliases</span><span class="o">=</span><span class="n">to_exit</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">],</span>
                    <span class="n">report_to</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                    <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_to_exit</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">new_to_exit</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_to_exit</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">exit_to_string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Created Exit from </span><span class="si">{</span><span class="n">location</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_room</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">new_to_exit</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">new_to_exit</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">alias_string</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Create exit back from new room</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Building the exit back to the current room</span>
            <span class="n">back_exit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">back_exit</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                <span class="n">exit_back_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No back exit created.&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">location</span><span class="p">:</span>
                <span class="n">exit_back_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You cannot create an exit back to a None-location.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_typeclass</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_typeclass</span><span class="p">(</span>
                    <span class="n">obj_type</span><span class="o">=</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">back_exit</span><span class="p">[</span><span class="s2">&quot;option&quot;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_typeclass</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">new_back_exit</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">exit_typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">back_exit</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">new_room</span><span class="p">,</span>
                    <span class="n">destination</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">aliases</span><span class="o">=</span><span class="n">back_exit</span><span class="p">[</span><span class="s2">&quot;aliases&quot;</span><span class="p">],</span>
                    <span class="n">report_to</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                    <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_back_exit</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">new_back_exit</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">alias_string</span> <span class="o">=</span> <span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_back_exit</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">exit_back_string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Created Exit back from </span><span class="si">{</span><span class="n">new_room</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">location</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">new_back_exit</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">new_back_exit</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">alias_string</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">room_string</span><span class="si">}{</span><span class="n">exit_to_string</span><span class="si">}{</span><span class="n">exit_back_string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_room</span> <span class="ow">and</span> <span class="s2">&quot;teleport&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">new_room</span><span class="p">,</span> <span class="n">move_type</span><span class="o">=</span><span class="s2">&quot;teleport&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdTunnel">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTunnel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdTunnel</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create new rooms in cardinal directions only</span>

<span class="sd">    Usage:</span>
<span class="sd">      tunnel[/switch] &lt;direction&gt;[:typeclass] [= &lt;roomname&gt;[;alias;alias;...][:typeclass]]</span>

<span class="sd">    Switches:</span>
<span class="sd">      oneway - do not create an exit back to the current location</span>
<span class="sd">      tel - teleport to the newly created room</span>

<span class="sd">    Example:</span>
<span class="sd">      tunnel n</span>
<span class="sd">      tunnel n = house;mike&#39;s place;green building</span>

<span class="sd">    This is a simple way to build using pre-defined directions:</span>
<span class="sd">     |wn,ne,e,se,s,sw,w,nw|n (north, northeast etc)</span>
<span class="sd">     |wu,d|n (up and down)</span>
<span class="sd">     |wi,o|n (in and out)</span>
<span class="sd">    The full names (north, in, southwest, etc) will always be put as</span>
<span class="sd">    main name for the exit, using the abbreviation as an alias (so an</span>
<span class="sd">    exit will always be able to be used with both &quot;north&quot; as well as</span>
<span class="sd">    &quot;n&quot; for example). Opposite directions will automatically be</span>
<span class="sd">    created back from the new room unless the /oneway switch is given.</span>
<span class="sd">    For more flexibility and power in creating rooms, use dig.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@tunnel&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@tun&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;oneway&quot;</span><span class="p">,</span> <span class="s2">&quot;tel&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd: perm(tunnel) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;cmd_tunnel&quot;</span>

    <span class="c1"># store the direction, full name and its opposite</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;north&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;northeast&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">),</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;east&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
        <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;southeast&quot;</span><span class="p">,</span> <span class="s2">&quot;nw&quot;</span><span class="p">),</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;south&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
        <span class="s2">&quot;sw&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;southwest&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">),</span>
        <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;west&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span>
        <span class="s2">&quot;nw&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;northwest&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">),</span>
        <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">),</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">),</span>
        <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span>
        <span class="s2">&quot;o&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="CmdTunnel.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTunnel.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the tunnel command&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Usage: tunnel[/switch] &lt;direction&gt;[:typeclass] [= &lt;roomname&gt;&quot;</span>
                <span class="s2">&quot;[;alias;alias;...][:typeclass]]&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># If we get a typeclass, we need to get just the exitname</span>
        <span class="n">exitshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">exitshort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;tunnel can only understand the following directions: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(use dig for more freedom)&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># retrieve all input and parse it</span>
        <span class="n">exitname</span><span class="p">,</span> <span class="n">backshort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">exitshort</span><span class="p">]</span>
        <span class="n">backname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">backshort</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if we received a typeclass for the exit, add it to the alias(short name)</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="c1"># limit to only the first : character</span>
            <span class="n">exit_typeclass</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># exitshort and backshort are the last part of the exit strings,</span>
            <span class="c1"># so we add our typeclass argument after</span>
            <span class="n">exitshort</span> <span class="o">+=</span> <span class="n">exit_typeclass</span>
            <span class="n">backshort</span> <span class="o">+=</span> <span class="n">exit_typeclass</span>

        <span class="n">roomname</span> <span class="o">=</span> <span class="s2">&quot;Some place&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="n">roomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>  <span class="c1"># this may include aliases; that&#39;s fine.</span>

        <span class="n">telswitch</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;tel&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">telswitch</span> <span class="o">=</span> <span class="s2">&quot;/teleport&quot;</span>
        <span class="n">backstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;oneway&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">backstring</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">backname</span><span class="si">}</span><span class="s2">;</span><span class="si">{</span><span class="n">backshort</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># build the string we will use to call dig</span>
        <span class="n">digstring</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@dig</span><span class="si">{</span><span class="n">telswitch</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">roomname</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">exitname</span><span class="si">}</span><span class="s2">;</span><span class="si">{</span><span class="n">exitshort</span><span class="si">}{</span><span class="n">backstring</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">(</span><span class="n">digstring</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdLink">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdLink">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdLink</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    link existing rooms together with exits</span>

<span class="sd">    Usage:</span>
<span class="sd">      link[/switches] &lt;object&gt; = &lt;target&gt;</span>
<span class="sd">      link[/switches] &lt;object&gt; =</span>
<span class="sd">      link[/switches] &lt;object&gt;</span>

<span class="sd">    Switch:</span>
<span class="sd">      twoway - connect two exits. For this to work, BOTH &lt;object&gt;</span>
<span class="sd">               and &lt;target&gt; must be exit objects.</span>

<span class="sd">    If &lt;object&gt; is an exit, set its destination to &lt;target&gt;. Two-way operation</span>
<span class="sd">    instead sets the destination to the *locations* of the respective given</span>
<span class="sd">    arguments.</span>
<span class="sd">    The second form (a lone =) sets the destination to None (same as</span>
<span class="sd">    the unlink command) and the third form (without =) just shows the</span>
<span class="sd">    currently set destination.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@link&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(link) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdLink.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdLink.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the link&quot;&quot;&quot;</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: link[/twoway] &lt;object&gt; = &lt;target&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">object_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>

        <span class="c1"># try to search locally first</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># local results was a multimatch. Inform them to be more specific</span>
            <span class="n">_AT_SEARCH_RESULT</span> <span class="o">=</span> <span class="n">variable_from_module</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">SEARCH_AT_RESULT</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_AT_SEARCH_RESULT</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">object_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># A unique local match</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># No matches. Search globally</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># this means a target name was given</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Cannot link an object to itself.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">note</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Note: </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) did not have a destination set before. Make sure you linked the right&quot;</span>
                <span class="s2">&quot; thing.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">note</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;twoway&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">location</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;To create a two-way link, </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> must both have a location&quot;</span>
                    <span class="p">)</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot; (i.e. they cannot be rooms, but should be exits).&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="n">note</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">dbref</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">location</span>
                <span class="n">target</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Link created </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (in </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">) &lt;-&gt; </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (in&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">) (two-way).&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">target</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Link created </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> (one way).&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this means that no = was given (otherwise rhs</span>
            <span class="c1"># would have been an empty string). So we inspect</span>
            <span class="c1"># the home/destination on object</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span>
            <span class="k">if</span> <span class="n">dest</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is an exit to </span><span class="si">{</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not an exit. Its home location is </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">home</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We gave the command link &#39;obj = &#39; which means we want to</span>
            <span class="c1"># clear destination.</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Former exit </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> no longer links anywhere.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> had no destination to unlink.&quot;</span>
        <span class="c1"># give feedback</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="CmdUnLink">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdUnLink">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdUnLink</span><span class="p">(</span><span class="n">CmdLink</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove exit-connections between rooms</span>

<span class="sd">    Usage:</span>
<span class="sd">      unlink &lt;Object&gt;</span>

<span class="sd">    Unlinks an object, for example an exit, disconnecting</span>
<span class="sd">    it from whatever it was connected to.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># this is just a child of CmdLink</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;unlink&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(unlink) or perm(Builder)&quot;</span>
    <span class="n">help_key</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdUnLink.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdUnLink.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All we need to do here is to set the right command</span>
<span class="sd">        and call func in CmdLink</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: unlink &lt;object&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># This mimics &#39;link &lt;obj&gt; = &#39; which is the same as unlink</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># call the link functionality</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">func</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="CmdSetHome">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetHome">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdSetHome</span><span class="p">(</span><span class="n">CmdLink</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set an object&#39;s home location</span>

<span class="sd">    Usage:</span>
<span class="sd">      sethome &lt;obj&gt; [= &lt;home_location&gt;]</span>
<span class="sd">      sethome &lt;obj&gt;</span>

<span class="sd">    The &quot;home&quot; location is a &quot;safety&quot; location for objects; they</span>
<span class="sd">    will be moved there if their current location ceases to exist. All</span>
<span class="sd">    objects should always have a home location for this reason.</span>
<span class="sd">    It is also a convenient target of the &quot;home&quot; command.</span>

<span class="sd">    If no location is given, just view the object&#39;s home location.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@sethome&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(sethome) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdSetHome.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetHome.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;implement the command&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Usage: sethome &lt;obj&gt; [= &lt;home_location&gt;]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># just view</span>
            <span class="n">home</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">home</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">home</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;This object has no home location set!&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&#39;s current home is </span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">home</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set a home location</span>
            <span class="n">new_home</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_home</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">old_home</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">home</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="n">new_home</span>
            <span class="k">if</span> <span class="n">old_home</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Home location of </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> was changed from </span><span class="si">{</span><span class="n">old_home</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">old_home</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">) to&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">new_home</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">new_home</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Home location of </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> was set to </span><span class="si">{</span><span class="n">new_home</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">new_home</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdListCmdSets">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdListCmdSets">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdListCmdSets</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    list command sets defined on an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      cmdsets &lt;obj&gt;</span>

<span class="sd">    This displays all cmdsets assigned</span>
<span class="sd">    to a user. Defaults to yourself.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@cmdsets&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(listcmdsets) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdListCmdSets.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdListCmdSets.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;list the cmdsets&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arglist</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span>
        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">cmdset</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdName">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdName">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdName</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    change the name and/or aliases of an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      name &lt;obj&gt; = &lt;newname&gt;;alias1;alias2</span>

<span class="sd">    Rename an object to something new. Use *obj to</span>
<span class="sd">    rename an account.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@name&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@rename&quot;</span><span class="p">]</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(rename) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdName.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdName.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;change the name&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: name &lt;obj&gt; = &lt;newname&gt;[;alias;alias;...]&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">:</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">objname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">caller</span><span class="o">.</span><span class="n">account</span><span class="p">:</span>
                <span class="c1"># account mode</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]:</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Accounts can&#39;t have aliases.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">newname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">newname</span><span class="p">:</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No name defined!&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have right to edit this account </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">newname</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account&#39;s name changed to &#39;</span><span class="si">{</span><span class="n">newname</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="c1"># object search, also with *</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">:</span>
            <span class="n">newname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No names or aliases defined!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have the right to edit </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># change the name and set aliases:</span>
        <span class="k">if</span> <span class="n">newname</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">newname</span>
        <span class="n">astring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">]</span>
            <span class="n">astring</span> <span class="o">=</span> <span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
        <span class="c1"># fix for exits - we need their exit-command to change name too</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">flush_from_cache</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object&#39;s name changed to &#39;</span><span class="si">{</span><span class="n">newname</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">astring</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdOpen">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdOpen">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdOpen</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    open a new exit from the current room</span>

<span class="sd">    Usage:</span>
<span class="sd">      open &lt;new exit&gt;[;alias;alias..][:typeclass] [,&lt;return exit&gt;[;alias;..][:typeclass]]] = &lt;destination&gt;</span>

<span class="sd">    Handles the creation of exits. If a destination is given, the exit</span>
<span class="sd">    will point there. The &lt;return exit&gt; argument sets up an exit at the</span>
<span class="sd">    destination leading back to the current room. Destination name</span>
<span class="sd">    can be given both as a #dbref and a name, if that name is globally</span>
<span class="sd">    unique.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@open&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(open) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="n">method_type</span> <span class="o">=</span> <span class="s2">&quot;cmd_open&quot;</span>

    <span class="n">new_obj_lockstring</span> <span class="o">=</span> <span class="s2">&quot;control:id(</span><span class="si">{id}</span><span class="s2">) or perm(Admin);delete:id(</span><span class="si">{id}</span><span class="s2">) or perm(Admin)&quot;</span>

    <span class="c1"># a custom member method to chug out exits and do checks</span>
<div class="viewcode-block" id="CmdOpen.create_exit">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdOpen.create_exit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_name</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">exit_aliases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to avoid code duplication.</span>
<span class="sd">        At this point we know destination is a valid location</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># check if this exit object already exists at the location.</span>
        <span class="c1"># we need to ignore errors (so no automatic feedback)since we</span>
        <span class="c1"># have to know the result of the search to decide what to do.</span>
        <span class="n">exit_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exit_name</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exit_obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># give error message and return</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exit_name</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">exit_obj</span><span class="p">:</span>
            <span class="n">exit_obj</span> <span class="o">=</span> <span class="n">exit_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_obj</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
                <span class="c1"># we are trying to link a non-exit</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">exit_name</span><span class="si">}</span><span class="s2">&#39; already exists and is not an exit!</span><span class="se">\n</span><span class="s2">If you want to convert it &quot;</span>
                    <span class="s2">&quot;to an exit, you must assign an object to the &#39;destination&#39; property first.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># we are re-linking an old exit.</span>
            <span class="n">old_destination</span> <span class="o">=</span> <span class="n">exit_obj</span><span class="o">.</span><span class="n">destination</span>
            <span class="k">if</span> <span class="n">old_destination</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Exit </span><span class="si">{</span><span class="n">exit_name</span><span class="si">}</span><span class="s2"> already exists.&quot;</span>
                <span class="k">if</span> <span class="n">old_destination</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="c1"># reroute the old exit.</span>
                    <span class="n">exit_obj</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
                    <span class="k">if</span> <span class="n">exit_aliases</span><span class="p">:</span>
                        <span class="p">[</span><span class="n">exit_obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">exit_aliases</span><span class="p">]</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot; Rerouted its old destination &#39;</span><span class="si">{</span><span class="n">old_destination</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; and changed aliases.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot; It already points to the correct place.&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># exit does not exist before. Create a new one.</span>
            <span class="n">exit_typeclass</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_typeclass</span><span class="p">(</span>
                <span class="n">obj_type</span><span class="o">=</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_typeclass</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">exit_obj</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">exit_typeclass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">exit_name</span><span class="p">,</span>
                <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                <span class="n">aliases</span><span class="o">=</span><span class="n">exit_aliases</span><span class="p">,</span>
                <span class="n">report_to</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError creating exit:|n </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">exit_obj</span><span class="p">:</span>
                <span class="c1"># storing a destination is what makes it an exit!</span>
                <span class="n">exit_obj</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_aliases</span>
                    <span class="k">else</span> <span class="s2">&quot; (aliases: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exit_aliases</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Created new Exit &#39;</span><span class="si">{</span><span class="n">exit_name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="n">location</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">string</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: Exit &#39;</span><span class="si">{</span><span class="n">exit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not created.&quot;</span>
        <span class="c1"># emit results</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exit_obj</span></div>


<div class="viewcode-block" id="CmdOpen.parse">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdOpen.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">location</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;Usage: open &lt;new exit&gt;[;alias...][:typeclass]&quot;</span>
                <span class="s2">&quot;[,&lt;return exit&gt;[;alias..][:typeclass]]] &quot;</span>
                <span class="s2">&quot;= &lt;destination&gt;&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InterruptCommand</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You cannot create an exit from a None-location.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InterruptCommand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InterruptCommand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_typeclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;option&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="CmdOpen.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdOpen.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is where the processing starts.</span>
<span class="sd">        Uses the ObjManipCommand.parser() for pre-processing</span>
<span class="sd">        as well as the self.create_exit() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create exit</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_exit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_aliases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_typeclass</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="c1"># an error; the exit was not created, so we quit.</span>
            <span class="k">return</span>
        <span class="c1"># Create back exit, if any</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">back_exit_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">back_exit_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;aliases&quot;</span><span class="p">]</span>
            <span class="n">back_exit_typeclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;option&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_exit</span><span class="p">(</span>
                <span class="n">back_exit_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="n">back_exit_aliases</span><span class="p">,</span>
                <span class="n">back_exit_typeclass</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_convert_from_string</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">strobj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a single object in *string form* to its equivalent python</span>
<span class="sd">    type.</span>

<span class="sd">     Python earlier than 2.6:</span>
<span class="sd">    Handles floats, ints, and limited nested lists and dicts</span>
<span class="sd">    (can&#39;t handle lists in a dict, for example, this is mainly due to</span>
<span class="sd">    the complexity of parsing this rather than any technical difficulty -</span>
<span class="sd">    if there is a need for set-ing such complex structures on the</span>
<span class="sd">    command line we might consider adding it).</span>
<span class="sd">     Python 2.6 and later:</span>
<span class="sd">    Supports all Python structures through literal_eval as long as they</span>
<span class="sd">    are valid Python syntax. If they are not (such as [test, test2], ie</span>
<span class="sd">    without the quotes around the strings), the entire structure will</span>
<span class="sd">    be converted to a string and a warning will be given.</span>

<span class="sd">    We need to convert like this since all data being sent over the</span>
<span class="sd">    telnet connection by the Account is text - but we will want to</span>
<span class="sd">    store it as the &quot;real&quot; python type so we can do convenient</span>
<span class="sd">    comparisons later (e.g.  obj.db.value = 2, if value is stored as a</span>
<span class="sd">    string this will always fail).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use literal_eval to parse python structure exactly.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_LITERAL_EVAL</span><span class="p">(</span><span class="n">strobj</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="c1"># treat as string</span>
        <span class="n">strobj</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">strobj</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;|RNote: name &quot;|r</span><span class="si">{</span><span class="n">strobj</span><span class="si">}</span><span class="s1">|R&quot; was converted to a string. Make sure this is acceptable.&#39;</span>
        <span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strobj</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|RUnknown error in evaluating Attribute: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">string</span>


<div class="viewcode-block" id="CmdSetAttribute">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdSetAttribute</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set attribute on an object or account</span>

<span class="sd">    Usage:</span>
<span class="sd">      set[/switch] &lt;obj&gt;/&lt;attr&gt;[:category] = &lt;value&gt;</span>
<span class="sd">      set[/switch] &lt;obj&gt;/&lt;attr&gt;[:category] =                  # delete attribute</span>
<span class="sd">      set[/switch] &lt;obj&gt;/&lt;attr&gt;[:category]                    # view attribute</span>
<span class="sd">      set[/switch] *&lt;account&gt;/&lt;attr&gt;[:category] = &lt;value&gt;</span>

<span class="sd">    Switch:</span>
<span class="sd">        edit: Open the line editor (string values only)</span>
<span class="sd">        script: If we&#39;re trying to set an attribute on a script</span>
<span class="sd">        channel: If we&#39;re trying to set an attribute on a channel</span>
<span class="sd">        account: If we&#39;re trying to set an attribute on an account</span>
<span class="sd">        room: Setting an attribute on a room (global search)</span>
<span class="sd">        exit: Setting an attribute on an exit (global search)</span>
<span class="sd">        char: Setting an attribute on a character (global search)</span>
<span class="sd">        character: Alias for char, as above.</span>

<span class="sd">    Example:</span>
<span class="sd">        set self/foo = &quot;bar&quot;</span>
<span class="sd">        set/delete self/foo</span>
<span class="sd">        set self/foo = $dbref(#53)</span>

<span class="sd">    Sets attributes on objects. The second example form above clears a</span>
<span class="sd">    previously set attribute while the third form inspects the current value of</span>
<span class="sd">    the attribute (if any). The last one (with the star) is a shortcut for</span>
<span class="sd">    operating on a player Account rather than an Object.</span>

<span class="sd">    If you want &lt;value&gt; to be an object, use $dbef(#dbref) or</span>
<span class="sd">    $search(key) to assign it. You need control or edit access to</span>
<span class="sd">    the object you are adding.</span>

<span class="sd">    The most common data to save with this command are strings and</span>
<span class="sd">    numbers. You can however also set Python primitives such as lists,</span>
<span class="sd">    dictionaries and tuples on objects (this might be important for</span>
<span class="sd">    the functionality of certain custom objects).  This is indicated</span>
<span class="sd">    by you starting your value with one of |c&#39;|n, |c&quot;|n, |c(|n, |c[|n</span>
<span class="sd">    or |c{ |n.</span>

<span class="sd">    Once you have stored a Python primitive as noted above, you can include</span>
<span class="sd">    |c[&lt;key&gt;]|n in &lt;attr&gt; to reference nested values in e.g. a list or dict.</span>

<span class="sd">    Remember that if you use Python primitives like this, you must</span>
<span class="sd">    write proper Python syntax too - notably you must include quotes</span>
<span class="sd">    around your strings or you will get an error.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@set&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(set) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>
    <span class="n">nested_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*?\]&quot;</span><span class="p">)</span>
    <span class="n">not_found</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<div class="viewcode-block" id="CmdSetAttribute.check_obj">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.check_obj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This may be overridden by subclasses in case restrictions need to be</span>
<span class="sd">        placed on whether certain objects can have attributes set by certain</span>
<span class="sd">        accounts.</span>

<span class="sd">        This function is expected to display its own error message.</span>

<span class="sd">        Returning False will abort the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CmdSetAttribute.check_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.check_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This may be overridden by subclasses in case restrictions need to be</span>
<span class="sd">        placed on what attributes can be set by who beyond the normal lock.</span>

<span class="sd">        This functions is expected to display its own error message. It is</span>
<span class="sd">        run once for every attribute that is checked, blocking only those</span>
<span class="sd">        attributes which are not permitted and letting the others through.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">attr_name</span></div>


<div class="viewcode-block" id="CmdSetAttribute.split_nested_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.split_nested_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_nested_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields tuples of (possible attr name, nested keys on that attr).</span>
<span class="sd">        For performance, this is biased to the deepest match, but allows compatibility</span>
<span class="sd">        with older attrs that might have been named with `[]`&#39;s.</span>

<span class="sd">        &gt; list(split_nested_attr(&quot;nested[&#39;asdf&#39;][0]&quot;))</span>
<span class="sd">        [</span>
<span class="sd">            (&#39;nested&#39;, [&#39;asdf&#39;, 0]),</span>
<span class="sd">            (&quot;nested[&#39;asdf&#39;]&quot;, [0]),</span>
<span class="sd">            (&quot;nested[&#39;asdf&#39;][0]&quot;, []),</span>
<span class="sd">        ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">quotes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">clean_key</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;[]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">quotes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LIST_APPEND_CHAR</span><span class="p">:</span>
                <span class="c1"># List insert/append syntax</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="n">base_attr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">base_attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[:</span> <span class="n">attr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">base_attr</span><span class="p">,</span> <span class="p">[</span><span class="n">clean_key</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="n">index</span><span class="p">:]])</span>
            <span class="n">base_attr</span> <span class="o">+=</span> <span class="n">part</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="CmdSetAttribute.do_nested_lookup">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.do_nested_lookup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_nested_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_found</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="CmdSetAttribute.view_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.view_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look up the value of an attribute and return a string displaying it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">nested_keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_nested_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_nested_lookup</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">nested_keys</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_found</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category:</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> [category:</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">] does not exist.&quot;</span>
        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="s2">&quot; (Nested lookups attempted)&quot;</span>
        <span class="k">return</span> <span class="n">error</span></div>


<div class="viewcode-block" id="CmdSetAttribute.rm_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.rm_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rm_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove an attribute from the object, or a nested data structure, and report back.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">nested_keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_nested_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="n">nested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nested_keys</span><span class="p">:</span>
                    <span class="n">del_key</span> <span class="o">=</span> <span class="n">nested_keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                    <span class="n">deep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_nested_lookup</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">nested_keys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">deep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_found</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">deep</span><span class="p">[</span><span class="n">del_key</span><span class="p">]</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Deleted attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category:</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">].&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exists</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Deleted attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category:</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">].&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">] &quot;</span>
                            <span class="s2">&quot;was found to delete.&quot;</span>
                        <span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">] was found to delete.&quot;</span>
        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="s2">&quot; (Nested lookups attempted)&quot;</span>
        <span class="k">return</span> <span class="n">error</span></div>


<div class="viewcode-block" id="CmdSetAttribute.set_attr">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.set_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">nested_keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_nested_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nested_keys</span><span class="p">:</span>
                <span class="n">acc_key</span> <span class="o">=</span> <span class="n">nested_keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lookup_value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
                <span class="n">deep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_nested_lookup</span><span class="p">(</span><span class="n">lookup_value</span><span class="p">,</span> <span class="o">*</span><span class="n">nested_keys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">deep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_found</span><span class="p">:</span>
                    <span class="c1"># To support appending and inserting to lists</span>
                    <span class="c1"># a key that starts with LIST_APPEND_CHAR will insert a new item at that</span>
                    <span class="c1"># location, and move the other elements down.</span>
                    <span class="c1"># Using LIST_APPEND_CHAR alone will append to the list</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acc_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">acc_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LIST_APPEND_CHAR</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acc_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">where</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">acc_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                                <span class="n">deep</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">deep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">lookup_value</span>
                            <span class="n">attr</span> <span class="o">=</span> <span class="n">key</span>
                            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                    <span class="c1"># List magic failed, just use like a key/index</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">deep</span><span class="p">[</span><span class="n">acc_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="c1"># Tuples can&#39;t be modified</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">deep</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">lookup_value</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;Modified&quot;</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Created&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/|w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|n [category:</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="c1"># this means literal_eval tried to parse a faulty string</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|RCritical Python syntax error in your value. Only &quot;</span>
                <span class="s2">&quot;primitive Python structures are allowed.</span><span class="se">\n</span><span class="s2">You also &quot;</span>
                <span class="s2">&quot;need to use correct Python syntax. Remember especially &quot;</span>
                <span class="s2">&quot;to put quotes around all strings inside lists and &quot;</span>
                <span class="s2">&quot;dicts.|n&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@interactive</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">caller</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Activate the line editor&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Called for the editor to load the buffer&quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># we set empty buffer on nonexisting Attribute because otherwise</span>
                <span class="c1"># we&#39;d always have the string &quot;None&quot; in the buffer to start with</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>  <span class="c1"># we already confirmed we are ok with this</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Called when editor saves its buffer.&quot;&quot;&quot;</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved Attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># check non-strings before activating editor</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;|rWarning: Attribute |w</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">|r is of type |w</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">|r. &quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">To continue editing, it must be converted to (and saved as) a string. &quot;</span>
                    <span class="s2">&quot;Continue? [Y]/N?&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Aborted edit.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># start the editor</span>
        <span class="n">EvEditor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CmdSetAttribute.search_for_obj">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.search_for_obj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_for_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Searches for an object matching objname. The object may be of different typeclasses.</span>
<span class="sd">        Args:</span>
<span class="sd">            objname: Name of the object we&#39;re looking for</span>

<span class="sd">        Returns:</span>
<span class="sd">            A typeclassed object, or None if nothing is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">variable_from_module</span>

        <span class="n">_AT_SEARCH_RESULT</span> <span class="o">=</span> <span class="n">variable_from_module</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">SEARCH_AT_RESULT</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="n">objname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;account&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">found_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">objname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;script&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">found_obj</span> <span class="o">=</span> <span class="n">_AT_SEARCH_RESULT</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">search_script</span><span class="p">(</span><span class="n">objname</span><span class="p">),</span> <span class="n">caller</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;channel&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">found_obj</span> <span class="o">=</span> <span class="n">_AT_SEARCH_RESULT</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">search_channel</span><span class="p">(</span><span class="n">objname</span><span class="p">),</span> <span class="n">caller</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">global_search</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;char&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;character&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span>
            <span class="k">elif</span> <span class="s2">&quot;room&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span>
            <span class="k">elif</span> <span class="s2">&quot;exit&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_search</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">typeclass</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">found_obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="n">global_search</span><span class="p">,</span> <span class="n">typeclass</span><span class="o">=</span><span class="n">typeclass</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">found_obj</span></div>


<div class="viewcode-block" id="CmdSetAttribute.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSetAttribute.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement the set attribute - a limited form of py.&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: set obj/attr[:category] = value. Use empty value to clear.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get values prepared by the parser</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;option&quot;</span><span class="p">)</span>  <span class="c1"># None if unset</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_for_obj</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;edit&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># edit in the line editor</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to edit </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;The Line editor can only be applied to one attribute at a time.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Use `set/edit &lt;objname&gt;/&lt;attr&gt;` to define the Attribute to edit.</span><span class="se">\n</span><span class="s2">To &quot;</span>
                    <span class="s2">&quot;edit the current room description, use `set/edit here/desc` (or &quot;</span>
                    <span class="s2">&quot;use the `desc` command).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edit_handler</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caller</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># no = means we inspect the attribute(s)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">key</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_obj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># deleting the attribute(s)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to edit </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># setting attribute(s). Make sure to convert to real Python type before saving.</span>
            <span class="c1"># add support for $dbref() and $search() in set argument</span>
            <span class="k">global</span> <span class="n">_ATTRFUNCPARSER</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_ATTRFUNCPARSER</span><span class="p">:</span>
                <span class="n">_ATTRFUNCPARSER</span> <span class="o">=</span> <span class="n">funcparser</span><span class="o">.</span><span class="n">FuncParser</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;dbref&quot;</span><span class="p">:</span> <span class="n">funcparser</span><span class="o">.</span><span class="n">funcparser_callable_search</span><span class="p">,</span>
                        <span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="n">funcparser</span><span class="o">.</span><span class="n">funcparser_callable_search</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to edit </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c1"># from evennia import set_trace;set_trace()</span>
                <span class="n">parsed_value</span> <span class="o">=</span> <span class="n">_ATTRFUNCPARSER</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">return_str</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parsed_value</span><span class="p">,</span> <span class="s2">&quot;access&quot;</span><span class="p">):</span>
                    <span class="c1"># if this is an object we must have the right to read it, if so,</span>
                    <span class="c1"># we will not convert it to a string</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">parsed_value</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">parsed_value</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;You don&#39;t have permission to set object with identifier &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">parsed_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_convert_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="p">))</span>
        <span class="c1"># check if anything was done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;No valid attributes were found. Usage: set obj/attr[:category] = value. Use empty&quot;</span>
                <span class="s2">&quot; value to clear.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># send feedback</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="CmdTypeclass">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTypeclass">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdTypeclass</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set or change an object&#39;s typeclass</span>

<span class="sd">    Usage:</span>
<span class="sd">      typeclass[/switch] &lt;object&gt; [= typeclass.path]</span>
<span class="sd">      typeclass/prototype &lt;object&gt; = prototype_key</span>

<span class="sd">      typeclasses or typeclass/list/show [typeclass.path]</span>
<span class="sd">      swap - this is a shorthand for using /force/reset flags.</span>
<span class="sd">      update - this is a shorthand for using the /force/reload flag.</span>

<span class="sd">    Switch:</span>
<span class="sd">      show, examine - display the current typeclass of object (default) or, if</span>
<span class="sd">            given a typeclass path, show the docstring of that typeclass.</span>
<span class="sd">      update - *only* re-run at_object_creation on this object</span>
<span class="sd">              meaning locks or other properties set later may remain.</span>
<span class="sd">      reset - clean out *all* the attributes and properties on the</span>
<span class="sd">              object - basically making this a new clean object. This will also</span>
<span class="sd">              reset cmdsets!</span>
<span class="sd">      force - change to the typeclass also if the object</span>
<span class="sd">              already has a typeclass of the same name.</span>
<span class="sd">      list - show available typeclasses. Only typeclasses in modules actually</span>
<span class="sd">             imported or used from somewhere in the code will show up here</span>
<span class="sd">             (those typeclasses are still available if you know the path)</span>
<span class="sd">      prototype - clean and overwrite the object with the specified</span>
<span class="sd">               prototype key - effectively making a whole new object.</span>

<span class="sd">    Example:</span>
<span class="sd">      type button = examples.red_button.RedButton</span>
<span class="sd">      type/prototype button=a red button</span>

<span class="sd">    If the typeclass_path is not given, the current object&#39;s typeclass is</span>
<span class="sd">    assumed.</span>

<span class="sd">    View or set an object&#39;s typeclass. If setting, the creation hooks of the</span>
<span class="sd">    new typeclass will be run on the object. If you have clashing properties on</span>
<span class="sd">    the old class, use /reset. By default you are protected from changing to a</span>
<span class="sd">    typeclass of the same name as the one you already have - use /force to</span>
<span class="sd">    override this protection.</span>

<span class="sd">    The given typeclass must be identified by its location using python</span>
<span class="sd">    dot-notation pointing to the correct module and class. If no typeclass is</span>
<span class="sd">    given (or a wrong typeclass is given). Errors in the path or new typeclass</span>
<span class="sd">    will lead to the old typeclass being kept. The location of the typeclass</span>
<span class="sd">    module is searched from the default typeclass directory, as defined in the</span>
<span class="sd">    server settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@typeclass&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">,</span> <span class="s2">&quot;@parent&quot;</span><span class="p">,</span> <span class="s2">&quot;@swap&quot;</span><span class="p">,</span> <span class="s2">&quot;@update&quot;</span><span class="p">,</span> <span class="s2">&quot;@typeclasses&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(typeclass) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generic_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">typeclass_path</span><span class="p">):</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="n">typeclass_path</span><span class="p">:</span>
            <span class="c1"># make sure we search the right database table</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_typeclass</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">typeclass_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="c1"># this could be a prototype and not a typeclass at all</span>
                <span class="k">return</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="n">dbclass</span> <span class="o">=</span> <span class="n">new_typeclass</span><span class="o">.</span><span class="n">__dbclass__</span>

            <span class="k">if</span> <span class="n">caller</span><span class="o">.</span><span class="n">__dbclass__</span> <span class="o">==</span> <span class="n">dbclass</span><span class="p">:</span>
                <span class="c1"># object or account match</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">__dbclass__</span> <span class="o">==</span> <span class="n">dbclass</span><span class="p">:</span>
                <span class="c1"># applying account while caller is object</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to search </span><span class="si">{</span><span class="n">new_typeclass</span><span class="si">}</span><span class="s2"> with query &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;puppet&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">caller</span><span class="o">.</span><span class="n">puppet</span><span class="o">.</span><span class="n">__dbclass__</span> <span class="o">==</span> <span class="n">dbclass</span><span class="p">:</span>
                <span class="c1"># applying object while caller is account</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to search </span><span class="si">{</span><span class="n">new_typeclass</span><span class="si">}</span><span class="s2"> with query &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">puppet</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># other mismatch between caller and specified typeclass</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to search </span><span class="si">{</span><span class="n">new_typeclass</span><span class="si">}</span><span class="s2"> with query &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">new_typeclass</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">new_typeclass</span><span class="si">}</span><span class="s2"> with query &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no rhs, use caller&#39;s typeclass</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="CmdTypeclass.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTypeclass.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements command&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="s2">&quot;list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdname</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;typeclasses&quot;</span><span class="p">,</span> <span class="s2">&quot;@typeclasses&quot;</span><span class="p">):</span>
            <span class="n">tclasses</span> <span class="o">=</span> <span class="n">get_all_typeclasses</span><span class="p">()</span>
            <span class="n">contribs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tclasses</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;evennia.contrib&quot;</span><span class="p">)]</span> <span class="ow">or</span> <span class="p">[</span>
                <span class="s2">&quot;&lt;None loaded&gt;&quot;</span>
            <span class="p">]</span>
            <span class="n">core</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tclasses</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;evennia&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contribs</span>
            <span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&lt;None loaded&gt;&quot;</span><span class="p">]</span>
            <span class="n">game</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tclasses</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;evennia&quot;</span><span class="p">)]</span> <span class="ow">or</span> <span class="p">[</span>
                <span class="s2">&quot;&lt;None loaded&gt;&quot;</span>
            <span class="p">]</span>
            <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;|wCore typeclasses|n</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    </span><span class="si">{core}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;|wLoaded Contrib typeclasses|n</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    </span><span class="si">{contrib}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;|wGame-dir typeclasses|n</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    </span><span class="si">{game}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">core</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">core</span><span class="p">),</span> <span class="n">contrib</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contribs</span><span class="p">),</span> <span class="n">game</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">EvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">exit_on_lastpage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> &lt;object&gt; [= typeclass]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdstring</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;show&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;examine&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">oquery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">oquery</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="c1"># no object found to examine, see if it&#39;s a typeclass-path instead</span>
                <span class="n">tclasses</span> <span class="o">=</span> <span class="n">get_all_typeclasses</span><span class="p">()</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tclass</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">tclass</span> <span class="ow">in</span> <span class="n">tclasses</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">oquery</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">nmatches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nmatches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                        <span class="s2">&quot;Multiple typeclasses found matching </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">oquery</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No object or typeclass path found to match &#39;</span><span class="si">{</span><span class="n">oquery</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># one match found</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docstring for typeclass &#39;</span><span class="si">{</span><span class="n">oquery</span><span class="si">}</span><span class="s2">&#39;: </span><span class="se">\n</span><span class="si">{</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># do the search again to get the error handling in case of multi-match</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">oquery</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;s current typeclass is&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic_search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dbclass__&quot;</span><span class="p">):</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a typed object.&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">new_typeclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">path</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;prototype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;More than one match for </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">prototype</span><span class="p">:</span>
                <span class="c1"># one match</span>
                <span class="n">prototype</span> <span class="o">=</span> <span class="n">prototype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no match</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No prototype &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; was found.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">new_typeclass</span> <span class="o">=</span> <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;typeclass&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;show&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;examine&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;s current typeclass is &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdstring</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;swap&quot;</span><span class="p">,</span> <span class="s2">&quot;@swap&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdstring</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;@update&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;force&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are not allowed to do that.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;swap_typeclass&quot;</span><span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;This object cannot have a type at all!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">is_same</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_typeclass</span><span class="p">(</span><span class="n">new_typeclass</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_same</span> <span class="ow">and</span> <span class="s2">&quot;force&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already has the typeclass &#39;</span><span class="si">{</span><span class="n">new_typeclass</span><span class="si">}</span><span class="s2">&#39;. Use /force to override.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="s2">&quot;reset&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">reset</span>  <span class="c1"># default to update</span>

            <span class="n">hooks</span> <span class="o">=</span> <span class="s2">&quot;at_object_creation&quot;</span> <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reset</span> <span class="k">else</span> <span class="s2">&quot;all&quot;</span>
            <span class="n">old_typeclass_path</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">typeclass_path</span>

            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span>
                    <span class="s2">&quot;|yNote that this will reset the object back to its typeclass&#39; default state,&quot;</span>
                    <span class="s2">&quot; removing any custom locks/perms/attributes etc that may have been added by an&quot;</span>
                    <span class="s2">&quot; explicit create_object call. Use `update` or type/force instead in order to&quot;</span>
                    <span class="s2">&quot; keep such data. Continue [Y]/N?|n&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">):</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Aborted.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># special prompt for the user in cases where we want</span>
            <span class="c1"># to confirm changes.</span>
            <span class="k">if</span> <span class="s2">&quot;prototype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">diff</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">prototype_diff_from_object</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">format_diff</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Applying prototype &#39;</span><span class="si">{</span><span class="n">prototype</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; over &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; will cause the&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; follow changes:</span><span class="se">\n</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reset</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|yWARNING:|n Use the /reset switch to apply the prototype over a blank&quot;</span>
                        <span class="s2">&quot; state.&quot;</span>
                    <span class="p">)</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Are you sure you want to apply these changes [yes]/no?&quot;</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">answer</span> <span class="ow">and</span> <span class="n">answer</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">):</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Canceled: No changes were applied.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># we let this raise exception if needed</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">swap_typeclass</span><span class="p">(</span>
                <span class="n">new_typeclass</span><span class="p">,</span> <span class="n">clean_attributes</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span> <span class="n">clean_cmdsets</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span> <span class="n">run_start_hooks</span><span class="o">=</span><span class="n">hooks</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;prototype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">batch_update_objects_with_prototype</span><span class="p">(</span>
                    <span class="n">prototype</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">],</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
                <span class="p">)</span>
                <span class="n">prototype_success</span> <span class="o">=</span> <span class="n">modified</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype_success</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prototype </span><span class="si">{</span><span class="n">prototype</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> failed to apply.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_same</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> updated its existing typeclass (</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> changed typeclass from </span><span class="si">{</span><span class="n">old_typeclass_path</span><span class="si">}</span><span class="s2"> to&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">typeclass_path</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;Only the at_object_creation hook was run (update mode).&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;All object creation hooks were run.&quot;</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot; All old attributes where deleted before the swap.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot; Attributes set before swap were not removed</span><span class="se">\n</span><span class="s2">(use `swap` or `type/reset` to&quot;</span>
                    <span class="s2">&quot; clear all).&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;prototype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">and</span> <span class="n">prototype_success</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; Prototype &#39;</span><span class="si">{</span><span class="n">prototype</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; was successfully applied over the object&quot;</span>
                    <span class="s2">&quot; type.&quot;</span>
                <span class="p">)</span>

        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdWipe">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdWipe">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdWipe</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    clear all attributes from an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      wipe &lt;object&gt;[/&lt;attr&gt;[/&lt;attr&gt;...]]</span>

<span class="sd">    Example:</span>
<span class="sd">      wipe box</span>
<span class="sd">      wipe box/colour</span>

<span class="sd">    Wipes all of an object&#39;s attributes, or optionally only those</span>
<span class="sd">    matching the given attribute-wildcard search string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@wipe&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(wipe) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdWipe.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdWipe.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        inp is the dict produced in ObjManipCommand.parse()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: wipe &lt;object&gt;[/&lt;attr&gt;/&lt;attr&gt;...]&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get the attributes set by our custom parser</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are not allowed to do that.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="c1"># wipe everything</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Wiped all attributes on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
            <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Wiped attributes </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdLock">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdLock">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdLock</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    assign a lock definition to an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      lock &lt;object or *account&gt;[ = &lt;lockstring&gt;]</span>
<span class="sd">      or</span>
<span class="sd">      lock[/switch] &lt;object or *account&gt;/&lt;access_type&gt;</span>

<span class="sd">    Switch:</span>
<span class="sd">      del - delete given access type</span>
<span class="sd">      view - view lock associated with given access type (default)</span>

<span class="sd">    If no lockstring is given, shows all locks on</span>
<span class="sd">    object.</span>

<span class="sd">    Lockstring is of the form</span>
<span class="sd">       access_type:[NOT] func1(args)[ AND|OR][ NOT] func2(args) ...]</span>
<span class="sd">    Where func1, func2 ... valid lockfuncs with or without arguments.</span>
<span class="sd">    Separator expressions need not be capitalized.</span>

<span class="sd">    For example:</span>
<span class="sd">       &#39;get: id(25) or perm(Admin)&#39;</span>
<span class="sd">    The &#39;get&#39; lock access_type is checked e.g. by the &#39;get&#39; command.</span>
<span class="sd">    An object locked with this example lock will only be possible to pick up</span>
<span class="sd">    by Admins or by an object with id=25.</span>

<span class="sd">    You can add several access_types after one another by separating</span>
<span class="sd">    them by &#39;;&#39;, i.e:</span>
<span class="sd">       &#39;get:id(25); delete:perm(Builder)&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@lock&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@locks&quot;</span><span class="p">]</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd: perm(locks) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdLock.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdLock.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the command&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Usage: lock &lt;object&gt;[ = &lt;lockstring&gt;] or lock[/switch] &lt;object&gt;/&lt;access_type&gt;&quot;</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="c1"># call of the form lock obj/access_type</span>
            <span class="n">objname</span><span class="p">,</span> <span class="n">access_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">objname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">objname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="n">has_control_access</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">access_type</span> <span class="o">==</span> <span class="s2">&quot;control&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_control_access</span><span class="p">:</span>
                <span class="c1"># only allow to change &#39;control&#39; access if you have &#39;control&#39; access already</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You need &#39;control&#39; access to change this type of lock.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_control_access</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are not allowed to do that.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">lockdef</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">access_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lockdef</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;del&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">access_type</span><span class="p">)</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;deleted lock </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lockdef</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="n">lockdef</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> has no lock of access type &#39;</span><span class="si">{</span><span class="n">access_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># we have a = separator, so we are assigning a new lock</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">swi</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">)</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Switch(es) |w</span><span class="si">{</span><span class="n">swi</span><span class="si">}</span><span class="s2">|n can not be used with a &quot;</span>
                    <span class="s2">&quot;lock assignment. Use e.g. &quot;</span>
                    <span class="s2">&quot;|wlock/del objname/locktype|n instead.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">objname</span><span class="p">,</span> <span class="n">lockdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">objname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">objname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are not allowed to do that.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">lockdef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&#39;|</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">lockdef</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lockdef</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">LockException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;cmd&quot;</span> <span class="ow">in</span> <span class="n">lockdef</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">inherits_from</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;evennia.objects.objects.DefaultExit&quot;</span>
            <span class="p">):</span>
                <span class="c1"># special fix to update Exits since &quot;cmd&quot;-type locks won&#39;t</span>
                <span class="c1"># update on them unless their cmdsets are rebuilt.</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">at_init</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added lock &#39;</span><span class="si">{</span><span class="n">lockdef</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># if we get here, we are just viewing all locks on obj</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You are not allowed to do that.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span></div>
</div>



<div class="viewcode-block" id="CmdExamine">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdExamine</span><span class="p">(</span><span class="n">ObjManipCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get detailed information about an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      examine [&lt;object&gt;[/attrname]]</span>
<span class="sd">      examine [*&lt;account&gt;[/attrname]]</span>

<span class="sd">    Switch:</span>
<span class="sd">      account - examine an Account (same as adding *)</span>
<span class="sd">      object - examine an Object (useful when OOC)</span>
<span class="sd">      script - examine a Script</span>
<span class="sd">      channel - examine a Channel</span>

<span class="sd">    The examine command shows detailed game info about an</span>
<span class="sd">    object and optionally a specific attribute on it.</span>
<span class="sd">    If object is not specified, the current location is examined.</span>

<span class="sd">    Append a * before the search string to examine an account.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@examine&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@ex&quot;</span><span class="p">,</span> <span class="s2">&quot;@exam&quot;</span><span class="p">]</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(examine) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>
    <span class="n">arg_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(/\w+?(\s|$))|\s|$&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;account&quot;</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">]</span>

    <span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>

    <span class="n">detail_color</span> <span class="o">=</span> <span class="s2">&quot;|c&quot;</span>
    <span class="n">header_color</span> <span class="o">=</span> <span class="s2">&quot;|w&quot;</span>
    <span class="n">quell_color</span> <span class="o">=</span> <span class="s2">&quot;|r&quot;</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

<div class="viewcode-block" id="CmdExamine.msg">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.msg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Central point for sending messages to the caller. This tags</span>
<span class="sd">        the message as &#39;examine&#39; for eventual custom markup in the client.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            text (str): The text to send.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;examine&quot;</span><span class="p">}))</span></div>


<div class="viewcode-block" id="CmdExamine.format_key">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_aliases">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_aliases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">make_iter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">aliases</span><span class="p">)))</span></div>


<div class="viewcode-block" id="CmdExamine.format_typeclass">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_typeclass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_typeclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;typeclass_path&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">typeclass_path</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_sessions">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_sessions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;sessions&quot;</span><span class="p">):</span>
            <span class="n">sessions</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">sess</span><span class="o">.</span><span class="n">sessid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">())</span></div>


<div class="viewcode-block" id="CmdExamine.format_email">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_email">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail_color</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">|n&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_last_login">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_last_login">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_last_login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;last_login&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">last_login</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail_color</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">last_login</span><span class="si">}</span><span class="s2">|n&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_account_key">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_account_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_account_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detail_color</span><span class="si">}{</span><span class="n">account</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">|n (</span><span class="si">{</span><span class="n">account</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_account_typeclass">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_account_typeclass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_account_typeclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">account</span><span class="o">.</span><span class="n">typeclass_path</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_account_permissions">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_account_permissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_account_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;Superuser&gt;&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">perms</span><span class="p">:</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;None&gt;&quot;</span><span class="p">]</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">&quot;_quell&quot;</span><span class="p">):</span>
            <span class="n">perms</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quell_color</span><span class="si">}</span><span class="s2">(quelled)|n&quot;</span>
        <span class="k">return</span> <span class="n">perms</span></div>


<div class="viewcode-block" id="CmdExamine.format_location">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_location">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> (#</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_home">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_home">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_home</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">home</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> (#</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_destination">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_destination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> (#</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_permissions">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_permissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">perms</span><span class="p">:</span>
            <span class="n">perms_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
                <span class="n">perms_string</span> <span class="o">+=</span> <span class="s2">&quot; &lt;Superuser&gt;&quot;</span>
            <span class="k">return</span> <span class="n">perms_string</span></div>


<div class="viewcode-block" id="CmdExamine.format_locks">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_locks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_locks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">locks</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">locks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">locks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">lock</span> <span class="k">for</span> <span class="n">lock</span> <span class="ow">in</span> <span class="n">locks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)]),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Default&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_scripts">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_scripts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">scripts</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">scripts</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_single_tag">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_single_tag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_single_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">db_category</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">db_key</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">db_category</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">db_key</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_tags">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_tags">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_objs</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">formatted_tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_tags</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_single_cmdset_options">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_single_cmdset_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_single_cmdset_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_truefalse</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">: T&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">: F&quot;</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">_truefalse</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmdset</span><span class="p">,</span> <span class="n">opt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;no_exits&quot;</span><span class="p">,</span> <span class="s2">&quot;no_objs&quot;</span><span class="p">,</span> <span class="s2">&quot;no_channels&quot;</span><span class="p">,</span> <span class="s2">&quot;duplicates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmdset</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">txt</span> <span class="k">if</span> <span class="n">txt</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_single_cmdset">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_single_cmdset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_single_cmdset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_single_cmdset_options</span><span class="p">(</span><span class="n">cmdset</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmdset</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">cmdset</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">] (</span><span class="si">{</span><span class="n">cmdset</span><span class="o">.</span><span class="n">mergetype</span><span class="si">}</span><span class="s2">, prio </span><span class="si">{</span><span class="n">cmdset</span><span class="o">.</span><span class="n">priority</span><span class="si">}{</span><span class="n">options</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_stored_cmdsets">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_stored_cmdsets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_stored_cmdsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;cmdset&quot;</span><span class="p">):</span>
            <span class="n">stored_cmdset_strings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stored_cmdsets</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">stored_cmdsets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmdset</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;_EMPTY_CMDSET&quot;</span><span class="p">:</span>
                    <span class="n">stored_cmdset_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_cmdset</span><span class="p">(</span><span class="n">cmdset</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stored_cmdset_strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_merged_cmdsets">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_merged_cmdsets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_merged_cmdsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;cmdset&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">all_cmdsets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cmdset</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">current_cmdset</span><span class="o">.</span><span class="n">merged_from</span><span class="p">]</span>
        <span class="c1"># we always at least try to add account- and session sets since these are ignored</span>
        <span class="c1"># if we merge on the object level.</span>
        <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">evennia</span><span class="o">.</span><span class="n">DefaultObject</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">:</span>
            <span class="c1"># get Attribute-cmdsets if they exist</span>
            <span class="n">all_cmdsets</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">cmdset</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                <span class="c1"># if there are more sessions than one on objects it&#39;s because of multisession mode</span>
                <span class="c1"># we only show the first session&#39;s cmdset here (it is -in principle- possible</span>
                <span class="c1"># that different sessions have different cmdsets but for admins who want such</span>
                <span class="c1"># madness it is better that they overload with their own CmdExamine to handle it).</span>
                <span class="n">all_cmdsets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">cmdset</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># we have to protect this since many objects don&#39;t have sessions.</span>
                <span class="n">all_cmdsets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="n">cmdset</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cmdset</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># an error means we are merging an object without a session</span>
                <span class="k">pass</span>
        <span class="n">all_cmdsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmdset</span> <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">all_cmdsets</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">all_cmdsets</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">merged_cmdset_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">all_cmdsets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmdset</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;_EMPTY_CMDSET&quot;</span><span class="p">:</span>
                <span class="n">merged_cmdset_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_cmdset</span><span class="p">(</span><span class="n">cmdset</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">merged_cmdset_strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_current_cmds">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_current_cmds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_current_cmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">):</span>
        <span class="n">current_commands</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">cmd</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">current_cmdset</span> <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_commands</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_attribute_value_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrvalue</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrvalue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attrvalue</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">attrvalue</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">attrvalue</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_Saver&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">deserialize</span><span class="p">(</span><span class="n">attrvalue</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">deserialize</span><span class="p">(</span><span class="n">attrvalue</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">attrvalue</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">typ</span>

<div class="viewcode-block" id="CmdExamine.format_single_attribute_detail">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_single_attribute_detail">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_single_attribute_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">_FUNCPARSER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_FUNCPARSER</span><span class="p">:</span>
            <span class="n">_FUNCPARSER</span> <span class="o">=</span> <span class="n">funcparser</span><span class="o">.</span><span class="n">FuncParser</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FUNCPARSER_OUTGOING_MESSAGES_MODULES</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_key</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_category</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">value</span>
        <span class="n">valuetype</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">strvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">strvalue</span>
            <span class="n">valuetype</span> <span class="o">=</span> <span class="s2">&quot; |B[strvalue]|n&quot;</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute_value_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; |B[type:</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">]|n</span><span class="si">{</span><span class="n">valuetype</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">typ</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valuetype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_FUNCPARSER</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ansi_raw</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">escape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Attribute </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header_color</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">|n &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[category=</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_single_attribute">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_single_attribute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_single_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">_FUNCPARSER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_FUNCPARSER</span><span class="p">:</span>
            <span class="n">_FUNCPARSER</span> <span class="o">=</span> <span class="n">funcparser</span><span class="o">.</span><span class="n">FuncParser</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FUNCPARSER_OUTGOING_MESSAGES_MODULES</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_key</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_category</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">value</span>
        <span class="n">valuetype</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">strvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">strvalue</span>
            <span class="n">valuetype</span> <span class="o">=</span> <span class="s2">&quot; |B[strvalue]|n&quot;</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute_value_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; |B[type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">]|n</span><span class="si">{</span><span class="n">valuetype</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">typ</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valuetype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_FUNCPARSER</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ansi_raw</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">escape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header_color</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">|n[</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">value</span><span class="si">}{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header_color</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">|n=</span><span class="si">{</span><span class="n">value</span><span class="si">}{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_attributes">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_attributes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_attribute</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_attributes</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># we don&#39;t want just an empty line</span>
            <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="CmdExamine.format_nattributes">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_nattributes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_nattributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ndb_attr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">nattributes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">ndb_attr</span> <span class="ow">and</span> <span class="n">ndb_attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_attribute</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ndb_attr</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_exits">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_exits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_exits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;exits&quot;</span><span class="p">):</span>
            <span class="n">exits</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">exit</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">exit</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">exits</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">exits</span> <span class="k">if</span> <span class="n">exits</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CmdExamine.format_chars">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_chars">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_chars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">):</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">contents</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chars</span> <span class="k">if</span> <span class="n">chars</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CmdExamine.format_things">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_things">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_things</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">):</span>
            <span class="n">things</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">contents</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">destination</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">things</span> <span class="k">if</span> <span class="n">things</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CmdExamine.format_script_desc">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_script_desc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_script_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_desc&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_desc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">crop</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">db_desc</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_script_is_persistent">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_script_is_persistent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_script_is_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_persistent&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_persistent</span> <span class="k">else</span> <span class="s2">&quot;F&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_script_timer_data">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_script_timer_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_script_timer_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_interval&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start_delay</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_start_delay</span> <span class="k">else</span> <span class="s2">&quot;F&quot;</span>
            <span class="n">next_repeat</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">time_until_next_repeat</span><span class="p">()</span>
            <span class="n">active</span> <span class="o">=</span> <span class="s2">&quot;|grunning|n&quot;</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_is_active</span> <span class="ow">and</span> <span class="n">next_repeat</span> <span class="k">else</span> <span class="s2">&quot;|rinactive|n&quot;</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_interval</span>
            <span class="n">next_repeat</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">if</span> <span class="n">next_repeat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">next_repeat</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_repeats</span><span class="p">:</span>
                <span class="n">remaining_repeats</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">remaining_repeats</span><span class="p">()</span>
                <span class="n">remaining_repeats</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">remaining_repeats</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">remaining_repeats</span>
                <span class="n">repeats</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">remaining_repeats</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">db_repeats</span><span class="si">}</span><span class="s2"> remain&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">active</span><span class="si">}</span><span class="s2"> - interval: </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">s &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(next: </span><span class="si">{</span><span class="n">next_repeat</span><span class="si">}{</span><span class="n">repeats</span><span class="si">}</span><span class="s2">, start_delay: </span><span class="si">{</span><span class="n">start_delay</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_channel_sub_totals">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_channel_sub_totals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_channel_sub_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_account_subscriptions&quot;</span><span class="p">):</span>
            <span class="n">account_subs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_account_subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">object_subs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_object_subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">online</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">online</span><span class="p">())</span>
            <span class="n">ntotal</span> <span class="o">=</span> <span class="n">account_subs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="n">object_subs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ntotal</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">online</span><span class="si">}</span><span class="s2"> online)&quot;</span></div>


<div class="viewcode-block" id="CmdExamine.format_channel_account_subs">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_channel_account_subs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_channel_account_subs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_account_subscriptions&quot;</span><span class="p">):</span>
            <span class="n">account_subs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_account_subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">account_subs</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">format_grid</span><span class="p">([</span><span class="n">sub</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">account_subs</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">_DEFAULT_WIDTH</span><span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.format_channel_object_subs">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_channel_object_subs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_channel_object_subs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;db_object_subscriptions&quot;</span><span class="p">):</span>
            <span class="n">object_subs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_object_subscriptions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">object_subs</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">format_grid</span><span class="p">([</span><span class="n">sub</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">object_subs</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">_DEFAULT_WIDTH</span><span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="CmdExamine.get_formatted_obj_data">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.get_formatted_obj_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_formatted_obj_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls all other `format_*` methods.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Name/key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_key</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Aliases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_aliases</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Typeclass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_typeclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Sessions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_sessions</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_email</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Last Login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_last_login</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">evennia</span><span class="o">.</span><span class="n">DefaultObject</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">has_account</span><span class="p">:</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Account&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_account_key</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;  Account Typeclass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_account_typeclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;  Account Permissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_account_permissions</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_location</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Home&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_home</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_destination</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Permissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_permissions</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Locks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_locks</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_cmdset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;_EMPTY_CMDSET&quot;</span>
        <span class="p">):</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Stored Cmdset(s)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_stored_cmdsets</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Merged Cmdset(s)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_merged_cmdsets</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Commands available to </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> (result of Merged Cmdset(s))&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format_current_cmds</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;script&quot;</span><span class="p">:</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_script_desc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Persistent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_script_is_persistent</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Script Repeat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_script_timer_data</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Scripts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_scripts</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_tags</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Persistent Attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Non-Persistent Attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_nattributes</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Exits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_exits</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Characters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_chars</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_things</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;channel&quot;</span><span class="p">:</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Subscription Totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_channel_sub_totals</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Account Subscriptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_channel_account_subs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">objdata</span><span class="p">[</span><span class="s2">&quot;Object Subscriptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_channel_object_subs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">objdata</span></div>


<div class="viewcode-block" id="CmdExamine.format_output">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.format_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats the full examine page return.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formatted_obj_data</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">)</span>

        <span class="c1"># format output</span>
        <span class="n">main_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">objdata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">blockstr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header_color</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s2">|n: </span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_width</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">display_len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">blockstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)))</span>
                <span class="n">main_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockstr</span><span class="p">)</span>
        <span class="n">main_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">main_str</span><span class="p">)</span>

        <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_width</span><span class="p">(),</span> <span class="n">max_width</span><span class="p">))</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">*</span> <span class="n">max_width</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">main_str</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="s2">&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_search_by_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_name</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Route to different search functions depending on the object type being</span>
<span class="sd">        examined. This also handles error reporting for multimatches/no matches.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj_name (str): The search query.</span>
<span class="sd">            objtype (str): One of &#39;object&#39;, &#39;account&#39;, &#39;script&#39; or &#39;channel&#39;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            any: `None` if no match or multimatch, otherwise a single result.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">obj_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">&quot;account&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">obj_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># this means we are calling examine from an account object</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="n">obj_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">search_object</span><span class="o">=</span><span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;search_</span><span class="si">{</span><span class="n">objtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="n">obj_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">objtype</span><span class="si">}</span><span class="s2"> found with key </span><span class="si">{</span><span class="n">obj_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Multiple </span><span class="si">{objtype}</span><span class="s2"> found with key </span><span class="si">{obj_name}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{matches}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">obj_name</span><span class="o">=</span><span class="n">obj_name</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ob</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">(#</span><span class="si">{</span><span class="n">ob</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="CmdExamine.parse">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">examine_objs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># If no arguments are provided, examine the invoker&#39;s location.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">examine_objs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You need to supply a target to examine.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InterruptCommand</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">objdef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_objattr</span><span class="p">:</span>
                <span class="c1"># note that we check the objtype for every repeat; this will always</span>
                <span class="c1"># be the same result, but it makes for a cleaner code and multi-examine</span>
                <span class="c1"># is not so common anyway.</span>

                <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">obj_name</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>  <span class="c1"># name</span>
                <span class="n">obj_attrs</span> <span class="o">=</span> <span class="n">objdef</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span>  <span class="c1"># /attrs</span>

                <span class="c1"># identify object type, in prio account - script - channel</span>
                <span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">inherits_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;evennia.accounts.accounts.DefaultAccount&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="s2">&quot;account&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
                    <span class="ow">or</span> <span class="n">obj_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;account&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;script&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;script&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;channel&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="n">object_type</span> <span class="o">=</span> <span class="s2">&quot;channel&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="n">object_type</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_by_object_type</span><span class="p">(</span><span class="n">obj_name</span><span class="p">,</span> <span class="n">object_type</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">examine_objs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="CmdExamine.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdExamine.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process command&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">examine_objs</span><span class="p">:</span>
            <span class="c1"># these are parsed out in .parse already</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;examine&quot;</span><span class="p">):</span>
                <span class="c1"># If we don&#39;t have special info access, just look</span>
                <span class="c1"># at the object instead.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">at_look</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">obj_attrs</span><span class="p">:</span>
                <span class="c1"># we are only interested in specific attributes</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_attributes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_key</span> <span class="ow">in</span> <span class="n">obj_attrs</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No attributes found on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_strings</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_single_attribute_detail</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                    <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_strings</span><span class="p">)</span>
                    <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">display_len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out_strings</span><span class="p">)</span>
                    <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_width</span><span class="p">()))</span>
                    <span class="n">sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">*</span> <span class="n">max_width</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sep</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">out_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># examine the obj itself</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;account&quot;</span><span class="p">):</span>
                <span class="c1"># for objects and accounts we need to set up an asynchronous</span>
                <span class="c1"># fetch of the cmdset and not proceed with the examine display</span>
                <span class="c1"># until the fetch is complete</span>
                <span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="n">mergemode</span> <span class="o">=</span> <span class="s2">&quot;session&quot;</span>
                    <span class="n">session</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;account&quot;</span><span class="p">:</span>
                    <span class="n">mergemode</span> <span class="o">=</span> <span class="s2">&quot;account&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mergemode</span> <span class="o">=</span> <span class="s2">&quot;object&quot;</span>

                <span class="n">account</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">objct</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;account&quot;</span><span class="p">:</span>
                    <span class="n">account</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">account</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">account</span>
                    <span class="n">objct</span> <span class="o">=</span> <span class="n">obj</span>

                <span class="c1"># this is usually handled when a command runs, but when we examine</span>
                <span class="c1"># we may have leftover inherited cmdsets directly after a move etc.</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="c1"># using callback to print results whenever function returns.</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_get_cmdset_callback</span><span class="p">(</span><span class="n">current_cmdset</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_output</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">current_cmdset</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="p">(</span>
                    <span class="n">command_objects</span><span class="p">,</span>
                    <span class="n">command_objects_list</span><span class="p">,</span>
                    <span class="n">command_objects_list_error</span><span class="p">,</span>
                    <span class="n">caller</span><span class="p">,</span>
                    <span class="n">error_to</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">generate_cmdset_providers</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

                <span class="n">get_and_merge_cmdsets</span><span class="p">(</span>
                    <span class="n">obj</span><span class="p">,</span> <span class="n">command_objects_list</span><span class="p">,</span> <span class="n">mergemode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_string</span><span class="p">,</span> <span class="n">error_to</span>
                <span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">_get_cmdset_callback</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for objects without cmdsets we can proceed to examine immediately</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_output</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="CmdFind">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdFind">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdFind</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    search the database for objects</span>

<span class="sd">    Usage:</span>
<span class="sd">      find[/switches] &lt;name or dbref or *account&gt; [= dbrefmin[-dbrefmax]]</span>
<span class="sd">      locate - this is a shorthand for using the /loc switch.</span>

<span class="sd">    Switches:</span>
<span class="sd">      room       - only look for rooms (location=None)</span>
<span class="sd">      exit       - only look for exits (destination!=None)</span>
<span class="sd">      char       - only look for characters (BASE_CHARACTER_TYPECLASS)</span>
<span class="sd">      exact      - only exact matches are returned.</span>
<span class="sd">      loc        - display object location if exists and match has one result</span>
<span class="sd">      startswith - search for names starting with the string, rather than containing</span>

<span class="sd">    Searches the database for an object of a particular name or exact #dbref.</span>
<span class="sd">    Use *accountname to search for an account. The switches allows for</span>
<span class="sd">    limiting object matches to certain game entities. Dbrefmin and dbrefmax</span>
<span class="sd">    limits matches to within the given dbrefs range, or above/below if only</span>
<span class="sd">    one is given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@find&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@search&quot;</span><span class="p">,</span> <span class="s2">&quot;@locate&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;room&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;startswith&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(find) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdFind.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdFind.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search functionality&quot;&quot;&quot;</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">switches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: find &lt;string&gt; [= low [-high]]&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;locate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdstring</span><span class="p">:</span>  <span class="c1"># Use option /loc as a default for locate command alias</span>
            <span class="n">switches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;loc&quot;</span><span class="p">)</span>

        <span class="n">searchstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try grabbing the actual min/max id values by database aggregation</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">Min</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">high</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">low</span> <span class="ow">and</span> <span class="n">high</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Min and max ID not returned by aggregation;&quot;</span>
                    <span class="s2">&quot; falling back to queryset slicing.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1"># If that doesn&#39;t work for some reason (empty DB?), guess the lower</span>
            <span class="c1"># bound and do a less-efficient query to find the upper.</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check that rhs is either a valid dbref or dbref range</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="n">dbref</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-\s]+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="p">)</span>

                <span class="c1"># dbref() will return either a valid int or None</span>
                <span class="k">assert</span> <span class="n">bounds</span>
                <span class="c1"># None should not exist in the bounds list</span>
                <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bounds</span>

                <span class="n">low</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">high</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Invalid dbref range provided (not a number).&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_err</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Error parsing upper and lower bounds of query.&quot;</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
        <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

        <span class="n">is_dbref</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dbref</span><span class="p">(</span><span class="n">searchstring</span><span class="p">)</span>
        <span class="n">is_account</span> <span class="o">=</span> <span class="n">searchstring</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>

        <span class="n">restrictions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">restrictions</span> <span class="o">=</span> <span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_dbref</span> <span class="ow">or</span> <span class="n">is_account</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_dbref</span><span class="p">:</span>
                <span class="c1"># a dbref search</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;|wExact dbref match|n(#</span><span class="si">%i</span><span class="s2">-#</span><span class="si">%i%s</span><span class="s2">):&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">restrictions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># an account search</span>
                <span class="n">searchstring</span> <span class="o">=</span> <span class="n">searchstring</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;|wMatch|n(#</span><span class="si">%i</span><span class="s2">-#</span><span class="si">%i%s</span><span class="s2">):&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">restrictions</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;room&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ROOM_TYPECLASS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;exit&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EXIT_TYPECLASS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;char&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">CHAR_TYPECLASS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   |RNo match found.|n&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   |RNo match found for &#39;</span><span class="si">{</span><span class="n">searchstring</span><span class="si">}</span><span class="s2">&#39; in #dbref interval.|n&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|g   </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get_extra_display_name_info</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">|n&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;loc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_account</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot; (|wlocation|n: |g</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">get_extra_display_name_info</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">|n)&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not an account/dbref search but a wider search; build a queryset.</span>
            <span class="c1"># Searches for key and aliases</span>
            <span class="k">if</span> <span class="s2">&quot;exact&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">keyquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">db_key__iexact</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">)</span>
                <span class="n">aliasquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
                    <span class="n">db_tags__db_key__iexact</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span>
                    <span class="n">db_tags__db_tagtype__iexact</span><span class="o">=</span><span class="s2">&quot;alias&quot;</span><span class="p">,</span>
                    <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
                    <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;startswith&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
                <span class="n">keyquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">db_key__istartswith</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">)</span>
                <span class="n">aliasquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
                    <span class="n">db_tags__db_key__istartswith</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span>
                    <span class="n">db_tags__db_tagtype__iexact</span><span class="o">=</span><span class="s2">&quot;alias&quot;</span><span class="p">,</span>
                    <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
                    <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">db_key__icontains</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">)</span>
                <span class="n">aliasquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
                    <span class="n">db_tags__db_key__icontains</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span>
                    <span class="n">db_tags__db_tagtype__iexact</span><span class="o">=</span><span class="s2">&quot;alias&quot;</span><span class="p">,</span>
                    <span class="n">id__gte</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
                    <span class="n">id__lte</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Keep the initial queryset handy for later reuse</span>
            <span class="n">result_qs</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">keyquery</span> <span class="o">|</span> <span class="n">aliasquery</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            <span class="n">nresults</span> <span class="o">=</span> <span class="n">result_qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="c1"># Use iterator to minimize memory ballooning on large result sets</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">result_qs</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>

            <span class="c1"># Check and see if type filtering was requested; skip it if not</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">switches</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;room&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">)):</span>
                <span class="n">obj_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;room&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">and</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ROOM_TYPECLASS</span><span class="p">))</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;exit&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">and</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">EXIT_TYPECLASS</span><span class="p">))</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;char&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">and</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">CHAR_TYPECLASS</span><span class="p">))</span>
                    <span class="p">):</span>
                        <span class="n">obj_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="c1"># Filter previous queryset instead of requesting another</span>
                <span class="n">filtered_qs</span> <span class="o">=</span> <span class="n">result_qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
                <span class="n">nresults</span> <span class="o">=</span> <span class="n">filtered_qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

                <span class="c1"># Use iterator again to minimize memory ballooning</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">filtered_qs</span><span class="o">.</span><span class="n">iterator</span><span class="p">()</span>

            <span class="c1"># still results after type filtering?</span>
            <span class="k">if</span> <span class="n">nresults</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nresults</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nresults</span><span class="si">}</span><span class="s2"> Matches&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;One Match&quot;</span>

                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|w</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">|n(#</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">-#</span><span class="si">{</span><span class="n">high</span><span class="si">}{</span><span class="n">restrictions</span><span class="si">}</span><span class="s2">):&quot;</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; |g</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">get_extra_display_name_info</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">|n&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;loc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
                    <span class="ow">and</span> <span class="n">nresults</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">res</span>
                    <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot; (|wlocation|n:&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; |g</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">get_extra_display_name_info</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">|n)&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|wNo Matches|n(#</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">-#</span><span class="si">{</span><span class="n">high</span><span class="si">}{</span><span class="n">restrictions</span><span class="si">}</span><span class="s2">):&quot;</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   |RNo matches found for &#39;</span><span class="si">{</span><span class="n">searchstring</span><span class="si">}</span><span class="s2">&#39;|n&quot;</span>

        <span class="c1"># send result</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="ScriptEvMore">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ScriptEvMore">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScriptEvMore</span><span class="p">(</span><span class="n">EvMore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Listing 1000+ Scripts can be very slow and memory-consuming. So</span>
<span class="sd">    we use this custom EvMore child to build en EvTable only for</span>
<span class="sd">    each page of the list.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ScriptEvMore.init_pages">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ScriptEvMore.init_pages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scripts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the script list pagination&quot;&quot;&quot;</span>
        <span class="n">script_pages</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">scripts</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init_pages</span><span class="p">(</span><span class="n">script_pages</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScriptEvMore.page_formatter">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.ScriptEvMore.page_formatter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scripts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes a page of scripts and formats the output</span>
<span class="sd">        into an EvTable.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scripts</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;No scripts&gt;&quot;</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">EvTable</span><span class="p">(</span>
            <span class="s2">&quot;|wdbref|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wobj|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wkey|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wintval|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wnext|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wrept|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wtypeclass|n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;|wdesc|n&quot;</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
            <span class="n">border</span><span class="o">=</span><span class="s2">&quot;tablecols&quot;</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
            <span class="n">nextrep</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">time_until_next_repeat</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nextrep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nextrep</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_paused_time</span>
                <span class="n">nextrep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PAUSED </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nextrep</span><span class="p">)</span><span class="si">}</span><span class="s2">s&quot;</span> <span class="k">if</span> <span class="n">nextrep</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nextrep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nextrep</span><span class="si">}</span><span class="s2">s&quot;</span>

            <span class="n">maxrepeat</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">repeats</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">remaining_repeats</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">maxrepeat</span><span class="p">:</span>
                <span class="n">rept</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%i</span><span class="s2">/</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxrepeat</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">maxrepeat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rept</span> <span class="o">=</span> <span class="s2">&quot;-/-&quot;</span>

            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">script</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">script</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">script</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">else</span> <span class="s2">&quot;&lt;Global&gt;&quot;</span>
                <span class="p">),</span>
                <span class="n">script</span><span class="o">.</span><span class="n">db_key</span><span class="p">,</span>
                <span class="n">script</span><span class="o">.</span><span class="n">interval</span> <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">nextrep</span><span class="p">,</span>
                <span class="n">rept</span><span class="p">,</span>
                <span class="n">script</span><span class="o">.</span><span class="n">typeclass_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">crop</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdScripts">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdScripts">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdScripts</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List and manage all running scripts. Allows for creating new global</span>
<span class="sd">    scripts.</span>

<span class="sd">    Usage:</span>
<span class="sd">      script[/switches] [script-#dbref, key, script.path]</span>
<span class="sd">      script[/start||stop] &lt;obj&gt; = [&lt;script.path or script-key&gt;]</span>

<span class="sd">    Switches:</span>
<span class="sd">      start  - start/unpause an existing script&#39;s timer.</span>
<span class="sd">      stop   - stops an existing script&#39;s timer</span>
<span class="sd">      pause  - pause a script&#39;s timer</span>
<span class="sd">      delete - deletes script. This will also stop the timer as needed</span>

<span class="sd">    Examples:</span>
<span class="sd">        script                             - list all scripts</span>
<span class="sd">        script key:foo.bar.Script         - create a new global Script with typeclass</span>
<span class="sd">                                             and key &#39;key&#39;</span>
<span class="sd">        script foo.bar.Script              - create a new global Script with typeclass</span>
<span class="sd">                                             (key taken from typeclass or auto-generated)</span>
<span class="sd">        script/pause foo.bar.Script        - pause global script</span>
<span class="sd">        script typeclass|name|#dbref       - examine named existing global script</span>
<span class="sd">        script/delete #dbref[-#dbref]      - delete script or range by #dbref</span>

<span class="sd">        script myobj =                    - list all scripts on object</span>
<span class="sd">        script myobj = foo.bar.Script     - create and assign script to object</span>
<span class="sd">        script/stop myobj = name|#dbref   - stop named script on object</span>
<span class="sd">        script/delete myobj = name|#dbref - delete script on object</span>
<span class="sd">        script/delete myobj =             - delete ALL scripts on object</span>

<span class="sd">    When given with an `&lt;obj&gt;` as left-hand-side, this creates and</span>
<span class="sd">    assigns a new script to that object. Without an `&lt;obj&gt;`, this</span>
<span class="sd">    manages and inspects global scripts.</span>

<span class="sd">    If no switches are given, this command just views all active</span>
<span class="sd">    scripts. The argument can be either an object, at which point it</span>
<span class="sd">    will be searched for all scripts defined on it, or a script name</span>
<span class="sd">    or #dbref. For using the /stop switch, a unique script #dbref is</span>
<span class="sd">    required since whole classes of scripts often have the same name.</span>

<span class="sd">    Use the `script` build-level command for managing scripts attached to</span>
<span class="sd">    objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@scripts&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@script&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(scripts) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;System&quot;</span>

    <span class="n">excluded_typeclass_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evennia.prototypes.prototypes.DbPrototype&quot;</span><span class="p">]</span>

    <span class="n">switch_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;|gStarted|n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="s2">&quot;|RStopped|n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pause&quot;</span><span class="p">:</span> <span class="s2">&quot;|Paused|n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="s2">&quot;|rDeleted|n&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># never show these script types</span>
    <span class="n">hide_script_paths</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;evennia.prototypes.prototypes.DbPrototype&quot;</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># see if a dbref was provided</span>
        <span class="k">if</span> <span class="n">dbref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="p">):</span>
            <span class="n">scripts</span> <span class="o">=</span> <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_all_scripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scripts</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scripts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No script found with dbref </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InterruptCommand</span>

        <span class="c1"># if we provided a key, we must find an exact match, otherwise we&#39;re creating that anew</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">db_key__iexact</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">,</span> <span class="n">db_typeclass_path__iendswith</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span>
            <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span><span class="p">)</span>

        <span class="c1"># the more general case - try typeclass path</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_typeclass_path__iendswith</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="p">)</span>
            <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">scripts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scripts</span>

        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span>
        <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># may be a dbref-range</span>
            <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbref</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">val1</span> <span class="ow">and</span> <span class="n">val2</span><span class="p">:</span>
                <span class="n">scripts</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scripts</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">scripts</span>

<div class="viewcode-block" id="CmdScripts.parse">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdScripts.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_separate_key_typeclass</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
            <span class="n">part1</span><span class="p">,</span> <span class="o">*</span><span class="n">part2</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">part1</span><span class="p">,</span> <span class="n">part2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">part2</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">part1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># arg with &quot;=&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span> <span class="o">=</span> <span class="n">_separate_key_typeclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># an empty &quot;=&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># arg without &quot;=&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_query</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span> <span class="o">=</span> <span class="n">_separate_key_typeclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdScripts.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdScripts.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;implement method&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># show all scripts</span>
            <span class="n">scripts</span> <span class="o">=</span> <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scripts</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No scripts found.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">ScriptEvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">scripts</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># find script or object to operate on</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_script</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_query</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_query</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">objects</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># creation / view mode</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="c1"># we have an object</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
                    <span class="c1"># creation mode</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_query</span><span class="p">,</span> <span class="n">autostart</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Script |w</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="si">}</span><span class="s2">|n successfully added and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;started on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Script </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="si">}</span><span class="s2"> could not be added and/or started &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;on </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="si">}</span><span class="s2"> (or it started and &quot;</span>
                            <span class="s2">&quot;immediately shut down).&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># just show all scripts on object</span>
                    <span class="n">scripts</span> <span class="o">=</span> <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
                        <span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">scripts</span><span class="p">:</span>
                        <span class="n">ScriptEvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">scripts</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scripts defined on </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">scripts</span><span class="p">:</span>
                <span class="c1"># show found script(s)</span>
                <span class="n">ScriptEvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">scripts</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create global script</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_script</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_script</span><span class="p">(</span>
                        <span class="n">typeclass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">typeclass_query</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_query</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
                    <span class="n">new_script</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">new_script</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Global Script Created - </span><span class="si">{</span><span class="n">new_script</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">new_script</span><span class="o">.</span><span class="n">typeclass_path</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ScriptEvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="p">[</span><span class="n">new_script</span><span class="p">],</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Global Script |rNOT|n Created |r(see log)|n - arguments: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">scripts</span> <span class="ow">or</span> <span class="n">obj</span><span class="p">:</span>
            <span class="c1"># modification switches - must operate on existing scripts</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">scripts</span><span class="p">:</span>
                <span class="n">scripts</span> <span class="o">=</span> <span class="n">ScriptDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">db_obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
                    <span class="n">db_typeclass_path__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_script_paths</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">scripts</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiple scripts found: </span><span class="si">{</span><span class="n">scripts</span><span class="si">}</span><span class="s2">. Are you sure you want to &quot;</span>
                    <span class="s2">&quot;operate on all of them? [Y]/N? &quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">):</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Aborted.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
                <span class="n">script_key</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">key</span>
                <span class="n">script_typeclass_path</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">typeclass_path</span>
                <span class="n">scripttype</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Script on </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">obj</span> <span class="k">else</span> <span class="s2">&quot;Global Script&quot;</span>

                <span class="k">for</span> <span class="n">switch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="n">verb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_mapping</span><span class="p">[</span><span class="n">switch</span><span class="p">]</span>
                    <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">switch</span><span class="p">)()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
                        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scripttype</span><span class="si">}</span><span class="s2"> |rNOT|n </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> |r(see log)|n - &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">script_typeclass_path</span><span class="si">}</span><span class="s2">)|n&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scripttype</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">script_key</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">script_typeclass_path</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">script</span> <span class="ow">and</span> <span class="n">script</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="n">ScriptEvMore</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="p">[</span><span class="n">script</span><span class="p">],</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Script was deleted automatically.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No scripts found.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdObjects">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdObjects">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdObjects</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    statistics on objects in the database</span>

<span class="sd">    Usage:</span>
<span class="sd">      objects [&lt;nr&gt;]</span>

<span class="sd">    Gives statictics on objects in database as well as</span>
<span class="sd">    a list of &lt;nr&gt; latest objects in database. If not</span>
<span class="sd">    given, &lt;nr&gt; defaults to 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@objects&quot;</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(listobjects) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;System&quot;</span>

<div class="viewcode-block" id="CmdObjects.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdObjects.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement the command&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">nlim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="mi">10</span>
        <span class="n">nobjs</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">Character</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_CHARACTER_TYPECLASS</span><span class="p">)</span>
        <span class="n">nchars</span> <span class="o">=</span> <span class="n">Character</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">Room</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_ROOM_TYPECLASS</span><span class="p">)</span>
        <span class="n">nrooms</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">Exit</span> <span class="o">=</span> <span class="n">class_from_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_EXIT_TYPECLASS</span><span class="p">)</span>
        <span class="n">nexits</span> <span class="o">=</span> <span class="n">Exit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all_family</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">nother</span> <span class="o">=</span> <span class="n">nobjs</span> <span class="o">-</span> <span class="n">nchars</span> <span class="o">-</span> <span class="n">nrooms</span> <span class="o">-</span> <span class="n">nexits</span>
        <span class="n">nobjs</span> <span class="o">=</span> <span class="n">nobjs</span> <span class="ow">or</span> <span class="mi">1</span>  <span class="c1"># fix zero-div error with empty database</span>

        <span class="c1"># total object sum table</span>
        <span class="n">totaltable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">styled_table</span><span class="p">(</span>
            <span class="s2">&quot;|wtype|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wcomment|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wcount|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|w%|n&quot;</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;l&quot;</span>
        <span class="p">)</span>
        <span class="n">totaltable</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">totaltable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
            <span class="s2">&quot;Characters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;(BASE_CHARACTER_TYPECLASS + children)&quot;</span><span class="p">,</span>
            <span class="n">nchars</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nchars</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobjs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">totaltable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
            <span class="s2">&quot;Rooms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;(BASE_ROOM_TYPECLASS + children)&quot;</span><span class="p">,</span>
            <span class="n">nrooms</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nrooms</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobjs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">totaltable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
            <span class="s2">&quot;Exits&quot;</span><span class="p">,</span>
            <span class="s2">&quot;(BASE_EXIT_TYPECLASS + children)&quot;</span><span class="p">,</span>
            <span class="n">nexits</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nexits</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobjs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">totaltable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nother</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">nother</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobjs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

        <span class="c1"># typeclass table</span>
        <span class="n">typetable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">styled_table</span><span class="p">(</span>
            <span class="s2">&quot;|wtypeclass|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wcount|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|w%|n&quot;</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;l&quot;</span>
        <span class="p">)</span>
        <span class="n">typetable</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">dbtotals</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_typeclass_totals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">dbtotals</span><span class="p">:</span>
            <span class="n">typetable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;error&gt;&quot;</span><span class="p">),</span>
                <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;percent&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># last N table</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;db_date_created&quot;</span><span class="p">)[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nobjs</span> <span class="o">-</span> <span class="n">nlim</span><span class="p">)</span> <span class="p">:]</span>
        <span class="n">latesttable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">styled_table</span><span class="p">(</span>
            <span class="s2">&quot;|wcreated|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wdbref|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wname|n&quot;</span><span class="p">,</span> <span class="s2">&quot;|wtypeclass|n&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;table&quot;</span>
        <span class="p">)</span>
        <span class="n">latesttable</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="n">latesttable</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">datetime_format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">date_created</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">path</span>
            <span class="p">)</span>

        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|wObject subtype totals (out of </span><span class="si">%i</span><span class="s2"> Objects):|n</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nobjs</span><span class="p">,</span> <span class="n">totaltable</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|wObject typeclass distribution:|n</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">typetable</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|wLast </span><span class="si">%s</span><span class="s2"> Objects created:|n</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">nobjs</span><span class="p">,</span> <span class="n">nlim</span><span class="p">),</span> <span class="n">latesttable</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdTeleport">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTeleport">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdTeleport</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    teleport object to another location</span>

<span class="sd">    Usage:</span>
<span class="sd">      tel/switch [&lt;object&gt; to||=] &lt;target location&gt;</span>

<span class="sd">    Examples:</span>
<span class="sd">      tel Limbo</span>
<span class="sd">      tel/quiet box = Limbo</span>
<span class="sd">      tel/tonone box</span>

<span class="sd">    Switches:</span>
<span class="sd">      quiet  - don&#39;t echo leave/arrive messages to the source/target</span>
<span class="sd">               locations for the move.</span>
<span class="sd">      intoexit - if target is an exit, teleport INTO</span>
<span class="sd">                 the exit object instead of to its destination</span>
<span class="sd">      tonone - if set, teleport the object to a None-location. If this</span>
<span class="sd">               switch is set, &lt;target location&gt; is ignored.</span>
<span class="sd">               Note that the only way to retrieve</span>
<span class="sd">               an object from a None location is by direct #dbref</span>
<span class="sd">               reference. A puppeted object cannot be moved to None.</span>
<span class="sd">      loc - teleport object to the target&#39;s location instead of its contents</span>

<span class="sd">    Teleports an object somewhere. If no object is given, you yourself are</span>
<span class="sd">    teleported to the target location.</span>

<span class="sd">    To lock an object from being teleported, set its `teleport` lock, it will be</span>
<span class="sd">    checked with the caller. To block</span>
<span class="sd">    a destination from being teleported to, set the destination&#39;s `teleport_here`</span>
<span class="sd">    lock - it will be checked with the thing being teleported. Admins and</span>
<span class="sd">    higher permissions can always teleport.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@teleport&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="s2">&quot;@tel&quot;</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="s2">&quot;intoexit&quot;</span><span class="p">,</span> <span class="s2">&quot;tonone&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">)</span>
    <span class="n">rhs_split</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot; to &quot;</span><span class="p">)</span>  <span class="c1"># Prefer = delimiter, but allow &quot; to &quot; usage.</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(teleport) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

<div class="viewcode-block" id="CmdTeleport.parse">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTeleport.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Breaking out searching here to make this easier to override.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_to_teleport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_to_teleport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_to_teleport</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Did not find object to teleport.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InterruptCommand</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="CmdTeleport.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTeleport.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs the teleport&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">obj_to_teleport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_to_teleport</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>

        <span class="k">if</span> <span class="s2">&quot;tonone&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># teleporting to None</span>

            <span class="k">if</span> <span class="n">destination</span><span class="p">:</span>
                <span class="c1"># in this case lhs is always the object to teleport</span>
                <span class="n">obj_to_teleport</span> <span class="o">=</span> <span class="n">destination</span>

            <span class="k">if</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">has_account</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot teleport a puppeted object (</span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">, puppeted by&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">account</span><span class="si">}</span><span class="s2">) to a None-location.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teleported </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> -&gt; None-location.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span> <span class="ow">and</span> <span class="s2">&quot;quiet&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
                <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">msg_contents</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller</span><span class="si">}</span><span class="s2"> teleported </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> into nothingness.&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">caller</span>
                <span class="p">)</span>
            <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: teleport[/switches] [&lt;obj&gt; =] &lt;target or (X,Y,Z)&gt;||home&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Destination not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;loc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">location</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">destination</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Destination has no location.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">obj_to_teleport</span> <span class="o">==</span> <span class="n">destination</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You can&#39;t teleport an object inside of itself!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">obj_to_teleport</span> <span class="o">==</span> <span class="n">destination</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You can&#39;t teleport an object inside something it holds!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span> <span class="ow">and</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">destination</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> is already at </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># check any locks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;Admin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;teleport&quot;</span><span class="p">)):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> &#39;teleport&#39;-lock blocks you from teleporting it anywhere.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">destination</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">obj_to_teleport</span><span class="p">,</span> <span class="s2">&quot;teleport_here&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2"> &#39;teleport_here&#39;-lock blocks </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> from moving there.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># try the teleport</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="c1"># teleporting from none-location</span>
            <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">destination</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teleported </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> None -&gt; </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">obj_to_teleport</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span>
            <span class="n">destination</span><span class="p">,</span>
            <span class="n">quiet</span><span class="o">=</span><span class="s2">&quot;quiet&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">,</span>
            <span class="n">emit_to_obj</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
            <span class="n">use_destination</span><span class="o">=</span><span class="s2">&quot;intoexit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">,</span>
            <span class="n">move_type</span><span class="o">=</span><span class="s2">&quot;teleport&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">obj_to_teleport</span> <span class="o">==</span> <span class="n">caller</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teleported to </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teleported </span><span class="si">{</span><span class="n">obj_to_teleport</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Teleportation failed.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CmdTag">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTag">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdTag</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    handles the tags of an object</span>

<span class="sd">    Usage:</span>
<span class="sd">      tag[/del] &lt;obj&gt; [= &lt;tag&gt;[:&lt;category&gt;]]</span>
<span class="sd">      tag/search &lt;tag&gt;[:&lt;category]</span>

<span class="sd">    Switches:</span>
<span class="sd">      search - return all objects with a given Tag</span>
<span class="sd">      del - remove the given tag. If no tag is specified,</span>
<span class="sd">            clear all tags on object.</span>

<span class="sd">    Manipulates and lists tags on objects. Tags allow for quick</span>
<span class="sd">    grouping of and searching for objects.  If only &lt;obj&gt; is given,</span>
<span class="sd">    list all tags on the object.  If /search is used, list objects</span>
<span class="sd">    with the given tag.</span>
<span class="sd">    The category can be used for grouping tags themselves, but it</span>
<span class="sd">    should be used with restrain - tags on their own are usually</span>
<span class="sd">    enough to for most grouping schemes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@tag&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@tags&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;del&quot;</span><span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(tag) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>
    <span class="n">arg_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(/\w+?(\s|$))|\s|$&quot;</span>

<div class="viewcode-block" id="CmdTag.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdTag.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement the tag functionality&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Usage: tag[/switches] &lt;obj&gt; [= &lt;tag&gt;[:&lt;category&gt;]]&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s2">&quot;search&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># search by tag</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
            <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">objs</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">search_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="n">nobjs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nobjs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">catstr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot; (category: &#39;|w</span><span class="si">%s</span><span class="s2">|n&#39;)&quot;</span> <span class="o">%</span> <span class="n">category</span>
                    <span class="k">if</span> <span class="n">category</span>
                    <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nobjs</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot; (may have different tag categories)&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">matchstr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">)</span>

                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Found |w</span><span class="si">%i</span><span class="s2">|n object</span><span class="si">%s</span><span class="s2"> with tag &#39;|w</span><span class="si">%s</span><span class="s2">|n&#39;</span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">nobjs</span><span class="p">,</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nobjs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">tag</span><span class="p">,</span>
                    <span class="n">catstr</span><span class="p">,</span>
                    <span class="n">matchstr</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;No objects found with tag &#39;</span><span class="si">%s%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">tag</span><span class="p">,</span>
                    <span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s2">&quot;del&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># remove one or all tags</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
                <span class="c1"># remove individual tag</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
                <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">tag</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">):</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Removed tag &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">tag</span><span class="p">,</span>
                        <span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">obj</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;No tag &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2"> to delete on </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">tag</span><span class="p">,</span>
                        <span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">obj</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no tag specified, clear all tags</span>
                <span class="n">old_tags</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">old_tags</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Cleared all tags from </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">old_tags</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;No Tags to clear on </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">obj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># no search/deletion</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="c1"># = is found; command args are of the form obj = tag</span>
            <span class="c1"># first search locally, then global</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
            <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="c1"># create the tag</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Added tag &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">tag</span><span class="p">,</span>
                <span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">category</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">obj</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no = found - list tags on object</span>
            <span class="c1"># first search locally, then global</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">tagtuples</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">return_key_and_category</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ntags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tagtuples</span><span class="p">)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tagtuples</span><span class="p">]</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; (category: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tagtuples</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ntags</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Tag</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">ntags</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">obj</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">categories</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntags</span><span class="p">))),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No tags attached to </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>
</div>



<span class="c1"># helper functions for spawn</span>


<div class="viewcode-block" id="CmdSpawn">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSpawn">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CmdSpawn</span><span class="p">(</span><span class="n">COMMAND_DEFAULT_CLASS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    spawn objects from prototype</span>

<span class="sd">    Usage:</span>
<span class="sd">      spawn[/noloc] &lt;prototype_key&gt;</span>
<span class="sd">      spawn[/noloc] &lt;prototype_dict&gt;</span>

<span class="sd">      spawn/search [prototype_keykey][;tag[,tag]]</span>
<span class="sd">      spawn/list [tag, tag, ...]</span>
<span class="sd">      spawn/list modules    - list only module-based prototypes</span>
<span class="sd">      spawn/show [&lt;prototype_key&gt;]</span>
<span class="sd">      spawn/update &lt;prototype_key&gt;</span>

<span class="sd">      spawn/save &lt;prototype_dict&gt;</span>
<span class="sd">      spawn/edit [&lt;prototype_key&gt;]</span>
<span class="sd">      olc     - equivalent to spawn/edit</span>

<span class="sd">    Switches:</span>
<span class="sd">      noloc - allow location to be None if not specified explicitly. Otherwise,</span>
<span class="sd">              location will default to caller&#39;s current location.</span>
<span class="sd">      search - search prototype by name or tags.</span>
<span class="sd">      list - list available prototypes, optionally limit by tags.</span>
<span class="sd">      show, examine - inspect prototype by key. If not given, acts like list.</span>
<span class="sd">      raw - show the raw dict of the prototype as a one-line string for manual editing.</span>
<span class="sd">      save - save a prototype to the database. It will be listable by /list.</span>
<span class="sd">      delete - remove a prototype from database, if allowed to.</span>
<span class="sd">      update - find existing objects with the same prototype_key and update</span>
<span class="sd">               them with latest version of given prototype. If given with /save,</span>
<span class="sd">               will auto-update all objects with the old version of the prototype</span>
<span class="sd">               without asking first.</span>
<span class="sd">      edit, menu, olc - create/manipulate prototype in a menu interface.</span>

<span class="sd">    Example:</span>
<span class="sd">      spawn GOBLIN</span>
<span class="sd">      spawn {&quot;key&quot;:&quot;goblin&quot;, &quot;typeclass&quot;:&quot;monster.Monster&quot;, &quot;location&quot;:&quot;#2&quot;}</span>
<span class="sd">      spawn/save {&quot;key&quot;: &quot;grunt&quot;, prototype: &quot;goblin&quot;};;mobs;edit:all()</span>
<span class="sd">    \f</span>
<span class="sd">    Dictionary keys:</span>
<span class="sd">      |wprototype_parent  |n - name of parent prototype to use. Required if typeclass is</span>
<span class="sd">                        not set. Can be a path or a list for multiple inheritance (inherits</span>
<span class="sd">                        left to right). If set one of the parents must have a typeclass.</span>
<span class="sd">      |wtypeclass  |n - string. Required if prototype_parent is not set.</span>
<span class="sd">      |wkey        |n - string, the main object identifier</span>
<span class="sd">      |wlocation   |n - this should be a valid object or #dbref</span>
<span class="sd">      |whome       |n - valid object or #dbref</span>
<span class="sd">      |wdestination|n - only valid for exits (object or dbref)</span>
<span class="sd">      |wpermissions|n - string or list of permission strings</span>
<span class="sd">      |wlocks      |n - a lock-string</span>
<span class="sd">      |waliases    |n - string or list of strings.</span>
<span class="sd">      |wndb_|n&lt;name&gt;  - value of a nattribute (ndb_ is stripped)</span>

<span class="sd">      |wprototype_key|n   - name of this prototype. Unique. Used to store/retrieve from db</span>
<span class="sd">                            and update existing prototyped objects if desired.</span>
<span class="sd">      |wprototype_desc|n  - desc of this prototype. Used in listings</span>
<span class="sd">      |wprototype_locks|n - locks of this prototype. Limits who may use prototype</span>
<span class="sd">      |wprototype_tags|n  - tags of this prototype. Used to find prototype</span>

<span class="sd">      any other keywords are interpreted as Attributes and their values.</span>

<span class="sd">    The available prototypes are defined globally in modules set in</span>
<span class="sd">    settings.PROTOTYPE_MODULES. If spawn is used without arguments it</span>
<span class="sd">    displays a list of available prototypes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;@spawn&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;@olc&quot;</span><span class="p">]</span>
    <span class="n">switch_options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;noloc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;search&quot;</span><span class="p">,</span>
        <span class="s2">&quot;list&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show&quot;</span><span class="p">,</span>
        <span class="s2">&quot;raw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;examine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save&quot;</span><span class="p">,</span>
        <span class="s2">&quot;delete&quot;</span><span class="p">,</span>
        <span class="s2">&quot;menu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;olc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;update&quot;</span><span class="p">,</span>
        <span class="s2">&quot;edit&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;cmd:perm(spawn) or perm(Builder)&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="s2">&quot;Building&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search_prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prototype_key</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for prototype and handle no/multi-match and access.</span>

<span class="sd">        Returns a single found prototype or None - in the</span>
<span class="sd">        case, the caller has already been informed of the</span>
<span class="sd">        search error we need not do any further action.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prototypes</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
        <span class="n">nprots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prototypes</span><span class="p">)</span>

        <span class="c1"># handle the search result</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prototypes</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No prototype named &#39;</span><span class="si">{</span><span class="n">prototype_key</span><span class="si">}</span><span class="s2">&#39; was found.&quot;</span>
        <span class="k">elif</span> <span class="n">nprots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> prototypes matching &#39;</span><span class="si">{}</span><span class="s2">&#39;:</span><span class="se">\n</span><span class="s2">  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">nprots</span><span class="p">,</span>
                <span class="n">prototype_key</span><span class="p">,</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proto</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">prototypes</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we have a single prototype, check access</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">prototypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">check_lockstring</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">access_type</span><span class="o">=</span><span class="s2">&quot;spawn&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;You don&#39;t have access to use this prototype.&quot;</span>

        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># return None on any error</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">prototype</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a prototype dict or key from the input and convert it safely</span>
<span class="sd">        into a dict if appropriate.</span>

<span class="sd">        Args:</span>
<span class="sd">            inp (str): The input from user.</span>
<span class="sd">            expect (type, optional):</span>
<span class="sd">        Returns:</span>
<span class="sd">            prototype (dict, str or None): The parsed prototype. If None, the error</span>
<span class="sd">                was already reported.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eval_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">_LITERAL_EVAL</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># treat as string</span>
            <span class="n">eval_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># it&#39;s possible that the input was a prototype-key, in which case</span>
            <span class="c1"># it&#39;s okay for the LITERAL_EVAL to fail. Only if the result does not</span>
            <span class="c1"># match the expected type do we have a problem.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">expect</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">eval_err</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">eval_err</span><span class="si">}</span><span class="se">\n</span><span class="s2">|RCritical Python syntax error in argument. Only&quot;</span>
                        <span class="s2">&quot; primitive Python structures are allowed. </span><span class="se">\n</span><span class="s2">Make sure to use correct&quot;</span>
                        <span class="s2">&quot; Python syntax. Remember especially to put quotes around all strings&quot;</span>
                        <span class="s2">&quot; inside lists and dicts.|n For more advanced uses, embed funcparser&quot;</span>
                        <span class="s2">&quot; callables ($funcs) in the strings.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">expect</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">expect</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1"># an actual prototype. We need to make sure it&#39;s safe,</span>
            <span class="c1"># so don&#39;t allow exec.</span>
            <span class="c1"># TODO: Exec support is deprecated. Remove completely for 1.0.</span>
            <span class="k">if</span> <span class="s2">&quot;exec&quot;</span> <span class="ow">in</span> <span class="n">prototype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">check_permstring</span><span class="p">(</span><span class="s2">&quot;Developer&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Spawn aborted: You are not allowed to use the &#39;exec&#39; prototype key.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># we homogenize the prototype first, to be more lenient with free-form</span>
                <span class="n">protlib</span><span class="o">.</span><span class="n">validate_prototype</span><span class="p">(</span><span class="n">protlib</span><span class="o">.</span><span class="n">homogenize_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">return</span> <span class="n">prototype</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_prototype_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prototypes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the detailed specs of one or more prototypes.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str, optional): If this is given and `prototypes` is not, search for</span>
<span class="sd">                the prototype(s) by this query. This may be a partial query which</span>
<span class="sd">                may lead to multiple matches, all being displayed.</span>
<span class="sd">            prototypes (list, optional): If given, ignore `query` and only show these</span>
<span class="sd">                prototype-details.</span>
<span class="sd">        Returns:</span>
<span class="sd">            display (str, None): A formatted string of one or more prototype details.</span>
<span class="sd">                If None, the caller was already informed of the error.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prototypes</span><span class="p">:</span>
            <span class="c1"># we need to query. Note that if query is None, all prototypes will</span>
            <span class="c1"># be returned.</span>
            <span class="n">prototypes</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prototypes</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span> <span class="k">for</span> <span class="n">prot</span> <span class="ow">in</span> <span class="n">prototypes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No prototype named &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39; was found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No prototypes found.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_list_prototypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display prototypes as a list, optionally limited by key/tags.&quot;&quot;&quot;</span>
        <span class="n">protlib</span><span class="o">.</span><span class="n">list_prototypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

    <span class="nd">@interactive</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_existing_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span> <span class="n">prototype_key</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update existing objects (if any) with this prototype-key to the latest</span>
<span class="sd">        prototype version.</span>

<span class="sd">        Args:</span>
<span class="sd">            caller (Object): This is necessary for @interactive to work.</span>
<span class="sd">            prototype_key (str): The prototype to update.</span>
<span class="sd">            quiet (bool, optional): If set, don&#39;t report to user if no</span>
<span class="sd">                old objects were found to update.</span>
<span class="sd">        Returns:</span>
<span class="sd">            n_updated (int): Number of updated objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">existing_objects</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_objects_with_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No existing objects found with an older version of this prototype.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">existing_objects</span><span class="p">:</span>
            <span class="n">n_existing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_objects</span><span class="p">)</span>
            <span class="n">slow</span> <span class="o">=</span> <span class="s2">&quot; (note that this may be slow)&quot;</span> <span class="k">if</span> <span class="n">n_existing</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">n_existing</span><span class="si">}</span><span class="s2"> existing object(s) with an older version &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;of prototype &#39;</span><span class="si">{</span><span class="n">prototype_key</span><span class="si">}</span><span class="s2">&#39;. Should it be re-applied to them</span><span class="si">{</span><span class="n">slow</span><span class="si">}</span><span class="s2">? [Y]/N&quot;</span>
            <span class="p">)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">]:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;|rNo update was done of existing objects. &quot;</span>
                    <span class="s2">&quot;Use spawn/update &lt;key&gt; to apply later as needed.|n&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_updated</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">batch_update_objects_with_prototype</span><span class="p">(</span>
                    <span class="n">prototype</span><span class="p">,</span>
                    <span class="n">objects</span><span class="o">=</span><span class="n">existing_objects</span><span class="p">,</span>
                    <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log_trace</span><span class="p">()</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_updated</span><span class="si">}</span><span class="s2"> objects were updated.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_key_desc_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argstring</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse ;-separated input list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">argstring</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">argstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">argstring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">tags</span>

<div class="viewcode-block" id="CmdSpawn.func">
<a class="viewcode-back" href="../../../../api/evennia.commands.default.building.html#evennia.commands.default.building.CmdSpawn.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the spawner&quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span>
        <span class="n">noloc</span> <span class="o">=</span> <span class="s2">&quot;noloc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>

        <span class="c1"># run the menu/olc</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdstring</span> <span class="o">==</span> <span class="s2">&quot;olc&quot;</span>
            <span class="ow">or</span> <span class="s2">&quot;menu&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
            <span class="ow">or</span> <span class="s2">&quot;olc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
            <span class="ow">or</span> <span class="s2">&quot;edit&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span>
        <span class="p">):</span>
            <span class="c1"># OLC menu mode</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">:</span>
                <span class="n">prototype_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
                <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="n">olc_menus</span><span class="o">.</span><span class="n">start_olc</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;search&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># query for a key match. The arg is a search query or nothing.</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="c1"># an empty search returns the full list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_list_prototypes</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># search for key;tag combinations</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_key_desc_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list_prototypes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;raw&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># query for key match and return the prototype as a safe one-liner string.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You need to specify a prototype-key to get the raw data for.&quot;</span><span class="p">)</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_prototype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prototype</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;show&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;examine&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># show a specific prot detail. The argument is a search query or empty.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="c1"># we don&#39;t show the list of all details, that&#39;s too spammy.</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You need to specify a prototype-key to show.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">detail_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prototype_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">detail_string</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">detail_string</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># for list, all optional arguments are tags.</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhslist</span>
            <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_prototypes</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;No prototypes found with prototype-tag(s): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">list_to_string</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;save&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># store a prototype to the database store</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Usage: spawn/save [&lt;key&gt;[;desc[;tag,tag[,...][;lockstring]]]] =&quot;</span>
                    <span class="s2">&quot; &lt;prototype_dict&gt;&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
                <span class="c1"># input on the form key = prototype</span>
                <span class="n">prototype_key</span><span class="p">,</span> <span class="n">prototype_desc</span><span class="p">,</span> <span class="n">prototype_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_key_desc_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
                <span class="n">prototype_key</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype_key</span> <span class="k">else</span> <span class="n">prototype_key</span>
                <span class="n">prototype_desc</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype_desc</span> <span class="k">else</span> <span class="n">prototype_desc</span>
                <span class="n">prototype_tags</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype_tags</span> <span class="k">else</span> <span class="n">prototype_tags</span>
                <span class="n">prototype_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prototype_desc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">prototype_tags</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">prototype_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># handle parsing</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_prototype</span><span class="p">(</span><span class="n">prototype_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">prot_prototype_key</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">prototype_key</span> <span class="ow">or</span> <span class="n">prot_prototype_key</span><span class="p">):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;A prototype_key must be given, either as `prototype_key = &lt;prototype&gt;` &quot;</span>
                    <span class="s2">&quot;or as a key &#39;prototype_key&#39; inside the prototype structure.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">prototype_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prot_prototype_key</span>

            <span class="k">if</span> <span class="n">prot_prototype_key</span> <span class="o">!=</span> <span class="n">prototype_key</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;(Replacing `prototype_key` in prototype with given key.)&quot;</span><span class="p">)</span>
                <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prototype_key</span>

            <span class="k">if</span> <span class="n">prototype_desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prot_prototype_key</span> <span class="o">!=</span> <span class="n">prototype_desc</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;(Replacing `prototype_desc` in prototype with given desc.)&quot;</span><span class="p">)</span>
                <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prototype_desc</span>
            <span class="k">if</span> <span class="n">prototype_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_tags&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prototype_tags</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;(Replacing `prototype_tags` in prototype with given tag(s))&quot;</span><span class="p">)</span>
                <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prototype_tags</span>

            <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># check for existing prototype (exact match)</span>
            <span class="n">old_prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">diff</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">prototype_diff</span><span class="p">(</span><span class="n">old_prototype</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">homogenize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">diffstr</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">format_diff</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">new_prototype_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prototype_detail</span><span class="p">(</span><span class="n">prototypes</span><span class="o">=</span><span class="p">[</span><span class="n">prototype</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">old_prototype</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">diffstr</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|yAlready existing Prototype:|n</span><span class="se">\n</span><span class="si">{</span><span class="n">new_prototype_detail</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There seems to be no changes. Do you still want to (re)save? [Y]/N&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;|yExisting prototype &quot;</span><span class="si">{</span><span class="n">prototype_key</span><span class="si">}</span><span class="s1">&quot; found. Change:|n</span><span class="se">\n</span><span class="si">{</span><span class="n">diffstr</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s2">&quot;|yNew changed prototype:|n</span><span class="se">\n</span><span class="si">{</span><span class="n">new_prototype_detail</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">question</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|yDo you want to apply the change to the existing prototype?|n [Y]/N&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|yCreating new prototype:|n</span><span class="se">\n</span><span class="si">{</span><span class="n">new_prototype_detail</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to continue saving? [Y]/N&quot;</span>

            <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">string</span> <span class="o">+</span> <span class="n">question</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">]:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rSave cancelled.|n&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># all seems ok. Try to save.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prot</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">save_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prot</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError saving:|R </span><span class="si">{}</span><span class="s2">.|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="n">protlib</span><span class="o">.</span><span class="n">PermissionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rError saving:|R </span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|gSaved prototype:|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">))</span>

            <span class="c1"># check if we want to update existing objects</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_existing_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype_key</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># all switches beyond this point gets a common non-arg return</span>
            <span class="n">ncount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">())</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;Usage: spawn &lt;prototype-key&gt; or {{key: value, ...}}&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> (</span><span class="si">{</span><span class="n">ncount</span><span class="si">}</span><span class="s2"> existing prototypes. Use /list to inspect)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># remove db-based prototype</span>
            <span class="n">prototype_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prototype_detail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype_detail</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|rDeleting prototype:|n</span><span class="se">\n</span><span class="si">{</span><span class="n">prototype_detail</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to continue deleting? [Y]/N&quot;</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">string</span> <span class="o">+</span> <span class="n">question</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">]:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rDeletion cancelled.|n&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">delete_prototype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">protlib</span><span class="o">.</span><span class="n">PermissionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">retmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|rError deleting:|R </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">|n&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Deletion successful&quot;</span>
                    <span class="k">if</span> <span class="n">success</span>
                    <span class="k">else</span> <span class="s2">&quot;Deletion failed (does the prototype exist?)&quot;</span>
                <span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">retmsg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;update&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">switches</span><span class="p">:</span>
            <span class="c1"># update existing prototypes</span>
            <span class="n">prototype_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_existing_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype_key</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># If we get to this point, we use not switches but are trying a</span>
        <span class="c1"># direct creation of an object from a given prototype or -key</span>

        <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_prototype</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="nb">dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
            <span class="c1"># this will only let through dicts or strings</span>
            <span class="k">return</span>

        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&lt;unnamed&gt;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># A prototype key we are looking to apply</span>
            <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prototype</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># proceed to spawning</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">spawner</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Spawned </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">noloc</span><span class="p">:</span>
                    <span class="c1"># we don&#39;t hardcode the location in the prototype (unless the user</span>
                    <span class="c1"># did so manually) - that would lead to it having to be &#39;removed&#39; every</span>
                    <span class="c1"># time we try to update objects with this prototype in the future.</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.commands.default.building</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>