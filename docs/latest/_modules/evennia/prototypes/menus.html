<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.prototypes.menus &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.prototypes.menus</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.prototypes.menus</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">OLC Prototype menu nodes</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">choice</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.locks.lockhandler</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_all_lockfuncs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.objects.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectDB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.prototypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">prototypes</span> <span class="k">as</span> <span class="n">protlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.prototypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">spawner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">evmore</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.ansi</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_ansi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.evmenu</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvMenu</span><span class="p">,</span> <span class="n">list_node</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># OLC Prototype design menu</span>
<span class="c1">#</span>
<span class="c1"># ------------------------------------------------------------</span>

<span class="n">_MENU_CROP_WIDTH</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">_MENU_ATTR_LITERAL_EVAL_ERROR</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;|rCritical Python syntax error in your value. Only primitive Python structures are allowed.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;You also need to use correct Python syntax. Remember especially to put quotes around all &quot;</span>
    <span class="s2">&quot;strings inside lists and dicts.|n&quot;</span>
<span class="p">)</span>


<span class="c1"># Helper functions</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return currently active menu prototype.&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="p">,</span> <span class="s2">&quot;olc_prototype&quot;</span><span class="p">):</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span> <span class="o">=</span> <span class="n">prototype</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_new</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">prototype</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return prototype where parent values are included&quot;&quot;&quot;</span>
    <span class="n">flat_prototype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="p">,</span> <span class="s2">&quot;olc_flat_prototype&quot;</span><span class="p">):</span>
        <span class="n">flat_prototype</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_flat_prototype</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flat_prototype</span><span class="p">:</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_flat_prototype</span> <span class="o">=</span> <span class="n">flat_prototype</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">flatten_prototype</span><span class="p">(</span>
            <span class="n">prot</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">flat_prototype</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_unchanged_inherited</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">protname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return prototype values inherited from parent(s), which are not replaced in child&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">protname</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">protname</span><span class="p">[</span><span class="n">protname</span><span class="p">],</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flattened</span> <span class="o">=</span> <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protname</span> <span class="ow">in</span> <span class="n">flattened</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protname</span><span class="p">[</span><span class="n">protname</span><span class="p">],</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the prototype with existing one&quot;&quot;&quot;</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span> <span class="o">=</span> <span class="n">prototype</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_new</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">prototype</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_new_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if prototype is marked as new or was loaded from a saved one.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="p">,</span> <span class="s2">&quot;olc_new&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_option_value</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prototype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cropper</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format wizard option values.</span>

<span class="sd">    Args:</span>
<span class="sd">        prop (str): Name or value to format.</span>
<span class="sd">        required (bool, optional): The option is required.</span>
<span class="sd">        prototype (dict, optional): If given, `prop` will be considered a key in this prototype.</span>
<span class="sd">        cropper (callable, optional): A function to crop the value to a certain width.</span>

<span class="sd">    Returns:</span>
<span class="sd">        value (str): The formatted value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prototype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">prop</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_iter</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">and</span> <span class="n">required</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|runset&quot;</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">|n)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cropper</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="n">cropper</span> <span class="k">else</span> <span class="n">utils</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">_MENU_CROP_WIDTH</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set prototype&#39;s field in a safe way.&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">prototype</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span> <span class="o">=</span> <span class="n">prototype</span>
    <span class="k">return</span> <span class="n">prototype</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_property</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add or update a property. To be called by the &#39;goto&#39; option variable.</span>

<span class="sd">    Args:</span>
<span class="sd">        caller (Object, Account): The user of the wizard.</span>
<span class="sd">        raw_string (str): Input from user on given node - the new value to set.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        test_parse (bool): If set (default True), parse raw_string for protfuncs and obj-refs and</span>
<span class="sd">            try to run result through literal_eval. The parser will be run in &#39;testing&#39; mode and any</span>
<span class="sd">            parsing errors will shown to the user. Note that this is just for testing, the original</span>
<span class="sd">            given string will be what is inserted.</span>
<span class="sd">        prop (str): Property name to edit with `raw_string`.</span>
<span class="sd">        processor (callable): Converts `raw_string` to a form suitable for saving.</span>
<span class="sd">        next_node (str): Where to redirect to after this has run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        next_node (str): Next node to go to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prop&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_key&quot;</span><span class="p">)</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">next_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_node&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">processor</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">raw_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;Could not set </span><span class="si">{prop}</span><span class="s2"> to </span><span class="si">{value}</span><span class="s2"> (</span><span class="si">{err}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">value</span><span class="o">=</span><span class="n">raw_string</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># this means we&#39;ll re-run the current node.</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">raw_string</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">next_node</span>

    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span> <span class="o">=</span> <span class="n">prototype</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO simple way to get rid of the u&#39;&#39; markers in list reprs, remove this when on py3.</span>
        <span class="n">repr_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">repr_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; Set </span><span class="si">{prop}</span><span class="s2"> to </span><span class="si">{value}</span><span class="s2"> (</span><span class="si">{typ}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">repr_value</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_parse&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Simulating prototype-func parsing ...&quot;</span><span class="p">)</span>
        <span class="n">parsed_value</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">protfunc_parser</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot; |g(Example-)value when parsed (</span><span class="si">{}</span><span class="s2">):|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">parsed_value</span><span class="p">),</span> <span class="n">parsed_value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; |gNo change when parsed.&quot;</span><span class="p">)</span>

    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">next_node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_wizard_options</span><span class="p">(</span><span class="n">curr_node</span><span class="p">,</span> <span class="n">prev_node</span><span class="p">,</span> <span class="n">next_node</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;|W&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates default navigation options available in the wizard.&quot;&quot;&quot;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">prev_node</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wB|Wack&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{color}</span><span class="s2">(</span><span class="si">{node}</span><span class="s2">)|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">prev_node</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prev_node</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">next_node</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wF|Worward&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">),</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{color}</span><span class="s2">(</span><span class="si">{node}</span><span class="s2">)|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">next_node</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">next_node</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wI|Wndex&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">curr_node</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wV|Walidate prototype&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;node_validate_prototype&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="n">curr_node</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">search</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wSE|Warch objects&quot;</span><span class="p">,</span> <span class="s2">&quot;search object&quot;</span><span class="p">,</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;node_search_object&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="n">curr_node</span><span class="p">}),</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">actioninfo</span> <span class="o">=</span> <span class="n">string</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_path_cropper</span><span class="p">(</span><span class="n">pythonpath</span><span class="p">):</span>
    <span class="s2">&quot;Crop path to only the last component&quot;</span>
    <span class="k">return</span> <span class="n">pythonpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run validation on prototype&quot;&quot;&quot;</span>

    <span class="n">txt</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">|g No validation errors found.|n (but errors could still happen at spawn-time)&quot;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># validate, don&#39;t spawn</span>
        <span class="n">spawner</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">only_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">|r</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">RuntimeWarning</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">|y</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">txt</span> <span class="o">+</span> <span class="n">errors</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_protfuncs</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sorted_funcs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">protlib</span><span class="o">.</span><span class="n">FUNC_PARSER</span><span class="o">.</span><span class="n">callables</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">protfunc_name</span><span class="p">,</span> <span class="n">protfunc</span> <span class="ow">in</span> <span class="n">sorted_funcs</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;- |c$</span><span class="si">{name}</span><span class="s2">|n - |W</span><span class="si">{docs}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">protfunc_name</span><span class="p">,</span>
                <span class="n">docs</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">justify</span><span class="p">(</span><span class="n">protfunc</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_lockfuncs</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sorted_funcs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_all_lockfuncs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">lockfunc_name</span><span class="p">,</span> <span class="n">lockfunc</span> <span class="ow">in</span> <span class="n">sorted_funcs</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">(</span><span class="n">lockfunc</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;- |c$</span><span class="si">{name}</span><span class="s2">|n - |W</span><span class="si">{docs}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">lockfunc_name</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">justify</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_list_actions</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create footer text for nodes with extra list actions</span>

<span class="sd">    Args:</span>
<span class="sd">        actions (str): Available actions. The first letter of the action name will be assumed</span>
<span class="sd">            to be a shortcut.</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        prefix (str): Default prefix to use.</span>
<span class="sd">    Returns:</span>
<span class="sd">        string (str): Formatted footer for adding to the node text.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;|WSelect with |w&lt;num&gt;|W. Other actions:|n &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|w</span><span class="si">{}</span><span class="s2">|n|W</span><span class="si">{}</span><span class="s2"> |w&lt;num&gt;|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot; |W|||n &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">keyname</span><span class="p">,</span> <span class="n">comparer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">only_inherit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return current value, marking if value comes from parent or set in this prototype.</span>

<span class="sd">    Args:</span>
<span class="sd">        keyname (str): Name of prototoype key to get current value of.</span>
<span class="sd">        comparer (callable, optional): This will be called as comparer(prototype_value,</span>
<span class="sd">            flattened_value) and is expected to return the value to show as the current</span>
<span class="sd">            or inherited one. If not given, a straight comparison is used and what is returned</span>
<span class="sd">            depends on the only_inherit setting.</span>
<span class="sd">        formatter (callable, optional)): This will be called with the result of comparer.</span>
<span class="sd">        only_inherit (bool, optional): If a current value should only be shown if all</span>
<span class="sd">            the values are inherited from the prototype parent (otherwise, show an empty string).</span>
<span class="sd">    Returns:</span>
<span class="sd">        current (str): The current value.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_comparer</span><span class="p">(</span><span class="n">protval</span><span class="p">,</span> <span class="n">flatval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">only_inherit</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">protval</span> <span class="k">else</span> <span class="n">flatval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protval</span> <span class="k">if</span> <span class="n">protval</span> <span class="k">else</span> <span class="n">flatval</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">comparer</span><span class="p">):</span>
        <span class="n">comparer</span> <span class="o">=</span> <span class="n">_default_comparer</span>

    <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">flat_prot</span> <span class="o">=</span> <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">prot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">flat_prot</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">comparer</span><span class="p">(</span><span class="n">prot</span><span class="p">[</span><span class="n">keyname</span><span class="p">],</span> <span class="n">flat_prot</span><span class="p">[</span><span class="n">keyname</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">only_inherit</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="k">return</span> <span class="s2">&quot;|WCurrent|n </span><span class="si">{}</span><span class="s2"> |W(|binherited|W):|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;|WCurrent|n </span><span class="si">{}</span><span class="s2">|W:|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;|W[No </span><span class="si">{}</span><span class="s2"> set]|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">only_inherit</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">prot</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;|WCurrent|n </span><span class="si">{}</span><span class="s2">|W:|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">flat_prot</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">flat_prot</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;|WCurrent|n </span><span class="si">{}</span><span class="s2"> |W(|n|binherited|W):|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">only_inherit</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;|W[No </span><span class="si">{}</span><span class="s2"> set]|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_parse</span><span class="p">(</span><span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to parse default input to a node decorated with the node_list decorator on</span>
<span class="sd">    the form l1, l 2, look 1, etc. Spaces are ignored, as is case.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw_inp (str): Input from the user.</span>
<span class="sd">        choices (list): List of available options on the node listing (list of strings).</span>
<span class="sd">        args (tuples): The available actions, each specifed as a tuple (name, alias, ...)</span>
<span class="sd">    Returns:</span>
<span class="sd">        choice (str): A choice among the choices, or None if no match was found.</span>
<span class="sd">        action (str): The action operating on the choice, or None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_inp</span> <span class="o">=</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">}</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)\s*?(\d+)$&quot;</span> <span class="o">%</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">raw_inp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">choices</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">action</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="c1"># Menu nodes ------------------------------</span>

<span class="c1"># helper nodes</span>

<span class="c1"># validate prototype (available as option from all nodes)</span>


<div class="viewcode-block" id="node_validate_prototype">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_validate_prototype">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_validate_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;General node to view and validate a protototype&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">prev_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">_validate_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    The validator checks if the prototype&#39;s various values are on the expected form. It also tests</span>
<span class="s2">    any $protfuncs.</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prev_node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_&quot;</span> <span class="o">+</span> <span class="n">prev_node</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># node examine_entity</span>


<div class="viewcode-block" id="node_examine_entity">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_examine_entity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_examine_entity</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General node to view a text and then return to previous node.  Kwargs should contain &quot;text&quot; for</span>
<span class="sd">    the text to show and &#39;back&quot; pointing to the node to return to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Nothing was found here.&quot;</span><span class="p">)</span>
    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;Use |wback|n to return to the previous node.&quot;</span>
    <span class="n">prev_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prev_node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_&quot;</span> <span class="o">+</span> <span class="n">prev_node</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># node object_search</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_search_object</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="s2">&quot;update search term based on query stored on menu; store match too&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">searchstring</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_term</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">searchstring</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Must specify a search criterion.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">is_dbref</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dbref</span><span class="p">(</span><span class="n">searchstring</span><span class="p">)</span>
    <span class="n">is_account</span> <span class="o">=</span> <span class="n">searchstring</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_dbref</span> <span class="ow">or</span> <span class="n">is_account</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_dbref</span><span class="p">:</span>
            <span class="c1"># a dbref search</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">global_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># an account search</span>
            <span class="n">searchstring</span> <span class="o">=</span> <span class="n">searchstring</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">search_account</span><span class="p">(</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keyquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">db_key__istartswith</span><span class="o">=</span><span class="n">searchstring</span><span class="p">)</span>
        <span class="n">aliasquery</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
            <span class="n">db_tags__db_key__istartswith</span><span class="o">=</span><span class="n">searchstring</span><span class="p">,</span> <span class="n">db_tags__db_tagtype__iexact</span><span class="o">=</span><span class="s2">&quot;alias&quot;</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">ObjectDB</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">keyquery</span> <span class="o">|</span> <span class="n">aliasquery</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Searching for &#39;</span><span class="si">{}</span><span class="s2">&#39; ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">searchstring</span><span class="p">))</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_matches</span> <span class="o">=</span> <span class="n">results</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(#</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_object_search_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">obj_entry</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;available_choices&quot;</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obj_entry</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_matches</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;examine&quot;</span><span class="p">):</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rYou don&#39;t have &#39;examine&#39; access on this object.|n&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_term</span>
        <span class="k">return</span> <span class="s2">&quot;node_search_object&quot;</span>

    <span class="n">prot</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">prototype_from_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;search_object&quot;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_object_search_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;All this does is to queue a search query&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;available_choices&quot;</span><span class="p">]</span>
    <span class="n">obj_entry</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;create prototype from object&quot;</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">raw_inp</span> <span class="o">=</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">obj_entry</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obj_entry</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_matches</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">prototype_from_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;examine&quot;</span><span class="p">):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|rYou don&#39;t have &#39;examine&#39; access on this object.|n&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_term</span>
                <span class="k">return</span> <span class="s2">&quot;node_search_object&quot;</span>

            <span class="n">txt</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prot</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;search_object&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># load prototype</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">):</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rYou don&#39;t have access to do this with this object.|n&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_term</span>
                <span class="k">return</span> <span class="s2">&quot;node_search_object&quot;</span>

            <span class="n">_set_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prot</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Created prototype from object.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_index&quot;</span>
    <span class="k">elif</span> <span class="n">raw_inp</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_term</span> <span class="o">=</span> <span class="n">raw_inp</span>
        <span class="k">return</span> <span class="s2">&quot;node_search_object&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># empty input - exit back to previous node</span>
        <span class="n">prev_node</span> <span class="o">=</span> <span class="s2">&quot;node_&quot;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prev_node</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_search_object</span><span class="p">,</span> <span class="n">_object_search_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_search_object</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node for searching for an existing object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_search_object_matches</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nmatches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="n">prev_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Found </span><span class="si">{num}</span><span class="s2"> match</span><span class="si">{post}</span><span class="s2">.</span>

<span class="s2">         (|RWarning: creating a prototype will |roverwrite|r |Rthe current prototype!)|n&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">num</span><span class="o">=</span><span class="n">nmatches</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;es&quot;</span> <span class="k">if</span> <span class="n">nmatches</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">_set_actioninfo</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;create prototype from object&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Enter search criterion.&quot;</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You can search objects by specifying partial key, alias or its exact #dbref. Use *query to</span>
<span class="s2">        search for an Account instead.</span>

<span class="s2">        Once having found any matches you can choose to examine it or use |ccreate prototype from</span>
<span class="s2">        object|n. If doing the latter, a prototype will be calculated from the selected object and</span>
<span class="s2">        loaded as the new &#39;current&#39; prototype. This is useful for having a base to build from but be</span>
<span class="s2">        careful you are not throwing away any existing, unsaved, prototype work!</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prev_node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_object_search_actions</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="n">prev_node</span><span class="p">})})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># main index (start page) node</span>


<div class="viewcode-block" id="node_index">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_index</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">       |c --- Prototype wizard --- |n</span>
<span class="s2">       </span><span class="si">%s</span>

<span class="s2">       A |cprototype|n is a &#39;template&#39; for |wspawning|n an in-game entity. A field of the prototype</span>
<span class="s2">       can either be hard-coded, left empty or scripted using |w$protfuncs|n - for example to</span>
<span class="s2">       randomize the value every time a new entity is spawned. The fields whose names start with</span>
<span class="s2">       &#39;Prototype-&#39; are not fields on the object itself but are used for prototype-inheritance, or</span>
<span class="s2">       when saving and loading.</span>

<span class="s2">       Select prototype field to edit. If you are unsure, start from [|w1|n]. Enter [|wh|n]elp at</span>
<span class="s2">       any menu node for more info.</span>

<span class="s2">       &quot;&quot;&quot;</span>
    <span class="n">helptxt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">       |c- prototypes |n</span>

<span class="s2">       A prototype is really just a Python dictionary. When spawning, this dictionary is essentially</span>
<span class="s2">       passed into `|wevennia.utils.create.create_object(**prototype)|n` to create a new object. By</span>
<span class="s2">       using different prototypes you can customize instances of objects without having to do code</span>
<span class="s2">       changes to their typeclass (something which requires code access). The classical example is</span>
<span class="s2">       to spawn goblins with different names, looks, equipment and skill, each based on the same</span>
<span class="s2">       `Goblin` typeclass.</span>

<span class="s2">       At any time you can [|wV|n]alidate that the prototype works correctly and use it to</span>
<span class="s2">       [|wSP|n]awn a new entity. You can also [|wSA|n]ve|n your work, [|wLO|n]oad an existing</span>
<span class="s2">       prototype to [|wSE|n]arch for existing objects to use as a base. Use [|wL|n]ook to re-show a</span>
<span class="s2">       menu node. [|wQ|n]uit will always exit the menu and [|wH|n]elp will show context-sensitive</span>
<span class="s2">       help.</span>


<span class="s2">       |c- $protfuncs |n</span>

<span class="s2">       Prototype-functions (protfuncs) allow for limited scripting within a prototype. These are</span>
<span class="s2">       entered as a string $funcname(arg, arg, ...) and are evaluated |wat the time of spawning|n</span>
<span class="s2">       only.  They can also be nested for combined effects.</span>

<span class="s2">       </span><span class="si">{pfuncs}</span>
<span class="s2">       &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># If a prototype is being edited, show its key and</span>
    <span class="c1"># prototype_key under the title</span>
    <span class="n">loaded_prototype</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;prototype_key&quot;</span> <span class="ow">in</span> <span class="n">prototype</span> <span class="ow">or</span> <span class="s2">&quot;key&quot;</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">:</span>
        <span class="n">loaded_prototype</span> <span class="o">=</span> <span class="s2">&quot; --- Editing: |y</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)|n --- &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">%</span> <span class="p">(</span><span class="n">loaded_prototype</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptxt</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;|WPrototype-Key|n|n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_format_option_value</span><span class="p">(</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_key&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;Prototype_Parent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Typeclass&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Aliases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Attrs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Locks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Permissions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Home&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Destination&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">required</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cropper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Prototype_Parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Typeclass&quot;</span><span class="p">):</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;prototype_parent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;typeclass&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prototype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Typeclass&quot;</span><span class="p">:</span>
            <span class="n">cropper</span> <span class="o">=</span> <span class="n">_path_cropper</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">|n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;|W&quot;</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Prototype_Parent&quot;</span> <span class="k">else</span> <span class="s2">&quot;|w&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                    <span class="n">_format_option_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">cropper</span><span class="o">=</span><span class="n">cropper</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Desc&quot;</span><span class="p">,</span> <span class="s2">&quot;Tags&quot;</span><span class="p">,</span> <span class="s2">&quot;Locks&quot;</span><span class="p">):</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;|WPrototype-</span><span class="si">{}</span><span class="s2">|n|n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">_format_option_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wV|Walidate prototype&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_validate_prototype&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wSA|Wve prototype&quot;</span><span class="p">,</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;sa&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_save&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wSP|Wawn prototype&quot;</span><span class="p">,</span> <span class="s2">&quot;spawn&quot;</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_spawn&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wLO|Wad prototype&quot;</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="s2">&quot;lo&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_load&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wSE|Warch objects|n&quot;</span><span class="p">,</span> <span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">),</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_search_object&quot;</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype_key node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_check_prototype_key</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">old_prototype</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">olc_new</span> <span class="o">=</span> <span class="n">_is_new_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">old_prototype</span><span class="p">:</span>
        <span class="n">old_prototype</span> <span class="o">=</span> <span class="n">old_prototype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># we are starting a new prototype that matches an existing</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">caller</span><span class="o">.</span><span class="n">locks</span><span class="o">.</span><span class="n">check_lockstring</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span> <span class="n">old_prototype</span><span class="p">[</span><span class="s2">&quot;prototype_locks&quot;</span><span class="p">],</span> <span class="n">access_type</span><span class="o">=</span><span class="s2">&quot;edit&quot;</span>
        <span class="p">):</span>
            <span class="c1"># return to the node_prototype_key to try another key</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s2">&quot;Prototype &#39;</span><span class="si">{key}</span><span class="s2">&#39; already exists and you don&#39;t &quot;</span>
                <span class="s2">&quot;have permission to edit it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_prototype_key&quot;</span>
        <span class="k">elif</span> <span class="n">olc_new</span><span class="p">:</span>
            <span class="c1"># we are selecting an existing prototype to edit. Reset to index.</span>
            <span class="k">del</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_new</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">_menutree</span><span class="o">.</span><span class="n">olc_prototype</span> <span class="o">=</span> <span class="n">old_prototype</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Prototype already exists. Reloading.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_index&quot;</span>

    <span class="k">return</span> <span class="n">_set_property</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="node_prototype_key">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_prototype_key">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_key</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cPrototype-Key|n uniquely identifies the prototype and is |wmandatory|n. It is used to</span>
<span class="s2">        find and use the prototype to spawn new entities. It is not case sensitive.</span>

<span class="s2">        (To set a new value, just write it and press enter)</span>

<span class="s2">        </span><span class="si">{current}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_key&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The prototype-key is not itself used when spawnng the new object, but is only used for</span>
<span class="s2">        managing, storing and loading the prototype. It must be globally unique, so existing keys</span>
<span class="s2">        will be checked before a new key is accepted. If an existing key is picked, the existing</span>
<span class="s2">        prototype will be loaded.</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_parent&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_check_prototype_key</span><span class="p">})</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype_parents node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_all_prototype_parents</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return prototype_key of all available prototypes for listing in menu&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">prototype</span> <span class="ow">in</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;prototype_key&quot;</span> <span class="ow">in</span> <span class="n">prototype</span>
    <span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_parent_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the default Convert prototype to a string representation for closer inspection&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">prototype_parent</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">prototype_parent</span><span class="p">:</span>
        <span class="c1"># a selection of parent was made</span>
        <span class="n">prototype_parent</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">prototype_parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prototype_parent_key</span> <span class="o">=</span> <span class="n">prototype_parent</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>

        <span class="c1"># which action to apply on the selection</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="c1"># examine the prototype</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prototype_parent</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;back&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;prototype_parent&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="c1"># add/append parent</span>
            <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
            <span class="n">current_prot_parent</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_prot_parent</span><span class="p">:</span>
                <span class="n">current_prot_parent</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_iter</span><span class="p">(</span><span class="n">current_prot_parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prototype_parent_key</span> <span class="ow">in</span> <span class="n">current_prot_parent</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Prototype_parent </span><span class="si">{}</span><span class="s2"> is already used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_parent_key</span><span class="p">))</span>
                    <span class="k">return</span> <span class="s2">&quot;node_prototype_parent&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_prot_parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prototype_parent_key</span><span class="p">)</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Add prototype parent for multi-inheritance.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_prot_parent</span> <span class="o">=</span> <span class="n">prototype_parent_key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prototype_parent</span><span class="p">:</span>
                    <span class="n">spawner</span><span class="o">.</span><span class="n">flatten_prototype</span><span class="p">(</span><span class="n">prototype_parent</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not found.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s2">&quot;Selected prototype-parent </span><span class="si">{}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;caused Error(s):</span><span class="se">\n</span><span class="s2">|r</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_parent</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;node_prototype_parent&quot;</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="n">current_prot_parent</span><span class="p">)</span>
            <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="c1"># remove prototype parent</span>
            <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
            <span class="n">current_prot_parent</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_prot_parent</span><span class="p">:</span>
                <span class="n">current_prot_parent</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_iter</span><span class="p">(</span><span class="n">current_prot_parent</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_prot_parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prototype_parent_key</span><span class="p">)</span>
                    <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="n">current_prot_parent</span><span class="p">)</span>
                    <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Removed prototype parent </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_parent_key</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                        <span class="s2">&quot;|rPrototype-parent </span><span class="si">{}</span><span class="s2"> could not be removed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_parent_key</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;node_prototype_parent&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_parent_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prototype_parent</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">new_parent</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prototype_parent</span><span class="p">:</span>
            <span class="n">spawner</span><span class="o">.</span><span class="n">flatten_prototype</span><span class="p">(</span><span class="n">prototype_parent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not found.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s2">&quot;Selected prototype-parent </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="s2">&quot;caused Error(s):</span><span class="se">\n</span><span class="s2">|r</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_parent</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">_set_property</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="n">new_parent</span><span class="p">,</span>
            <span class="n">prop</span><span class="o">=</span><span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span>
            <span class="n">processor</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">next_node</span><span class="o">=</span><span class="s2">&quot;node_prototype_parent&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_get_flat_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Selected prototype parent |c</span><span class="si">{}</span><span class="s2">|n.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_parent</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_all_prototype_parents</span><span class="p">,</span> <span class="n">_prototype_parent_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_parent</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="n">prot_parent_keys</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_parent&quot;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cPrototype Parent|n allows you to |winherit|n prototype values from another named</span>
<span class="s2">        prototype (given as that prototype&#39;s |wprototype_key|n).  If not changing these values in</span>
<span class="s2">        the current prototype, the parent&#39;s value will be used. Pick the available prototypes below.</span>

<span class="s2">        Note that somewhere in the prototype&#39;s parentage, a |ctypeclass|n must be specified. If no</span>
<span class="s2">        parent is given, this prototype must define the typeclass (next menu node).</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Prototypes can inherit from one another. Changes in the child replace any values set in a</span>
<span class="s2">        parent. The |wtypeclass|n key must exist |wsomewhere|n in the parent chain for the</span>
<span class="s2">        prototype to be valid.</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">))</span>

    <span class="n">ptexts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">prot_parent_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_iter</span><span class="p">(</span><span class="n">prot_parent_keys</span><span class="p">):</span>
            <span class="n">prot_parent</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">pkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prot_parent</span><span class="p">:</span>
                <span class="n">prot_parent</span> <span class="o">=</span> <span class="n">prot_parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ptexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;|c -- </span><span class="si">{pkey}</span><span class="s2"> -- |n</span><span class="se">\n</span><span class="si">{prot}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">pkey</span><span class="o">=</span><span class="n">pkey</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prot_parent</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Prototype parent |r</span><span class="si">{pkey}</span><span class="s2"> was not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkey</span><span class="o">=</span><span class="n">pkey</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ptexts</span><span class="p">:</span>
        <span class="n">ptexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;[No prototype_parent set]&quot;</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ptexts</span><span class="p">))</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;|W&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_prototype_parent_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># typeclasses node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_all_typeclasses</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get name of available typeclasses.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">name</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_all_typeclasses</span><span class="p">(</span><span class="s2">&quot;evennia.objects.models.ObjectDB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;evennia.objects.models.ObjectDB&quot;</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_typeclass_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for typeclass listing&quot;&quot;&quot;</span>

    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">typeclass_path</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">typeclass_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="n">typeclass</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_all_typeclasses</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typeclass_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">typeclass</span><span class="p">:</span>
                <span class="n">docstr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">typeclass</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">docstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">docstr</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">docstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="k">if</span> <span class="n">docstr</span> <span class="k">else</span> <span class="s2">&quot;&lt;empty&gt;&quot;</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Typeclass |c</span><span class="si">{typeclass_path}</span><span class="s2">|n; &quot;</span>
                    <span class="s2">&quot;First paragraph of docstring:</span><span class="se">\n\n</span><span class="si">{docstring}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">typeclass_path</span><span class="o">=</span><span class="n">typeclass_path</span><span class="p">,</span> <span class="n">docstring</span><span class="o">=</span><span class="n">docstr</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;This is typeclass |y</span><span class="si">{}</span><span class="s2">|n.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typeclass</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;typeclass&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
            <span class="n">old_typeclass</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_typeclass</span><span class="p">:</span>
                <span class="n">_set_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype</span><span class="p">)</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Cleared typeclass </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_typeclass</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No typeclass to remove.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;node_typeclass&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_typeclass_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">typeclass</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select typeclass from list and add it to prototype. Return next node to go to.&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">_set_property</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">typeclass</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Selected typeclass |c</span><span class="si">{}</span><span class="s2">|n.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typeclass</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_all_typeclasses</span><span class="p">,</span> <span class="n">_typeclass_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_typeclass</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cTypeclass|n defines what &#39;type&#39; of object this is - the actual working code to use.</span>

<span class="s2">        All spawned objects must have a typeclass. If not given here, the typeclass must be set in</span>
<span class="s2">        one of the prototype&#39;s |cparents|n.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;typeclass&quot;</span><span class="p">),</span>
        <span class="n">actions</span><span class="o">=</span><span class="s2">&quot;|WSelect with |w&lt;num&gt;|W. Other actions: &quot;</span>
        <span class="s2">&quot;|we|Wxamine |w&lt;num&gt;|W, |wr|Wemove selection&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        A |nTypeclass|n is specified by the actual python-path to the class definition in the</span>
<span class="s2">        Evennia code structure.</span>

<span class="s2">        Which |cAttributes|n, |cLocks|n and other properties have special</span>
<span class="s2">        effects or expects certain values depend greatly on the code in play.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;|W&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_typeclass_actions</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># key node</span>


<div class="viewcode-block" id="node_key">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_key">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_key</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cKey|n is the given name of the object to spawn. This will retain the given case.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The key should often not be identical for every spawned object. Using a randomising</span>
<span class="s2">        $protfunc can be used, for example |c$choice(Alan, Tom, John)|n will give one of the three</span>
<span class="s2">        names every time an object of this prototype is spawned.</span>

<span class="s2">        |c$protfuncs|n</span>
<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;typeclass&quot;</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_set_property</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># aliases node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_all_aliases</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="s2">&quot;Get aliases in prototype&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="p">[])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_aliases_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
    <span class="s2">&quot;Add numbers as aliases&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="n">_all_aliases</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">aliases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Added alias &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;node_aliases&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_aliases_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for aliases listing&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">alias</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span><span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">))</span>

    <span class="n">aliases</span> <span class="o">=</span> <span class="n">_all_aliases</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alias</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aliases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Removed alias &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;No matching alias found to remove.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if not a valid remove, add as a new alias</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">and</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Added alias &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Alias &#39;</span><span class="si">{}</span><span class="s2">&#39; was already set.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;node_aliases&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_all_aliases</span><span class="p">,</span> <span class="n">_aliases_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_aliases</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cAliases|n are alternative ways to address an object, next to its |cKey|n.  Aliases are not</span>
<span class="s2">        case sensitive.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;aliases&quot;</span><span class="p">,</span>
            <span class="n">comparer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">propval</span><span class="p">,</span> <span class="n">flatval</span><span class="p">:</span> <span class="p">[</span><span class="n">al</span> <span class="k">for</span> <span class="n">al</span> <span class="ow">in</span> <span class="n">flatval</span> <span class="k">if</span> <span class="n">al</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">propval</span><span class="p">],</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span>
        <span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;|w&lt;text&gt;|W to add new alias. Other action: &quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Aliases are fixed alternative identifiers and are stored with the new object.</span>

<span class="s2">        |c$protfuncs|n</span>

<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_aliases_actions</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># attributes node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_attrs</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">utils</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">attrs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_tup_by_attrname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span><span class="p">[</span><span class="n">inp</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_display_attribute</span><span class="p">(</span><span class="n">attr_tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pretty-print attribute tuple&quot;&quot;&quot;</span>
    <span class="n">attrkey</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">locks</span> <span class="o">=</span> <span class="n">attr_tuple</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">protfunc_parser</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{attrkey}</span><span class="s2"> |c=|n </span><span class="si">{value}</span><span class="s2"> |W(</span><span class="si">{typ}{category}{locks}</span><span class="s2">)|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">attrkey</span><span class="o">=</span><span class="n">attrkey</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">,</span>
        <span class="n">category</span><span class="o">=</span><span class="s2">&quot;, category=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">locks</span><span class="o">=</span><span class="s2">&quot;, locks=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locks</span><span class="p">))</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">locks</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_attr</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attr_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add new attribute, parsing input.</span>

<span class="sd">    Args:</span>
<span class="sd">        caller (Object): Caller of menu.</span>
<span class="sd">        attr_string (str): Input from user</span>
<span class="sd">            attr is entered on these forms</span>
<span class="sd">                attr = value</span>
<span class="sd">                attr;category = value</span>
<span class="sd">                attr;category;lockstring = value</span>
<span class="sd">    Keyword Args:</span>
<span class="sd">        delete (str): If this is set, attr_string is</span>
<span class="sd">            considered the name of the attribute to delete and</span>
<span class="sd">            no further parsing happens.</span>
<span class="sd">    Returns:</span>
<span class="sd">        result (str): Result string of action.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">attrname</span> <span class="o">=</span> <span class="n">attr_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">attr_string</span><span class="p">:</span>
        <span class="n">attrname</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">attr_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">attrname</span> <span class="o">=</span> <span class="n">attrname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">nameparts</span> <span class="o">=</span> <span class="n">attrname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">nparts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameparts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nparts</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">attrname</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="n">nameparts</span>
        <span class="k">elif</span> <span class="n">nparts</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">attrname</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">locks</span> <span class="o">=</span> <span class="n">nameparts</span>
    <span class="n">attr_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">locks</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">attrname</span><span class="p">:</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">attrs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Removed Attribute &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Attribute to delete not found.&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># replace existing attribute with the same name in the prototype</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_tuple</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Edited Attribute &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_tuple</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Added Attribute &quot;</span> <span class="o">+</span> <span class="n">_display_attribute</span><span class="p">(</span><span class="n">attr_tuple</span><span class="p">)</span>

        <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Attribute must be given as &#39;attrname[;category;locks] = &lt;value&gt;&#39;.&quot;</span>

    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_attr_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attrstr</span><span class="p">):</span>
    <span class="n">attrname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attrstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">attrname</span> <span class="o">=</span> <span class="n">attrname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">attr_tup</span> <span class="o">=</span> <span class="n">_get_tup_by_attrname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr_tup</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_attribute</span><span class="p">(</span><span class="n">attr_tup</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;attrs&quot;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Attribute not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;node_attrs&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_attrs_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for attribute listing&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">attrstr</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">attrstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attrstr</span> <span class="o">=</span> <span class="n">raw_inp</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attrname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attrstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rNeed to enter the attribute on the form attrname=value.|n&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;node_attrs&quot;</span>

    <span class="n">attrname</span> <span class="o">=</span> <span class="n">attrname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">attr_tup</span> <span class="o">=</span> <span class="n">_get_tup_by_attrname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">action</span> <span class="ow">and</span> <span class="n">attr_tup</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_attribute</span><span class="p">(</span><span class="n">attr_tup</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;attrs&quot;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_add_attr</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_add_attr</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;node_attrs&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_attrs</span><span class="p">,</span> <span class="n">_attr_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_attrs</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_currentcmp</span><span class="p">(</span><span class="n">propval</span><span class="p">,</span> <span class="n">flatval</span><span class="p">):</span>
        <span class="s2">&quot;match by key + category&quot;</span>
        <span class="n">cmp1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">propval</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tup</span>
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">flatval</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmp1</span>
        <span class="p">]</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cAttributes|n are custom properties of the object. Enter attributes on one of these forms:</span>

<span class="s2">        attrname=value</span>
<span class="s2">        attrname;category=value</span>
<span class="s2">        attrname;category;lockstring=value</span>

<span class="s2">        To give an attribute without a category but with a lockstring, leave that spot empty</span>
<span class="s2">        (attrname;;lockstring=value). Attribute values can have embedded $protfuncs.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">,</span>
            <span class="n">comparer</span><span class="o">=</span><span class="n">_currentcmp</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_display_attribute</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">))</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Most commonly, Attributes don&#39;t need any categories or locks. If using locks, the lock-types</span>
<span class="s2">        &#39;attredit&#39; and &#39;attrread&#39; are used to limit editing and viewing of the Attribute. Putting</span>
<span class="s2">        the lock-type `attrcreate` in the |clocks|n prototype key can be used to restrict builders</span>
<span class="s2">        from adding new Attributes.</span>

<span class="s2">        |c$protfuncs</span>

<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_attrs_actions</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># tags node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_tags</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">tags</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_tup_by_tagname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tagname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="n">inp</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_display_tag</span><span class="p">(</span><span class="n">tag_tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pretty-print tag tuple&quot;&quot;&quot;</span>
    <span class="n">tagkey</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">tag_tuple</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;Tag: &#39;</span><span class="si">{tagkey}</span><span class="s2">&#39; (category: </span><span class="si">{category}{dat}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tagkey</span><span class="o">=</span><span class="n">tagkey</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">dat</span><span class="o">=</span><span class="s2">&quot;, data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tag_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add tags to the system, parsing input</span>

<span class="sd">    Args:</span>
<span class="sd">        caller (Object): Caller of menu.</span>
<span class="sd">        tag_string (str): Input from user on one of these forms</span>
<span class="sd">            tagname</span>
<span class="sd">            tagname;category</span>
<span class="sd">            tagname;category;data</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        delete (str): If this is set, tag_string is considered</span>
<span class="sd">            the name of the tag to delete.</span>

<span class="sd">    Returns:</span>
<span class="sd">        result (str): Result string of action.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nameparts</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ntuple</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameparts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntuple</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="n">nameparts</span>
        <span class="k">elif</span> <span class="n">ntuple</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">nameparts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">tag_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">category</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="n">prot</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">old_tag</span> <span class="o">=</span> <span class="n">_get_tup_by_tagname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_tag</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_tag</span><span class="p">))</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Removed Tag &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Found no Tag to remove.&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">old_tag</span><span class="p">:</span>
            <span class="c1"># a fresh, new tag</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_tuple</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Added Tag &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># old tag exists; editing a tag means replacing old with new</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_tag</span><span class="p">)</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_tuple</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Edited Tag &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Tag must be given as &#39;tag[;category;data]&#39;.&quot;</span>

    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_tag_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">):</span>
    <span class="n">tag_tup</span> <span class="o">=</span> <span class="n">_get_tup_by_tagname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tag_tup</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_tag</span><span class="p">(</span><span class="n">tag_tup</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;attrs&quot;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Tag not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;node_attrs&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_tags_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for tags listing&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">tagname</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">tagname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tagname</span> <span class="o">=</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">tag_tup</span> <span class="o">=</span> <span class="n">_get_tup_by_tagname</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tag_tup</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_tag</span><span class="p">(</span><span class="n">tag_tup</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;tags&quot;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_add_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_add_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;node_tags&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_tags</span><span class="p">,</span> <span class="n">_tag_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_tags</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_currentcmp</span><span class="p">(</span><span class="n">propval</span><span class="p">,</span> <span class="n">flatval</span><span class="p">):</span>
        <span class="s2">&quot;match by key + category&quot;</span>
        <span class="n">cmp1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">propval</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tup</span>
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">flatval</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmp1</span>
        <span class="p">]</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cTags|n are used to group objects so they can quickly be found later. Enter tags on one of</span>
<span class="s2">        the following forms:</span>
<span class="s2">            tagname</span>
<span class="s2">            tagname;category</span>
<span class="s2">            tagname;category;data</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
            <span class="n">comparer</span><span class="o">=</span><span class="n">_currentcmp</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_display_tag</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">))</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Tags are shared between all objects with that tag. So the &#39;data&#39; field (which is not</span>
<span class="s2">        commonly used) can only hold eventual info about the Tag itself, not about the individual</span>
<span class="s2">        object on which it sits.</span>

<span class="s2">        All objects created with this prototype will automatically get assigned a tag named the same</span>
<span class="s2">        as the |cprototype_key|n and with a category &quot;</span><span class="si">{tag_category}</span><span class="s2">&quot;. This allows the spawner to</span>
<span class="s2">        optionally update previously spawned objects when their prototype changes.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tag_category</span><span class="o">=</span><span class="n">protlib</span><span class="o">.</span><span class="n">PROTOTYPE_TAG_CATEGORY</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="s2">&quot;locks&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_tags_actions</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># locks node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;locks&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lck</span> <span class="k">for</span> <span class="n">lck</span> <span class="ow">in</span> <span class="n">locks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">lck</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lock</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lock_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lockstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lockstr</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;locks&quot;</span><span class="p">})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="n">_caller_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">locktype</span><span class="p">,</span> <span class="n">lockdef</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lockstring lacks &#39;:&#39;.&quot;</span>

    <span class="n">locktype</span> <span class="o">=</span> <span class="n">locktype</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">locks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
            <span class="n">locks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;locks&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locks</span><span class="p">),</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Lock </span><span class="si">{}</span><span class="s2"> deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;No lock found to delete.&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">locktypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lck</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">lck</span> <span class="ow">in</span> <span class="n">locks</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">locktypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">locktype</span><span class="p">)</span>
        <span class="n">locks</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">lock</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Lock with locktype &#39;</span><span class="si">{}</span><span class="s2">&#39; updated.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">locktype</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">locks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Added lock &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
    <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;locks&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locks</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_locks_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">lock</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;locks&quot;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;node_locks&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_locks</span><span class="p">,</span> <span class="n">_lock_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_currentcmp</span><span class="p">(</span><span class="n">propval</span><span class="p">,</span> <span class="n">flatval</span><span class="p">):</span>
        <span class="s2">&quot;match by locktype&quot;</span>
        <span class="n">cmp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">lck</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">lck</span> <span class="ow">in</span> <span class="n">propval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span> <span class="k">for</span> <span class="n">lstr</span> <span class="ow">in</span> <span class="n">flatval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">lstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmp1</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cLock string|n defines limitations for accessing various properties of the object once</span>
<span class="s2">        it&#39;s spawned. The string should be on one of the following forms:</span>

<span class="s2">            locktype:[NOT] lockfunc(args)</span>
<span class="s2">            locktype: [NOT] lockfunc(args) [AND|OR|NOT] lockfunc(args) [AND|OR|NOT] ...</span>

<span class="s2">        </span><span class="si">{current}{action}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;locks&quot;</span><span class="p">,</span>
            <span class="n">comparer</span><span class="o">=</span><span class="n">_currentcmp</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lockstr</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">lstr</span> <span class="ow">in</span> <span class="n">lockstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">action</span><span class="o">=</span><span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Here is an example of two lock strings:</span>

<span class="s2">            edit:false()</span>
<span class="s2">            call:tag(Foo) OR perm(Builder)</span>

<span class="s2">        Above locks limit two things, &#39;edit&#39; and &#39;call&#39;. Which lock types are actually checked</span>
<span class="s2">        depend on the typeclass of the object being spawned. Here &#39;edit&#39; is never allowed by anyone</span>
<span class="s2">        while &#39;call&#39; is allowed to all accessors with a |ctag|n &#39;Foo&#39; OR which has the</span>
<span class="s2">        |cPermission|n &#39;Builder&#39;.</span>

<span class="s2">        |cAvailable lockfuncs:|n</span>

<span class="s2">        </span><span class="si">{lfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">lfuncs</span><span class="o">=</span><span class="n">_format_lockfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;locks&quot;</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_locks_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># permissions node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_permissions</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">perms</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">perms</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_display_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">permission</span><span class="p">,</span> <span class="n">only_hierarchy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">PERMISSION_HIERARCHY</span>
    <span class="n">perm_low</span> <span class="o">=</span> <span class="n">permission</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">perm_low</span> <span class="ow">in</span> <span class="p">[</span><span class="n">prm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">prm</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="p">]:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;Permission (in hieararchy): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;|w[</span><span class="si">{}</span><span class="s2">]|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span> <span class="k">if</span> <span class="n">prm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">perm_low</span> <span class="k">else</span> <span class="s2">&quot;|W</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">prm</span> <span class="ow">in</span> <span class="n">hierarchy</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">only_hierarchy</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;Permission: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_permission_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">permission</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">permission</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;permissions&quot;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">perm</span><span class="p">:</span>
        <span class="n">perm_low</span> <span class="o">=</span> <span class="n">perm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">_caller_permissions</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="n">perms_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">prm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">prm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">perms_low</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">perm_low</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">perms</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Removed Permission &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Found no Permission to remove.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">perm_low</span> <span class="ow">in</span> <span class="n">perms_low</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Permission already set.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">perms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
                <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="n">perms</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Added Permission &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_permissions_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for permission listing&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">perm</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">perm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_display_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">perm</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;permissions&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_add_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_add_perm</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;node_permissions&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_permissions</span><span class="p">,</span> <span class="n">_permission_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_permissions</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_currentcmp</span><span class="p">(</span><span class="n">pval</span><span class="p">,</span> <span class="n">fval</span><span class="p">):</span>
        <span class="n">cmp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">pval</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">perm</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">fval</span> <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmp1</span><span class="p">]</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cPermissions|n are simple strings used to grant access to this object. A permission is used</span>
<span class="s2">        when a |clock|n is checked that contains the |wperm|n or |wpperm|n lock functions. Certain</span>
<span class="s2">        permissions belong in the |cpermission hierarchy|n together with the |Wperm()|n lock</span>
<span class="s2">        function.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;permissions&quot;</span><span class="p">,</span>
            <span class="n">comparer</span><span class="o">=</span><span class="n">_currentcmp</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prm</span> <span class="k">for</span> <span class="n">prm</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">))</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Any string can act as a permission as long as a lock is set to look for it. Depending on the</span>
<span class="s2">        lock, having a permission could even be negative (i.e. the lock is only passed if you</span>
<span class="s2">        |wdon&#39;t|n have the &#39;permission&#39;). The most common permissions are the hierarchical</span>
<span class="s2">        permissions:</span>

<span class="s2">            </span><span class="si">{permissions}</span><span class="s2">.</span>

<span class="s2">        For example, a |clock|n string like &quot;edit:perm(Builder)&quot; will grant access to accessors</span>
<span class="s2">        having the |cpermission|n &quot;Builder&quot; or higher.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">permissions</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PERMISSION_HIERARCHY</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="s2">&quot;locks&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_permissions_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># location node</span>


<div class="viewcode-block" id="node_location">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_location">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_location</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cLocation|n of this object in the world. If not given, the object will spawn in the</span>
<span class="s2">        inventory of |c</span><span class="si">{caller}</span><span class="s2">|n by default.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You get the most control by not specifying the location - you can then teleport the spawned</span>
<span class="s2">        objects as needed later. Setting the location may be useful for quickly populating a given</span>
<span class="s2">        location. One could also consider randomizing the location using a $protfunc.</span>

<span class="s2">        |c$protfuncs|n</span>
<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_set_property</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># home node</span>


<div class="viewcode-block" id="node_home">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_home">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_home</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cHome|n location of an object is often only used as a backup - this is where the object</span>
<span class="s2">        will be moved to if its location is deleted. The home location can also be used as an actual</span>
<span class="s2">        home for characters to quickly move back to.</span>

<span class="s2">        If unset, the global home default (|w</span><span class="si">{default}</span><span class="s2">|n) will be used.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_HOME</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The home can be given as a #dbref but can also be specified using the protfunc</span>
<span class="s2">        &#39;$obj(name)&#39;. Use |wSE|nearch to find objects in the database.</span>

<span class="s2">        The home location is commonly not used except as a backup; using the global default is often</span>
<span class="s2">        enough.</span>

<span class="s2">        |c$protfuncs|n</span>
<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_set_property</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># destination node</span>


<div class="viewcode-block" id="node_destination">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_destination">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_destination</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The object&#39;s |cDestination|n is generally only used by Exit-like objects to designate where</span>
<span class="s2">        the exit &#39;leads to&#39;. It&#39;s usually unset for all other types of objects.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The destination can be given as a #dbref but can also be specified using the protfunc</span>
<span class="s2">        &#39;$obj(name)&#39;. Use |wSEearch to find objects in the database.</span>

<span class="s2">        |c$protfuncs|n</span>
<span class="s2">        </span><span class="si">{pfuncs}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pfuncs</span><span class="o">=</span><span class="n">_format_protfuncs</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_desc&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_set_property</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype_desc node</span>


<div class="viewcode-block" id="node_prototype_desc">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_prototype_desc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_desc</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The |cPrototype-Description|n briefly describes the prototype when it&#39;s viewed in listings.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_desc&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Giving a brief description helps you and others to locate the prototype for use later.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_desc&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_key&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_tags&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">_set_property</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">prop</span><span class="o">=</span><span class="s2">&quot;prototype_desc&quot;</span><span class="p">,</span>
                    <span class="n">processor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="n">next_node</span><span class="o">=</span><span class="s2">&quot;node_prototype_desc&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype_tags node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_prototype_tags</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_tags&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tags</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_prototype_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tag_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add prototype_tags to the system. We only support straight tags, no</span>
<span class="sd">    categories (category is assigned automatically).</span>

<span class="sd">    Args:</span>
<span class="sd">        caller (Object): Caller of menu.</span>
<span class="sd">        tag_string (str): Input from user - only tagname</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        delete (str): If this is set, tag_string is considered</span>
<span class="sd">            the name of the tag to delete.</span>

<span class="sd">    Returns:</span>
<span class="sd">        result (str): Result string of action.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">_caller_prototype_tags</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Removed Prototype-Tag &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Found no Prototype-Tag to remove.&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># a fresh, new tag</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Added Prototype-Tag &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Prototype-Tag already added.&quot;</span>

        <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_tags&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;No Prototype-Tag specified.&quot;</span>

    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_tag_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">):</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;Prototype-Tag: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tagname</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;node_prototype_tags&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_tags_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actions for tags listing&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">tagname</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span><span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">tagname</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_add_prototype_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_add_prototype_tag</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;node_prototype_tags&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_prototype_tags</span><span class="p">,</span> <span class="n">_prototype_tag_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_tags</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cPrototype-Tags|n can be used to classify and find prototypes in listings Tag names are not</span>
<span class="s2">        case-sensitive and can have not have a custom category.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;prototype_tags&quot;</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tg</span> <span class="k">for</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span>
        <span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;|w&lt;text&gt;|n|W to add Tag. Other Action:|n &quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Using prototype-tags is a good way to organize and group large numbers of prototypes by</span>
<span class="s2">        genre, type etc. Under the hood, prototypes&#39; tags will all be stored with the category</span>
<span class="s2">        &#39;</span><span class="si">{tagmetacategory}</span><span class="s2">&#39;.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tagmetacategory</span><span class="o">=</span><span class="n">protlib</span><span class="o">.</span><span class="n">_PROTOTYPE_TAG_META_CATEGORY</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_tags&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_desc&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_locks&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_prototype_tags_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># prototype_locks node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_caller_prototype_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lck</span> <span class="k">for</span> <span class="n">lck</span> <span class="ow">in</span> <span class="n">locks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">lck</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_lock_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lockstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lockstr</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;prototype_locks&quot;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">locks</span> <span class="o">=</span> <span class="n">_caller_prototype_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">locktype</span><span class="p">,</span> <span class="n">lockdef</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lockstring lacks &#39;:&#39;.&quot;</span>

    <span class="n">locktype</span> <span class="o">=</span> <span class="n">locktype</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">locks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
            <span class="n">locks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locks</span><span class="p">),</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Prototype-lock </span><span class="si">{}</span><span class="s2"> deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;No Prototype-lock found to delete.&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">locktypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lck</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">lck</span> <span class="ow">in</span> <span class="n">locks</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">locktypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">locktype</span><span class="p">)</span>
        <span class="n">locks</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">lock</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Prototype-lock with locktype &#39;</span><span class="si">{}</span><span class="s2">&#39; updated.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">locktype</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">locks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Added Prototype-lock &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
    <span class="n">_set_prototype_value</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locks</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_locks_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">lock</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="p">),</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;locks&quot;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">_prototype_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">_prototype_lock_add</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;node_prototype_locks&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_caller_prototype_locks</span><span class="p">,</span> <span class="n">_prototype_lock_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_locks</span><span class="p">(</span><span class="n">caller</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        |cPrototype-Locks|n are used to limit access to this prototype when someone else is trying</span>
<span class="s2">        to access it. By default any prototype can be edited only by the creator and by Admins while</span>
<span class="s2">        they can be used by anyone with access to the spawn command. There are two valid lock types</span>
<span class="s2">        the prototype access tools look for:</span>

<span class="s2">            - &#39;edit&#39;: Who can edit the prototype.</span>
<span class="s2">            - &#39;spawn&#39;: Who can spawn new objects with this prototype.</span>

<span class="s2">        If unsure, keep the open defaults.</span>

<span class="s2">        </span><span class="si">{current}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">current</span><span class="o">=</span><span class="n">_get_current_value</span><span class="p">(</span>
            <span class="n">caller</span><span class="p">,</span>
            <span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span>
            <span class="n">formatter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lstring</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">_locks_display</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">lstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">lstr</span> <span class="ow">in</span> <span class="n">lstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">only_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Actions: &quot;</span><span class="p">))</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Prototype locks can be used to vary access for different tiers of builders. It also allows</span>
<span class="s2">        developers to produce &#39;base prototypes&#39; only meant for builders to inherit and expand on</span>
<span class="s2">        rather than tweak in-place.</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_locks&quot;</span><span class="p">,</span> <span class="s2">&quot;prototype_tags&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_prototype_locks_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># update existing objects node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_apply_diff</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;update existing objects&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prototype&quot;</span><span class="p">]</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>
    <span class="n">back_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;back_node&quot;</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">num_changed</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">batch_update_objects_with_prototype</span><span class="p">(</span>
        <span class="n">prototype</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span>
    <span class="p">)</span>
    <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|g</span><span class="si">{num}</span><span class="s2"> objects were updated successfully.|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num_changed</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">back_node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_keep_diff</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change to KEEP setting for a given section of a diff&quot;&quot;&quot;</span>
    <span class="c1"># from evennia import set_trace;set_trace(term_size=(182, 50))</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">diff</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;KEEP&quot;</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_diff_text_and_options</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat the diff in a way suitable for the olc menu.</span>

<span class="sd">    Args:</span>
<span class="sd">        diff (dict): A diff as produced by `prototype_diff`.</span>
<span class="sd">        minimal (bool, optional): Don&#39;t show KEEPs.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        any (any): Forwarded into the generated options as arguments to the callable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        texts (list): List of texts.</span>
<span class="sd">        options (list): List of options dict.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_instructions</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;KEEP&quot;</span><span class="p">,</span> <span class="s2">&quot;REMOVE&quot;</span><span class="p">,</span> <span class="s2">&quot;ADD&quot;</span><span class="p">,</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_visualize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">rootname</span><span class="p">,</span> <span class="n">get_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_iter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">get_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&lt;unset&gt;&quot;</span>
            <span class="k">if</span> <span class="n">rootname</span> <span class="o">==</span> <span class="s2">&quot;attrs&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> |W=|n </span><span class="si">{}</span><span class="s2"> |W(category:|n </span><span class="si">{}</span><span class="s2">|W, locks:|n </span><span class="si">{}</span><span class="s2">|W)|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rootname</span> <span class="o">==</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> |W(category:|n </span><span class="si">{}</span><span class="s2">|W)|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_diffpart</span><span class="p">(</span><span class="n">diffpart</span><span class="p">,</span> <span class="n">optnum</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">diffpart</span><span class="p">)</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffpart</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">diffpart</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_instructions</span><span class="p">:</span>
            <span class="n">rootname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">instruction</span> <span class="o">=</span> <span class="n">diffpart</span>
            <span class="k">if</span> <span class="n">instruction</span> <span class="o">==</span> <span class="s2">&quot;KEEP&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span><span class="p">:</span>
                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   |gKEEP|W:|n </span><span class="si">{old}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">_visualize</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rootname</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># instructions we should be able to revert by a menu choice</span>
                <span class="n">vold</span> <span class="o">=</span> <span class="n">_visualize</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rootname</span><span class="p">)</span>
                <span class="n">vnew</span> <span class="o">=</span> <span class="n">_visualize</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">rootname</span><span class="p">)</span>
                <span class="n">vsep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">78</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="n">instruction</span> <span class="o">==</span> <span class="s2">&quot;ADD&quot;</span><span class="p">:</span>
                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;   |c[</span><span class="si">{optnum}</span><span class="s2">] |yADD|n: </span><span class="si">{new}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">optnum</span><span class="o">=</span><span class="n">optnum</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">_visualize</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">rootname</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">instruction</span> <span class="o">==</span> <span class="s2">&quot;REMOVE&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rootname</span> <span class="o">==</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">and</span> <span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">protlib</span><span class="o">.</span><span class="n">PROTOTYPE_TAG_CATEGORY</span><span class="p">:</span>
                        <span class="c1"># special exception for the prototype-tag mechanism</span>
                        <span class="c1"># this is added post-spawn automatically and should</span>
                        <span class="c1"># not be listed as REMOVE.</span>
                        <span class="k">return</span> <span class="n">texts</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">optnum</span>

                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;   |c[</span><span class="si">{optnum}</span><span class="s2">] |rREMOVE|n: </span><span class="si">{old}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">optnum</span><span class="o">=</span><span class="n">optnum</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">_visualize</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">rootname</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vinst</span> <span class="o">=</span> <span class="s2">&quot;|y</span><span class="si">{}</span><span class="s2">|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
                    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;   |c[</span><span class="si">{num}</span><span class="s2">] </span><span class="si">{inst}</span><span class="s2">|W:|n </span><span class="si">{old}</span><span class="s2"> |W-&gt;|n</span><span class="si">{sep}</span><span class="s2"> </span><span class="si">{new}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">inst</span><span class="o">=</span><span class="n">vinst</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">optnum</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">vold</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">vsep</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">vnew</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">optnum</span><span class="p">),</span>
                        <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;|gKEEP|n (</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">rootname</span><span class="p">,</span> <span class="n">_visualize</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">get_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_keep_diff</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(((</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">optnum</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">diffpart</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">subdiffpart</span> <span class="o">=</span> <span class="n">diffpart</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">text</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">optnum</span> <span class="o">=</span> <span class="n">_parse_diffpart</span><span class="p">(</span><span class="n">subdiffpart</span><span class="p">,</span> <span class="n">optnum</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">key</span><span class="p">,)))</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">texts</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">optnum</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># we use this to allow for skipping full KEEP instructions</span>
    <span class="n">optnum</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">root_key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
        <span class="n">diffpart</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="n">root_key</span><span class="p">]</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">optnum</span> <span class="o">=</span> <span class="n">_parse_diffpart</span><span class="p">(</span><span class="n">diffpart</span><span class="p">,</span> <span class="n">optnum</span><span class="p">,</span> <span class="n">root_key</span><span class="p">)</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="s2">&quot;- |w</span><span class="si">{}</span><span class="s2">:|n &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">heading</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">heading</span><span class="p">]</span>

        <span class="n">texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">texts</span><span class="p">,</span> <span class="n">options</span>


<div class="viewcode-block" id="node_apply_diff">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_apply_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_apply_diff</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Offer options for updating objects&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_keep_option</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">base_obj</span><span class="p">,</span> <span class="n">obj_prototype</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">back_node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helper returning an option dict&quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Keep </span><span class="si">{}</span><span class="s2"> as-is&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyname</span><span class="p">),</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">_keep_diff</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">keyname</span><span class="p">,</span>
                    <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">,</span>
                    <span class="s2">&quot;base_obj&quot;</span><span class="p">:</span> <span class="n">base_obj</span><span class="p">,</span>
                    <span class="s2">&quot;obj_prototype&quot;</span><span class="p">:</span> <span class="n">obj_prototype</span><span class="p">,</span>
                    <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span>
                    <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="n">objects</span><span class="p">,</span>
                    <span class="s2">&quot;back_node&quot;</span><span class="p">:</span> <span class="n">back_node</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="n">prototype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">update_objects</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">back_node</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;back_node&quot;</span><span class="p">,</span> <span class="s2">&quot;node_index&quot;</span><span class="p">)</span>
    <span class="n">obj_prototype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;obj_prototype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">base_obj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">custom_location</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">update_objects</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;There are no existing objects to update.&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">back_node</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">diff</span><span class="p">:</span>
        <span class="c1"># use one random object as a reference to calculate a diff</span>
        <span class="n">base_obj</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">update_objects</span><span class="p">)</span>

        <span class="n">diff</span><span class="p">,</span> <span class="n">obj_prototype</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">prototype_diff_from_object</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">base_obj</span><span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        This will go through all existing objects and apply the changes you accept.</span>

<span class="s2">        Be careful with this operation! The upgrade mechanism will try to automatically estimate</span>
<span class="s2">        what changes need to be applied. But the estimate is |wonly based on the analysis of one</span>
<span class="s2">        randomly selected object|n among all objects spawned by this prototype. If that object</span>
<span class="s2">        happens to be unusual in some way the estimate will be off and may lead to unexpected</span>
<span class="s2">        results for other objects. Always test your objects carefully after an upgrade and consider</span>
<span class="s2">        being conservative (switch to KEEP) for things you are unsure of. For complex upgrades it</span>
<span class="s2">        may be better to get help from an administrator with access to the `@py` command for doing</span>
<span class="s2">        this manually.</span>

<span class="s2">        Note that the `location` will never be auto-adjusted because it&#39;s so rare to want to</span>
<span class="s2">        homogenize the location of all object instances.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_location</span><span class="p">:</span>
        <span class="n">diff</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">txt</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">_format_diff_text_and_options</span><span class="p">(</span>
        <span class="n">diff</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="n">update_objects</span><span class="p">,</span> <span class="n">base_obj</span><span class="o">=</span><span class="n">base_obj</span><span class="p">,</span> <span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Suggested changes to </span><span class="si">{}</span><span class="s2"> objects. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_objects</span><span class="p">)),</span>
            <span class="s2">&quot;Showing random example obj to change: </span><span class="si">{name}</span><span class="s2"> (</span><span class="si">{dbref}</span><span class="s2">))</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">base_obj</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">dbref</span><span class="o">=</span><span class="n">base_obj</span><span class="o">.</span><span class="n">dbref</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">txt</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wu|Wpdate </span><span class="si">{}</span><span class="s2"> objects&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_objects</span><span class="p">)),</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Update </span><span class="si">{}</span><span class="s2"> objects&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_objects</span><span class="p">)),</span>
                    <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">_apply_diff</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">,</span>
                            <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="n">update_objects</span><span class="p">,</span>
                            <span class="s2">&quot;back_node&quot;</span><span class="p">:</span> <span class="n">back_node</span><span class="p">,</span>
                            <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span>
                            <span class="s2">&quot;base_obj&quot;</span><span class="p">:</span> <span class="n">base_obj</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">),</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wr|Weset changes&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;node_apply_diff&quot;</span><span class="p">,</span>
                        <span class="p">{</span><span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">,</span> <span class="s2">&quot;back_node&quot;</span><span class="p">:</span> <span class="n">back_node</span><span class="p">,</span> <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="n">update_objects</span><span class="p">},</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Analyzed a random sample object (out of </span><span class="si">{}</span><span class="s2">) - &quot;</span>
            <span class="s2">&quot;found no changes to apply.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">update_objects</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;update_objects&quot;</span><span class="p">,</span> <span class="n">back_node</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">back_node</span><span class="p">})</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype save node</span>


<div class="viewcode-block" id="node_prototype_save">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_prototype_save">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_save</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save prototype to disk&quot;&quot;&quot;</span>
    <span class="c1"># these are only set if we selected &#39;yes&#39; to save on a previous pass</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># set to True/False if answered, None if first pass</span>
    <span class="n">accept_save</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;accept_save&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">accept_save</span> <span class="ow">and</span> <span class="n">prototype</span><span class="p">:</span>
        <span class="c1"># we already validated and accepted the save, so this node acts as a goto callback and</span>
        <span class="c1"># should now only return the next node</span>
        <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protlib</span><span class="o">.</span><span class="n">save_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;|rCould not save:|n </span><span class="si">{}</span><span class="se">\n</span><span class="s2">(press Return to continue)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>

        <span class="n">spawned_objects</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_objects_with_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
        <span class="n">nspawned</span> <span class="o">=</span> <span class="n">spawned_objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;|gPrototype saved.|n&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nspawned</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to update </span><span class="si">{}</span><span class="s2"> object(s) &quot;</span>
                <span class="s2">&quot;already using this prototype?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nspawned</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wY|Wes|n&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Go to updating screen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;node_apply_diff&quot;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;accept_update&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="n">spawned_objects</span><span class="p">,</span>
                            <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">,</span>
                            <span class="s2">&quot;back_node&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_save&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">),</span>
                <span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;[|wN|Wo|n]&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Return to index&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(press Return to continue)&quot;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">}</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Updating objects means that the spawner will find all objects previously created by this</span>
<span class="s2">        prototype. You will be presented with a list of the changes the system will try to apply to</span>
<span class="s2">        each of these objects and you can choose to customize that change if needed. If you have</span>
<span class="s2">        done a lot of manual changes to your objects after spawning, you might want to update those</span>
<span class="s2">        objects manually instead.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>

    <span class="c1"># not validated yet</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">error</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">_validate_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="c1"># abort save</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|yValidation errors were found. They need to be corrected before this prototype &quot;</span>
            <span class="s2">&quot;can be saved (or used to spawn).|n&quot;</span>
        <span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_save&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">options</span>

    <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">):</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to save/overwrite the existing prototype &#39;</span><span class="si">{name}</span><span class="s2">&#39;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">prototype_key</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Do you want to save the prototype as &#39;</span><span class="si">{name}</span><span class="s2">&#39;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">prototype_key</span><span class="p">))</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Saving the prototype makes it available for use later. It can also be used to inherit from,</span>
<span class="s2">        by name.  Depending on |cprototype-locks|n it also makes the prototype usable and/or</span>
<span class="s2">        editable by others. Consider setting good |cPrototype-tags|n and to give a useful, brief</span>
<span class="s2">        |cPrototype-desc|n to make the prototype easy to find later.</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;[|wY|Wes|n]&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Save prototype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;node_prototype_save&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;accept_save&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">}),</span>
        <span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;|wN|Wo|n&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Abort and return to Index&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;node_prototype_save&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;accept_save&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">}),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># spawning node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_spawn</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spawn prototype&quot;&quot;&quot;</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prototype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_location</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_location</span><span class="p">:</span>
        <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_location</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">):</span>
        <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caller</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">spawner</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;|gNew instance|n </span><span class="si">{key}</span><span class="s2"> (</span><span class="si">{dbref}</span><span class="s2">) |gspawned at location |n</span><span class="si">{loc}</span><span class="s2">|n|g.|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">dbref</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">dbref</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;|rError: Spawner did not return a new instance.|n&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;prototype_spawn&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="node_prototype_spawn">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.node_prototype_spawn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_spawn</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Submenu for spawning the prototype&quot;&quot;&quot;</span>

    <span class="n">prototype</span> <span class="o">=</span> <span class="n">_get_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">)</span>

    <span class="n">already_validated</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;already_validated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">already_validated</span><span class="p">:</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">_validate_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|rPrototype validation failed. Correct the errors before spawning.|n&quot;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_spawn&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">options</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Spawning is the act of instantiating a prototype into an actual object. As a new object is</span>
<span class="s2">        spawned, every $protfunc in the prototype is called anew. Since this is a common thing to</span>
<span class="s2">        do, you may also temporarily change the |clocation|n of this prototype to bypass whatever</span>
<span class="s2">        value is set in the prototype.</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="c1"># show spawn submenu options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prototype_key</span> <span class="o">=</span> <span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">prototype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Spawn in prototype&#39;s defined location (</span><span class="si">{loc}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">location</span><span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">_spawn</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">custom_location</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">caller_loc</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">location</span>
    <span class="k">if</span> <span class="n">location</span> <span class="o">!=</span> <span class="n">caller_loc</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Spawn in </span><span class="si">{caller}</span><span class="s2">&#39;s location (</span><span class="si">{loc}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">caller_loc</span>
                <span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_spawn</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">caller_loc</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">location</span> <span class="o">!=</span> <span class="n">caller_loc</span> <span class="o">!=</span> <span class="n">caller</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Spawn in </span><span class="si">{caller}</span><span class="s2">&#39;s inventory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_spawn</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">caller</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">spawned_objects</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_objects_with_prototype</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">)</span>
    <span class="n">nspawned</span> <span class="o">=</span> <span class="n">spawned_objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">spawned_objects</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Update </span><span class="si">{num}</span><span class="s2"> existing objects with this prototype&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">nspawned</span><span class="p">),</span>
                <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="s2">&quot;node_apply_diff&quot;</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">spawned_objects</span><span class="p">),</span>
                        <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">prototype</span><span class="p">,</span>
                        <span class="s2">&quot;back_node&quot;</span><span class="p">:</span> <span class="s2">&quot;node_prototype_spawn&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_spawn&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="s2">&quot;node_index&quot;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>



<span class="c1"># prototype load node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_load_select</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype_key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">prototype_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_set_menu_prototype</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">prototype</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;|gLoaded prototype </span><span class="si">{}</span><span class="s2">.|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype</span><span class="p">[</span><span class="s2">&quot;prototype_key&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;|rFailed to load prototype &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype_key</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prototype_load_actions</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">raw_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the default Convert prototype to a string representation for closer inspection&quot;&quot;&quot;</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available_choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">prototype</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">_default_parse</span><span class="p">(</span>
        <span class="n">raw_inp</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">prototype</span><span class="p">:</span>
        <span class="c1"># which action to apply on the selection</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;examine&quot;</span><span class="p">:</span>
            <span class="c1"># examine the prototype</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">search_prototype</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">prototype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">protlib</span><span class="o">.</span><span class="n">prototype_to_str</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;prototype_load&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
            <span class="c1"># delete prototype from disk</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">protlib</span><span class="o">.</span><span class="n">delete_prototype</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">caller</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">protlib</span><span class="o">.</span><span class="n">PermissionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;|rDeletion error:|n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;|gPrototype </span><span class="si">{}</span><span class="s2"> was deleted.|n&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">:</span> <span class="s2">&quot;prototype_load&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;node_prototype_load&quot;</span>


<span class="nd">@list_node</span><span class="p">(</span><span class="n">_all_prototype_parents</span><span class="p">,</span> <span class="n">_prototype_load_select</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">node_prototype_load</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load prototype&quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Select a prototype to load. This will replace any prototype currently being edited!</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">_set_actioninfo</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">_format_list_actions</span><span class="p">(</span><span class="s2">&quot;examine&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">))</span>

    <span class="n">helptext</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Loading a prototype will load it and return you to the main index. It can be a good idea</span>
<span class="s2">        to examine the prototype before loading it.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">helptext</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">_wizard_options</span><span class="p">(</span><span class="s2">&quot;prototype_load&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;_default&quot;</span><span class="p">,</span> <span class="s2">&quot;goto&quot;</span><span class="p">:</span> <span class="n">_prototype_load_actions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span>


<span class="c1"># EvMenu definition, formatting and access functions</span>


<div class="viewcode-block" id="OLCMenu">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.OLCMenu">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OLCMenu</span><span class="p">(</span><span class="n">EvMenu</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom EvMenu with a different formatting for the options.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OLCMenu.nodetext_formatter">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.OLCMenu.nodetext_formatter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nodetext_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodetext</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format the node text itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">nodetext_formatter</span><span class="p">(</span><span class="n">nodetext</span><span class="p">)</span></div>


<div class="viewcode-block" id="OLCMenu.options_formatter">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.OLCMenu.options_formatter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">options_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optionlist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split the options into two blocks - olc options and normal options</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">olc_keys</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
            <span class="s2">&quot;back&quot;</span><span class="p">,</span>
            <span class="s2">&quot;previous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;next&quot;</span><span class="p">,</span>
            <span class="s2">&quot;validate prototype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;save prototype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;load prototype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spawn prototype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;search objects&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">actioninfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actioninfo</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;actioninfo&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actioninfo</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># important, or this could bleed over to other nodes</span>
        <span class="n">olc_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">other_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">optionlist</span><span class="p">:</span>
            <span class="n">raw_key</span> <span class="o">=</span> <span class="n">strip_ansi</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">raw_key</span> <span class="ow">in</span> <span class="n">olc_keys</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="k">if</span> <span class="n">desc</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">olc_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|lc</span><span class="si">{}</span><span class="s2">|lt</span><span class="si">{}</span><span class="s2">|le</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">))</span>

        <span class="n">olc_options</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">actioninfo</span> <span class="o">+</span> <span class="s2">&quot; |W|||n &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">olc_options</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; |W|||n &quot;</span> <span class="o">+</span> <span class="s2">&quot;|wQ|Wuit&quot;</span>
            <span class="k">if</span> <span class="n">olc_options</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">other_options</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">options_formatter</span><span class="p">(</span><span class="n">other_options</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">olc_options</span> <span class="ow">and</span> <span class="n">other_options</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">olc_options</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">other_options</span><span class="p">)</span></div>


<div class="viewcode-block" id="OLCMenu.helptext_formatter">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.OLCMenu.helptext_formatter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">helptext_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">helptext</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show help text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;|c --- Help ---|n</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">helptext</span><span class="p">)</span></div>


<div class="viewcode-block" id="OLCMenu.display_helptext">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.OLCMenu.display_helptext">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_helptext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evmore</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helptext</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">exit_cmd</span><span class="o">=</span><span class="s2">&quot;look&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="start_olc">
<a class="viewcode-back" href="../../../api/evennia.prototypes.menus.html#evennia.prototypes.menus.start_olc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">start_olc</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prototype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start menu-driven olc system for prototypes.</span>

<span class="sd">    Args:</span>
<span class="sd">        caller (Object or Account): The entity starting the menu.</span>
<span class="sd">        session (Session, optional): The individual session to get data.</span>
<span class="sd">        prototype (dict, optional): Given when editing an existing</span>
<span class="sd">            prototype rather than creating a new one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">menudata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;node_index&quot;</span><span class="p">:</span> <span class="n">node_index</span><span class="p">,</span>
        <span class="s2">&quot;node_validate_prototype&quot;</span><span class="p">:</span> <span class="n">node_validate_prototype</span><span class="p">,</span>
        <span class="s2">&quot;node_examine_entity&quot;</span><span class="p">:</span> <span class="n">node_examine_entity</span><span class="p">,</span>
        <span class="s2">&quot;node_search_object&quot;</span><span class="p">:</span> <span class="n">node_search_object</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_key&quot;</span><span class="p">:</span> <span class="n">node_prototype_key</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_parent&quot;</span><span class="p">:</span> <span class="n">node_prototype_parent</span><span class="p">,</span>
        <span class="s2">&quot;node_typeclass&quot;</span><span class="p">:</span> <span class="n">node_typeclass</span><span class="p">,</span>
        <span class="s2">&quot;node_key&quot;</span><span class="p">:</span> <span class="n">node_key</span><span class="p">,</span>
        <span class="s2">&quot;node_aliases&quot;</span><span class="p">:</span> <span class="n">node_aliases</span><span class="p">,</span>
        <span class="s2">&quot;node_attrs&quot;</span><span class="p">:</span> <span class="n">node_attrs</span><span class="p">,</span>
        <span class="s2">&quot;node_tags&quot;</span><span class="p">:</span> <span class="n">node_tags</span><span class="p">,</span>
        <span class="s2">&quot;node_locks&quot;</span><span class="p">:</span> <span class="n">node_locks</span><span class="p">,</span>
        <span class="s2">&quot;node_permissions&quot;</span><span class="p">:</span> <span class="n">node_permissions</span><span class="p">,</span>
        <span class="s2">&quot;node_location&quot;</span><span class="p">:</span> <span class="n">node_location</span><span class="p">,</span>
        <span class="s2">&quot;node_home&quot;</span><span class="p">:</span> <span class="n">node_home</span><span class="p">,</span>
        <span class="s2">&quot;node_destination&quot;</span><span class="p">:</span> <span class="n">node_destination</span><span class="p">,</span>
        <span class="s2">&quot;node_apply_diff&quot;</span><span class="p">:</span> <span class="n">node_apply_diff</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_desc&quot;</span><span class="p">:</span> <span class="n">node_prototype_desc</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_tags&quot;</span><span class="p">:</span> <span class="n">node_prototype_tags</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_locks&quot;</span><span class="p">:</span> <span class="n">node_prototype_locks</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_load&quot;</span><span class="p">:</span> <span class="n">node_prototype_load</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_save&quot;</span><span class="p">:</span> <span class="n">node_prototype_save</span><span class="p">,</span>
        <span class="s2">&quot;node_prototype_spawn&quot;</span><span class="p">:</span> <span class="n">node_prototype_spawn</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">OLCMenu</span><span class="p">(</span>
        <span class="n">caller</span><span class="p">,</span>
        <span class="n">menudata</span><span class="p">,</span>
        <span class="n">startnode</span><span class="o">=</span><span class="s2">&quot;node_index&quot;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="n">olc_prototype</span><span class="o">=</span><span class="n">prototype</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.prototypes.menus</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>