<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.contrib.tutorials.evadventure.tests.test_combat &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.tutorials.evadventure.tests.test_combat</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.contrib.tutorials.evadventure.tests.test_combat</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Test EvAdventure combat.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">patch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.ansi</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_ansi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.test_resources</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseEvenniaTest</span><span class="p">,</span>
    <span class="n">EvenniaCommandTestMixin</span><span class="p">,</span>
    <span class="n">EvenniaTestCase</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">combat_base</span><span class="p">,</span> <span class="n">combat_turnbased</span><span class="p">,</span> <span class="n">combat_twitch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..characters</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvAdventureCharacter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ability</span><span class="p">,</span> <span class="n">WieldLocation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..npcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvAdventureMob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvAdventureConsumable</span><span class="p">,</span> <span class="n">EvAdventureRunestone</span><span class="p">,</span> <span class="n">EvAdventureWeapon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..rooms</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvAdventureRoom</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_CombatTestBase</span><span class="p">(</span><span class="n">EvenniaTestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up common entities for testing combat:</span>

<span class="sd">    - `location` (key=testroom)</span>
<span class="sd">    - `combatant` (key=testchar)</span>
<span class="sd">    - `target` (key=testmonster)`</span>

<span class="sd">    We also mock the `.msg` method of both `combatant` and `target` so we can</span>
<span class="sd">    see what was sent.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">EvAdventureRoom</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testroom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testchar&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">allow_combat</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">allow_death</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureMob</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testmonster&quot;</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;is_idle&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),),</span>
        <span class="p">)</span>

        <span class="c1"># mock the msg so we can check what they were sent later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>


<div class="viewcode-block" id="TestEvAdventureCombatBaseHandler">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureCombatBaseHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestEvAdventureCombatBaseHandler</span><span class="p">(</span><span class="n">_CombatTestBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the base functionality of the base combat handler.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestEvAdventureCombatBaseHandler.setUp">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureCombatBaseHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This also tests the `get_or_create_combathandler` classfunc&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">EvAdventureCombatBaseHandler</span><span class="o">.</span><span class="n">get_or_create_combathandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;combathandler&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureCombatBaseHandler.test_combathandler_msg">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureCombatBaseHandler.test_combathandler_msg">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_combathandler_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test sending messages to all in handler&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">msg_contents</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;test_message&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">msg_contents</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s2">&quot;test_message&quot;</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">from_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mapping</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;testchar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="s2">&quot;testmonster&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureCombatBaseHandler.test_get_combat_summary">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureCombatBaseHandler.test_get_combat_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_combat_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test combat summary&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_sides</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]))</span>

        <span class="c1"># as seen from one side</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_combat_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">strip_ansi</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="s2">&quot; testchar (Perfect)  vs  testmonster (Perfect) &quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># as seen from other side</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_sides</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">]))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_combat_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">strip_ansi</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="s2">&quot; testmonster (Perfect)  vs  testchar (Perfect) &quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestCombatActionsBase">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestCombatActionsBase</span><span class="p">(</span><span class="n">_CombatTestBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for testing all subclasses of CombatAction in combat_base.py</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestCombatActionsBase.setUp">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">EvAdventureCombatBaseHandler</span><span class="o">.</span><span class="n">get_or_create_combathandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;combathandler&quot;</span>
        <span class="p">)</span>
        <span class="c1"># we need to mock all NotImplemented methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_sides</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">([],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">give_advantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">give_disadvantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">remove_advantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">remove_disadvantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_advantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_disadvantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">has_advantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">has_disadvantage</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_base_action">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_base_action">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_base_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatAction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;hold&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_attack__miss">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_attack__miss">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_attack__miss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attack&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>

        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># target has default armor 11, so 8+1 str will miss</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionAttack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_attack__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_attack__success">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_attack__success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attack&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>

        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11 + 1 str will hit beat armor 11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionAttack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_stunt_fail">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_stunt_fail">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># fails 8+1 dex vs DEX 11 defence</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionStunt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">give_advantage</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_stunt_advantage__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_stunt_advantage__success">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_advantage__success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11+1 dex vs DEX 11 defence is success</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionStunt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">give_advantage</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_stunt_disadvantage__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_stunt_disadvantage__success">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_disadvantage__success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11+1 dex vs DEX 11 defence is success</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionStunt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">give_disadvantage</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_use_item">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_use_item">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_use_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use up a potion during combat.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureConsumable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Healing potion&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;uses&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">item</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;use&quot;</span><span class="p">,</span>
            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">uses</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionUseItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">uses</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># deleted, it was used up</span></div>


<div class="viewcode-block" id="TestCombatActionsBase.test_swap_wielded_weapon_or_spell">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestCombatActionsBase.test_swap_wielded_weapon_or_spell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_swap_wielded_weapon_or_spell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First draw a weapon (from empty fists), then swap that out to another weapon, then</span>
<span class="sd">        swap to a spell rune.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sword</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">EvAdventureWeapon</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sword&quot;</span><span class="p">)</span>
        <span class="n">zweihander</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureWeapon</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;zweihander&quot;</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;inventory_use_slot&quot;</span><span class="p">,</span> <span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">),),</span>
        <span class="p">)</span>
        <span class="n">runestone</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">EvAdventureRunestone</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ice rune&quot;</span><span class="p">)</span>

        <span class="c1"># check hands are empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">weapon</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Bare hands&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">WEAPON_HAND</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># swap to sword</span>

        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;wield&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">sword</span><span class="p">}</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionWield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">weapon</span><span class="p">,</span> <span class="n">sword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">WEAPON_HAND</span><span class="p">],</span> <span class="n">sword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># swap to zweihander (two-handed sword)</span>
        <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zweihander</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionWield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">weapon</span><span class="p">,</span> <span class="n">zweihander</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">WEAPON_HAND</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">],</span> <span class="n">zweihander</span><span class="p">)</span>

        <span class="c1"># swap to runestone (also using two hands)</span>
        <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runestone</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionWield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">weapon</span><span class="p">,</span> <span class="n">runestone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">WEAPON_HAND</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">],</span> <span class="n">runestone</span><span class="p">)</span>

        <span class="c1"># swap back to normal one-handed sword</span>
        <span class="n">actiondict</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sword</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_base</span><span class="o">.</span><span class="n">CombatActionWield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="n">action</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">weapon</span><span class="p">,</span> <span class="n">sword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">WEAPON_HAND</span><span class="p">],</span> <span class="n">sword</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="n">WieldLocation</span><span class="o">.</span><span class="n">TWO_HANDS</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EvAdventureTurnbasedCombatHandlerTest</span><span class="p">(</span><span class="n">_CombatTestBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test methods on the turn-based combat handler and actions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># make sure to mock away all time-keeping elements</span>
<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.setUp">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.setUp">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="s2">&quot;evennia.contrib.tutorials.evadventure.&quot;</span>
            <span class="s2">&quot;combat_turnbased.EvAdventureTurnbasedCombatHandler.interval&quot;</span>
        <span class="p">),</span>
        <span class="n">new</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c1"># add target to combat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">EvAdventureTurnbasedCombatHandler</span><span class="o">.</span><span class="n">get_or_create_combathandler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;combathandler&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">add_combatant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">add_combatant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}):</span>
        <span class="n">action_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">action_classes</span><span class="p">[</span><span class="n">action_dict</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">action_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_actions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">,</span> <span class="n">action_dict2</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">},</span> <span class="n">combatant_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_msg</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to run an action and check so combatant saw the expected message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">action_dict2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">at_repeat</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">combatant_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this works because we mock combatant.msg in SetUp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">combatant_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this works because we mock target.msg in SetUp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">target_msg</span><span class="p">)</span>

<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_combatanthandler_setup">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_combatanthandler_setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_combatanthandler_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Testing all is set up correctly in the combathandler&quot;&quot;&quot;</span>

        <span class="n">chandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">combatants</span><span class="p">),</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">action_classes</span><span class="p">),</span>
            <span class="p">{</span>
                <span class="s2">&quot;hold&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionHold</span><span class="p">,</span>
                <span class="s2">&quot;attack&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionAttack</span><span class="p">,</span>
                <span class="s2">&quot;stunt&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionStunt</span><span class="p">,</span>
                <span class="s2">&quot;use&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionUseItem</span><span class="p">,</span>
                <span class="s2">&quot;wield&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionWield</span><span class="p">,</span>
                <span class="s2">&quot;flee&quot;</span><span class="p">:</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatActionFlee</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">flee_timeout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">advantage_matrix</span><span class="p">),</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">disadvantage_matrix</span><span class="p">),</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">fleeing_combatants</span><span class="p">),</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">chandler</span><span class="o">.</span><span class="n">defeated_combatants</span><span class="p">),</span> <span class="p">{})</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_remove_combatant">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_remove_combatant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_remove_combatant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a combatant.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">remove_combatant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">combatants</span><span class="p">),</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}})</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_stop_combat">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_stop_combat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stop_combat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stopping combat, making sure combathandler is deleted.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">stop_combat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_get_sides">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_get_sides">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_sides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Getting the sides of combat&quot;&quot;&quot;</span>

        <span class="n">combatant2</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureCharacter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testchar2&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="p">)</span>
        <span class="n">target2</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureMob</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;testmonster2&quot;</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;is_idle&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">add_combatant</span><span class="p">(</span><span class="n">combatant2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">add_combatant</span><span class="p">(</span><span class="n">target2</span><span class="p">)</span>

        <span class="c1"># allies to combatant</span>
        <span class="n">allies</span><span class="p">,</span> <span class="n">enemies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">allies</span><span class="p">,</span> <span class="n">enemies</span><span class="p">),</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">combatant2</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target2</span><span class="p">]))</span>

        <span class="c1"># allies to monster</span>
        <span class="n">allies</span><span class="p">,</span> <span class="n">enemies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">allies</span><span class="p">,</span> <span class="n">enemies</span><span class="p">),</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target2</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">combatant2</span><span class="p">]))</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_queue_and_execute_action">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_queue_and_execute_action">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_queue_and_execute_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue actions and execute&quot;&quot;&quot;</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">combatants</span><span class="p">),</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}},</span>
        <span class="p">)</span>

        <span class="n">mock_action</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">action_classes</span><span class="p">[</span><span class="s2">&quot;hold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_action</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">execute_next_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">action_classes</span><span class="p">[</span><span class="s2">&quot;hold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">hold</span>
        <span class="p">)</span>
        <span class="n">mock_action</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_execute_full_turn">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_execute_full_turn">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_execute_full_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a full (passive) turn&quot;&quot;&quot;</span>

        <span class="n">hold</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">hold</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">execute_next_action</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">at_repeat</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">execute_next_action</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)],</span> <span class="n">any_order</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_action__action_ticks_turn">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_action__action_ticks_turn">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_action__action_ticks_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that action execution ticks turns&quot;&quot;&quot;</span>

        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">actiondict</span><span class="p">,</span> <span class="n">actiondict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">turn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_attack__success__kill">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_attack__success__kill">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_attack__success__kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that the combathandler is deleted once there are no more enemies&quot;&quot;&quot;</span>
        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attack&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>

        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11 + 1 str will hit beat armor 11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">actiondict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">)</span>
        <span class="c1"># after this the combat is over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_stunt_fail">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_stunt_fail">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># fails 8+1 dex vs DEX 11 defence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">advantage_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">disadvantage_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="p">{})</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_stunt_advantage__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_stunt_advantage__success">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_advantage__success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test so the advantage matrix is updated correctly&quot;&quot;&quot;</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11+1 dex vs DEX 11 defence is success</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">advantage_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]),</span> <span class="kc">True</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_stunt_disadvantage__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_stunt_disadvantage__success">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_base.rules.randint&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt_disadvantage__success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_randint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test so the disadvantage matrix is updated correctly&quot;&quot;&quot;</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">DEX</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mock_randint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 11+1 dex vs DEX 11 defence is success</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">disadvantage_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">]),</span> <span class="kc">True</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EvAdventureTurnbasedCombatHandlerTest.test_flee__success">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.EvAdventureTurnbasedCombatHandlerTest.test_flee__success">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_flee__success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test fleeing twice, leading to leaving combat.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">turn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;flee&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="c1"># first flee records the fleeing state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">flee_timeout</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to make sure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">turn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">fleeing_combatants</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># action_dict should still be in place due to repeat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">combatants</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="n">action_dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;You retreat, being exposed to attack while doing so (will escape in 1 turn).&quot;</span><span class="p">,</span>
                <span class="p">{},</span>
            <span class="p">),</span>
            <span class="n">from_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Check that enemies have advantage against you now</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">combat_turnbased</span><span class="o">.</span><span class="n">CombatAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">has_advantage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">))</span>

        <span class="c1"># second flee should remove combatant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_actions</span><span class="p">(</span><span class="n">action_dict</span><span class="p">)</span>
        <span class="c1"># this ends combat, so combathandler should be gone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combathandler</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestEvAdventureTwitchCombatHandler</span><span class="p">(</span><span class="n">EvenniaCommandTestMixin</span><span class="p">,</span> <span class="n">_CombatTestBase</span><span class="p">):</span>
<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.setUp">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="c1"># in order to use the EvenniaCommandTestMixin we need these variables defined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">EvAdventureCombatTwitchHandler</span><span class="o">.</span><span class="n">get_or_create_combathandler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;combathandler&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_combathandler</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">EvAdventureCombatTwitchHandler</span><span class="o">.</span><span class="n">get_or_create_combathandler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;combathandler&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_get_sides">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_get_sides">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_sides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">get_sides</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sides</span><span class="p">,</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]))</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_give_advantage">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_give_advantage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_give_advantage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">give_advantage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">advantage_against</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_give_disadvantage">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_give_disadvantage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_give_disadvantage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">give_disadvantage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">disadvantage_against</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_queue_action">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_queue_action">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">999</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_queue_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test so the queue action cleans up tickerhandler correctly&quot;&quot;&quot;</span>

        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="n">actiondict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">current_ticker_ref</span><span class="p">)</span>

        <span class="n">actiondict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">queue_action</span><span class="p">(</span><span class="n">actiondict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">current_ticker_ref</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_execute_next_action">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_execute_next_action">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_execute_next_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;repeat&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>  <span class="c1"># to separate from fallback</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">execute_next_action</span><span class="p">()</span>
        <span class="c1"># should now be back to fallback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">fallback_action_dict</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_check_stop_combat">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_check_stop_combat">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_check_stop_combat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test combat-stop functionality&quot;&quot;&quot;</span>

        <span class="c1"># noone remains (both combatant/target &lt;0 hp</span>
        <span class="c1"># get_sides does not include the caller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">get_sides</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">([],</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">stop_combat</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">check_stop_combat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Noone stands after the dust settles.&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">from_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">stop_combat</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

        <span class="c1"># only one side wiped out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">get_sides</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">],</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">check_stop_combat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The combat is over.&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">from_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_hold">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_hold">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdHold</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;You hold back, doing nothing&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hold&quot;</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_attack">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_attack">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_attack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test attack action in the twitch combathandler&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdAttack</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;You attack testmonster!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attack&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_stunt">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_stunt">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_stunt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boost_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">foil_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;stunt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;recipient&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span>
            <span class="s2">&quot;advantage&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;stunt_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;defense_type&quot;</span><span class="p">:</span> <span class="n">Ability</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdStunt</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;STR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You prepare a stunt!&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;boost&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="n">boost_result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdStunt</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;STR me </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You prepare a stunt!&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;boost&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="n">boost_result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdStunt</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;STR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You prepare a stunt!&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;foil&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="n">foil_result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdStunt</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;STR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> me&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You prepare a stunt!&quot;</span><span class="p">,</span>
            <span class="n">cmdstring</span><span class="o">=</span><span class="s2">&quot;foil&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="n">foil_result</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_useitem">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_useitem">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_useitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureConsumable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;potion&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;uses&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdUseItem</span><span class="p">(),</span> <span class="s2">&quot;potion&quot;</span><span class="p">,</span> <span class="s2">&quot;You prepare to use potion!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdUseItem</span><span class="p">(),</span>
            <span class="sa">f</span><span class="s2">&quot;potion on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You prepare to use potion!&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestEvAdventureTwitchCombatHandler.test_wield">
<a class="viewcode-back" href="../../../../../../api/evennia.contrib.tutorials.evadventure.tests.test_combat.html#evennia.contrib.tutorials.evadventure.tests.test_combat.TestEvAdventureTwitchCombatHandler.test_wield">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.unrepeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;evennia.contrib.tutorials.evadventure.combat_twitch.repeat&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_wield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sword</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">EvAdventureWeapon</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sword&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span><span class="p">)</span>
        <span class="n">runestone</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">EvAdventureWeapon</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;runestone&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combatant</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdWield</span><span class="p">(),</span> <span class="s2">&quot;sword&quot;</span><span class="p">,</span> <span class="s2">&quot;You reach for sword!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;wield&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">sword</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">combat_twitch</span><span class="o">.</span><span class="n">CmdWield</span><span class="p">(),</span> <span class="s2">&quot;runestone&quot;</span><span class="p">,</span> <span class="s2">&quot;You reach for runestone!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combatant_combathandler</span><span class="o">.</span><span class="n">action_dict</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;wield&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">runestone</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
        <span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../../index.html">
              <img class="logo" src="../../../../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.contrib.tutorials.evadventure.tests.test_combat</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>