<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>evennia.web.website.views.help &#8212; Evennia latest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=e4a91a55" />
    <script src="../../../../../_static/documentation_options.js?v=c6e86fd7"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" accesskey="U">evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.web.website.views.help</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evennia.web.website.views.help</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Views to manipulate help entries.</span>

<span class="sd">Multi entry object type supported added by DaveWithTheNiceHat 2021</span>
<span class="sd">    Pull Request #2429</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseBadRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">slugify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic</span><span class="w"> </span><span class="kn">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">ListView</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.help.filehelp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FILE_HELP_ENTRIES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.help.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">HelpEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.ansi</span><span class="w"> </span><span class="kn">import</span> <span class="n">strip_ansi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">evennia.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">inherits_from</span>

<span class="n">DEFAULT_HELP_CATEGORY</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_HELP_CATEGORY</span>


<div class="viewcode-block" id="get_help_category">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.get_help_category">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_help_category</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="n">slugify_cat</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns help category.</span>

<span class="sd">    Args:</span>
<span class="sd">        help_entry (HelpEntry, FileHelpEntry or Command): Help entry instance.</span>
<span class="sd">        slugify_cat (bool): If true the return string is slugified. Default is True.</span>

<span class="sd">    Notes:</span>
<span class="sd">        If an entry does not have a `help_category` attribute, DEFAULT_HELP_CATEGORY from the</span>
<span class="sd">        settings file is used.</span>
<span class="sd">        If the entry does not have attribute &#39;web_help_entries&#39;. One is created with a slugified</span>
<span class="sd">        copy of the attribute help_category. This attribute is used for sorting the entries for the</span>
<span class="sd">        help index (ListView) page.</span>

<span class="sd">    Returns:</span>
<span class="sd">        help_category (str): The category for the help entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;help_category&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">help_category</span><span class="p">:</span>
        <span class="n">help_category</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;db_help_category&quot;</span><span class="p">,</span> <span class="n">DEFAULT_HELP_CATEGORY</span><span class="p">)</span>
    <span class="c1"># if one does not exist, create a category for ease of use with web views html templates</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;web_help_category&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;web_help_category&quot;</span><span class="p">,</span> <span class="n">slugify</span><span class="p">(</span><span class="n">help_category</span><span class="p">))</span>
    <span class="n">help_category</span> <span class="o">=</span> <span class="n">help_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">slugify</span><span class="p">(</span><span class="n">help_category</span><span class="p">)</span> <span class="k">if</span> <span class="n">slugify_cat</span> <span class="k">else</span> <span class="n">help_category</span></div>



<div class="viewcode-block" id="get_help_topic">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.get_help_topic">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_help_topic</span><span class="p">(</span><span class="n">help_entry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the topic of the help entry.</span>

<span class="sd">    Args:</span>
<span class="sd">        help_entry (HelpEntry, FileHelpEntry or Command): Help entry instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        help_topic (str): The topic of the help entry. Default is &#39;unknown_topic&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">help_topic</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># if object has no key, assume it is a db help entry.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">help_topic</span><span class="p">:</span>
        <span class="n">help_topic</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;db_key&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_topic&quot;</span><span class="p">)</span>
    <span class="c1"># if one does not exist, create a key for ease of use with web views html templates</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;web_help_key&quot;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">help_entry</span><span class="p">,</span> <span class="s2">&quot;web_help_key&quot;</span><span class="p">,</span> <span class="n">slugify</span><span class="p">(</span><span class="n">help_topic</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">help_topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>



<div class="viewcode-block" id="can_read_topic">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.can_read_topic">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">can_read_topic</span><span class="p">(</span><span class="n">cmd_or_topic</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if an account or puppet has read access to a help entry.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmd_or_topic (Command, HelpEntry or FileHelpEntry): The topic/command to test.</span>
<span class="sd">        account: the account or puppet checking for access.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: If command can be viewed or not.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This uses the &#39;read&#39; lock. If no &#39;read&#39; lock is defined, the topic is assumed readable</span>
<span class="sd">        by all.</span>
<span class="sd">        Even if this returns False, the entry will still be visible in the help index unless</span>
<span class="sd">        `can_list_topic` is also returning False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">cmd_or_topic</span><span class="p">,</span> <span class="s2">&quot;evennia.commands.command.Command&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cmd_or_topic</span><span class="o">.</span><span class="n">auto_help</span> <span class="ow">and</span> <span class="n">cmd_or_topic</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cmd_or_topic</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="collect_topics">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.collect_topics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">collect_topics</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect help topics from all sources (cmd/db/file).</span>

<span class="sd">    Args:</span>
<span class="sd">        account (Character or Account): Account or Character to collect help topics from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cmd_help_topics (dict): contains Command instances.</span>
<span class="sd">        db_help_topics (dict): contains HelpEntry instances.</span>
<span class="sd">        file_help_topics (dict): contains FileHelpEntry instances</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># collect commands of account and all puppets</span>
    <span class="c1"># skip a command if an entry is recorded with the same topics, category and help entry</span>
    <span class="n">cmd_help_topics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">account</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span>
        <span class="c1"># create list of account and account&#39;s puppets</span>
        <span class="n">puppets</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">characters</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">account</span><span class="p">]</span>
        <span class="c1"># add the account&#39;s and puppets&#39; commands to cmd_help_topics list</span>
        <span class="k">for</span> <span class="n">puppet</span> <span class="ow">in</span> <span class="n">puppets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cmdset</span> <span class="ow">in</span> <span class="n">puppet</span><span class="o">.</span><span class="n">cmdset</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="c1"># removing doublets in cmdset, caused by cmdhandler</span>
                <span class="c1"># having to allow doublet commands to manage exits etc.</span>
                <span class="n">cmdset</span><span class="o">.</span><span class="n">make_unique</span><span class="p">(</span><span class="n">puppet</span><span class="p">)</span>
                <span class="c1"># retrieve all available commands and database / file-help topics.</span>
                <span class="c1"># also check the &#39;cmd:&#39; lock here</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmdset</span><span class="p">:</span>
                    <span class="c1"># skip the command if the puppet does not have access</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">puppet</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># skip the command if the puppet does not have read access</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_read_topic</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">puppet</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># skip the command if it&#39;s help entry already exists in the topic list</span>
                    <span class="n">entry_exists</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">verify_cmd</span> <span class="ow">in</span> <span class="n">cmd_help_topics</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">verify_cmd</span><span class="o">.</span><span class="n">key</span>
                            <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">key</span>
                            <span class="ow">and</span> <span class="n">verify_cmd</span><span class="o">.</span><span class="n">help_category</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">.</span><span class="n">help_category</span>
                            <span class="ow">and</span> <span class="n">verify_cmd</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">.</span><span class="vm">__doc__</span>
                        <span class="p">):</span>
                            <span class="n">entry_exists</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">entry_exists</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># add this command to the list</span>
                    <span class="n">cmd_help_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># Verify account has read access to filehelp entries and gather them into a dictionary</span>
    <span class="n">file_help_topics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">topic</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">topic</span>
        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">FILE_HELP_ENTRIES</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">can_read_topic</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Verify account has read access to database entries and gather them into a dictionary</span>
    <span class="n">db_help_topics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">topic</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">topic</span>
        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">HelpEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">can_read_topic</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Collect commands into a dictionary, read access verified at puppet level</span>
    <span class="n">cmd_help_topics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">auto_help_display_key</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;auto_help_display_key&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">cmd</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">cmd</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmd_help_topics</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">cmd_help_topics</span><span class="p">,</span> <span class="n">db_help_topics</span><span class="p">,</span> <span class="n">file_help_topics</span></div>



<div class="viewcode-block" id="HelpMixin">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpMixin">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HelpMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a &quot;mixin&quot;, a modifier of sorts.</span>

<span class="sd">    Any view class with this in its inheritance list will be modified to work</span>
<span class="sd">    with HelpEntry objects instead of generic Objects or otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Help&quot;</span>

<div class="viewcode-block" id="HelpMixin.get_queryset">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpMixin.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django hook; here we want to return a list of only those HelpEntries</span>
<span class="sd">        and other documentation that the current user is allowed to see.</span>

<span class="sd">        Returns:</span>
<span class="sd">            queryset (list): List of Help entries available to the user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># collect all help entries</span>
        <span class="n">cmd_help_topics</span><span class="p">,</span> <span class="n">db_help_topics</span><span class="p">,</span> <span class="n">file_help_topics</span> <span class="o">=</span> <span class="n">collect_topics</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>

        <span class="c1"># merge the entries</span>
        <span class="n">file_db_help_topics</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">file_help_topics</span><span class="p">,</span> <span class="o">**</span><span class="n">db_help_topics</span><span class="p">}</span>
        <span class="n">all_topics</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">file_db_help_topics</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd_help_topics</span><span class="p">}</span>
        <span class="n">all_entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_topics</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># sort the entries</span>
        <span class="n">all_entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_help_topic</span><span class="p">)</span>  <span class="c1"># sort alphabetically</span>
        <span class="n">all_entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_help_category</span><span class="p">)</span>  <span class="c1"># group by categories</span>

        <span class="k">return</span> <span class="n">all_entries</span></div>
</div>



<div class="viewcode-block" id="HelpListView">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpListView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HelpListView</span><span class="p">(</span><span class="n">HelpMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of help entries that can be viewed by a user, authenticated</span>
<span class="sd">    or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/help_list.html&quot;</span>

    <span class="c1"># -- Evennia constructs --</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Help Index&quot;</span></div>



<div class="viewcode-block" id="HelpDetailView">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpDetailView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HelpDetailView</span><span class="p">(</span><span class="n">HelpMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the detail page for a given help entry.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -- Django constructs --</span>
    <span class="c1"># the html template to use when contructing the detail page for a help topic</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;website/help_detail.html&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Makes sure the page has a sensible title.</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">get_help_topic</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2"> detail&quot;</span>

<div class="viewcode-block" id="HelpDetailView.get_context_data">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpDetailView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds navigational data to the template to let browsers go to the next</span>
<span class="sd">        or previous entry in the help list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            context (dict): Django context object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get a full query set</span>
        <span class="n">full_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="c1"># Get the object in question</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">full_set</span><span class="p">)</span>

        <span class="c1"># filter non related categories from the query set</span>
        <span class="n">obj_category</span> <span class="o">=</span> <span class="n">get_help_category</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">category_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">full_set</span><span class="p">:</span>
            <span class="n">entry_category</span> <span class="o">=</span> <span class="n">get_help_category</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry_category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">obj_category</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">category_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_set</span>

        <span class="c1"># Find the index position of the given obj in the category set</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">category_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Find the previous and next topics, if either exist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;topic_previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get the help entry text</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Failed to find entry.&quot;</span>
        <span class="k">if</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;evennia.commands.command.Command&quot;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">elif</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;evennia.help.models.HelpEntry&quot;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">db_entrytext</span>
        <span class="k">elif</span> <span class="n">inherits_from</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;evennia.help.filehelp.FileHelpEntry&quot;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">entrytext</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">strip_ansi</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># remove ansii markups</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;entry_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">context</span></div>


<div class="viewcode-block" id="HelpDetailView.get_object">
<a class="viewcode-back" href="../../../../../api/evennia.web.website.views.help.html#evennia.web.website.views.help.HelpDetailView.get_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override of Django hook that retrieves an object by category and topic</span>
<span class="sd">        instead of pk and slug.</span>

<span class="sd">        Args:</span>
<span class="sd">            queryset (list): A list of help entry objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            entry (HelpEntry, FileHelpEntry or Command): HelpEntry requested in the URL.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get the queryset for the help entries the user can access</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="c1"># get the category and topic requested</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;topic&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="c1"># Find the object in the queryset</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="c1"># continue to next entry if the topics do not match</span>
            <span class="n">entry_topic</span> <span class="o">=</span> <span class="n">get_help_topic</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">slugify</span><span class="p">(</span><span class="n">entry_topic</span><span class="p">)</span> <span class="o">==</span> <span class="n">topic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># if the category also matches, object requested is found</span>
            <span class="n">entry_category</span> <span class="o">=</span> <span class="n">get_help_category</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="n">entry_category</span><span class="p">)</span> <span class="o">==</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">entry</span>
                <span class="k">break</span>

        <span class="c1"># Check if this object was requested in a valid manner</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No (</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">)s found matching the query.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># cache the object if one was found</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">return</span> <span class="n">obj</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/evennia_logo.png" alt="Logo of Evennia"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com/docs/latest/index.html">Documentation Top</a> </li>
  <li><a href="https://www.evennia.com">Evennia Home</a> </li>
  <li><a href="https://github.com/evennia/evennia">Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Doc Versions</h3>
<ul>
  
    <li>
      <a href="https://www.evennia.com/docs/latest/index.html">latest (main branch)</a>
    </li>
  
  
    <li>
      <a href="https://www.evennia.com/docs/5.x/index.html">v5.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/4.x/index.html">v4.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/3.x/index.html">v3.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/2.x/index.html">v2.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/1.x/index.html">v1.0.0 branch (outdated)</a>
    </li>
  
    <li>
      <a href="https://www.evennia.com/docs/0.x/index.html">v0.9.5 branch (outdated)</a>
    </li>
  
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Evennia</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../../evennia.html" >evennia</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">evennia.web.website.views.help</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>